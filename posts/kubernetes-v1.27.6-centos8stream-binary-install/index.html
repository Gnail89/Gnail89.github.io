<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Kubernetes V1.27.6 Centos8stream Binary Install | 📕W.'s Blog</title>
<meta name=keywords content="kubernetes,etcd,calico"><meta name=description content="k8s study"><meta name=author content><link rel=canonical href=https://gnail89.github.io/posts/kubernetes-v1.27.6-centos8stream-binary-install/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://gnail89.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://gnail89.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://gnail89.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://gnail89.github.io/apple-touch-icon.png><link rel=mask-icon href=https://gnail89.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Kubernetes V1.27.6 Centos8stream Binary Install"><meta property="og:description" content="k8s study"><meta property="og:type" content="article"><meta property="og:url" content="https://gnail89.github.io/posts/kubernetes-v1.27.6-centos8stream-binary-install/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-27T17:05:29+08:00"><meta property="article:modified_time" content="2023-09-27T17:05:29+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Kubernetes V1.27.6 Centos8stream Binary Install"><meta name=twitter:description content="k8s study"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://gnail89.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Kubernetes V1.27.6 Centos8stream Binary Install","item":"https://gnail89.github.io/posts/kubernetes-v1.27.6-centos8stream-binary-install/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Kubernetes V1.27.6 Centos8stream Binary Install","name":"Kubernetes V1.27.6 Centos8stream Binary Install","description":"k8s study","keywords":["kubernetes","etcd","calico"],"articleBody":"环境 主机名 IP地址 备注 VIP 192.168.100.100 浮动IP k8s-master01 192.168.100.101 master节点 k8s-master02 192.168.100.102 master节点 k8s-master03 192.168.100.103 master节点 k8s-node01 192.168.100.104 node节点 k8s-node02 192.168.100.105 node节点 网段说明\nservice: 10.96.0.0/12 pod: 172.16.0.0/12 k8s基础系统环境配置 配置IP # 网卡UUID不能重复，UUID重复无法获取到IPV6地址 # # 查看当前的网卡列表和 UUID： # nmcli con show # 删除要更改 UUID 的网络连接： # nmcli con delete uuid \u003c原 UUID\u003e # 重新生成 UUID： # nmcli con add type ethernet ifname \u003c接口名称\u003e con-name \u003c新名称\u003e # 重新启用网络连接： # nmcli con up \u003c新名称\u003e # 更改网卡的UUID nmcli con delete uuid a5078897-4aae-3fa8-8b7a-0773d924901d;nmcli con add type ethernet ifname ens1 con-name ens1;nmcli con up ens1 nmcli con delete uuid a5078897-4aae-3fa8-8b7a-0773d924901d;nmcli con add type ethernet ifname ens1 con-name ens1;nmcli con up ens1 nmcli con delete uuid a5078897-4aae-3fa8-8b7a-0773d924901d;nmcli con add type ethernet ifname ens1 con-name ens1;nmcli con up ens1 nmcli con delete uuid a5078897-4aae-3fa8-8b7a-0773d924901d;nmcli con add type ethernet ifname ens1 con-name ens1;nmcli con up ens1 nmcli con delete uuid a5078897-4aae-3fa8-8b7a-0773d924901d;nmcli con add type ethernet ifname ens1 con-name ens1;nmcli con up ens1 # 修改静态的IPv4地址 nmcli con mod ens1 ipv4.addresses 192.168.100.101/24; nmcli con mod ens1 ipv4.gateway 192.168.100.1; nmcli con mod ens1 ipv4.method manual; nmcli con mod ens1 ipv4.dns \"192.168.100.1\"; nmcli con up ens1 nmcli con mod ens1 ipv4.addresses 192.168.100.102/24; nmcli con mod ens1 ipv4.gateway 192.168.100.1; nmcli con mod ens1 ipv4.method manual; nmcli con mod ens1 ipv4.dns \"192.168.100.1\"; nmcli con up ens1 nmcli con mod ens1 ipv4.addresses 192.168.100.103/24; nmcli con mod ens1 ipv4.gateway 192.168.100.1; nmcli con mod ens1 ipv4.method manual; nmcli con mod ens1 ipv4.dns \"192.168.100.1\"; nmcli con up ens1 nmcli con mod ens1 ipv4.addresses 192.168.100.104/24; nmcli con mod ens1 ipv4.gateway 192.168.100.1; nmcli con mod ens1 ipv4.method manual; nmcli con mod ens1 ipv4.dns \"192.168.100.1\"; nmcli con up ens1 nmcli con mod ens1 ipv4.addresses 192.168.100.105/24; nmcli con mod ens1 ipv4.gateway 192.168.100.1; nmcli con mod ens1 ipv4.method manual; nmcli con mod ens1 ipv4.dns \"192.168.100.1\"; nmcli con up ens1 # 没有IPv6不配置即可(没有测试IPv6) nmcli con mod ens1 ipv6.addresses fc00:43f4:1eea:1::10; nmcli con mod ens1 ipv6.gateway fc00:43f4:1eea:1::1; nmcli con mod ens1 ipv6.method manual; nmcli con mod ens1 ipv6.dns \"2400:3200::1\"; nmcli con up ens1 nmcli con mod ens1 ipv6.addresses fc00:43f4:1eea:1::20; nmcli con mod ens1 ipv6.gateway fc00:43f4:1eea:1::1; nmcli con mod ens1 ipv6.method manual; nmcli con mod ens1 ipv6.dns \"2400:3200::1\"; nmcli con up ens1 nmcli con mod ens1 ipv6.addresses fc00:43f4:1eea:1::30; nmcli con mod ens1 ipv6.gateway fc00:43f4:1eea:1::1; nmcli con mod ens1 ipv6.method manual; nmcli con mod ens1 ipv6.dns \"2400:3200::1\"; nmcli con up ens1 nmcli con mod ens1 ipv6.addresses fc00:43f4:1eea:1::40; nmcli con mod ens1 ipv6.gateway fc00:43f4:1eea:1::1; nmcli con mod ens1 ipv6.method manual; nmcli con mod ens1 ipv6.dns \"2400:3200::1\"; nmcli con up ens1 nmcli con mod ens1 ipv6.addresses fc00:43f4:1eea:1::50; nmcli con mod ens1 ipv6.gateway fc00:43f4:1eea:1::1; nmcli con mod ens1 ipv6.method manual; nmcli con mod ens1 ipv6.dns \"2400:3200::1\"; nmcli con up ens1 # 查看网卡配置 # nmcli device show ens1 # nmcli con show ens1 [root@localhost ~]# cat /etc/sysconfig/network-scripts/ifcfg-ens1 TYPE=Ethernet PROXY_METHOD=none BROWSER_ONLY=no BOOTPROTO=none IPADDR=192.168.100.101 PREFIX=24 GATEWAY=192.168.100.1 DNS1=192.168.100.1 DEFROUTE=yes IPV4_FAILURE_FATAL=no IPV6INIT=yes IPV6_AUTOCONF=yes IPV6_DEFROUTE=yes IPV6_FAILURE_FATAL=no IPV6_ADDR_GEN_MODE=stable-privacy NAME=ens1 UUID=a5078897-4aae-3fa8-8b7a-0773d924901e DEVICE=ens1 ONBOOT=yes AUTOCONNECT_PRIORITY=-999 IPV6ADDR=fc00:43f4:1eea:1::10/128 IPV6_DEFAULTGW=fc00:43f4:1eea:1::1 DNS2=2400:3200::1 设置主机名 hostnamectl set-hostname k8s-master01 hostnamectl set-hostname k8s-master02 hostnamectl set-hostname k8s-master03 hostnamectl set-hostname k8s-node01 hostnamectl set-hostname k8s-node02 配置yum源 sudo sed -e 's|^mirrorlist=|#mirrorlist=|g' \\ -e 's|^#baseurl=http://mirror.centos.org/$contentdir|baseurl=https://mirrors.tuna.tsinghua.edu.cn/centos|g' \\ -i.bak \\ /etc/yum.repos.d/CentOS-*.repo 安装一些软件(可选) yum update -y \u0026\u0026 yum -y install wget psmisc vim net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 git network-scripts tar curl 下载离线文件(可选) # 下载必要工具 yum -y install createrepo yum-utils wget epel-release elrepo-release # 下载全量依赖包 repotrack wget psmisc vim net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 git network-scripts tar curl gcc keepalived haproxy bash-completion chrony sshpass ipvsadm ipset sysstat conntrack libseccomp # 创建yum源信息 createrepo -u -d /data/centos8/ # 拷贝包到内网机器上 scp -r centos8/ root@192.168.100.101: scp -r centos8/ root@192.168.100.102: scp -r centos8/ root@192.168.100.103: scp -r centos8/ root@192.168.100.104: scp -r centos8/ root@192.168.100.105: # 在内网机器上创建repo配置文件 rm -rf /etc/yum.repos.d/* cat \u003e /etc/yum.repos.d/base.repo \u003c\u003c EOF [base] name=CentOS-$releasever - Media baseurl=file:///root/centos8/ gpgcheck=0 enabled=1 EOF # 安装下载好的包 yum clean all yum makecache yum install -y /root/centos8/* 下载软件包(必要) #!/bin/bash # 查看版本地址： # # https://github.com/containernetworking/plugins/releases/ # https://github.com/containerd/containerd/releases/ # https://github.com/kubernetes-sigs/cri-tools/releases/ # https://github.com/Mirantis/cri-dockerd/releases/ # https://github.com/etcd-io/etcd/releases/ # https://github.com/cloudflare/cfssl/releases/ # https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG # https://download.docker.com/linux/static/stable/x86_64/ # https://github.com/opencontainers/runc/releases/ # https://mirrors.tuna.tsinghua.edu.cn/elrepo/kernel/el7/x86_64/RPMS/ # https://github.com/helm/helm/tags # http://nginx.org/download/ # Version numbers cni_plugins_version='v1.3.0' cri_containerd_cni_version='1.7.6' crictl_version='v1.28.0' cri_dockerd_version='0.3.4' etcd_version='v3.5.9' cfssl_version='1.6.4' kubernetes_server_version='1.27.6' docker_version='24.0.6' runc_version='1.1.9' kernel_version='5.4.256' helm_version='3.12.3' nginx_version='1.25.2' # URLs base_url='https://ghproxy.com/https://github.com' kernel_url=\"http://mirrors.tuna.tsinghua.edu.cn/elrepo/kernel/el7/x86_64/RPMS/kernel-lt-${kernel_version}-1.el7.elrepo.x86_64.rpm\" runc_url=\"${base_url}/opencontainers/runc/releases/download/v${runc_version}/runc.amd64\" docker_url=\"https://download.docker.com/linux/static/stable/x86_64/docker-${docker_version}.tgz\" cni_plugins_url=\"${base_url}/containernetworking/plugins/releases/download/${cni_plugins_version}/cni-plugins-linux-amd64-${cni_plugins_version}.tgz\" cri_containerd_cni_url=\"${base_url}/containerd/containerd/releases/download/v${cri_containerd_cni_version}/cri-containerd-cni-${cri_containerd_cni_version}-linux-amd64.tar.gz\" crictl_url=\"${base_url}/kubernetes-sigs/cri-tools/releases/download/${crictl_version}/crictl-${crictl_version}-linux-amd64.tar.gz\" cri_dockerd_url=\"${base_url}/Mirantis/cri-dockerd/releases/download/v${cri_dockerd_version}/cri-dockerd-${cri_dockerd_version}.amd64.tgz\" etcd_url=\"${base_url}/etcd-io/etcd/releases/download/${etcd_version}/etcd-${etcd_version}-linux-amd64.tar.gz\" cfssl_url=\"${base_url}/cloudflare/cfssl/releases/download/v${cfssl_version}/cfssl_${cfssl_version}_linux_amd64\" cfssljson_url=\"${base_url}/cloudflare/cfssl/releases/download/v${cfssl_version}/cfssljson_${cfssl_version}_linux_amd64\" helm_url=\"https://files.m.daocloud.io/get.helm.sh/helm-v${helm_version}-linux-amd64.tar.gz\" kubernetes_server_url=\"https://dl.k8s.io/v${kubernetes_server_version}/kubernetes-server-linux-amd64.tar.gz\" nginx_url=\"http://nginx.org/download/nginx-${nginx_version}.tar.gz\" # Download packages packages=( #$kernel_url $runc_url $docker_url $cni_plugins_url $cri_containerd_cni_url $crictl_url $cri_dockerd_url $etcd_url $cfssl_url $cfssljson_url $helm_url $kubernetes_server_url $nginx_url ) for package_url in \"${packages[@]}\"; do filename=$(basename \"$package_url\") if wget -cq --progress=bar:force:noscroll -nc \"$package_url\"; then echo \"Downloaded $filename\" else echo \"Failed to download $filename\" exit 1 fi done 关闭防火墙 systemctl disable --now firewalld 关闭SELinux setenforce 0 sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/selinux/config 关闭交换分区 sed -ri 's/.*swap.*/#\u0026/' /etc/fstab swapoff -a \u0026\u0026 sysctl -w vm.swappiness=0 cat /etc/fstab # /dev/mapper/centos-swap swap swap defaults 0 0 网络配置 # NetworkManager cat \u003e /etc/NetworkManager/conf.d/calico.conf \u003c\u003c EOF [keyfile] unmanaged-devices=interface-name:cali*;interface-name:tunl* EOF systemctl restart NetworkManager 时间同步 yum install chrony -y systemctl enable --now chronyd chronyc sources -v 配置ulimit ulimit -SHn 65535 cat \u003e\u003e /etc/security/limits.conf \u003c","wordCount":"7147","inLanguage":"en","datePublished":"2023-09-27T17:05:29+08:00","dateModified":"2023-09-27T17:05:29+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://gnail89.github.io/posts/kubernetes-v1.27.6-centos8stream-binary-install/"},"publisher":{"@type":"Organization","name":"📕W.'s Blog","logo":{"@type":"ImageObject","url":"https://gnail89.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://gnail89.github.io accesskey=h title="📕W.'s Blog (Alt + H)">📕W.'s Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://gnail89.github.io/search/ title=🔍Search><span>🔍Search</span></a></li><li><a href=https://gnail89.github.io/archives/ title=📚Archive><span>📚Archive</span></a></li><li><a href=https://gnail89.github.io/tags/ title=🔖Tags><span>🔖Tags</span></a></li><li><a href=https://gnail89.github.io/categories/ title=🧩Categories><span>🧩Categories</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://gnail89.github.io>Home</a>&nbsp;»&nbsp;<a href=https://gnail89.github.io/posts/>Posts</a></div><h1 class=post-title>Kubernetes V1.27.6 Centos8stream Binary Install</h1><div class=post-description>k8s study</div><div class=post-meta>&lt;span title='2023-09-27 17:05:29 +0800 +0800'>September 27, 2023&lt;/span>&amp;nbsp;·&amp;nbsp;34 min&amp;nbsp;·&amp;nbsp;7147 words</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#配置ip>配置IP</a></li><li><a href=#设置主机名>设置主机名</a></li><li><a href=#配置yum源>配置yum源</a></li><li><a href=#安装一些软件可选>安装一些软件(可选)</a></li><li><a href=#下载离线文件可选>下载离线文件(可选)</a></li><li><a href=#下载软件包必要>下载软件包(必要)</a></li><li><a href=#关闭防火墙>关闭防火墙</a></li><li><a href=#关闭selinux>关闭SELinux</a></li><li><a href=#关闭交换分区>关闭交换分区</a></li><li><a href=#网络配置>网络配置</a></li><li><a href=#时间同步>时间同步</a></li><li><a href=#配置ulimit>配置ulimit</a></li><li><a href=#配置免密登录>配置免密登录</a></li><li><a href=#添加elrepo源>添加elrepo源</a></li><li><a href=#升级内核至418版本以上>升级内核至4.18版本以上</a></li><li><a href=#安装ipvsadm>安装ipvsadm</a></li><li><a href=#修改内核参数>修改内核参数</a></li><li><a href=#所有节点配置hosts本地解析>所有节点配置hosts本地解析</a></li></ul><ul><li><a href=#安装containerd作为runtime方式一推荐>安装Containerd作为Runtime(方式一，推荐)</a><ul><li><a href=#配置containerd所需的模块>配置Containerd所需的模块</a></li><li><a href=#配置containerd所需的内核>配置Containerd所需的内核</a></li><li><a href=#创建containerd的配置文件>创建Containerd的配置文件</a></li><li><a href=#启动并设置为开机启动>启动并设置为开机启动</a></li><li><a href=#配置crictl客户端连接的运行时位置>配置crictl客户端连接的运行时位置</a></li></ul></li><li><a href=#安装docker作为runtime方式二>安装docker作为Runtime(方式二)</a><ul><li><a href=#安装docker>安装docker</a></li><li><a href=#安装cri-docker>安装cri-docker</a></li></ul></li><li><a href=#k8s与etcd安装仅在master01操作>k8s与etcd安装(仅在master01操作)</a><ul><li><a href=#解压k8s安装包>解压k8s安装包</a></li><li><a href=#查看版本>查看版本</a></li><li><a href=#将组件复制到其他k8s节点>将组件复制到其他k8s节点</a></li></ul></li><li><a href=#相关证书生成>相关证书生成</a><ul><li><a href=#生成etcd证书>生成etcd证书</a></li><li><a href=#生成k8s相关证书>生成k8s相关证书</a></li></ul></li></ul><ul><li><a href=#etcd配置>etcd配置</a><ul><li><a href=#master01配置>master01配置</a></li><li><a href=#master02配置>master02配置</a></li><li><a href=#master03配置>master03配置</a></li></ul></li><li><a href=#创建service所有master节点操作>创建service(所有master节点操作)</a><ul><li><a href=#创建etcdservice并启动>创建etcd.service并启动</a></li><li><a href=#创建etcd证书目录>创建etcd证书目录</a></li><li><a href=#查看etcd状态>查看etcd状态</a></li></ul></li></ul><ul><li><a href=#nginx高可用方案>nginx高可用方案</a><ul><li><a href=#编译nginx>编译nginx</a></li><li><a href=#写入启动配置>写入启动配置</a></li></ul></li><li><a href=#keepalived和haproxy高可用方案>keepalived和haproxy高可用方案</a><ul><li><a href=#安装keepalived和haproxy服务>安装keepalived和haproxy服务</a></li><li><a href=#修改haproxy配置文件所有master节点配置文件一样>修改haproxy配置文件(所有master节点配置文件一样)</a></li><li><a href=#master01配置keepalived-master节点>master01配置keepalived master节点</a></li><li><a href=#master02配置keepalived-backup节点>master02配置keepalived backup节点</a></li><li><a href=#master03配置keepalived-backup节点>master03配置keepalived backup节点</a></li><li><a href=#配置健康检查脚本keepalived主机上配置>配置健康检查脚本(keepalived主机上配置)</a></li><li><a href=#启动服务>启动服务</a></li><li><a href=#测试高可用>测试高可用</a></li></ul></li></ul><ul><li><a href=#创建apiserver所有master节点>创建apiserver(所有master节点)</a><ul><li><a href=#master01节点配置>master01节点配置</a></li><li><a href=#master02节点配置>master02节点配置</a></li><li><a href=#master03节点配置>master03节点配置</a></li><li><a href=#启动apiserver所有master节点>启动apiserver(所有master节点)</a></li></ul></li><li><a href=#配置kube-controller-manager-service>配置kube-controller-manager service</a><ul><li><a href=#启动kube-controller-manager>启动kube-controller-manager</a></li></ul></li><li><a href=#配置kube-scheduler-service>配置kube-scheduler service</a><ul><li><a href=#所有master节点配置且配置相同>所有master节点配置，且配置相同</a></li><li><a href=#启动并查看服务状态>启动并查看服务状态</a></li></ul></li></ul><ul><li><a href=#在master01上配置>在master01上配置</a></li></ul><ul><li><a href=#在master01上将证书复制到node节点>在master01上将证书复制到node节点</a></li><li><a href=#kubelet配置>kubelet配置</a><ul><li><a href=#当使用docker作为runtime>当使用docker作为Runtime</a></li><li><a href=#当使用containerd作为runtime-推荐>当使用Containerd作为Runtime (推荐)</a></li><li><a href=#所有k8s节点创建kubelet的配置文件>所有k8s节点创建kubelet的配置文件</a></li><li><a href=#启动kubelet>启动kubelet</a></li><li><a href=#查看集群>查看集群</a></li><li><a href=#查看容器运行时>查看容器运行时</a></li></ul></li><li><a href=#kube-proxy配置>kube-proxy配置</a><ul><li><a href=#将kubeconfig发送至其他节点>将kubeconfig发送至其他节点</a></li><li><a href=#所有k8s节点添加kube-proxy的service文件>所有k8s节点添加kube-proxy的service文件</a></li><li><a href=#所有k8s节点添加kube-proxy的配置>所有k8s节点添加kube-proxy的配置</a></li><li><a href=#启动kube-proxy>启动kube-proxy</a></li></ul></li></ul><ul><li><a href=#升级runc可选>升级runc(可选)</a></li><li><a href=#安装calico>安装Calico</a><ul><li><a href=#更改calico网段>更改calico网段</a></li><li><a href=#查看容器状态>查看容器状态</a></li></ul></li><li><a href=#安装cilium示例>安装cilium(示例)</a><ul><li><a href=#安装helm示例>安装helm(示例)</a></li><li><a href=#安装示例>安装(示例)</a></li><li><a href=#查看示例>查看(示例)</a></li><li><a href=#下载专属监控面板示例>下载专属监控面板(示例)</a></li><li><a href=#下载部署测试用例示例>下载部署测试用例(示例)</a></li><li><a href=#查看pod示例>查看pod(示例)</a></li><li><a href=#修改为nodeport示例>修改为NodePort(示例)</a></li><li><a href=#查看端口示例>查看端口(示例)</a></li><li><a href=#访问示例>访问(示例)</a></li></ul></li></ul><ul><li><a href=#修改文件>修改文件</a></li></ul><ul><li><a href=#安装>安装</a></li><li><a href=#查看状态>查看状态</a></li></ul><ul><li><a href=#部署pod资源>部署pod资源</a></li><li><a href=#用pod解析默认命名空间中的kubernetes>用pod解析默认命名空间中的kubernetes</a></li><li><a href=#测试跨命名空间是否可以解析>测试跨命名空间是否可以解析</a></li><li><a href=#每个节点都必须要能访问kubernetes的kubernetes-svc-443和kube-dns的service-53>每个节点都必须要能访问Kubernetes的kubernetes svc 443和kube-dns的service 53</a></li><li><a href=#pod和pod之间要能通>Pod和Pod之间要能通</a></li><li><a href=#创建三个副本可以看到3个副本分布在不同的节点上>创建三个副本，可以看到3个副本分布在不同的节点上</a></li></ul><ul><li><a href=#更改dashboard的svc为nodeport>更改dashboard的svc为NodePort</a></li><li><a href=#查看端口号>查看端口号</a></li><li><a href=#创建token>创建token</a></li><li><a href=#登录dashboard>登录dashboard</a></li></ul><ul><li><a href=#部署>部署</a></li><li><a href=#过滤查看ingress端口>过滤查看ingress端口</a></li></ul></nav></div></details></div><div class=post-content><h1 id=环境>环境<a hidden class=anchor aria-hidden=true href=#环境>#</a></h1><table><thead><tr><th>主机名</th><th>IP地址</th><th>备注</th></tr></thead><tbody><tr><td>VIP</td><td>192.168.100.100</td><td>浮动IP</td></tr><tr><td>k8s-master01</td><td>192.168.100.101</td><td>master节点</td></tr><tr><td>k8s-master02</td><td>192.168.100.102</td><td>master节点</td></tr><tr><td>k8s-master03</td><td>192.168.100.103</td><td>master节点</td></tr><tr><td>k8s-node01</td><td>192.168.100.104</td><td>node节点</td></tr><tr><td>k8s-node02</td><td>192.168.100.105</td><td>node节点</td></tr></tbody></table><blockquote><p>网段说明</p></blockquote><ul><li>service: 10.96.0.0/12</li><li>pod: 172.16.0.0/12</li></ul><h1 id=k8s基础系统环境配置>k8s基础系统环境配置<a hidden class=anchor aria-hidden=true href=#k8s基础系统环境配置>#</a></h1><h2 id=配置ip>配置IP<a hidden class=anchor aria-hidden=true href=#配置ip>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 网卡UUID不能重复，UUID重复无法获取到IPV6地址</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># 查看当前的网卡列表和 UUID：</span>
</span></span><span class=line><span class=cl><span class=c1># nmcli con show</span>
</span></span><span class=line><span class=cl><span class=c1># 删除要更改 UUID 的网络连接：</span>
</span></span><span class=line><span class=cl><span class=c1># nmcli con delete uuid &lt;原 UUID&gt;</span>
</span></span><span class=line><span class=cl><span class=c1># 重新生成 UUID：</span>
</span></span><span class=line><span class=cl><span class=c1># nmcli con add type ethernet ifname &lt;接口名称&gt; con-name &lt;新名称&gt;</span>
</span></span><span class=line><span class=cl><span class=c1># 重新启用网络连接：</span>
</span></span><span class=line><span class=cl><span class=c1># nmcli con up &lt;新名称&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 更改网卡的UUID</span>
</span></span><span class=line><span class=cl>nmcli con delete uuid a5078897-4aae-3fa8-8b7a-0773d924901d<span class=p>;</span>nmcli con add <span class=nb>type</span> ethernet ifname ens1 con-name ens1<span class=p>;</span>nmcli con up ens1
</span></span><span class=line><span class=cl>nmcli con delete uuid a5078897-4aae-3fa8-8b7a-0773d924901d<span class=p>;</span>nmcli con add <span class=nb>type</span> ethernet ifname ens1 con-name ens1<span class=p>;</span>nmcli con up ens1
</span></span><span class=line><span class=cl>nmcli con delete uuid a5078897-4aae-3fa8-8b7a-0773d924901d<span class=p>;</span>nmcli con add <span class=nb>type</span> ethernet ifname ens1 con-name ens1<span class=p>;</span>nmcli con up ens1
</span></span><span class=line><span class=cl>nmcli con delete uuid a5078897-4aae-3fa8-8b7a-0773d924901d<span class=p>;</span>nmcli con add <span class=nb>type</span> ethernet ifname ens1 con-name ens1<span class=p>;</span>nmcli con up ens1
</span></span><span class=line><span class=cl>nmcli con delete uuid a5078897-4aae-3fa8-8b7a-0773d924901d<span class=p>;</span>nmcli con add <span class=nb>type</span> ethernet ifname ens1 con-name ens1<span class=p>;</span>nmcli con up ens1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改静态的IPv4地址</span>
</span></span><span class=line><span class=cl>nmcli con mod ens1 ipv4.addresses 192.168.100.101/24<span class=p>;</span> nmcli con mod ens1 ipv4.gateway  192.168.100.1<span class=p>;</span> nmcli con mod ens1 ipv4.method manual<span class=p>;</span> nmcli con mod ens1 ipv4.dns <span class=s2>&#34;192.168.100.1&#34;</span><span class=p>;</span> nmcli con up ens1
</span></span><span class=line><span class=cl>nmcli con mod ens1 ipv4.addresses 192.168.100.102/24<span class=p>;</span> nmcli con mod ens1 ipv4.gateway  192.168.100.1<span class=p>;</span> nmcli con mod ens1 ipv4.method manual<span class=p>;</span> nmcli con mod ens1 ipv4.dns <span class=s2>&#34;192.168.100.1&#34;</span><span class=p>;</span> nmcli con up ens1
</span></span><span class=line><span class=cl>nmcli con mod ens1 ipv4.addresses 192.168.100.103/24<span class=p>;</span> nmcli con mod ens1 ipv4.gateway  192.168.100.1<span class=p>;</span> nmcli con mod ens1 ipv4.method manual<span class=p>;</span> nmcli con mod ens1 ipv4.dns <span class=s2>&#34;192.168.100.1&#34;</span><span class=p>;</span> nmcli con up ens1
</span></span><span class=line><span class=cl>nmcli con mod ens1 ipv4.addresses 192.168.100.104/24<span class=p>;</span> nmcli con mod ens1 ipv4.gateway  192.168.100.1<span class=p>;</span> nmcli con mod ens1 ipv4.method manual<span class=p>;</span> nmcli con mod ens1 ipv4.dns <span class=s2>&#34;192.168.100.1&#34;</span><span class=p>;</span> nmcli con up ens1
</span></span><span class=line><span class=cl>nmcli con mod ens1 ipv4.addresses 192.168.100.105/24<span class=p>;</span> nmcli con mod ens1 ipv4.gateway  192.168.100.1<span class=p>;</span> nmcli con mod ens1 ipv4.method manual<span class=p>;</span> nmcli con mod ens1 ipv4.dns <span class=s2>&#34;192.168.100.1&#34;</span><span class=p>;</span> nmcli con up ens1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 没有IPv6不配置即可(没有测试IPv6)</span>
</span></span><span class=line><span class=cl>nmcli con mod ens1 ipv6.addresses fc00:43f4:1eea:1::10<span class=p>;</span> nmcli con mod ens1 ipv6.gateway fc00:43f4:1eea:1::1<span class=p>;</span> nmcli con mod ens1 ipv6.method manual<span class=p>;</span> nmcli con mod ens1 ipv6.dns <span class=s2>&#34;2400:3200::1&#34;</span><span class=p>;</span> nmcli con up ens1
</span></span><span class=line><span class=cl>nmcli con mod ens1 ipv6.addresses fc00:43f4:1eea:1::20<span class=p>;</span> nmcli con mod ens1 ipv6.gateway fc00:43f4:1eea:1::1<span class=p>;</span> nmcli con mod ens1 ipv6.method manual<span class=p>;</span> nmcli con mod ens1 ipv6.dns <span class=s2>&#34;2400:3200::1&#34;</span><span class=p>;</span> nmcli con up ens1
</span></span><span class=line><span class=cl>nmcli con mod ens1 ipv6.addresses fc00:43f4:1eea:1::30<span class=p>;</span> nmcli con mod ens1 ipv6.gateway fc00:43f4:1eea:1::1<span class=p>;</span> nmcli con mod ens1 ipv6.method manual<span class=p>;</span> nmcli con mod ens1 ipv6.dns <span class=s2>&#34;2400:3200::1&#34;</span><span class=p>;</span> nmcli con up ens1
</span></span><span class=line><span class=cl>nmcli con mod ens1 ipv6.addresses fc00:43f4:1eea:1::40<span class=p>;</span> nmcli con mod ens1 ipv6.gateway fc00:43f4:1eea:1::1<span class=p>;</span> nmcli con mod ens1 ipv6.method manual<span class=p>;</span> nmcli con mod ens1 ipv6.dns <span class=s2>&#34;2400:3200::1&#34;</span><span class=p>;</span> nmcli con up ens1
</span></span><span class=line><span class=cl>nmcli con mod ens1 ipv6.addresses fc00:43f4:1eea:1::50<span class=p>;</span> nmcli con mod ens1 ipv6.gateway fc00:43f4:1eea:1::1<span class=p>;</span> nmcli con mod ens1 ipv6.method manual<span class=p>;</span> nmcli con mod ens1 ipv6.dns <span class=s2>&#34;2400:3200::1&#34;</span><span class=p>;</span> nmcli con up ens1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看网卡配置</span>
</span></span><span class=line><span class=cl><span class=c1># nmcli device show ens1</span>
</span></span><span class=line><span class=cl><span class=c1># nmcli con show ens1</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@localhost ~<span class=o>]</span><span class=c1># cat /etc/sysconfig/network-scripts/ifcfg-ens1 </span>
</span></span><span class=line><span class=cl><span class=nv>TYPE</span><span class=o>=</span>Ethernet
</span></span><span class=line><span class=cl><span class=nv>PROXY_METHOD</span><span class=o>=</span>none
</span></span><span class=line><span class=cl><span class=nv>BROWSER_ONLY</span><span class=o>=</span>no
</span></span><span class=line><span class=cl><span class=nv>BOOTPROTO</span><span class=o>=</span>none
</span></span><span class=line><span class=cl><span class=nv>IPADDR</span><span class=o>=</span>192.168.100.101
</span></span><span class=line><span class=cl><span class=nv>PREFIX</span><span class=o>=</span><span class=m>24</span>
</span></span><span class=line><span class=cl><span class=nv>GATEWAY</span><span class=o>=</span>192.168.100.1
</span></span><span class=line><span class=cl><span class=nv>DNS1</span><span class=o>=</span>192.168.100.1
</span></span><span class=line><span class=cl><span class=nv>DEFROUTE</span><span class=o>=</span>yes
</span></span><span class=line><span class=cl><span class=nv>IPV4_FAILURE_FATAL</span><span class=o>=</span>no
</span></span><span class=line><span class=cl><span class=nv>IPV6INIT</span><span class=o>=</span>yes
</span></span><span class=line><span class=cl><span class=nv>IPV6_AUTOCONF</span><span class=o>=</span>yes
</span></span><span class=line><span class=cl><span class=nv>IPV6_DEFROUTE</span><span class=o>=</span>yes
</span></span><span class=line><span class=cl><span class=nv>IPV6_FAILURE_FATAL</span><span class=o>=</span>no
</span></span><span class=line><span class=cl><span class=nv>IPV6_ADDR_GEN_MODE</span><span class=o>=</span>stable-privacy
</span></span><span class=line><span class=cl><span class=nv>NAME</span><span class=o>=</span>ens1
</span></span><span class=line><span class=cl><span class=nv>UUID</span><span class=o>=</span>a5078897-4aae-3fa8-8b7a-0773d924901e
</span></span><span class=line><span class=cl><span class=nv>DEVICE</span><span class=o>=</span>ens1
</span></span><span class=line><span class=cl><span class=nv>ONBOOT</span><span class=o>=</span>yes
</span></span><span class=line><span class=cl><span class=nv>AUTOCONNECT_PRIORITY</span><span class=o>=</span>-999
</span></span><span class=line><span class=cl><span class=nv>IPV6ADDR</span><span class=o>=</span>fc00:43f4:1eea:1::10/128
</span></span><span class=line><span class=cl><span class=nv>IPV6_DEFAULTGW</span><span class=o>=</span>fc00:43f4:1eea:1::1
</span></span><span class=line><span class=cl><span class=nv>DNS2</span><span class=o>=</span>2400:3200::1
</span></span></code></pre></div><h2 id=设置主机名>设置主机名<a hidden class=anchor aria-hidden=true href=#设置主机名>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>hostnamectl set-hostname k8s-master01
</span></span><span class=line><span class=cl>hostnamectl set-hostname k8s-master02
</span></span><span class=line><span class=cl>hostnamectl set-hostname k8s-master03
</span></span><span class=line><span class=cl>hostnamectl set-hostname k8s-node01
</span></span><span class=line><span class=cl>hostnamectl set-hostname k8s-node02
</span></span></code></pre></div><h2 id=配置yum源>配置yum源<a hidden class=anchor aria-hidden=true href=#配置yum源>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo sed -e <span class=s1>&#39;s|^mirrorlist=|#mirrorlist=|g&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>         -e <span class=s1>&#39;s|^#baseurl=http://mirror.centos.org/$contentdir|baseurl=https://mirrors.tuna.tsinghua.edu.cn/centos|g&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>         -i.bak <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>         /etc/yum.repos.d/CentOS-*.repo
</span></span></code></pre></div><h2 id=安装一些软件可选>安装一些软件(可选)<a hidden class=anchor aria-hidden=true href=#安装一些软件可选>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yum update -y <span class=o>&amp;&amp;</span> yum -y install wget psmisc vim net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 git network-scripts tar curl
</span></span></code></pre></div><h2 id=下载离线文件可选>下载离线文件(可选)<a hidden class=anchor aria-hidden=true href=#下载离线文件可选>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 下载必要工具</span>
</span></span><span class=line><span class=cl>yum -y install createrepo yum-utils wget epel-release elrepo-release
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 下载全量依赖包</span>
</span></span><span class=line><span class=cl>repotrack wget psmisc vim net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 git network-scripts tar curl gcc keepalived haproxy bash-completion chrony sshpass ipvsadm ipset sysstat conntrack libseccomp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建yum源信息</span>
</span></span><span class=line><span class=cl>createrepo -u -d /data/centos8/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 拷贝包到内网机器上</span>
</span></span><span class=line><span class=cl>scp -r centos8/ root@192.168.100.101:
</span></span><span class=line><span class=cl>scp -r centos8/ root@192.168.100.102:
</span></span><span class=line><span class=cl>scp -r centos8/ root@192.168.100.103:
</span></span><span class=line><span class=cl>scp -r centos8/ root@192.168.100.104:
</span></span><span class=line><span class=cl>scp -r centos8/ root@192.168.100.105:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在内网机器上创建repo配置文件</span>
</span></span><span class=line><span class=cl>rm -rf /etc/yum.repos.d/*
</span></span><span class=line><span class=cl>cat &gt; /etc/yum.repos.d/base.repo  <span class=s>&lt;&lt; EOF 
</span></span></span><span class=line><span class=cl><span class=s>[base]
</span></span></span><span class=line><span class=cl><span class=s>name=CentOS-$releasever - Media
</span></span></span><span class=line><span class=cl><span class=s>baseurl=file:///root/centos8/
</span></span></span><span class=line><span class=cl><span class=s>gpgcheck=0
</span></span></span><span class=line><span class=cl><span class=s>enabled=1
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 安装下载好的包</span>
</span></span><span class=line><span class=cl>yum clean all
</span></span><span class=line><span class=cl>yum makecache
</span></span><span class=line><span class=cl>yum install -y /root/centos8/*
</span></span></code></pre></div><h2 id=下载软件包必要>下载软件包(必要)<a hidden class=anchor aria-hidden=true href=#下载软件包必要>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1># 查看版本地址：</span>
</span></span><span class=line><span class=cl><span class=c1># </span>
</span></span><span class=line><span class=cl><span class=c1># https://github.com/containernetworking/plugins/releases/</span>
</span></span><span class=line><span class=cl><span class=c1># https://github.com/containerd/containerd/releases/</span>
</span></span><span class=line><span class=cl><span class=c1># https://github.com/kubernetes-sigs/cri-tools/releases/</span>
</span></span><span class=line><span class=cl><span class=c1># https://github.com/Mirantis/cri-dockerd/releases/</span>
</span></span><span class=line><span class=cl><span class=c1># https://github.com/etcd-io/etcd/releases/</span>
</span></span><span class=line><span class=cl><span class=c1># https://github.com/cloudflare/cfssl/releases/</span>
</span></span><span class=line><span class=cl><span class=c1># https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG</span>
</span></span><span class=line><span class=cl><span class=c1># https://download.docker.com/linux/static/stable/x86_64/</span>
</span></span><span class=line><span class=cl><span class=c1># https://github.com/opencontainers/runc/releases/</span>
</span></span><span class=line><span class=cl><span class=c1># https://mirrors.tuna.tsinghua.edu.cn/elrepo/kernel/el7/x86_64/RPMS/</span>
</span></span><span class=line><span class=cl><span class=c1># https://github.com/helm/helm/tags</span>
</span></span><span class=line><span class=cl><span class=c1># http://nginx.org/download/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Version numbers</span>
</span></span><span class=line><span class=cl><span class=nv>cni_plugins_version</span><span class=o>=</span><span class=s1>&#39;v1.3.0&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>cri_containerd_cni_version</span><span class=o>=</span><span class=s1>&#39;1.7.6&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>crictl_version</span><span class=o>=</span><span class=s1>&#39;v1.28.0&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>cri_dockerd_version</span><span class=o>=</span><span class=s1>&#39;0.3.4&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>etcd_version</span><span class=o>=</span><span class=s1>&#39;v3.5.9&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>cfssl_version</span><span class=o>=</span><span class=s1>&#39;1.6.4&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>kubernetes_server_version</span><span class=o>=</span><span class=s1>&#39;1.27.6&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>docker_version</span><span class=o>=</span><span class=s1>&#39;24.0.6&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>runc_version</span><span class=o>=</span><span class=s1>&#39;1.1.9&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>kernel_version</span><span class=o>=</span><span class=s1>&#39;5.4.256&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>helm_version</span><span class=o>=</span><span class=s1>&#39;3.12.3&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>nginx_version</span><span class=o>=</span><span class=s1>&#39;1.25.2&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># URLs </span>
</span></span><span class=line><span class=cl><span class=nv>base_url</span><span class=o>=</span><span class=s1>&#39;https://ghproxy.com/https://github.com&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>kernel_url</span><span class=o>=</span><span class=s2>&#34;http://mirrors.tuna.tsinghua.edu.cn/elrepo/kernel/el7/x86_64/RPMS/kernel-lt-</span><span class=si>${</span><span class=nv>kernel_version</span><span class=si>}</span><span class=s2>-1.el7.elrepo.x86_64.rpm&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>runc_url</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>base_url</span><span class=si>}</span><span class=s2>/opencontainers/runc/releases/download/v</span><span class=si>${</span><span class=nv>runc_version</span><span class=si>}</span><span class=s2>/runc.amd64&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>docker_url</span><span class=o>=</span><span class=s2>&#34;https://download.docker.com/linux/static/stable/x86_64/docker-</span><span class=si>${</span><span class=nv>docker_version</span><span class=si>}</span><span class=s2>.tgz&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>cni_plugins_url</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>base_url</span><span class=si>}</span><span class=s2>/containernetworking/plugins/releases/download/</span><span class=si>${</span><span class=nv>cni_plugins_version</span><span class=si>}</span><span class=s2>/cni-plugins-linux-amd64-</span><span class=si>${</span><span class=nv>cni_plugins_version</span><span class=si>}</span><span class=s2>.tgz&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>cri_containerd_cni_url</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>base_url</span><span class=si>}</span><span class=s2>/containerd/containerd/releases/download/v</span><span class=si>${</span><span class=nv>cri_containerd_cni_version</span><span class=si>}</span><span class=s2>/cri-containerd-cni-</span><span class=si>${</span><span class=nv>cri_containerd_cni_version</span><span class=si>}</span><span class=s2>-linux-amd64.tar.gz&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>crictl_url</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>base_url</span><span class=si>}</span><span class=s2>/kubernetes-sigs/cri-tools/releases/download/</span><span class=si>${</span><span class=nv>crictl_version</span><span class=si>}</span><span class=s2>/crictl-</span><span class=si>${</span><span class=nv>crictl_version</span><span class=si>}</span><span class=s2>-linux-amd64.tar.gz&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>cri_dockerd_url</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>base_url</span><span class=si>}</span><span class=s2>/Mirantis/cri-dockerd/releases/download/v</span><span class=si>${</span><span class=nv>cri_dockerd_version</span><span class=si>}</span><span class=s2>/cri-dockerd-</span><span class=si>${</span><span class=nv>cri_dockerd_version</span><span class=si>}</span><span class=s2>.amd64.tgz&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>etcd_url</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>base_url</span><span class=si>}</span><span class=s2>/etcd-io/etcd/releases/download/</span><span class=si>${</span><span class=nv>etcd_version</span><span class=si>}</span><span class=s2>/etcd-</span><span class=si>${</span><span class=nv>etcd_version</span><span class=si>}</span><span class=s2>-linux-amd64.tar.gz&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>cfssl_url</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>base_url</span><span class=si>}</span><span class=s2>/cloudflare/cfssl/releases/download/v</span><span class=si>${</span><span class=nv>cfssl_version</span><span class=si>}</span><span class=s2>/cfssl_</span><span class=si>${</span><span class=nv>cfssl_version</span><span class=si>}</span><span class=s2>_linux_amd64&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>cfssljson_url</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>base_url</span><span class=si>}</span><span class=s2>/cloudflare/cfssl/releases/download/v</span><span class=si>${</span><span class=nv>cfssl_version</span><span class=si>}</span><span class=s2>/cfssljson_</span><span class=si>${</span><span class=nv>cfssl_version</span><span class=si>}</span><span class=s2>_linux_amd64&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>helm_url</span><span class=o>=</span><span class=s2>&#34;https://files.m.daocloud.io/get.helm.sh/helm-v</span><span class=si>${</span><span class=nv>helm_version</span><span class=si>}</span><span class=s2>-linux-amd64.tar.gz&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>kubernetes_server_url</span><span class=o>=</span><span class=s2>&#34;https://dl.k8s.io/v</span><span class=si>${</span><span class=nv>kubernetes_server_version</span><span class=si>}</span><span class=s2>/kubernetes-server-linux-amd64.tar.gz&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>nginx_url</span><span class=o>=</span><span class=s2>&#34;http://nginx.org/download/nginx-</span><span class=si>${</span><span class=nv>nginx_version</span><span class=si>}</span><span class=s2>.tar.gz&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Download packages</span>
</span></span><span class=line><span class=cl><span class=nv>packages</span><span class=o>=(</span>
</span></span><span class=line><span class=cl>  <span class=c1>#$kernel_url</span>
</span></span><span class=line><span class=cl>  <span class=nv>$runc_url</span>
</span></span><span class=line><span class=cl>  <span class=nv>$docker_url</span>
</span></span><span class=line><span class=cl>  <span class=nv>$cni_plugins_url</span>
</span></span><span class=line><span class=cl>  <span class=nv>$cri_containerd_cni_url</span>
</span></span><span class=line><span class=cl>  <span class=nv>$crictl_url</span>
</span></span><span class=line><span class=cl>  <span class=nv>$cri_dockerd_url</span>
</span></span><span class=line><span class=cl>  <span class=nv>$etcd_url</span>
</span></span><span class=line><span class=cl>  <span class=nv>$cfssl_url</span>
</span></span><span class=line><span class=cl>  <span class=nv>$cfssljson_url</span>
</span></span><span class=line><span class=cl>  <span class=nv>$helm_url</span>
</span></span><span class=line><span class=cl>  <span class=nv>$kubernetes_server_url</span>
</span></span><span class=line><span class=cl>  <span class=nv>$nginx_url</span>
</span></span><span class=line><span class=cl><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> package_url in <span class=s2>&#34;</span><span class=si>${</span><span class=nv>packages</span><span class=p>[@]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=nv>filename</span><span class=o>=</span><span class=k>$(</span>basename <span class=s2>&#34;</span><span class=nv>$package_url</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> wget -cq --progress<span class=o>=</span>bar:force:noscroll -nc <span class=s2>&#34;</span><span class=nv>$package_url</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Downloaded </span><span class=nv>$filename</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Failed to download </span><span class=nv>$filename</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></div><h2 id=关闭防火墙>关闭防火墙<a hidden class=anchor aria-hidden=true href=#关闭防火墙>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl disable --now firewalld
</span></span></code></pre></div><h2 id=关闭selinux>关闭SELinux<a hidden class=anchor aria-hidden=true href=#关闭selinux>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>setenforce <span class=m>0</span>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s#SELINUX=enforcing#SELINUX=disabled#g&#39;</span> /etc/selinux/config
</span></span></code></pre></div><h2 id=关闭交换分区>关闭交换分区<a hidden class=anchor aria-hidden=true href=#关闭交换分区>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sed -ri <span class=s1>&#39;s/.*swap.*/#&amp;/&#39;</span> /etc/fstab
</span></span><span class=line><span class=cl>swapoff -a <span class=o>&amp;&amp;</span> sysctl -w vm.swappiness<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat /etc/fstab
</span></span><span class=line><span class=cl><span class=c1># /dev/mapper/centos-swap swap                    swap    defaults        0 0</span>
</span></span></code></pre></div><h2 id=网络配置>网络配置<a hidden class=anchor aria-hidden=true href=#网络配置>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># NetworkManager</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/NetworkManager/conf.d/calico.conf <span class=s>&lt;&lt; EOF 
</span></span></span><span class=line><span class=cl><span class=s>[keyfile]
</span></span></span><span class=line><span class=cl><span class=s>unmanaged-devices=interface-name:cali*;interface-name:tunl*
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>systemctl restart NetworkManager
</span></span></code></pre></div><h2 id=时间同步>时间同步<a hidden class=anchor aria-hidden=true href=#时间同步>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yum install chrony -y
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> --now chronyd
</span></span><span class=line><span class=cl>chronyc sources -v
</span></span></code></pre></div><h2 id=配置ulimit>配置ulimit<a hidden class=anchor aria-hidden=true href=#配置ulimit>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>ulimit</span> -SHn <span class=m>65535</span>
</span></span><span class=line><span class=cl>cat &gt;&gt; /etc/security/limits.conf <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>* soft nofile 655360
</span></span></span><span class=line><span class=cl><span class=s>* hard nofile 655360
</span></span></span><span class=line><span class=cl><span class=s>* soft nproc 655360
</span></span></span><span class=line><span class=cl><span class=s>* hard nproc 655360
</span></span></span><span class=line><span class=cl><span class=s>* soft memlock unlimited
</span></span></span><span class=line><span class=cl><span class=s>* hard memlock unlimitedd
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h2 id=配置免密登录>配置免密登录<a hidden class=anchor aria-hidden=true href=#配置免密登录>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yum install -y sshpass
</span></span><span class=line><span class=cl>ssh-keygen -f /root/.ssh/id_rsa -P <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>IP</span><span class=o>=</span><span class=s2>&#34;192.168.100.101 192.168.100.102 192.168.100.103 192.168.100.104 192.168.100.105&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>SSHPASS</span><span class=o>=</span><span class=m>12345678</span>
</span></span><span class=line><span class=cl><span class=k>for</span> HOST in <span class=nv>$IP</span><span class=p>;</span><span class=k>do</span>
</span></span><span class=line><span class=cl>     sshpass -e ssh-copy-id -o <span class=nv>StrictHostKeyChecking</span><span class=o>=</span>no <span class=nv>$HOST</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt; /root/.ssh/config <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>Host *
</span></span></span><span class=line><span class=cl><span class=s>  StrictHostKeyChecking no
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h2 id=添加elrepo源>添加elrepo源<a hidden class=anchor aria-hidden=true href=#添加elrepo源>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yum install -y elrepo-release
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s@mirrorlist@#mirrorlist@g&#34;</span> /etc/yum.repos.d/elrepo.repo 
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g&#34;</span> /etc/yum.repos.d/elrepo.repo 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看可用安装包</span>
</span></span><span class=line><span class=cl>yum --disablerepo<span class=o>=</span><span class=s2>&#34;*&#34;</span> --enablerepo<span class=o>=</span><span class=s2>&#34;elrepo-kernel&#34;</span> list available
</span></span></code></pre></div><h2 id=升级内核至418版本以上>升级内核至4.18版本以上<a hidden class=anchor aria-hidden=true href=#升级内核至418版本以上>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 稳定版kernel-ml   长期维护版kernel-lt</span>
</span></span><span class=line><span class=cl>yum -y --enablerepo<span class=o>=</span>elrepo-kernel install kernel-lt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看已安装那些内核</span>
</span></span><span class=line><span class=cl>rpm -qa <span class=p>|</span> grep kernel
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看默认内核</span>
</span></span><span class=line><span class=cl>grubby --default-kernel
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看所有内核版本</span>
</span></span><span class=line><span class=cl>grubby --info<span class=o>=</span>ALL
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 若不是最新的使用命令设置</span>
</span></span><span class=line><span class=cl>grubby --set-default /boot/vmlinuz-5.4.256-1.el8.elrepo.x86_64
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 重启生效</span>
</span></span><span class=line><span class=cl>init <span class=m>6</span>
</span></span><span class=line><span class=cl><span class=c1># 或</span>
</span></span><span class=line><span class=cl>systemctl --force reboot
</span></span></code></pre></div><h2 id=安装ipvsadm>安装ipvsadm<a hidden class=anchor aria-hidden=true href=#安装ipvsadm>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yum install -y ipvsadm ipset sysstat conntrack libseccomp
</span></span><span class=line><span class=cl>cat &gt;&gt; /etc/modules-load.d/ipvs.conf <span class=s>&lt;&lt;EOF 
</span></span></span><span class=line><span class=cl><span class=s>ip_vs
</span></span></span><span class=line><span class=cl><span class=s>ip_vs_rr
</span></span></span><span class=line><span class=cl><span class=s>ip_vs_wrr
</span></span></span><span class=line><span class=cl><span class=s>ip_vs_sh
</span></span></span><span class=line><span class=cl><span class=s>nf_conntrack
</span></span></span><span class=line><span class=cl><span class=s>ip_tables
</span></span></span><span class=line><span class=cl><span class=s>ip_set
</span></span></span><span class=line><span class=cl><span class=s>xt_set
</span></span></span><span class=line><span class=cl><span class=s>ipt_set
</span></span></span><span class=line><span class=cl><span class=s>ipt_rpfilter
</span></span></span><span class=line><span class=cl><span class=s>ipt_REJECT
</span></span></span><span class=line><span class=cl><span class=s>ipip
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>systemctl restart systemd-modules-load.service
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>lsmod <span class=p>|</span> grep -e ip_vs -e nf_conntrack
</span></span><span class=line><span class=cl>ip_vs_sh               <span class=m>16384</span>  <span class=m>0</span>
</span></span><span class=line><span class=cl>ip_vs_wrr              <span class=m>16384</span>  <span class=m>0</span>
</span></span><span class=line><span class=cl>ip_vs_rr               <span class=m>16384</span>  <span class=m>16</span>
</span></span><span class=line><span class=cl>ip_vs                 <span class=m>176128</span>  <span class=m>22</span> ip_vs_rr,ip_vs_sh,ip_vs_wrr
</span></span><span class=line><span class=cl>nf_conntrack          <span class=m>159744</span>  <span class=m>4</span> xt_conntrack,nf_nat,xt_MASQUERADE,ip_vs
</span></span><span class=line><span class=cl>nf_defrag_ipv6         <span class=m>24576</span>  <span class=m>2</span> nf_conntrack,ip_vs
</span></span><span class=line><span class=cl>nf_defrag_ipv4         <span class=m>16384</span>  <span class=m>1</span> nf_conntrack
</span></span><span class=line><span class=cl>libcrc32c              <span class=m>16384</span>  <span class=m>4</span> nf_conntrack,nf_nat,xfs,ip_vs
</span></span></code></pre></div><h2 id=修改内核参数>修改内核参数<a hidden class=anchor aria-hidden=true href=#修改内核参数>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.ip_forward = 1
</span></span></span><span class=line><span class=cl><span class=s>net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span class=line><span class=cl><span class=s>fs.may_detach_mounts = 1
</span></span></span><span class=line><span class=cl><span class=s>vm.overcommit_memory=1
</span></span></span><span class=line><span class=cl><span class=s>vm.panic_on_oom=0
</span></span></span><span class=line><span class=cl><span class=s>fs.inotify.max_user_watches=89100
</span></span></span><span class=line><span class=cl><span class=s>fs.file-max=52706963
</span></span></span><span class=line><span class=cl><span class=s>fs.nr_open=52706963
</span></span></span><span class=line><span class=cl><span class=s>net.netfilter.nf_conntrack_max=2310720
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_keepalive_time = 600
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_keepalive_probes = 3
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_keepalive_intvl =15
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_max_tw_buckets = 36000
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_tw_reuse = 1
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_max_orphans = 327680
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_orphan_retries = 3
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_syncookies = 1
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_max_syn_backlog = 16384
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.ip_conntrack_max = 65536
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_max_syn_backlog = 16384
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_timestamps = 0
</span></span></span><span class=line><span class=cl><span class=s>net.core.somaxconn = 16384
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>net.ipv6.conf.all.disable_ipv6 = 0
</span></span></span><span class=line><span class=cl><span class=s>net.ipv6.conf.default.disable_ipv6 = 0
</span></span></span><span class=line><span class=cl><span class=s>net.ipv6.conf.lo.disable_ipv6 = 0
</span></span></span><span class=line><span class=cl><span class=s>net.ipv6.conf.all.forwarding = 1
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sysctl --system
</span></span></code></pre></div><h2 id=所有节点配置hosts本地解析>所有节点配置hosts本地解析<a hidden class=anchor aria-hidden=true href=#所有节点配置hosts本地解析>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat /etc/hosts
</span></span><span class=line><span class=cl>192.168.100.100 k8s-vip
</span></span><span class=line><span class=cl>192.168.100.101 k8s-master01
</span></span><span class=line><span class=cl>192.168.100.102 k8s-master02
</span></span><span class=line><span class=cl>192.168.100.103 k8s-master03
</span></span><span class=line><span class=cl>192.168.100.104 k8s-node01
</span></span><span class=line><span class=cl>192.168.100.105 k8s-node02
</span></span></code></pre></div><h1 id=k8s基础组件安装>k8s基础组件安装<a hidden class=anchor aria-hidden=true href=#k8s基础组件安装>#</a></h1><blockquote><p>注意: docker 和 containerd 二选其一即可</p></blockquote><h2 id=安装containerd作为runtime方式一推荐>安装Containerd作为Runtime(方式一，推荐)<a hidden class=anchor aria-hidden=true href=#安装containerd作为runtime方式一推荐>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 参考链接</span>
</span></span><span class=line><span class=cl><span class=c1># https://github.com/containernetworking/plugins/releases/</span>
</span></span><span class=line><span class=cl><span class=c1># https://github.com/containernetworking/plugins/releases/download/v1.3.0/cni-plugins-linux-amd64-v1.3.0.tgz</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#创建cni插件所需目录</span>
</span></span><span class=line><span class=cl>mkdir -p /etc/cni/net.d /opt/cni/bin 
</span></span><span class=line><span class=cl><span class=c1>#解压cni二进制包</span>
</span></span><span class=line><span class=cl>tar xf cni-plugins-linux-amd64-v*.tgz -C /opt/cni/bin/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 参考链接</span>
</span></span><span class=line><span class=cl><span class=c1># https://github.com/containerd/containerd/releases/</span>
</span></span><span class=line><span class=cl><span class=c1># https://github.com/containerd/containerd/releases/download/v1.7.6/cri-containerd-cni-1.7.6-linux-amd64.tar.gz</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#解压containerd到根目录</span>
</span></span><span class=line><span class=cl>tar -xzf cri-containerd-cni-*-linux-amd64.tar.gz -C /
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#创建服务启动文件</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/systemd/system/containerd.service <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=containerd container runtime
</span></span></span><span class=line><span class=cl><span class=s>Documentation=https://containerd.io
</span></span></span><span class=line><span class=cl><span class=s>After=network.target local-fs.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>ExecStartPre=-/sbin/modprobe overlay
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/bin/containerd
</span></span></span><span class=line><span class=cl><span class=s>Type=notify
</span></span></span><span class=line><span class=cl><span class=s>Delegate=yes
</span></span></span><span class=line><span class=cl><span class=s>KillMode=process
</span></span></span><span class=line><span class=cl><span class=s>Restart=always
</span></span></span><span class=line><span class=cl><span class=s>RestartSec=5
</span></span></span><span class=line><span class=cl><span class=s>LimitNPROC=infinity
</span></span></span><span class=line><span class=cl><span class=s>LimitCORE=infinity
</span></span></span><span class=line><span class=cl><span class=s>LimitNOFILE=infinity
</span></span></span><span class=line><span class=cl><span class=s>TasksMax=infinity
</span></span></span><span class=line><span class=cl><span class=s>OOMScoreAdjust=-999
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h3 id=配置containerd所需的模块>配置Containerd所需的模块<a hidden class=anchor aria-hidden=true href=#配置containerd所需的模块>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf
</span></span></span><span class=line><span class=cl><span class=s>overlay
</span></span></span><span class=line><span class=cl><span class=s>br_netfilter
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载模块</span>
</span></span><span class=line><span class=cl>systemctl restart systemd-modules-load.service
</span></span></code></pre></div><h3 id=配置containerd所需的内核>配置Containerd所需的内核<a hidden class=anchor aria-hidden=true href=#配置containerd所需的内核>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
</span></span></span><span class=line><span class=cl><span class=s>net.bridge.bridge-nf-call-iptables  = 1
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.ip_forward                 = 1
</span></span></span><span class=line><span class=cl><span class=s>net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载内核</span>
</span></span><span class=line><span class=cl>sysctl --system
</span></span></code></pre></div><h3 id=创建containerd的配置文件>创建Containerd的配置文件<a hidden class=anchor aria-hidden=true href=#创建containerd的配置文件>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建默认配置文件</span>
</span></span><span class=line><span class=cl>mkdir -p /etc/containerd
</span></span><span class=line><span class=cl>containerd config default &gt; /etc/containerd/config.toml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启用systemd cgroup</span>
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s#SystemdCgroup\ \=\ false#SystemdCgroup\ \=\ true#g&#34;</span> /etc/containerd/config.toml
</span></span><span class=line><span class=cl>cat /etc/containerd/config.toml <span class=p>|</span> grep SystemdCgroup
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s#registry.k8s.io#m.daocloud.io/registry.k8s.io#g&#34;</span> /etc/containerd/config.toml
</span></span><span class=line><span class=cl>cat /etc/containerd/config.toml <span class=p>|</span> grep sandbox_image
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s#config_path\ \=\ \&#34;\&#34;#config_path\ \=\ \&#34;/etc/containerd/certs.d\&#34;#g&#34;</span> /etc/containerd/config.toml
</span></span><span class=line><span class=cl>cat /etc/containerd/config.toml <span class=p>|</span> grep certs.d
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>mkdir -pv /etc/containerd/certs.d/docker.io
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配置国内加速</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/containerd/certs.d/docker.io/hosts.toml <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>server = &#34;https://docker.io&#34;
</span></span></span><span class=line><span class=cl><span class=s>[host.&#34;https://hub-mirror.c.163.com&#34;]
</span></span></span><span class=line><span class=cl><span class=s>  capabilities = [&#34;pull&#34;, &#34;resolve&#34;]
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h3 id=启动并设置为开机启动>启动并设置为开机启动<a hidden class=anchor aria-hidden=true href=#启动并设置为开机启动>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> --now containerd
</span></span><span class=line><span class=cl>systemctl restart containerd
</span></span></code></pre></div><h3 id=配置crictl客户端连接的运行时位置>配置crictl客户端连接的运行时位置<a hidden class=anchor aria-hidden=true href=#配置crictl客户端连接的运行时位置>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.28.0/crictl-v1.28.0-linux-amd64.tar.gz</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#解压</span>
</span></span><span class=line><span class=cl>tar xf crictl-v*-linux-amd64.tar.gz -C /usr/bin/
</span></span><span class=line><span class=cl><span class=c1>#生成配置文件</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/crictl.yaml <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>runtime-endpoint: unix:///run/containerd/containerd.sock
</span></span></span><span class=line><span class=cl><span class=s>image-endpoint: unix:///run/containerd/containerd.sock
</span></span></span><span class=line><span class=cl><span class=s>timeout: 10
</span></span></span><span class=line><span class=cl><span class=s>debug: false
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#测试</span>
</span></span><span class=line><span class=cl>systemctl restart containerd
</span></span><span class=line><span class=cl>crictl info
</span></span></code></pre></div><h2 id=安装docker作为runtime方式二>安装docker作为Runtime(方式二)<a hidden class=anchor aria-hidden=true href=#安装docker作为runtime方式二>#</a></h2><h3 id=安装docker>安装docker<a hidden class=anchor aria-hidden=true href=#安装docker>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 二进制包下载地址：https://download.docker.com/linux/static/stable/x86_64/</span>
</span></span><span class=line><span class=cl><span class=c1># wget https://download.docker.com/linux/static/stable/x86_64/docker-24.0.6.tgz</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#解压</span>
</span></span><span class=line><span class=cl>tar xf docker-*.tgz 
</span></span><span class=line><span class=cl><span class=c1>#拷贝二进制文件</span>
</span></span><span class=line><span class=cl>cp docker/* /usr/bin/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#创建containerd的service文件</span>
</span></span><span class=line><span class=cl>cat &gt;/etc/systemd/system/containerd.service <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=containerd container runtime
</span></span></span><span class=line><span class=cl><span class=s>Documentation=https://containerd.io
</span></span></span><span class=line><span class=cl><span class=s>After=network.target local-fs.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>ExecStartPre=-/sbin/modprobe overlay
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/bin/containerd
</span></span></span><span class=line><span class=cl><span class=s>Type=notify
</span></span></span><span class=line><span class=cl><span class=s>Delegate=yes
</span></span></span><span class=line><span class=cl><span class=s>KillMode=process
</span></span></span><span class=line><span class=cl><span class=s>Restart=always
</span></span></span><span class=line><span class=cl><span class=s>RestartSec=5
</span></span></span><span class=line><span class=cl><span class=s>LimitNPROC=infinity
</span></span></span><span class=line><span class=cl><span class=s>LimitCORE=infinity
</span></span></span><span class=line><span class=cl><span class=s>LimitNOFILE=1048576
</span></span></span><span class=line><span class=cl><span class=s>TasksMax=infinity
</span></span></span><span class=line><span class=cl><span class=s>OOMScoreAdjust=-999
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置开机自启</span>
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> --now containerd.service
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#准备docker的service文件</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/systemd/system/docker.service <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=Docker Application Container Engine
</span></span></span><span class=line><span class=cl><span class=s>Documentation=https://docs.docker.com
</span></span></span><span class=line><span class=cl><span class=s>After=network-online.target firewalld.service containerd.service
</span></span></span><span class=line><span class=cl><span class=s>Wants=network-online.target
</span></span></span><span class=line><span class=cl><span class=s>Requires=docker.socket containerd.service
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>Type=notify
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
</span></span></span><span class=line><span class=cl><span class=s>ExecReload=/bin/kill -s HUP $MAINPID
</span></span></span><span class=line><span class=cl><span class=s>TimeoutSec=0
</span></span></span><span class=line><span class=cl><span class=s>RestartSec=2
</span></span></span><span class=line><span class=cl><span class=s>Restart=always
</span></span></span><span class=line><span class=cl><span class=s>StartLimitBurst=3
</span></span></span><span class=line><span class=cl><span class=s>StartLimitInterval=60s
</span></span></span><span class=line><span class=cl><span class=s>LimitNOFILE=infinity
</span></span></span><span class=line><span class=cl><span class=s>LimitNPROC=infinity
</span></span></span><span class=line><span class=cl><span class=s>LimitCORE=infinity
</span></span></span><span class=line><span class=cl><span class=s>TasksMax=infinity
</span></span></span><span class=line><span class=cl><span class=s>Delegate=yes
</span></span></span><span class=line><span class=cl><span class=s>KillMode=process
</span></span></span><span class=line><span class=cl><span class=s>OOMScoreAdjust=-500
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#准备docker的socket文件</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/systemd/system/docker.socket <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=Docker Socket for the API
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Socket]
</span></span></span><span class=line><span class=cl><span class=s>ListenStream=/var/run/docker.sock
</span></span></span><span class=line><span class=cl><span class=s>SocketMode=0660
</span></span></span><span class=line><span class=cl><span class=s>SocketUser=root
</span></span></span><span class=line><span class=cl><span class=s>SocketGroup=docker
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=sockets.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#创建docker组</span>
</span></span><span class=line><span class=cl>groupadd docker
</span></span><span class=line><span class=cl><span class=c1>#启动docker</span>
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> --now docker.socket
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> --now docker.service
</span></span><span class=line><span class=cl><span class=c1>#验证</span>
</span></span><span class=line><span class=cl>docker info
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配置国内加速器</span>
</span></span><span class=line><span class=cl>mkdir -pv /etc/docker/
</span></span><span class=line><span class=cl>cat &gt;/etc/docker/daemon.json <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span></span></span><span class=line><span class=cl><span class=s>  &#34;registry-mirrors&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>    &#34;https://docker.m.daocloud.io&#34;,
</span></span></span><span class=line><span class=cl><span class=s>    &#34;https://docker.mirrors.ustc.edu.cn&#34;,
</span></span></span><span class=line><span class=cl><span class=s>    &#34;http://hub-mirror.c.163.com&#34;
</span></span></span><span class=line><span class=cl><span class=s>  ],
</span></span></span><span class=line><span class=cl><span class=s>  &#34;max-concurrent-downloads&#34;: 10,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;log-driver&#34;: &#34;json-file&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;log-level&#34;: &#34;warn&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;log-opts&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>    &#34;max-size&#34;: &#34;10m&#34;,
</span></span></span><span class=line><span class=cl><span class=s>    &#34;max-file&#34;: &#34;3&#34;
</span></span></span><span class=line><span class=cl><span class=s>    },
</span></span></span><span class=line><span class=cl><span class=s>  &#34;data-root&#34;: &#34;/var/lib/docker&#34;
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>systemctl daemon-reload 
</span></span><span class=line><span class=cl>systemctl stop docker
</span></span><span class=line><span class=cl>systemctl restart docker
</span></span></code></pre></div><h3 id=安装cri-docker>安装cri-docker<a hidden class=anchor aria-hidden=true href=#安装cri-docker>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 由于1.24以及更高版本不支持docker所以安装cri-docker</span>
</span></span><span class=line><span class=cl><span class=c1># 下载cri-docker </span>
</span></span><span class=line><span class=cl><span class=c1># wget  https://ghproxy.com/https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.4/cri-dockerd-0.3.4.amd64.tgz</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 解压cri-docker</span>
</span></span><span class=line><span class=cl>tar xvf cri-dockerd-*.amd64.tgz 
</span></span><span class=line><span class=cl>cp -r cri-dockerd/  /usr/bin/
</span></span><span class=line><span class=cl>chmod +x /usr/bin/cri-dockerd/cri-dockerd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 写入启动配置文件</span>
</span></span><span class=line><span class=cl>cat &gt;  /usr/lib/systemd/system/cri-docker.service <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=CRI Interface for Docker Application Container Engine
</span></span></span><span class=line><span class=cl><span class=s>Documentation=https://docs.mirantis.com
</span></span></span><span class=line><span class=cl><span class=s>After=network-online.target firewalld.service docker.service
</span></span></span><span class=line><span class=cl><span class=s>Wants=network-online.target
</span></span></span><span class=line><span class=cl><span class=s>Requires=cri-docker.socket
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>Type=notify
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/bin/cri-dockerd/cri-dockerd --network-plugin=cni --pod-infra-container-image=m.daocloud.io/registry.k8s.io/pause:3.8
</span></span></span><span class=line><span class=cl><span class=s>ExecReload=/bin/kill -s HUP $MAINPID
</span></span></span><span class=line><span class=cl><span class=s>TimeoutSec=0
</span></span></span><span class=line><span class=cl><span class=s>RestartSec=2
</span></span></span><span class=line><span class=cl><span class=s>Restart=always
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>StartLimitBurst=3
</span></span></span><span class=line><span class=cl><span class=s>StartLimitInterval=60s
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>LimitNOFILE=infinity
</span></span></span><span class=line><span class=cl><span class=s>LimitNPROC=infinity
</span></span></span><span class=line><span class=cl><span class=s>LimitCORE=infinity
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>TasksMax=infinity
</span></span></span><span class=line><span class=cl><span class=s>Delegate=yes
</span></span></span><span class=line><span class=cl><span class=s>KillMode=process
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 写入socket配置文件</span>
</span></span><span class=line><span class=cl>cat &gt; /usr/lib/systemd/system/cri-docker.socket <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=CRI Docker Socket for the API
</span></span></span><span class=line><span class=cl><span class=s>PartOf=cri-docker.service
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Socket]
</span></span></span><span class=line><span class=cl><span class=s>ListenStream=%t/cri-dockerd.sock
</span></span></span><span class=line><span class=cl><span class=s>SocketMode=0660
</span></span></span><span class=line><span class=cl><span class=s>SocketUser=root
</span></span></span><span class=line><span class=cl><span class=s>SocketGroup=docker
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=sockets.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进行启动cri-docker</span>
</span></span><span class=line><span class=cl>systemctl daemon-reload 
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> --now cri-docker
</span></span><span class=line><span class=cl>systemctl restart cri-docker
</span></span><span class=line><span class=cl>systemctl status cri-docker
</span></span></code></pre></div><h2 id=k8s与etcd安装仅在master01操作>k8s与etcd安装(仅在master01操作)<a hidden class=anchor aria-hidden=true href=#k8s与etcd安装仅在master01操作>#</a></h2><h3 id=解压k8s安装包>解压k8s安装包<a hidden class=anchor aria-hidden=true href=#解压k8s安装包>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 下载安装包</span>
</span></span><span class=line><span class=cl><span class=c1># wget https://dl.k8s.io/v1.27.6/kubernetes-server-linux-amd64.tar.gz</span>
</span></span><span class=line><span class=cl><span class=c1># wget https://github.com/etcd-io/etcd/releases/download/v3.5.9/etcd-v3.5.9-linux-amd64.tar.gz</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 解压k8s安装文件</span>
</span></span><span class=line><span class=cl>tar -xf kubernetes-server-linux-amd64.tar.gz  --strip-components<span class=o>=</span><span class=m>3</span> -C /usr/local/bin kubernetes/server/bin/kube<span class=o>{</span>let,ctl,-apiserver,-controller-manager,-scheduler,-proxy<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 解压etcd安装文件</span>
</span></span><span class=line><span class=cl>tar -xf etcd*.tar.gz <span class=o>&amp;&amp;</span> mv etcd-*/etcd /usr/local/bin/ <span class=o>&amp;&amp;</span> mv etcd-*/etcdctl /usr/local/bin/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看/usr/local/bin下内容</span>
</span></span><span class=line><span class=cl>ls /usr/local/bin/
</span></span><span class=line><span class=cl>containerd               crictl       etcdctl                  kube-proxy
</span></span><span class=line><span class=cl>containerd-shim          critest      kube-apiserver           kube-scheduler
</span></span><span class=line><span class=cl>containerd-shim-runc-v1  ctd-decoder  kube-controller-manager
</span></span><span class=line><span class=cl>containerd-shim-runc-v2  ctr          kubectl
</span></span><span class=line><span class=cl>containerd-stress        etcd         kubelet
</span></span></code></pre></div><h3 id=查看版本>查看版本<a hidden class=anchor aria-hidden=true href=#查看版本>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># kubelet --version</span>
</span></span><span class=line><span class=cl>Kubernetes v1.27.6
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># etcdctl version</span>
</span></span><span class=line><span class=cl>etcdctl version: 3.5.9
</span></span><span class=line><span class=cl>API version: 3.5
</span></span></code></pre></div><h3 id=将组件复制到其他k8s节点>将组件复制到其他k8s节点<a hidden class=anchor aria-hidden=true href=#将组件复制到其他k8s节点>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>Master</span><span class=o>=</span><span class=s1>&#39;k8s-master02 k8s-master03&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>Work</span><span class=o>=</span><span class=s1>&#39;k8s-node01 k8s-node02&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 拷贝master组件</span>
</span></span><span class=line><span class=cl><span class=k>for</span> NODE in <span class=nv>$Master</span><span class=p>;</span> <span class=k>do</span> <span class=nb>echo</span> <span class=nv>$NODE</span><span class=p>;</span> scp /usr/local/bin/kube<span class=o>{</span>let,ctl,-apiserver,-controller-manager,-scheduler,-proxy<span class=o>}</span> <span class=nv>$NODE</span>:/usr/local/bin/<span class=p>;</span> scp /usr/local/bin/etcd* <span class=nv>$NODE</span>:/usr/local/bin/<span class=p>;</span> <span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 拷贝work组件</span>
</span></span><span class=line><span class=cl><span class=k>for</span> NODE in <span class=nv>$Work</span><span class=p>;</span> <span class=k>do</span>     scp /usr/local/bin/kube<span class=o>{</span>let,-proxy<span class=o>}</span> <span class=nv>$NODE</span>:/usr/local/bin/ <span class=p>;</span> <span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 所有节点执行</span>
</span></span><span class=line><span class=cl>mkdir -pv /opt/cni/bin
</span></span></code></pre></div><h2 id=相关证书生成>相关证书生成<a hidden class=anchor aria-hidden=true href=#相关证书生成>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># master01节点下载证书生成工具</span>
</span></span><span class=line><span class=cl><span class=c1># wget &#34;https://ghproxy.com/https://github.com/cloudflare/cfssl/releases/download/v1.6.4/cfssl_1.6.4_linux_amd64&#34; -O /usr/local/bin/cfssl</span>
</span></span><span class=line><span class=cl><span class=c1># wget &#34;https://ghproxy.com/https://github.com/cloudflare/cfssl/releases/download/v1.6.4/cfssljson_1.6.4_linux_amd64&#34; -O /usr/local/bin/cfssljson</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 软件包内有</span>
</span></span><span class=line><span class=cl>cp cfssl_*_linux_amd64 /usr/local/bin/cfssl
</span></span><span class=line><span class=cl>cp cfssljson_*_linux_amd64 /usr/local/bin/cfssljson
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加执行权限</span>
</span></span><span class=line><span class=cl>chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson
</span></span></code></pre></div><h3 id=生成etcd证书>生成etcd证书<a hidden class=anchor aria-hidden=true href=#生成etcd证书>#</a></h3><h4 id=所有master节点创建证书存放目录>所有master节点创建证书存放目录<a hidden class=anchor aria-hidden=true href=#所有master节点创建证书存放目录>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -pv /etc/etcd/ssl
</span></span></code></pre></div><h4 id=在master01节点生成etcd证书>在master01节点生成etcd证书<a hidden class=anchor aria-hidden=true href=#在master01节点生成etcd证书>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir pki <span class=o>&amp;&amp;</span> <span class=nb>cd</span> pki
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt; etcd-ca-csr.json <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;CN&#34;: &#34;etcd&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;key&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>    &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span class=line><span class=cl><span class=s>    &#34;size&#34;: 2048
</span></span></span><span class=line><span class=cl><span class=s>  },
</span></span></span><span class=line><span class=cl><span class=s>  &#34;names&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>    {
</span></span></span><span class=line><span class=cl><span class=s>      &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;ST&#34;: &#34;Beijing&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;L&#34;: &#34;Beijing&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;O&#34;: &#34;etcd&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;OU&#34;: &#34;Etcd Security&#34;
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>  ],
</span></span></span><span class=line><span class=cl><span class=s>  &#34;ca&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>    &#34;expiry&#34;: &#34;876000h&#34;
</span></span></span><span class=line><span class=cl><span class=s>  }
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt; etcd-csr.json <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;CN&#34;: &#34;etcd&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;key&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>    &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span class=line><span class=cl><span class=s>    &#34;size&#34;: 2048
</span></span></span><span class=line><span class=cl><span class=s>  },
</span></span></span><span class=line><span class=cl><span class=s>  &#34;names&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>    {
</span></span></span><span class=line><span class=cl><span class=s>      &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;ST&#34;: &#34;Beijing&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;L&#34;: &#34;Beijing&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;O&#34;: &#34;etcd&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;OU&#34;: &#34;Etcd Security&#34;
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>  ]
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt; ca-config.json <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;signing&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>    &#34;default&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>      &#34;expiry&#34;: &#34;876000h&#34;
</span></span></span><span class=line><span class=cl><span class=s>    },
</span></span></span><span class=line><span class=cl><span class=s>    &#34;profiles&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>      &#34;kubernetes&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>        &#34;usages&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>            &#34;signing&#34;,
</span></span></span><span class=line><span class=cl><span class=s>            &#34;key encipherment&#34;,
</span></span></span><span class=line><span class=cl><span class=s>            &#34;server auth&#34;,
</span></span></span><span class=line><span class=cl><span class=s>            &#34;client auth&#34;
</span></span></span><span class=line><span class=cl><span class=s>        ],
</span></span></span><span class=line><span class=cl><span class=s>        &#34;expiry&#34;: &#34;876000h&#34;
</span></span></span><span class=line><span class=cl><span class=s>      }
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>  }
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 生成etcd证书和etcd证书的key（如果你觉得以后可能会扩容，可以在ip那多写几个预留出来）</span>
</span></span><span class=line><span class=cl><span class=c1># 如果没有IPv6 可删除可保留</span>
</span></span><span class=line><span class=cl>cfssl gencert -initca etcd-ca-csr.json <span class=p>|</span> cfssljson -bare /etc/etcd/ssl/etcd-ca
</span></span><span class=line><span class=cl>cfssl gencert <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -ca<span class=o>=</span>/etc/etcd/ssl/etcd-ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -ca-key<span class=o>=</span>/etc/etcd/ssl/etcd-ca-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -config<span class=o>=</span>ca-config.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -hostname<span class=o>=</span>127.0.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.100.101,192.168.100.102,192.168.100.103,fc00:43f4:1eea:1::10,fc00:43f4:1eea:1::20,fc00:43f4:1eea:1::30,::1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -profile<span class=o>=</span>kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   etcd-csr.json <span class=p>|</span> cfssljson -bare /etc/etcd/ssl/etcd
</span></span></code></pre></div><h4 id=将证书复制到其他节点>将证书复制到其他节点<a hidden class=anchor aria-hidden=true href=#将证书复制到其他节点>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>Master</span><span class=o>=</span><span class=s1>&#39;k8s-master02 k8s-master03&#39;</span>
</span></span><span class=line><span class=cl><span class=k>for</span> NODE in <span class=nv>$Master</span><span class=p>;</span> <span class=k>do</span> ssh <span class=nv>$NODE</span> <span class=s2>&#34;mkdir -p /etc/etcd/ssl&#34;</span><span class=p>;</span> <span class=k>for</span> FILE in etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem<span class=p>;</span> <span class=k>do</span> scp /etc/etcd/ssl/<span class=si>${</span><span class=nv>FILE</span><span class=si>}</span> <span class=nv>$NODE</span>:/etc/etcd/ssl/<span class=si>${</span><span class=nv>FILE</span><span class=si>}</span><span class=p>;</span> <span class=k>done</span><span class=p>;</span> <span class=k>done</span>
</span></span></code></pre></div><h3 id=生成k8s相关证书>生成k8s相关证书<a hidden class=anchor aria-hidden=true href=#生成k8s相关证书>#</a></h3><h4 id=所有k8s节点创建证书存放目录>所有k8s节点创建证书存放目录<a hidden class=anchor aria-hidden=true href=#所有k8s节点创建证书存放目录>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -pv /etc/kubernetes/pki
</span></span></code></pre></div><h4 id=master01节点生成k8s证书>master01节点生成k8s证书<a hidden class=anchor aria-hidden=true href=#master01节点生成k8s证书>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; ca-csr.json <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;CN&#34;: &#34;kubernetes&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;key&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>    &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span class=line><span class=cl><span class=s>    &#34;size&#34;: 2048
</span></span></span><span class=line><span class=cl><span class=s>  },
</span></span></span><span class=line><span class=cl><span class=s>  &#34;names&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>    {
</span></span></span><span class=line><span class=cl><span class=s>      &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;ST&#34;: &#34;Beijing&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;L&#34;: &#34;Beijing&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;O&#34;: &#34;Kubernetes&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;OU&#34;: &#34;Kubernetes-manual&#34;
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>  ],
</span></span></span><span class=line><span class=cl><span class=s>  &#34;ca&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>    &#34;expiry&#34;: &#34;876000h&#34;
</span></span></span><span class=line><span class=cl><span class=s>  }
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt; ca-config.json <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;signing&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>    &#34;default&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>      &#34;expiry&#34;: &#34;876000h&#34;
</span></span></span><span class=line><span class=cl><span class=s>    },
</span></span></span><span class=line><span class=cl><span class=s>    &#34;profiles&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>      &#34;kubernetes&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>        &#34;usages&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>            &#34;signing&#34;,
</span></span></span><span class=line><span class=cl><span class=s>            &#34;key encipherment&#34;,
</span></span></span><span class=line><span class=cl><span class=s>            &#34;server auth&#34;,
</span></span></span><span class=line><span class=cl><span class=s>            &#34;client auth&#34;
</span></span></span><span class=line><span class=cl><span class=s>        ],
</span></span></span><span class=line><span class=cl><span class=s>        &#34;expiry&#34;: &#34;876000h&#34;
</span></span></span><span class=line><span class=cl><span class=s>      }
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>  }
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt; apiserver-csr.json <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;CN&#34;: &#34;kube-apiserver&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;key&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>    &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span class=line><span class=cl><span class=s>    &#34;size&#34;: 2048
</span></span></span><span class=line><span class=cl><span class=s>  },
</span></span></span><span class=line><span class=cl><span class=s>  &#34;names&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>    {
</span></span></span><span class=line><span class=cl><span class=s>      &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;ST&#34;: &#34;Beijing&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;L&#34;: &#34;Beijing&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;O&#34;: &#34;Kubernetes&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;OU&#34;: &#34;Kubernetes-manual&#34;
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>  ]
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cfssl gencert -initca ca-csr.json <span class=p>|</span> cfssljson -bare /etc/kubernetes/pki/ca
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 生成一个k8s根证书 ，可以多写一些IP作为预留IP，为将来添加node做准备</span>
</span></span><span class=line><span class=cl><span class=c1># 10.96.0.1是service网段的第一个地址，需要计算，192.168.100.100为高可用vip地址</span>
</span></span><span class=line><span class=cl><span class=c1># 如果没有IPv6 可删除可保留</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cfssl gencert   <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-ca<span class=o>=</span>/etc/kubernetes/pki/ca.pem   <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-ca-key<span class=o>=</span>/etc/kubernetes/pki/ca-key.pem   <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-config<span class=o>=</span>ca-config.json   <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-hostname<span class=o>=</span>10.96.0.1,192.168.100.100,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,192.168.100.101,192.168.100.102,192.168.100.103,192.168.100.104,192.168.100.105,192.168.100.106,192.168.100.107,192.168.100.108,192.168.100.109,192.168.100.110,fc00:43f4:1eea:1::10,fc00:43f4:1eea:1::20,fc00:43f4:1eea:1::30,fc00:43f4:1eea:1::40,fc00:43f4:1eea:1::50,fc00:43f4:1eea:1::60,fc00:43f4:1eea:1::70,fc00:43f4:1eea:1::80,fc00:43f4:1eea:1::90,fc00:43f4:1eea:1::100,::1   <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-profile<span class=o>=</span>kubernetes   apiserver-csr.json <span class=p>|</span> cfssljson -bare /etc/kubernetes/pki/apiserver
</span></span></code></pre></div><h4 id=生成apiserver聚合证书>生成apiserver聚合证书<a hidden class=anchor aria-hidden=true href=#生成apiserver聚合证书>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; front-proxy-ca-csr.json <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;CN&#34;: &#34;kubernetes&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;key&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>     &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span class=line><span class=cl><span class=s>     &#34;size&#34;: 2048
</span></span></span><span class=line><span class=cl><span class=s>  },
</span></span></span><span class=line><span class=cl><span class=s>  &#34;ca&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>    &#34;expiry&#34;: &#34;876000h&#34;
</span></span></span><span class=line><span class=cl><span class=s>  }
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt; front-proxy-client-csr.json <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;CN&#34;: &#34;front-proxy-client&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;key&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>     &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span class=line><span class=cl><span class=s>     &#34;size&#34;: 2048
</span></span></span><span class=line><span class=cl><span class=s>  }
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cfssl gencert   -initca front-proxy-ca-csr.json <span class=p>|</span> cfssljson -bare /etc/kubernetes/pki/front-proxy-ca 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 有一个警告，可以忽略</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cfssl gencert  <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-ca<span class=o>=</span>/etc/kubernetes/pki/front-proxy-ca.pem   <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-ca-key<span class=o>=</span>/etc/kubernetes/pki/front-proxy-ca-key.pem   <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-config<span class=o>=</span>ca-config.json   <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-profile<span class=o>=</span>kubernetes   front-proxy-client-csr.json <span class=p>|</span> cfssljson -bare /etc/kubernetes/pki/front-proxy-client
</span></span></code></pre></div><h4 id=生成controller-manage的证书>生成controller-manage的证书<a hidden class=anchor aria-hidden=true href=#生成controller-manage的证书>#</a></h4><ul><li>在<strong>高可用配置</strong>部分选择使用哪种高可用方案</li><li>若使用 haproxy、keepalived 那么为 <code>--server=https://192.168.100.100:9443</code></li><li>若使用 nginx方案，那么为 <code>--server=https://127.0.0.1:8443</code></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; manager-csr.json <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;CN&#34;: &#34;system:kube-controller-manager&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;key&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>    &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span class=line><span class=cl><span class=s>    &#34;size&#34;: 2048
</span></span></span><span class=line><span class=cl><span class=s>  },
</span></span></span><span class=line><span class=cl><span class=s>  &#34;names&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>    {
</span></span></span><span class=line><span class=cl><span class=s>      &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;ST&#34;: &#34;Beijing&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;L&#34;: &#34;Beijing&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;O&#34;: &#34;system:kube-controller-manager&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;OU&#34;: &#34;Kubernetes-manual&#34;
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>  ]
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cfssl gencert <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -ca<span class=o>=</span>/etc/kubernetes/pki/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -ca-key<span class=o>=</span>/etc/kubernetes/pki/ca-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -config<span class=o>=</span>ca-config.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -profile<span class=o>=</span>kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   manager-csr.json <span class=p>|</span> cfssljson -bare /etc/kubernetes/pki/controller-manager
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置一个集群项</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl config set-cluster kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     --certificate-authority<span class=o>=</span>/etc/kubernetes/pki/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     --server<span class=o>=</span>https://192.168.100.100:9443 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     --kubeconfig<span class=o>=</span>/etc/kubernetes/controller-manager.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置一个环境项，一个上下文</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl config set-context system:kube-controller-manager@kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --cluster<span class=o>=</span>kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --user<span class=o>=</span>system:kube-controller-manager <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --kubeconfig<span class=o>=</span>/etc/kubernetes/controller-manager.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置一个用户项</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl config set-credentials system:kube-controller-manager <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     --client-certificate<span class=o>=</span>/etc/kubernetes/pki/controller-manager.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     --client-key<span class=o>=</span>/etc/kubernetes/pki/controller-manager-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     --kubeconfig<span class=o>=</span>/etc/kubernetes/controller-manager.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置默认环境</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl config use-context system:kube-controller-manager@kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     --kubeconfig<span class=o>=</span>/etc/kubernetes/controller-manager.kubeconfig
</span></span></code></pre></div><ul><li>在<strong>高可用配置</strong>部分选择使用哪种高可用方案</li><li>若使用 haproxy、keepalived 那么为 <code>--server=https://192.168.100.100:9443</code></li><li>若使用 nginx方案，那么为 <code>--server=https://127.0.0.1:8443</code></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; scheduler-csr.json <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;CN&#34;: &#34;system:kube-scheduler&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;key&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>    &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span class=line><span class=cl><span class=s>    &#34;size&#34;: 2048
</span></span></span><span class=line><span class=cl><span class=s>  },
</span></span></span><span class=line><span class=cl><span class=s>  &#34;names&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>    {
</span></span></span><span class=line><span class=cl><span class=s>      &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;ST&#34;: &#34;Beijing&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;L&#34;: &#34;Beijing&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;O&#34;: &#34;system:kube-scheduler&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;OU&#34;: &#34;Kubernetes-manual&#34;
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>  ]
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cfssl gencert <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -ca<span class=o>=</span>/etc/kubernetes/pki/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -ca-key<span class=o>=</span>/etc/kubernetes/pki/ca-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -config<span class=o>=</span>ca-config.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -profile<span class=o>=</span>kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   scheduler-csr.json <span class=p>|</span> cfssljson -bare /etc/kubernetes/pki/scheduler
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl config set-cluster kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     --certificate-authority<span class=o>=</span>/etc/kubernetes/pki/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     --server<span class=o>=</span>https://192.168.100.100:9443 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     --kubeconfig<span class=o>=</span>/etc/kubernetes/scheduler.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl config set-credentials system:kube-scheduler <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     --client-certificate<span class=o>=</span>/etc/kubernetes/pki/scheduler.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     --client-key<span class=o>=</span>/etc/kubernetes/pki/scheduler-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     --kubeconfig<span class=o>=</span>/etc/kubernetes/scheduler.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl config set-context system:kube-scheduler@kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     --cluster<span class=o>=</span>kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     --user<span class=o>=</span>system:kube-scheduler <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     --kubeconfig<span class=o>=</span>/etc/kubernetes/scheduler.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl config use-context system:kube-scheduler@kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     --kubeconfig<span class=o>=</span>/etc/kubernetes/scheduler.kubeconfig
</span></span></code></pre></div><ul><li>在<strong>高可用配置</strong>部分选择使用哪种高可用方案</li><li>若使用 haproxy、keepalived 那么为 <code>--server=https://192.168.100.100:9443</code></li><li>若使用 nginx方案，那么为 <code>--server=https://127.0.0.1:8443</code></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; admin-csr.json <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;CN&#34;: &#34;admin&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;key&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>    &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span class=line><span class=cl><span class=s>    &#34;size&#34;: 2048
</span></span></span><span class=line><span class=cl><span class=s>  },
</span></span></span><span class=line><span class=cl><span class=s>  &#34;names&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>    {
</span></span></span><span class=line><span class=cl><span class=s>      &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;ST&#34;: &#34;Beijing&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;L&#34;: &#34;Beijing&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;O&#34;: &#34;system:masters&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;OU&#34;: &#34;Kubernetes-manual&#34;
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>  ]
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cfssl gencert <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -ca<span class=o>=</span>/etc/kubernetes/pki/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -ca-key<span class=o>=</span>/etc/kubernetes/pki/ca-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -config<span class=o>=</span>ca-config.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -profile<span class=o>=</span>kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   admin-csr.json <span class=p>|</span> cfssljson -bare /etc/kubernetes/pki/admin
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl config set-cluster kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --certificate-authority<span class=o>=</span>/etc/kubernetes/pki/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --server<span class=o>=</span>https://192.168.100.100:9443 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/admin.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl config set-credentials kubernetes-admin <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --client-certificate<span class=o>=</span>/etc/kubernetes/pki/admin.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --client-key<span class=o>=</span>/etc/kubernetes/pki/admin-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/admin.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl config set-context kubernetes-admin@kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cluster<span class=o>=</span>kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --user<span class=o>=</span>kubernetes-admin <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/admin.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl config use-context kubernetes-admin@kubernetes  --kubeconfig<span class=o>=</span>/etc/kubernetes/admin.kubeconfig
</span></span></code></pre></div><h4 id=生成kube-proxy证书>生成kube-proxy证书<a hidden class=anchor aria-hidden=true href=#生成kube-proxy证书>#</a></h4><ul><li>在<strong>高可用配置</strong>部分选择使用哪种高可用方案</li><li>若使用 haproxy、keepalived 那么为 <code>--server=https://192.168.100.100:9443</code></li><li>若使用 nginx方案，那么为 <code>--server=https://127.0.0.1:8443</code></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; kube-proxy-csr.json <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;CN&#34;: &#34;system:kube-proxy&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;key&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>    &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span class=line><span class=cl><span class=s>    &#34;size&#34;: 2048
</span></span></span><span class=line><span class=cl><span class=s>  },
</span></span></span><span class=line><span class=cl><span class=s>  &#34;names&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>    {
</span></span></span><span class=line><span class=cl><span class=s>      &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;ST&#34;: &#34;Beijing&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;L&#34;: &#34;Beijing&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;O&#34;: &#34;system:kube-proxy&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;OU&#34;: &#34;Kubernetes-manual&#34;
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>  ]
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cfssl gencert <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -ca<span class=o>=</span>/etc/kubernetes/pki/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -ca-key<span class=o>=</span>/etc/kubernetes/pki/ca-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -config<span class=o>=</span>ca-config.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -profile<span class=o>=</span>kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   kube-proxy-csr.json <span class=p>|</span> cfssljson -bare /etc/kubernetes/pki/kube-proxy
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl config set-cluster kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --certificate-authority<span class=o>=</span>/etc/kubernetes/pki/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --server<span class=o>=</span>https://192.168.100.100:9443 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/kube-proxy.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl config set-credentials kube-proxy <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --client-certificate<span class=o>=</span>/etc/kubernetes/pki/kube-proxy.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --client-key<span class=o>=</span>/etc/kubernetes/pki/kube-proxy-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/kube-proxy.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl config set-context kube-proxy@kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cluster<span class=o>=</span>kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --user<span class=o>=</span>kube-proxy <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/kube-proxy.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl config use-context kube-proxy@kubernetes  --kubeconfig<span class=o>=</span>/etc/kubernetes/kube-proxy.kubeconfig
</span></span></code></pre></div><h4 id=生成serviceaccount-key-secret>生成ServiceAccount Key ——secret<a hidden class=anchor aria-hidden=true href=#生成serviceaccount-key-secret>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>openssl genrsa -out /etc/kubernetes/pki/sa.key <span class=m>2048</span>
</span></span><span class=line><span class=cl>openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub
</span></span></code></pre></div><h4 id=将证书发送到其他master节点>将证书发送到其他master节点<a hidden class=anchor aria-hidden=true href=#将证书发送到其他master节点>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 其他节点创建目录</span>
</span></span><span class=line><span class=cl><span class=c1># mkdir -pv /etc/kubernetes/pki/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> NODE in k8s-master02 k8s-master03<span class=p>;</span> <span class=k>do</span>  <span class=k>for</span> FILE in <span class=k>$(</span>ls /etc/kubernetes/pki <span class=p>|</span> grep -v etcd<span class=k>)</span><span class=p>;</span> <span class=k>do</span>  scp /etc/kubernetes/pki/<span class=si>${</span><span class=nv>FILE</span><span class=si>}</span> <span class=nv>$NODE</span>:/etc/kubernetes/pki/<span class=si>${</span><span class=nv>FILE</span><span class=si>}</span><span class=p>;</span> <span class=k>done</span><span class=p>;</span>  <span class=k>for</span> FILE in admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig<span class=p>;</span> <span class=k>do</span>  scp /etc/kubernetes/<span class=si>${</span><span class=nv>FILE</span><span class=si>}</span> <span class=nv>$NODE</span>:/etc/kubernetes/<span class=si>${</span><span class=nv>FILE</span><span class=si>}</span><span class=p>;</span> <span class=k>done</span><span class=p>;</span> <span class=k>done</span>
</span></span></code></pre></div><h4 id=查看证书>查看证书<a hidden class=anchor aria-hidden=true href=#查看证书>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ls /etc/kubernetes/pki/</span>
</span></span><span class=line><span class=cl>admin.csr          apiserver.pem           controller-manager-key.pem  front-proxy-ca.pem          kube-proxy-key.pem  scheduler-key.pem
</span></span><span class=line><span class=cl>admin-key.pem      ca.csr                  controller-manager.pem      front-proxy-client.csr      kube-proxy.pem      scheduler.pem
</span></span><span class=line><span class=cl>admin.pem          ca-key.pem              front-proxy-client-key.pem  sa.key
</span></span><span class=line><span class=cl>apiserver.csr      ca.pem                  front-proxy-ca.csr          front-proxy-client.pem      sa.pub
</span></span><span class=line><span class=cl>apiserver-key.pem  controller-manager.csr  front-proxy-ca-key.pem      kube-proxy.csr              scheduler.csr
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 共26个</span>
</span></span><span class=line><span class=cl><span class=c1># ls /etc/kubernetes/pki/ |wc -l</span>
</span></span><span class=line><span class=cl><span class=m>26</span>
</span></span></code></pre></div><h1 id=k8s系统组件etcd配置>k8s系统组件etcd配置<a hidden class=anchor aria-hidden=true href=#k8s系统组件etcd配置>#</a></h1><h2 id=etcd配置>etcd配置<a hidden class=anchor aria-hidden=true href=#etcd配置>#</a></h2><h3 id=master01配置>master01配置<a hidden class=anchor aria-hidden=true href=#master01配置>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 如果要用IPv6那么把IPv4地址修改为IPv6即可</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/etcd/etcd.config.yml <span class=s>&lt;&lt; EOF 
</span></span></span><span class=line><span class=cl><span class=s>name: &#39;k8s-master01&#39;
</span></span></span><span class=line><span class=cl><span class=s>data-dir: /var/lib/etcd
</span></span></span><span class=line><span class=cl><span class=s>wal-dir: /var/lib/etcd/wal
</span></span></span><span class=line><span class=cl><span class=s>snapshot-count: 5000
</span></span></span><span class=line><span class=cl><span class=s>heartbeat-interval: 100
</span></span></span><span class=line><span class=cl><span class=s>election-timeout: 1000
</span></span></span><span class=line><span class=cl><span class=s>quota-backend-bytes: 0
</span></span></span><span class=line><span class=cl><span class=s>listen-peer-urls: &#39;https://192.168.100.101:2380&#39;
</span></span></span><span class=line><span class=cl><span class=s>listen-client-urls: &#39;https://192.168.100.101:2379,http://127.0.0.1:2379&#39;
</span></span></span><span class=line><span class=cl><span class=s>max-snapshots: 3
</span></span></span><span class=line><span class=cl><span class=s>max-wals: 5
</span></span></span><span class=line><span class=cl><span class=s>cors:
</span></span></span><span class=line><span class=cl><span class=s>initial-advertise-peer-urls: &#39;https://192.168.100.101:2380&#39;
</span></span></span><span class=line><span class=cl><span class=s>advertise-client-urls: &#39;https://192.168.100.101:2379&#39;
</span></span></span><span class=line><span class=cl><span class=s>discovery:
</span></span></span><span class=line><span class=cl><span class=s>discovery-fallback: &#39;proxy&#39;
</span></span></span><span class=line><span class=cl><span class=s>discovery-proxy:
</span></span></span><span class=line><span class=cl><span class=s>discovery-srv:
</span></span></span><span class=line><span class=cl><span class=s>initial-cluster: &#39;k8s-master01=https://192.168.100.101:2380,k8s-master02=https://192.168.100.102:2380,k8s-master03=https://192.168.100.103:2380&#39;
</span></span></span><span class=line><span class=cl><span class=s>initial-cluster-token: &#39;etcd-k8s-cluster&#39;
</span></span></span><span class=line><span class=cl><span class=s>initial-cluster-state: &#39;new&#39;
</span></span></span><span class=line><span class=cl><span class=s>strict-reconfig-check: false
</span></span></span><span class=line><span class=cl><span class=s>enable-v2: true
</span></span></span><span class=line><span class=cl><span class=s>enable-pprof: true
</span></span></span><span class=line><span class=cl><span class=s>proxy: &#39;off&#39;
</span></span></span><span class=line><span class=cl><span class=s>proxy-failure-wait: 5000
</span></span></span><span class=line><span class=cl><span class=s>proxy-refresh-interval: 30000
</span></span></span><span class=line><span class=cl><span class=s>proxy-dial-timeout: 1000
</span></span></span><span class=line><span class=cl><span class=s>proxy-write-timeout: 5000
</span></span></span><span class=line><span class=cl><span class=s>proxy-read-timeout: 0
</span></span></span><span class=line><span class=cl><span class=s>client-transport-security:
</span></span></span><span class=line><span class=cl><span class=s>  cert-file: &#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;
</span></span></span><span class=line><span class=cl><span class=s>  key-file: &#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;
</span></span></span><span class=line><span class=cl><span class=s>  client-cert-auth: true
</span></span></span><span class=line><span class=cl><span class=s>  trusted-ca-file: &#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;
</span></span></span><span class=line><span class=cl><span class=s>  auto-tls: true
</span></span></span><span class=line><span class=cl><span class=s>peer-transport-security:
</span></span></span><span class=line><span class=cl><span class=s>  cert-file: &#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;
</span></span></span><span class=line><span class=cl><span class=s>  key-file: &#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;
</span></span></span><span class=line><span class=cl><span class=s>  peer-client-cert-auth: true
</span></span></span><span class=line><span class=cl><span class=s>  trusted-ca-file: &#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;
</span></span></span><span class=line><span class=cl><span class=s>  auto-tls: true
</span></span></span><span class=line><span class=cl><span class=s>debug: false
</span></span></span><span class=line><span class=cl><span class=s>log-package-levels:
</span></span></span><span class=line><span class=cl><span class=s>log-outputs: [default]
</span></span></span><span class=line><span class=cl><span class=s>force-new-cluster: false
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h3 id=master02配置>master02配置<a hidden class=anchor aria-hidden=true href=#master02配置>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 如果要用IPv6那么把IPv4地址修改为IPv6即可</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF 
</span></span><span class=line><span class=cl>name: <span class=s1>&#39;k8s-master02&#39;</span>
</span></span><span class=line><span class=cl>data-dir: /var/lib/etcd
</span></span><span class=line><span class=cl>wal-dir: /var/lib/etcd/wal
</span></span><span class=line><span class=cl>snapshot-count: <span class=m>5000</span>
</span></span><span class=line><span class=cl>heartbeat-interval: <span class=m>100</span>
</span></span><span class=line><span class=cl>election-timeout: <span class=m>1000</span>
</span></span><span class=line><span class=cl>quota-backend-bytes: <span class=m>0</span>
</span></span><span class=line><span class=cl>listen-peer-urls: <span class=s1>&#39;https://192.168.100.102:2380&#39;</span>
</span></span><span class=line><span class=cl>listen-client-urls: <span class=s1>&#39;https://192.168.100.102:2379,http://127.0.0.1:2379&#39;</span>
</span></span><span class=line><span class=cl>max-snapshots: <span class=m>3</span>
</span></span><span class=line><span class=cl>max-wals: <span class=m>5</span>
</span></span><span class=line><span class=cl>cors:
</span></span><span class=line><span class=cl>initial-advertise-peer-urls: <span class=s1>&#39;https://192.168.100.102:2380&#39;</span>
</span></span><span class=line><span class=cl>advertise-client-urls: <span class=s1>&#39;https://192.168.100.102:2379&#39;</span>
</span></span><span class=line><span class=cl>discovery:
</span></span><span class=line><span class=cl>discovery-fallback: <span class=s1>&#39;proxy&#39;</span>
</span></span><span class=line><span class=cl>discovery-proxy:
</span></span><span class=line><span class=cl>discovery-srv:
</span></span><span class=line><span class=cl>initial-cluster: <span class=s1>&#39;k8s-master01=https://192.168.100.101:2380,k8s-master02=https://192.168.100.102:2380,k8s-master03=https://192.168.100.103:2380&#39;</span>
</span></span><span class=line><span class=cl>initial-cluster-token: <span class=s1>&#39;etcd-k8s-cluster&#39;</span>
</span></span><span class=line><span class=cl>initial-cluster-state: <span class=s1>&#39;new&#39;</span>
</span></span><span class=line><span class=cl>strict-reconfig-check: <span class=nb>false</span>
</span></span><span class=line><span class=cl>enable-v2: <span class=nb>true</span>
</span></span><span class=line><span class=cl>enable-pprof: <span class=nb>true</span>
</span></span><span class=line><span class=cl>proxy: <span class=s1>&#39;off&#39;</span>
</span></span><span class=line><span class=cl>proxy-failure-wait: <span class=m>5000</span>
</span></span><span class=line><span class=cl>proxy-refresh-interval: <span class=m>30000</span>
</span></span><span class=line><span class=cl>proxy-dial-timeout: <span class=m>1000</span>
</span></span><span class=line><span class=cl>proxy-write-timeout: <span class=m>5000</span>
</span></span><span class=line><span class=cl>proxy-read-timeout: <span class=m>0</span>
</span></span><span class=line><span class=cl>client-transport-security:
</span></span><span class=line><span class=cl>  cert-file: <span class=s1>&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>
</span></span><span class=line><span class=cl>  key-file: <span class=s1>&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>
</span></span><span class=line><span class=cl>  client-cert-auth: <span class=nb>true</span>
</span></span><span class=line><span class=cl>  trusted-ca-file: <span class=s1>&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>
</span></span><span class=line><span class=cl>  auto-tls: <span class=nb>true</span>
</span></span><span class=line><span class=cl>peer-transport-security:
</span></span><span class=line><span class=cl>  cert-file: <span class=s1>&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>
</span></span><span class=line><span class=cl>  key-file: <span class=s1>&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>
</span></span><span class=line><span class=cl>  peer-client-cert-auth: <span class=nb>true</span>
</span></span><span class=line><span class=cl>  trusted-ca-file: <span class=s1>&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>
</span></span><span class=line><span class=cl>  auto-tls: <span class=nb>true</span>
</span></span><span class=line><span class=cl>debug: <span class=nb>false</span>
</span></span><span class=line><span class=cl>log-package-levels:
</span></span><span class=line><span class=cl>log-outputs: <span class=o>[</span>default<span class=o>]</span>
</span></span><span class=line><span class=cl>force-new-cluster: <span class=nb>false</span>
</span></span></code></pre></div><h3 id=master03配置>master03配置<a hidden class=anchor aria-hidden=true href=#master03配置>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 如果要用IPv6那么把IPv4地址修改为IPv6即可</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF 
</span></span><span class=line><span class=cl>name: <span class=s1>&#39;k8s-master03&#39;</span>
</span></span><span class=line><span class=cl>data-dir: /var/lib/etcd
</span></span><span class=line><span class=cl>wal-dir: /var/lib/etcd/wal
</span></span><span class=line><span class=cl>snapshot-count: <span class=m>5000</span>
</span></span><span class=line><span class=cl>heartbeat-interval: <span class=m>100</span>
</span></span><span class=line><span class=cl>election-timeout: <span class=m>1000</span>
</span></span><span class=line><span class=cl>quota-backend-bytes: <span class=m>0</span>
</span></span><span class=line><span class=cl>listen-peer-urls: <span class=s1>&#39;https://192.168.100.103:2380&#39;</span>
</span></span><span class=line><span class=cl>listen-client-urls: <span class=s1>&#39;https://192.168.100.103:2379,http://127.0.0.1:2379&#39;</span>
</span></span><span class=line><span class=cl>max-snapshots: <span class=m>3</span>
</span></span><span class=line><span class=cl>max-wals: <span class=m>5</span>
</span></span><span class=line><span class=cl>cors:
</span></span><span class=line><span class=cl>initial-advertise-peer-urls: <span class=s1>&#39;https://192.168.100.103:2380&#39;</span>
</span></span><span class=line><span class=cl>advertise-client-urls: <span class=s1>&#39;https://192.168.100.103:2379&#39;</span>
</span></span><span class=line><span class=cl>discovery:
</span></span><span class=line><span class=cl>discovery-fallback: <span class=s1>&#39;proxy&#39;</span>
</span></span><span class=line><span class=cl>discovery-proxy:
</span></span><span class=line><span class=cl>discovery-srv:
</span></span><span class=line><span class=cl>initial-cluster: <span class=s1>&#39;k8s-master01=https://192.168.100.101:2380,k8s-master02=https://192.168.100.102:2380,k8s-master03=https://192.168.100.103:2380&#39;</span>
</span></span><span class=line><span class=cl>initial-cluster-token: <span class=s1>&#39;etcd-k8s-cluster&#39;</span>
</span></span><span class=line><span class=cl>initial-cluster-state: <span class=s1>&#39;new&#39;</span>
</span></span><span class=line><span class=cl>strict-reconfig-check: <span class=nb>false</span>
</span></span><span class=line><span class=cl>enable-v2: <span class=nb>true</span>
</span></span><span class=line><span class=cl>enable-pprof: <span class=nb>true</span>
</span></span><span class=line><span class=cl>proxy: <span class=s1>&#39;off&#39;</span>
</span></span><span class=line><span class=cl>proxy-failure-wait: <span class=m>5000</span>
</span></span><span class=line><span class=cl>proxy-refresh-interval: <span class=m>30000</span>
</span></span><span class=line><span class=cl>proxy-dial-timeout: <span class=m>1000</span>
</span></span><span class=line><span class=cl>proxy-write-timeout: <span class=m>5000</span>
</span></span><span class=line><span class=cl>proxy-read-timeout: <span class=m>0</span>
</span></span><span class=line><span class=cl>client-transport-security:
</span></span><span class=line><span class=cl>  cert-file: <span class=s1>&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>
</span></span><span class=line><span class=cl>  key-file: <span class=s1>&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>
</span></span><span class=line><span class=cl>  client-cert-auth: <span class=nb>true</span>
</span></span><span class=line><span class=cl>  trusted-ca-file: <span class=s1>&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>
</span></span><span class=line><span class=cl>  auto-tls: <span class=nb>true</span>
</span></span><span class=line><span class=cl>peer-transport-security:
</span></span><span class=line><span class=cl>  cert-file: <span class=s1>&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>
</span></span><span class=line><span class=cl>  key-file: <span class=s1>&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>
</span></span><span class=line><span class=cl>  peer-client-cert-auth: <span class=nb>true</span>
</span></span><span class=line><span class=cl>  trusted-ca-file: <span class=s1>&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>
</span></span><span class=line><span class=cl>  auto-tls: <span class=nb>true</span>
</span></span><span class=line><span class=cl>debug: <span class=nb>false</span>
</span></span><span class=line><span class=cl>log-package-levels:
</span></span><span class=line><span class=cl>log-outputs: <span class=o>[</span>default<span class=o>]</span>
</span></span><span class=line><span class=cl>force-new-cluster: <span class=nb>false</span>
</span></span></code></pre></div><h2 id=创建service所有master节点操作>创建service(所有master节点操作)<a hidden class=anchor aria-hidden=true href=#创建service所有master节点操作>#</a></h2><h3 id=创建etcdservice并启动>创建etcd.service并启动<a hidden class=anchor aria-hidden=true href=#创建etcdservice并启动>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; /usr/lib/systemd/system/etcd.service <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=Etcd Service
</span></span></span><span class=line><span class=cl><span class=s>Documentation=https://coreos.com/etcd/docs/latest/
</span></span></span><span class=line><span class=cl><span class=s>After=network.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>Type=notify
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml
</span></span></span><span class=line><span class=cl><span class=s>Restart=on-failure
</span></span></span><span class=line><span class=cl><span class=s>RestartSec=10
</span></span></span><span class=line><span class=cl><span class=s>LimitNOFILE=65535
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>Alias=etcd3.service
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h3 id=创建etcd证书目录>创建etcd证书目录<a hidden class=anchor aria-hidden=true href=#创建etcd证书目录>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir /etc/kubernetes/pki/etcd
</span></span><span class=line><span class=cl>ln -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/
</span></span><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> --now etcd
</span></span></code></pre></div><h3 id=查看etcd状态>查看etcd状态<a hidden class=anchor aria-hidden=true href=#查看etcd状态>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 如果要用IPv6那么把IPv4地址修改为IPv6即可</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>ETCDCTL_API</span><span class=o>=</span><span class=m>3</span>
</span></span><span class=line><span class=cl>etcdctl --endpoints<span class=o>=</span><span class=s2>&#34;192.168.100.101:2379,192.168.100.102:2379,192.168.100.103:2379&#34;</span> --cacert<span class=o>=</span>/etc/kubernetes/pki/etcd/etcd-ca.pem --cert<span class=o>=</span>/etc/kubernetes/pki/etcd/etcd.pem --key<span class=o>=</span>/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint stat --write-out<span class=o>=</span>table 
</span></span><span class=line><span class=cl>+----------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span><span class=line><span class=cl><span class=p>|</span>       ENDPOINT       <span class=p>|</span>        ID        <span class=p>|</span> VERSION <span class=p>|</span> DB SIZE <span class=p>|</span> IS LEADER <span class=p>|</span> IS LEARNER <span class=p>|</span> RAFT TERM <span class=p>|</span> RAFT INDEX <span class=p>|</span> RAFT APPLIED INDEX <span class=p>|</span> ERRORS <span class=p>|</span>
</span></span><span class=line><span class=cl>+----------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span><span class=line><span class=cl><span class=p>|</span> 192.168.100.101:2379 <span class=p>|</span> c88a7ad9caa0caa0 <span class=p>|</span>   3.5.9 <span class=p>|</span>   <span class=m>10</span> MB <span class=p>|</span>     <span class=nb>false</span> <span class=p>|</span>      <span class=nb>false</span> <span class=p>|</span>         <span class=m>6</span> <span class=p>|</span>    <span class=m>1607415</span> <span class=p>|</span>            <span class=m>1607415</span> <span class=p>|</span>        <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> 192.168.100.102:2379 <span class=p>|</span> 66a0add9c0721410 <span class=p>|</span>   3.5.9 <span class=p>|</span>   <span class=m>10</span> MB <span class=p>|</span>      <span class=nb>true</span> <span class=p>|</span>      <span class=nb>false</span> <span class=p>|</span>         <span class=m>6</span> <span class=p>|</span>    <span class=m>1607415</span> <span class=p>|</span>            <span class=m>1607415</span> <span class=p>|</span>        <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> 192.168.100.103:2379 <span class=p>|</span> 5d94bf57d46a5d6f <span class=p>|</span>   3.5.9 <span class=p>|</span>   <span class=m>10</span> MB <span class=p>|</span>     <span class=nb>false</span> <span class=p>|</span>      <span class=nb>false</span> <span class=p>|</span>         <span class=m>6</span> <span class=p>|</span>    <span class=m>1607415</span> <span class=p>|</span>            <span class=m>1607415</span> <span class=p>|</span>        <span class=p>|</span>
</span></span><span class=line><span class=cl>+----------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span></code></pre></div><h1 id=高可用配置在master服务器上操作>高可用配置(在Master服务器上操作)<a hidden class=anchor aria-hidden=true href=#高可用配置在master服务器上操作>#</a></h1><p><strong>注意 nginx 和 haproxy+keepalived 方案二选一即可</strong></p><ul><li>选择使用那种高可用方案，同时可以俩种都选用，比如：</li></ul><blockquote><p>nginx方案实现集群内的高可用</p></blockquote><blockquote><p>haproxy、keepalived 方案实现集群外访问</p></blockquote><ul><li>在此之前已经生成k8s相关证书</li></ul><blockquote><p>若使用 nginx方案，那么为 <code>--server=https://127.0.0.1:8443</code></p></blockquote><blockquote><p>若使用 haproxy、keepalived 那么为 <code>--server=https://192.168.100.100:9443</code></p></blockquote><h2 id=nginx高可用方案>nginx高可用方案<a hidden class=anchor aria-hidden=true href=#nginx高可用方案>#</a></h2><h3 id=编译nginx>编译nginx<a hidden class=anchor aria-hidden=true href=#编译nginx>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 安装编译环境</span>
</span></span><span class=line><span class=cl>yum install gcc -y
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 下载解压nginx二进制文件</span>
</span></span><span class=line><span class=cl><span class=c1># wget http://nginx.org/download/nginx-1.25.1.tar.gz</span>
</span></span><span class=line><span class=cl>tar xvf nginx-*.tar.gz
</span></span><span class=line><span class=cl><span class=nb>cd</span> nginx-*
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进行编译</span>
</span></span><span class=line><span class=cl>./configure --with-stream --without-http --without-http_uwsgi_module --without-http_scgi_module --without-http_fastcgi_module
</span></span><span class=line><span class=cl>make <span class=o>&amp;&amp;</span> make install 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 拷贝编译好的nginx</span>
</span></span><span class=line><span class=cl><span class=nv>node</span><span class=o>=</span><span class=s1>&#39;k8s-master02 k8s-master03 k8s-node01 k8s-node02&#39;</span>
</span></span><span class=line><span class=cl><span class=k>for</span> NODE in <span class=nv>$node</span><span class=p>;</span> <span class=k>do</span> scp -r /usr/local/nginx/ <span class=nv>$NODE</span>:/usr/local/nginx/<span class=p>;</span> <span class=k>done</span>
</span></span></code></pre></div><h3 id=写入启动配置>写入启动配置<a hidden class=anchor aria-hidden=true href=#写入启动配置>#</a></h3><ul><li>在所有master主机上执行</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 写入nginx配置文件</span>
</span></span><span class=line><span class=cl>cat &gt; /usr/local/nginx/conf/kube-nginx.conf <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>worker_processes 1;
</span></span></span><span class=line><span class=cl><span class=s>events {
</span></span></span><span class=line><span class=cl><span class=s>    worker_connections  1024;
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>stream {
</span></span></span><span class=line><span class=cl><span class=s>    upstream backend {
</span></span></span><span class=line><span class=cl><span class=s>    	least_conn;
</span></span></span><span class=line><span class=cl><span class=s>        hash $remote_addr consistent;
</span></span></span><span class=line><span class=cl><span class=s>        server 192.168.100.101:6443        max_fails=3 fail_timeout=30s;
</span></span></span><span class=line><span class=cl><span class=s>        server 192.168.100.102:6443        max_fails=3 fail_timeout=30s;
</span></span></span><span class=line><span class=cl><span class=s>        server 192.168.100.103:6443        max_fails=3 fail_timeout=30s;
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>    server {
</span></span></span><span class=line><span class=cl><span class=s>        listen 127.0.0.1:8443;
</span></span></span><span class=line><span class=cl><span class=s>        proxy_connect_timeout 1s;
</span></span></span><span class=line><span class=cl><span class=s>        proxy_pass backend;
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 写入启动配置文件</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/systemd/system/kube-nginx.service <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=kube-apiserver nginx proxy
</span></span></span><span class=line><span class=cl><span class=s>After=network.target
</span></span></span><span class=line><span class=cl><span class=s>After=network-online.target
</span></span></span><span class=line><span class=cl><span class=s>Wants=network-online.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>Type=forking
</span></span></span><span class=line><span class=cl><span class=s>ExecStartPre=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx -t
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx
</span></span></span><span class=line><span class=cl><span class=s>ExecReload=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx -s reload
</span></span></span><span class=line><span class=cl><span class=s>PrivateTmp=true
</span></span></span><span class=line><span class=cl><span class=s>Restart=always
</span></span></span><span class=line><span class=cl><span class=s>RestartSec=5
</span></span></span><span class=line><span class=cl><span class=s>StartLimitInterval=0
</span></span></span><span class=line><span class=cl><span class=s>LimitNOFILE=65535
</span></span></span><span class=line><span class=cl><span class=s> 
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置开机自启</span>
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> --now  kube-nginx 
</span></span><span class=line><span class=cl>systemctl restart kube-nginx
</span></span><span class=line><span class=cl>systemctl status kube-nginx
</span></span></code></pre></div><h2 id=keepalived和haproxy高可用方案>keepalived和haproxy高可用方案<a hidden class=anchor aria-hidden=true href=#keepalived和haproxy高可用方案>#</a></h2><h3 id=安装keepalived和haproxy服务>安装keepalived和haproxy服务<a hidden class=anchor aria-hidden=true href=#安装keepalived和haproxy服务>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl disable --now firewalld
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>setenforce <span class=m>0</span>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s#SELINUX=enforcing#SELINUX=disabled#g&#39;</span> /etc/selinux/config
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>yum -y install keepalived haproxy
</span></span></code></pre></div><h3 id=修改haproxy配置文件所有master节点配置文件一样>修改haproxy配置文件(所有master节点配置文件一样)<a hidden class=anchor aria-hidden=true href=#修改haproxy配置文件所有master节点配置文件一样>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt;/etc/haproxy/haproxy.cfg&lt;&lt;<span class=s2>&#34;EOF&#34;</span>
</span></span><span class=line><span class=cl>global
</span></span><span class=line><span class=cl> maxconn <span class=m>2000</span>
</span></span><span class=line><span class=cl> ulimit-n <span class=m>16384</span>
</span></span><span class=line><span class=cl> log 127.0.0.1 local0 err
</span></span><span class=line><span class=cl> stats timeout 30s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>defaults
</span></span><span class=line><span class=cl> log global
</span></span><span class=line><span class=cl> mode http
</span></span><span class=line><span class=cl> option httplog
</span></span><span class=line><span class=cl> timeout connect <span class=m>5000</span>
</span></span><span class=line><span class=cl> timeout client <span class=m>50000</span>
</span></span><span class=line><span class=cl> timeout server <span class=m>50000</span>
</span></span><span class=line><span class=cl> timeout http-request 15s
</span></span><span class=line><span class=cl> timeout http-keep-alive 15s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>frontend monitor-in
</span></span><span class=line><span class=cl> <span class=nb>bind</span> *:33305
</span></span><span class=line><span class=cl> mode http
</span></span><span class=line><span class=cl> option httplog
</span></span><span class=line><span class=cl> monitor-uri /monitor
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>frontend k8s-master
</span></span><span class=line><span class=cl> <span class=nb>bind</span> 0.0.0.0:9443
</span></span><span class=line><span class=cl> <span class=nb>bind</span> 127.0.0.1:9443
</span></span><span class=line><span class=cl> mode tcp
</span></span><span class=line><span class=cl> option tcplog
</span></span><span class=line><span class=cl> tcp-request inspect-delay 5s
</span></span><span class=line><span class=cl> default_backend k8s-master
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>backend k8s-master
</span></span><span class=line><span class=cl> mode tcp
</span></span><span class=line><span class=cl> option tcplog
</span></span><span class=line><span class=cl> option tcp-check
</span></span><span class=line><span class=cl> balance roundrobin
</span></span><span class=line><span class=cl> default-server inter 10s downinter 5s rise <span class=m>2</span> fall <span class=m>2</span> slowstart 60s maxconn <span class=m>250</span> maxqueue <span class=m>256</span> weight <span class=m>100</span>
</span></span><span class=line><span class=cl> server  k8s-master01  192.168.100.101:6443 check
</span></span><span class=line><span class=cl> server  k8s-master02  192.168.100.102:6443 check
</span></span><span class=line><span class=cl> server  k8s-master03  192.168.100.103:6443 check
</span></span><span class=line><span class=cl>EOF
</span></span></code></pre></div><h3 id=master01配置keepalived-master节点>master01配置keepalived master节点<a hidden class=anchor aria-hidden=true href=#master01配置keepalived-master节点>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>#cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt; /etc/keepalived/keepalived.conf <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>! Configuration File for keepalived
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>global_defs {
</span></span></span><span class=line><span class=cl><span class=s>    router_id LVS_DEVEL
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>vrrp_script chk_apiserver {
</span></span></span><span class=line><span class=cl><span class=s>    script &#34;/etc/keepalived/check_apiserver.sh&#34;
</span></span></span><span class=line><span class=cl><span class=s>    interval 5 
</span></span></span><span class=line><span class=cl><span class=s>    weight -5
</span></span></span><span class=line><span class=cl><span class=s>    fall 2
</span></span></span><span class=line><span class=cl><span class=s>    rise 1
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>vrrp_instance VI_1 {
</span></span></span><span class=line><span class=cl><span class=s>    state MASTER
</span></span></span><span class=line><span class=cl><span class=s>    # 注意网卡名
</span></span></span><span class=line><span class=cl><span class=s>    interface ens1 
</span></span></span><span class=line><span class=cl><span class=s>    mcast_src_ip 192.168.100.101
</span></span></span><span class=line><span class=cl><span class=s>    virtual_router_id 51
</span></span></span><span class=line><span class=cl><span class=s>    priority 100
</span></span></span><span class=line><span class=cl><span class=s>    nopreempt
</span></span></span><span class=line><span class=cl><span class=s>    advert_int 2
</span></span></span><span class=line><span class=cl><span class=s>    authentication {
</span></span></span><span class=line><span class=cl><span class=s>        auth_type PASS
</span></span></span><span class=line><span class=cl><span class=s>        auth_pass K8SHA_KA_AUTH
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>    virtual_ipaddress {
</span></span></span><span class=line><span class=cl><span class=s>        192.168.100.100
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>    track_script {
</span></span></span><span class=line><span class=cl><span class=s>      chk_apiserver 
</span></span></span><span class=line><span class=cl><span class=s>} }
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h3 id=master02配置keepalived-backup节点>master02配置keepalived backup节点<a hidden class=anchor aria-hidden=true href=#master02配置keepalived-backup节点>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt; /etc/keepalived/keepalived.conf <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>! Configuration File for keepalived
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>global_defs {
</span></span></span><span class=line><span class=cl><span class=s>    router_id LVS_DEVEL
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>vrrp_script chk_apiserver {
</span></span></span><span class=line><span class=cl><span class=s>    script &#34;/etc/keepalived/check_apiserver.sh&#34;
</span></span></span><span class=line><span class=cl><span class=s>    interval 5 
</span></span></span><span class=line><span class=cl><span class=s>    weight -5
</span></span></span><span class=line><span class=cl><span class=s>    fall 2
</span></span></span><span class=line><span class=cl><span class=s>    rise 1
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>vrrp_instance VI_1 {
</span></span></span><span class=line><span class=cl><span class=s>    state BACKUP
</span></span></span><span class=line><span class=cl><span class=s>    # 注意网卡名
</span></span></span><span class=line><span class=cl><span class=s>    interface ens1
</span></span></span><span class=line><span class=cl><span class=s>    mcast_src_ip 192.168.100.102
</span></span></span><span class=line><span class=cl><span class=s>    virtual_router_id 51
</span></span></span><span class=line><span class=cl><span class=s>    priority 80
</span></span></span><span class=line><span class=cl><span class=s>    nopreempt
</span></span></span><span class=line><span class=cl><span class=s>    advert_int 2
</span></span></span><span class=line><span class=cl><span class=s>    authentication {
</span></span></span><span class=line><span class=cl><span class=s>        auth_type PASS
</span></span></span><span class=line><span class=cl><span class=s>        auth_pass K8SHA_KA_AUTH
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>    virtual_ipaddress {
</span></span></span><span class=line><span class=cl><span class=s>        192.168.100.100
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>    track_script {
</span></span></span><span class=line><span class=cl><span class=s>      chk_apiserver 
</span></span></span><span class=line><span class=cl><span class=s>} }
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h3 id=master03配置keepalived-backup节点>master03配置keepalived backup节点<a hidden class=anchor aria-hidden=true href=#master03配置keepalived-backup节点>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt; /etc/keepalived/keepalived.conf <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>! Configuration File for keepalived
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>global_defs {
</span></span></span><span class=line><span class=cl><span class=s>    router_id LVS_DEVEL
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>vrrp_script chk_apiserver {
</span></span></span><span class=line><span class=cl><span class=s>    script &#34;/etc/keepalived/check_apiserver.sh&#34;
</span></span></span><span class=line><span class=cl><span class=s>    interval 5 
</span></span></span><span class=line><span class=cl><span class=s>    weight -5
</span></span></span><span class=line><span class=cl><span class=s>    fall 2
</span></span></span><span class=line><span class=cl><span class=s>    rise 1
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>vrrp_instance VI_1 {
</span></span></span><span class=line><span class=cl><span class=s>    state BACKUP
</span></span></span><span class=line><span class=cl><span class=s>    # 注意网卡名
</span></span></span><span class=line><span class=cl><span class=s>    interface ens1
</span></span></span><span class=line><span class=cl><span class=s>    mcast_src_ip 192.168.100.103
</span></span></span><span class=line><span class=cl><span class=s>    virtual_router_id 51
</span></span></span><span class=line><span class=cl><span class=s>    priority 50
</span></span></span><span class=line><span class=cl><span class=s>    nopreempt
</span></span></span><span class=line><span class=cl><span class=s>    advert_int 2
</span></span></span><span class=line><span class=cl><span class=s>    authentication {
</span></span></span><span class=line><span class=cl><span class=s>        auth_type PASS
</span></span></span><span class=line><span class=cl><span class=s>        auth_pass K8SHA_KA_AUTH
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>    virtual_ipaddress {
</span></span></span><span class=line><span class=cl><span class=s>        192.168.100.100
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>    track_script {
</span></span></span><span class=line><span class=cl><span class=s>      chk_apiserver 
</span></span></span><span class=line><span class=cl><span class=s>} }
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h3 id=配置健康检查脚本keepalived主机上配置>配置健康检查脚本(keepalived主机上配置)<a hidden class=anchor aria-hidden=true href=#配置健康检查脚本keepalived主机上配置>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt;  /etc/keepalived/check_apiserver.sh <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>err=0
</span></span></span><span class=line><span class=cl><span class=s>for k in \$(seq 1 3)
</span></span></span><span class=line><span class=cl><span class=s>do
</span></span></span><span class=line><span class=cl><span class=s>    check_code=\$(pgrep haproxy)
</span></span></span><span class=line><span class=cl><span class=s>    if [[ \$check_code == &#34;&#34; ]]; then
</span></span></span><span class=line><span class=cl><span class=s>        err=\$(expr \$err + 1)
</span></span></span><span class=line><span class=cl><span class=s>        sleep 1
</span></span></span><span class=line><span class=cl><span class=s>        continue
</span></span></span><span class=line><span class=cl><span class=s>    else
</span></span></span><span class=line><span class=cl><span class=s>        err=0
</span></span></span><span class=line><span class=cl><span class=s>        break
</span></span></span><span class=line><span class=cl><span class=s>    fi
</span></span></span><span class=line><span class=cl><span class=s>done
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>if [[ \$err != &#34;0&#34; ]]; then
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;systemctl stop keepalived&#34;
</span></span></span><span class=line><span class=cl><span class=s>    /usr/bin/systemctl stop keepalived
</span></span></span><span class=line><span class=cl><span class=s>    exit 1
</span></span></span><span class=line><span class=cl><span class=s>else
</span></span></span><span class=line><span class=cl><span class=s>    exit 0
</span></span></span><span class=line><span class=cl><span class=s>fi
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 给脚本执行权限</span>
</span></span><span class=line><span class=cl>chmod +x /etc/keepalived/check_apiserver.sh
</span></span></code></pre></div><h3 id=启动服务>启动服务<a hidden class=anchor aria-hidden=true href=#启动服务>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> --now haproxy
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> --now keepalived
</span></span></code></pre></div><h3 id=测试高可用>测试高可用<a hidden class=anchor aria-hidden=true href=#测试高可用>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 能ping通</span>
</span></span><span class=line><span class=cl><span class=c1># ping 192.168.100.100</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 能telnet访问</span>
</span></span><span class=line><span class=cl><span class=c1># telnet 192.168.100.100 9443</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 关闭主节点，看vip是否漂移到备节点</span>
</span></span></code></pre></div><h1 id=k8s组件配置>k8s组件配置<a hidden class=anchor aria-hidden=true href=#k8s组件配置>#</a></h1><ul><li>所有k8s节点创建以下目录</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -p /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/log/kubernetes
</span></span></code></pre></div><h2 id=创建apiserver所有master节点>创建apiserver(所有master节点)<a hidden class=anchor aria-hidden=true href=#创建apiserver所有master节点>#</a></h2><h3 id=master01节点配置>master01节点配置<a hidden class=anchor aria-hidden=true href=#master01节点配置>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; /usr/lib/systemd/system/kube-apiserver.service <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=Kubernetes API Server
</span></span></span><span class=line><span class=cl><span class=s>Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span class=line><span class=cl><span class=s>After=network.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/bin/kube-apiserver \\
</span></span></span><span class=line><span class=cl><span class=s>      --v=2  \\
</span></span></span><span class=line><span class=cl><span class=s>      --allow-privileged=true  \\
</span></span></span><span class=line><span class=cl><span class=s>      --bind-address=0.0.0.0  \\
</span></span></span><span class=line><span class=cl><span class=s>      --secure-port=6443  \\
</span></span></span><span class=line><span class=cl><span class=s>      --advertise-address=192.168.100.101 \\
</span></span></span><span class=line><span class=cl><span class=s>      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112  \\
</span></span></span><span class=line><span class=cl><span class=s>      --service-node-port-range=30000-32767  \\
</span></span></span><span class=line><span class=cl><span class=s>      --etcd-servers=https://192.168.100.101:2379,https://192.168.100.102:2379,https://192.168.100.103:2379 \\
</span></span></span><span class=line><span class=cl><span class=s>      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --client-ca-file=/etc/kubernetes/pki/ca.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \\
</span></span></span><span class=line><span class=cl><span class=s>      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \\
</span></span></span><span class=line><span class=cl><span class=s>      --service-account-issuer=https://kubernetes.default.svc.cluster.local \\
</span></span></span><span class=line><span class=cl><span class=s>      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \\
</span></span></span><span class=line><span class=cl><span class=s>      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \
</span></span></span><span class=line><span class=cl><span class=s>      --authorization-mode=Node,RBAC  \\
</span></span></span><span class=line><span class=cl><span class=s>      --enable-bootstrap-token-auth=true  \\
</span></span></span><span class=line><span class=cl><span class=s>      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --requestheader-allowed-names=aggregator  \\
</span></span></span><span class=line><span class=cl><span class=s>      --requestheader-group-headers=X-Remote-Group  \\
</span></span></span><span class=line><span class=cl><span class=s>      --requestheader-extra-headers-prefix=X-Remote-Extra-  \\
</span></span></span><span class=line><span class=cl><span class=s>      --requestheader-username-headers=X-Remote-User \\
</span></span></span><span class=line><span class=cl><span class=s>      --enable-aggregator-routing=true
</span></span></span><span class=line><span class=cl><span class=s>Restart=on-failure
</span></span></span><span class=line><span class=cl><span class=s>RestartSec=10s
</span></span></span><span class=line><span class=cl><span class=s>LimitNOFILE=65535
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h3 id=master02节点配置>master02节点配置<a hidden class=anchor aria-hidden=true href=#master02节点配置>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; /usr/lib/systemd/system/kube-apiserver.service <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=Kubernetes API Server
</span></span></span><span class=line><span class=cl><span class=s>Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span class=line><span class=cl><span class=s>After=network.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/bin/kube-apiserver \\
</span></span></span><span class=line><span class=cl><span class=s>      --v=2  \\
</span></span></span><span class=line><span class=cl><span class=s>      --allow-privileged=true  \\
</span></span></span><span class=line><span class=cl><span class=s>      --bind-address=0.0.0.0  \\
</span></span></span><span class=line><span class=cl><span class=s>      --secure-port=6443  \\
</span></span></span><span class=line><span class=cl><span class=s>      --advertise-address=192.168.100.102 \\
</span></span></span><span class=line><span class=cl><span class=s>      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112  \\
</span></span></span><span class=line><span class=cl><span class=s>      --service-node-port-range=30000-32767  \\
</span></span></span><span class=line><span class=cl><span class=s>      --etcd-servers=https://192.168.100.101:2379,https://192.168.100.102:2379,https://192.168.100.103:2379 \\
</span></span></span><span class=line><span class=cl><span class=s>      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --client-ca-file=/etc/kubernetes/pki/ca.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \\
</span></span></span><span class=line><span class=cl><span class=s>      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \\
</span></span></span><span class=line><span class=cl><span class=s>      --service-account-issuer=https://kubernetes.default.svc.cluster.local \\
</span></span></span><span class=line><span class=cl><span class=s>      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \\
</span></span></span><span class=line><span class=cl><span class=s>      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \
</span></span></span><span class=line><span class=cl><span class=s>      --authorization-mode=Node,RBAC  \\
</span></span></span><span class=line><span class=cl><span class=s>      --enable-bootstrap-token-auth=true  \\
</span></span></span><span class=line><span class=cl><span class=s>      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --requestheader-allowed-names=aggregator  \\
</span></span></span><span class=line><span class=cl><span class=s>      --requestheader-group-headers=X-Remote-Group  \\
</span></span></span><span class=line><span class=cl><span class=s>      --requestheader-extra-headers-prefix=X-Remote-Extra-  \\
</span></span></span><span class=line><span class=cl><span class=s>      --requestheader-username-headers=X-Remote-User \\
</span></span></span><span class=line><span class=cl><span class=s>      --enable-aggregator-routing=true
</span></span></span><span class=line><span class=cl><span class=s>Restart=on-failure
</span></span></span><span class=line><span class=cl><span class=s>RestartSec=10s
</span></span></span><span class=line><span class=cl><span class=s>LimitNOFILE=65535
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h3 id=master03节点配置>master03节点配置<a hidden class=anchor aria-hidden=true href=#master03节点配置>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; /usr/lib/systemd/system/kube-apiserver.service <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=Kubernetes API Server
</span></span></span><span class=line><span class=cl><span class=s>Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span class=line><span class=cl><span class=s>After=network.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/bin/kube-apiserver \\
</span></span></span><span class=line><span class=cl><span class=s>      --v=2  \\
</span></span></span><span class=line><span class=cl><span class=s>      --allow-privileged=true  \\
</span></span></span><span class=line><span class=cl><span class=s>      --bind-address=0.0.0.0  \\
</span></span></span><span class=line><span class=cl><span class=s>      --secure-port=6443  \\
</span></span></span><span class=line><span class=cl><span class=s>      --advertise-address=192.168.100.103 \\
</span></span></span><span class=line><span class=cl><span class=s>      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112  \\
</span></span></span><span class=line><span class=cl><span class=s>      --service-node-port-range=30000-32767  \\
</span></span></span><span class=line><span class=cl><span class=s>      --etcd-servers=https://192.168.100.101:2379,https://192.168.100.102:2379,https://192.168.100.103:2379 \\
</span></span></span><span class=line><span class=cl><span class=s>      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --client-ca-file=/etc/kubernetes/pki/ca.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \\
</span></span></span><span class=line><span class=cl><span class=s>      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \\
</span></span></span><span class=line><span class=cl><span class=s>      --service-account-issuer=https://kubernetes.default.svc.cluster.local \\
</span></span></span><span class=line><span class=cl><span class=s>      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \\
</span></span></span><span class=line><span class=cl><span class=s>      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \
</span></span></span><span class=line><span class=cl><span class=s>      --authorization-mode=Node,RBAC  \\
</span></span></span><span class=line><span class=cl><span class=s>      --enable-bootstrap-token-auth=true  \\
</span></span></span><span class=line><span class=cl><span class=s>      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\
</span></span></span><span class=line><span class=cl><span class=s>      --requestheader-allowed-names=aggregator  \\
</span></span></span><span class=line><span class=cl><span class=s>      --requestheader-group-headers=X-Remote-Group  \\
</span></span></span><span class=line><span class=cl><span class=s>      --requestheader-extra-headers-prefix=X-Remote-Extra-  \\
</span></span></span><span class=line><span class=cl><span class=s>      --requestheader-username-headers=X-Remote-User \\
</span></span></span><span class=line><span class=cl><span class=s>      --enable-aggregator-routing=true
</span></span></span><span class=line><span class=cl><span class=s>Restart=on-failure
</span></span></span><span class=line><span class=cl><span class=s>RestartSec=10s
</span></span></span><span class=line><span class=cl><span class=s>LimitNOFILE=65535
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h3 id=启动apiserver所有master节点>启动apiserver(所有master节点)<a hidden class=anchor aria-hidden=true href=#启动apiserver所有master节点>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> --now kube-apiserver
</span></span><span class=line><span class=cl>systemctl restart kube-apiserver
</span></span><span class=line><span class=cl>systemctl status kube-apiserver
</span></span></code></pre></div><h2 id=配置kube-controller-manager-service>配置kube-controller-manager service<a hidden class=anchor aria-hidden=true href=#配置kube-controller-manager-service>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 所有master节点配置，且配置相同</span>
</span></span><span class=line><span class=cl><span class=c1># 172.16.0.0/12为pod网段，按需求设置你自己的网段</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt; /usr/lib/systemd/system/kube-controller-manager.service <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=Kubernetes Controller Manager
</span></span></span><span class=line><span class=cl><span class=s>Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span class=line><span class=cl><span class=s>After=network.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/bin/kube-controller-manager \\
</span></span></span><span class=line><span class=cl><span class=s>      --v=2 \\
</span></span></span><span class=line><span class=cl><span class=s>      --bind-address=0.0.0.0 \\
</span></span></span><span class=line><span class=cl><span class=s>      --root-ca-file=/etc/kubernetes/pki/ca.pem \\
</span></span></span><span class=line><span class=cl><span class=s>      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \\
</span></span></span><span class=line><span class=cl><span class=s>      --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \\
</span></span></span><span class=line><span class=cl><span class=s>      --service-account-private-key-file=/etc/kubernetes/pki/sa.key \\
</span></span></span><span class=line><span class=cl><span class=s>      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \\
</span></span></span><span class=line><span class=cl><span class=s>      --leader-elect=true \\
</span></span></span><span class=line><span class=cl><span class=s>      --use-service-account-credentials=true \\
</span></span></span><span class=line><span class=cl><span class=s>      --node-monitor-grace-period=40s \\
</span></span></span><span class=line><span class=cl><span class=s>      --node-monitor-period=5s \\
</span></span></span><span class=line><span class=cl><span class=s>      --controllers=*,bootstrapsigner,tokencleaner \\
</span></span></span><span class=line><span class=cl><span class=s>      --allocate-node-cidrs=true \\
</span></span></span><span class=line><span class=cl><span class=s>      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112 \\
</span></span></span><span class=line><span class=cl><span class=s>      --cluster-cidr=172.16.0.0/12,fc00:2222::/112 \\
</span></span></span><span class=line><span class=cl><span class=s>      --node-cidr-mask-size-ipv4=24 \\
</span></span></span><span class=line><span class=cl><span class=s>      --node-cidr-mask-size-ipv6=120 \\
</span></span></span><span class=line><span class=cl><span class=s>      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>Restart=always
</span></span></span><span class=line><span class=cl><span class=s>RestartSec=10s
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h3 id=启动kube-controller-manager>启动kube-controller-manager<a hidden class=anchor aria-hidden=true href=#启动kube-controller-manager>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> --now kube-controller-manager
</span></span><span class=line><span class=cl>systemctl restart kube-controller-manager
</span></span><span class=line><span class=cl>systemctl status kube-controller-manager
</span></span></code></pre></div><h2 id=配置kube-scheduler-service>配置kube-scheduler service<a hidden class=anchor aria-hidden=true href=#配置kube-scheduler-service>#</a></h2><h3 id=所有master节点配置且配置相同>所有master节点配置，且配置相同<a hidden class=anchor aria-hidden=true href=#所有master节点配置且配置相同>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; /usr/lib/systemd/system/kube-scheduler.service <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=Kubernetes Scheduler
</span></span></span><span class=line><span class=cl><span class=s>Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span class=line><span class=cl><span class=s>After=network.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/bin/kube-scheduler \\
</span></span></span><span class=line><span class=cl><span class=s>      --v=2 \\
</span></span></span><span class=line><span class=cl><span class=s>      --bind-address=0.0.0.0 \\
</span></span></span><span class=line><span class=cl><span class=s>      --leader-elect=true \\
</span></span></span><span class=line><span class=cl><span class=s>      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>Restart=always
</span></span></span><span class=line><span class=cl><span class=s>RestartSec=10s
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h3 id=启动并查看服务状态>启动并查看服务状态<a hidden class=anchor aria-hidden=true href=#启动并查看服务状态>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> --now kube-scheduler
</span></span><span class=line><span class=cl>systemctl restart kube-scheduler
</span></span><span class=line><span class=cl>systemctl status kube-scheduler
</span></span></code></pre></div><h1 id=tls-bootstrapping配置>TLS Bootstrapping配置<a hidden class=anchor aria-hidden=true href=#tls-bootstrapping配置>#</a></h1><h2 id=在master01上配置>在master01上配置<a hidden class=anchor aria-hidden=true href=#在master01上配置>#</a></h2><ul><li>在<strong>高可用配置</strong>部分选择使用哪种高可用方案</li><li>若使用 haproxy、keepalived 那么为 <code>--server=https://192.168.100.100:9443</code></li><li>若使用 nginx方案，那么为 <code>--server=https://127.0.0.1:8443</code></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> bootstrap
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt; bootstrap.secret.yaml <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Secret
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: bootstrap-token-c8ad9c
</span></span></span><span class=line><span class=cl><span class=s>  namespace: kube-system
</span></span></span><span class=line><span class=cl><span class=s>type: bootstrap.kubernetes.io/token
</span></span></span><span class=line><span class=cl><span class=s>stringData:
</span></span></span><span class=line><span class=cl><span class=s>  description: &#34;The default bootstrap token generated by &#39;kubelet &#39;.&#34;
</span></span></span><span class=line><span class=cl><span class=s>  token-id: c8ad9c
</span></span></span><span class=line><span class=cl><span class=s>  token-secret: 2e4d610cf3e7426e
</span></span></span><span class=line><span class=cl><span class=s>  usage-bootstrap-authentication: &#34;true&#34;
</span></span></span><span class=line><span class=cl><span class=s>  usage-bootstrap-signing: &#34;true&#34;
</span></span></span><span class=line><span class=cl><span class=s>  auth-extra-groups:  system:bootstrappers:default-node-token,system:bootstrappers:worker,system:bootstrappers:ingress
</span></span></span><span class=line><span class=cl><span class=s> 
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: ClusterRoleBinding
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: kubelet-bootstrap
</span></span></span><span class=line><span class=cl><span class=s>roleRef:
</span></span></span><span class=line><span class=cl><span class=s>  apiGroup: rbac.authorization.k8s.io
</span></span></span><span class=line><span class=cl><span class=s>  kind: ClusterRole
</span></span></span><span class=line><span class=cl><span class=s>  name: system:node-bootstrapper
</span></span></span><span class=line><span class=cl><span class=s>subjects:
</span></span></span><span class=line><span class=cl><span class=s>- apiGroup: rbac.authorization.k8s.io
</span></span></span><span class=line><span class=cl><span class=s>  kind: Group
</span></span></span><span class=line><span class=cl><span class=s>  name: system:bootstrappers:default-node-token
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: ClusterRoleBinding
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: node-autoapprove-bootstrap
</span></span></span><span class=line><span class=cl><span class=s>roleRef:
</span></span></span><span class=line><span class=cl><span class=s>  apiGroup: rbac.authorization.k8s.io
</span></span></span><span class=line><span class=cl><span class=s>  kind: ClusterRole
</span></span></span><span class=line><span class=cl><span class=s>  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient
</span></span></span><span class=line><span class=cl><span class=s>subjects:
</span></span></span><span class=line><span class=cl><span class=s>- apiGroup: rbac.authorization.k8s.io
</span></span></span><span class=line><span class=cl><span class=s>  kind: Group
</span></span></span><span class=line><span class=cl><span class=s>  name: system:bootstrappers:default-node-token
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: ClusterRoleBinding
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: node-autoapprove-certificate-rotation
</span></span></span><span class=line><span class=cl><span class=s>roleRef:
</span></span></span><span class=line><span class=cl><span class=s>  apiGroup: rbac.authorization.k8s.io
</span></span></span><span class=line><span class=cl><span class=s>  kind: ClusterRole
</span></span></span><span class=line><span class=cl><span class=s>  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
</span></span></span><span class=line><span class=cl><span class=s>subjects:
</span></span></span><span class=line><span class=cl><span class=s>- apiGroup: rbac.authorization.k8s.io
</span></span></span><span class=line><span class=cl><span class=s>  kind: Group
</span></span></span><span class=line><span class=cl><span class=s>  name: system:nodes
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: ClusterRole
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  annotations:
</span></span></span><span class=line><span class=cl><span class=s>    rbac.authorization.kubernetes.io/autoupdate: &#34;true&#34;
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    kubernetes.io/bootstrapping: rbac-defaults
</span></span></span><span class=line><span class=cl><span class=s>  name: system:kube-apiserver-to-kubelet
</span></span></span><span class=line><span class=cl><span class=s>rules:
</span></span></span><span class=line><span class=cl><span class=s>  - apiGroups:
</span></span></span><span class=line><span class=cl><span class=s>      - &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>    resources:
</span></span></span><span class=line><span class=cl><span class=s>      - nodes/proxy
</span></span></span><span class=line><span class=cl><span class=s>      - nodes/stats
</span></span></span><span class=line><span class=cl><span class=s>      - nodes/log
</span></span></span><span class=line><span class=cl><span class=s>      - nodes/spec
</span></span></span><span class=line><span class=cl><span class=s>      - nodes/metrics
</span></span></span><span class=line><span class=cl><span class=s>    verbs:
</span></span></span><span class=line><span class=cl><span class=s>      - &#34;*&#34;
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: ClusterRoleBinding
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: system:kube-apiserver
</span></span></span><span class=line><span class=cl><span class=s>  namespace: &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>roleRef:
</span></span></span><span class=line><span class=cl><span class=s>  apiGroup: rbac.authorization.k8s.io
</span></span></span><span class=line><span class=cl><span class=s>  kind: ClusterRole
</span></span></span><span class=line><span class=cl><span class=s>  name: system:kube-apiserver-to-kubelet
</span></span></span><span class=line><span class=cl><span class=s>subjects:
</span></span></span><span class=line><span class=cl><span class=s>  - apiGroup: rbac.authorization.k8s.io
</span></span></span><span class=line><span class=cl><span class=s>    kind: User
</span></span></span><span class=line><span class=cl><span class=s>    name: kube-apiserver
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl config set-cluster kubernetes     <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--certificate-authority<span class=o>=</span>/etc/kubernetes/pki/ca.pem     <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--embed-certs<span class=o>=</span><span class=nb>true</span>     --server<span class=o>=</span>https://127.0.0.1:8443     <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--kubeconfig<span class=o>=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl config set-credentials tls-bootstrap-token-user     <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--token<span class=o>=</span>c8ad9c.2e4d610cf3e7426e <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--kubeconfig<span class=o>=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl config set-context tls-bootstrap-token-user@kubernetes     <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--cluster<span class=o>=</span>kubernetes     <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--user<span class=o>=</span>tls-bootstrap-token-user     <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--kubeconfig<span class=o>=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl config use-context tls-bootstrap-token-user@kubernetes     <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--kubeconfig<span class=o>=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># token的位置在bootstrap.secret.yaml，如果修改的话到这个文件修改</span>
</span></span><span class=line><span class=cl>mkdir -pv /root/.kube <span class=p>;</span> cp /etc/kubernetes/admin.kubeconfig /root/.kube/config
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看集群状态，没问题的话继续后续操作</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl get cs</span>
</span></span><span class=line><span class=cl>Warning: v1 ComponentStatus is deprecated in v1.19+
</span></span><span class=line><span class=cl>NAME                 STATUS    MESSAGE   ERROR
</span></span><span class=line><span class=cl>controller-manager   Healthy   ok        
</span></span><span class=line><span class=cl>scheduler            Healthy   ok        
</span></span><span class=line><span class=cl>etcd-1               Healthy             
</span></span><span class=line><span class=cl>etcd-0               Healthy             
</span></span><span class=line><span class=cl>etcd-2               Healthy             
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 集群正常后执行以下操作</span>
</span></span><span class=line><span class=cl>kubectl create -f bootstrap.secret.yaml
</span></span></code></pre></div><h1 id=node节点配置>node节点配置<a hidden class=anchor aria-hidden=true href=#node节点配置>#</a></h1><h2 id=在master01上将证书复制到node节点>在master01上将证书复制到node节点<a hidden class=anchor aria-hidden=true href=#在master01上将证书复制到node节点>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /etc/kubernetes/
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=k>for</span> NODE in k8s-master02 k8s-master03 k8s-node01 k8s-node02<span class=p>;</span> <span class=k>do</span> ssh <span class=nv>$NODE</span> mkdir -p /etc/kubernetes/pki<span class=p>;</span> <span class=k>for</span> FILE in pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig kube-proxy.kubeconfig<span class=p>;</span> <span class=k>do</span> scp /etc/kubernetes/<span class=nv>$FILE</span> <span class=nv>$NODE</span>:/etc/kubernetes/<span class=si>${</span><span class=nv>FILE</span><span class=si>}</span><span class=p>;</span> <span class=k>done</span><span class=p>;</span> <span class=k>done</span>
</span></span></code></pre></div><h2 id=kubelet配置>kubelet配置<a hidden class=anchor aria-hidden=true href=#kubelet配置>#</a></h2><h3 id=当使用docker作为runtime>当使用docker作为Runtime<a hidden class=anchor aria-hidden=true href=#当使用docker作为runtime>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; /usr/lib/systemd/system/kubelet.service <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=Kubernetes Kubelet
</span></span></span><span class=line><span class=cl><span class=s>Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/bin/kubelet \\
</span></span></span><span class=line><span class=cl><span class=s>    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \\
</span></span></span><span class=line><span class=cl><span class=s>    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\
</span></span></span><span class=line><span class=cl><span class=s>    --config=/etc/kubernetes/kubelet-conf.yml \\
</span></span></span><span class=line><span class=cl><span class=s>    --container-runtime-endpoint=unix:///run/cri-dockerd.sock  \\
</span></span></span><span class=line><span class=cl><span class=s>    --node-labels=node.kubernetes.io/node=
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h3 id=当使用containerd作为runtime-推荐>当使用Containerd作为Runtime (推荐)<a hidden class=anchor aria-hidden=true href=#当使用containerd作为runtime-推荐>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -p /var/lib/kubelet /var/log/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 所有k8s节点配置kubelet service</span>
</span></span><span class=line><span class=cl>cat &gt; /usr/lib/systemd/system/kubelet.service <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=Kubernetes Kubelet
</span></span></span><span class=line><span class=cl><span class=s>Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span class=line><span class=cl><span class=s>After=containerd.service
</span></span></span><span class=line><span class=cl><span class=s>Requires=containerd.service
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/bin/kubelet \\
</span></span></span><span class=line><span class=cl><span class=s>    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \\
</span></span></span><span class=line><span class=cl><span class=s>    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\
</span></span></span><span class=line><span class=cl><span class=s>    --config=/etc/kubernetes/kubelet-conf.yml \\
</span></span></span><span class=line><span class=cl><span class=s>    --container-runtime-endpoint=unix:///run/containerd/containerd.sock  \\
</span></span></span><span class=line><span class=cl><span class=s>    --node-labels=node.kubernetes.io/node=
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h3 id=所有k8s节点创建kubelet的配置文件>所有k8s节点创建kubelet的配置文件<a hidden class=anchor aria-hidden=true href=#所有k8s节点创建kubelet的配置文件>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; /etc/kubernetes/kubelet-conf.yml <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: kubelet.config.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: KubeletConfiguration
</span></span></span><span class=line><span class=cl><span class=s>address: 0.0.0.0
</span></span></span><span class=line><span class=cl><span class=s>port: 10250
</span></span></span><span class=line><span class=cl><span class=s>readOnlyPort: 10255
</span></span></span><span class=line><span class=cl><span class=s>authentication:
</span></span></span><span class=line><span class=cl><span class=s>  anonymous:
</span></span></span><span class=line><span class=cl><span class=s>    enabled: false
</span></span></span><span class=line><span class=cl><span class=s>  webhook:
</span></span></span><span class=line><span class=cl><span class=s>    cacheTTL: 2m0s
</span></span></span><span class=line><span class=cl><span class=s>    enabled: true
</span></span></span><span class=line><span class=cl><span class=s>  x509:
</span></span></span><span class=line><span class=cl><span class=s>    clientCAFile: /etc/kubernetes/pki/ca.pem
</span></span></span><span class=line><span class=cl><span class=s>authorization:
</span></span></span><span class=line><span class=cl><span class=s>  mode: Webhook
</span></span></span><span class=line><span class=cl><span class=s>  webhook:
</span></span></span><span class=line><span class=cl><span class=s>    cacheAuthorizedTTL: 5m0s
</span></span></span><span class=line><span class=cl><span class=s>    cacheUnauthorizedTTL: 30s
</span></span></span><span class=line><span class=cl><span class=s>cgroupDriver: systemd
</span></span></span><span class=line><span class=cl><span class=s>cgroupsPerQOS: true
</span></span></span><span class=line><span class=cl><span class=s>clusterDNS:
</span></span></span><span class=line><span class=cl><span class=s>- 10.96.0.10
</span></span></span><span class=line><span class=cl><span class=s>clusterDomain: cluster.local
</span></span></span><span class=line><span class=cl><span class=s>containerLogMaxFiles: 5
</span></span></span><span class=line><span class=cl><span class=s>containerLogMaxSize: 10Mi
</span></span></span><span class=line><span class=cl><span class=s>contentType: application/vnd.kubernetes.protobuf
</span></span></span><span class=line><span class=cl><span class=s>cpuCFSQuota: true
</span></span></span><span class=line><span class=cl><span class=s>cpuManagerPolicy: none
</span></span></span><span class=line><span class=cl><span class=s>cpuManagerReconcilePeriod: 10s
</span></span></span><span class=line><span class=cl><span class=s>enableControllerAttachDetach: true
</span></span></span><span class=line><span class=cl><span class=s>enableDebuggingHandlers: true
</span></span></span><span class=line><span class=cl><span class=s>enforceNodeAllocatable:
</span></span></span><span class=line><span class=cl><span class=s>- pods
</span></span></span><span class=line><span class=cl><span class=s>eventBurst: 10
</span></span></span><span class=line><span class=cl><span class=s>eventRecordQPS: 5
</span></span></span><span class=line><span class=cl><span class=s>evictionHard:
</span></span></span><span class=line><span class=cl><span class=s>  imagefs.available: 15%
</span></span></span><span class=line><span class=cl><span class=s>  memory.available: 100Mi
</span></span></span><span class=line><span class=cl><span class=s>  nodefs.available: 10%
</span></span></span><span class=line><span class=cl><span class=s>  nodefs.inodesFree: 5%
</span></span></span><span class=line><span class=cl><span class=s>evictionPressureTransitionPeriod: 5m0s
</span></span></span><span class=line><span class=cl><span class=s>failSwapOn: true
</span></span></span><span class=line><span class=cl><span class=s>fileCheckFrequency: 20s
</span></span></span><span class=line><span class=cl><span class=s>hairpinMode: promiscuous-bridge
</span></span></span><span class=line><span class=cl><span class=s>healthzBindAddress: 127.0.0.1
</span></span></span><span class=line><span class=cl><span class=s>healthzPort: 10248
</span></span></span><span class=line><span class=cl><span class=s>httpCheckFrequency: 20s
</span></span></span><span class=line><span class=cl><span class=s>imageGCHighThresholdPercent: 85
</span></span></span><span class=line><span class=cl><span class=s>imageGCLowThresholdPercent: 80
</span></span></span><span class=line><span class=cl><span class=s>imageMinimumGCAge: 2m0s
</span></span></span><span class=line><span class=cl><span class=s>iptablesDropBit: 15
</span></span></span><span class=line><span class=cl><span class=s>iptablesMasqueradeBit: 14
</span></span></span><span class=line><span class=cl><span class=s>kubeAPIBurst: 10
</span></span></span><span class=line><span class=cl><span class=s>kubeAPIQPS: 5
</span></span></span><span class=line><span class=cl><span class=s>makeIPTablesUtilChains: true
</span></span></span><span class=line><span class=cl><span class=s>maxOpenFiles: 1000000
</span></span></span><span class=line><span class=cl><span class=s>maxPods: 110
</span></span></span><span class=line><span class=cl><span class=s>nodeStatusUpdateFrequency: 10s
</span></span></span><span class=line><span class=cl><span class=s>oomScoreAdj: -999
</span></span></span><span class=line><span class=cl><span class=s>podPidsLimit: -1
</span></span></span><span class=line><span class=cl><span class=s>registryBurst: 10
</span></span></span><span class=line><span class=cl><span class=s>registryPullQPS: 5
</span></span></span><span class=line><span class=cl><span class=s>resolvConf: /etc/resolv.conf
</span></span></span><span class=line><span class=cl><span class=s>rotateCertificates: true
</span></span></span><span class=line><span class=cl><span class=s>runtimeRequestTimeout: 2m0s
</span></span></span><span class=line><span class=cl><span class=s>serializeImagePulls: true
</span></span></span><span class=line><span class=cl><span class=s>staticPodPath: /etc/kubernetes/manifests
</span></span></span><span class=line><span class=cl><span class=s>streamingConnectionIdleTimeout: 4h0m0s
</span></span></span><span class=line><span class=cl><span class=s>syncFrequency: 1m0s
</span></span></span><span class=line><span class=cl><span class=s>volumeStatsAggPeriod: 1m0s
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h3 id=启动kubelet>启动kubelet<a hidden class=anchor aria-hidden=true href=#启动kubelet>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> --now kubelet
</span></span><span class=line><span class=cl>systemctl restart kubelet
</span></span><span class=line><span class=cl>systemctl status kubelet
</span></span></code></pre></div><h3 id=查看集群>查看集群<a hidden class=anchor aria-hidden=true href=#查看集群>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># kubectl get node </span>
</span></span><span class=line><span class=cl>NAME           STATUS   ROLES    AGE   VERSION
</span></span><span class=line><span class=cl>k8s-master01   Ready    &lt;none&gt;   13d   v1.27.6
</span></span><span class=line><span class=cl>k8s-master02   Ready    &lt;none&gt;   13d   v1.27.6
</span></span><span class=line><span class=cl>k8s-master03   Ready    &lt;none&gt;   13d   v1.27.6
</span></span><span class=line><span class=cl>k8s-node01     Ready    &lt;none&gt;   13d   v1.27.6
</span></span><span class=line><span class=cl>k8s-node02     Ready    &lt;none&gt;   13d   v1.27.6
</span></span></code></pre></div><h3 id=查看容器运行时>查看容器运行时<a hidden class=anchor aria-hidden=true href=#查看容器运行时>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># containerd</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl describe node | grep Runtime</span>
</span></span><span class=line><span class=cl>  Container Runtime Version:  containerd://1.7.6
</span></span><span class=line><span class=cl>  Container Runtime Version:  containerd://1.7.6
</span></span><span class=line><span class=cl>  Container Runtime Version:  containerd://1.7.6
</span></span><span class=line><span class=cl>  Container Runtime Version:  containerd://1.7.6
</span></span><span class=line><span class=cl>  Container Runtime Version:  containerd://1.7.6
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># docker</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl describe node | grep Runtime</span>
</span></span><span class=line><span class=cl>  Container Runtime Version:  docker://24.0.2
</span></span><span class=line><span class=cl>  Container Runtime Version:  docker://24.0.2
</span></span><span class=line><span class=cl>  Container Runtime Version:  docker://24.0.2
</span></span><span class=line><span class=cl>  Container Runtime Version:  docker://24.0.2
</span></span><span class=line><span class=cl>  Container Runtime Version:  docker://24.0.2
</span></span></code></pre></div><h2 id=kube-proxy配置>kube-proxy配置<a hidden class=anchor aria-hidden=true href=#kube-proxy配置>#</a></h2><h3 id=将kubeconfig发送至其他节点>将kubeconfig发送至其他节点<a hidden class=anchor aria-hidden=true href=#将kubeconfig发送至其他节点>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>for</span> NODE in k8s-master02 k8s-master03 k8s-node01 k8s-node02<span class=p>;</span> <span class=k>do</span> scp /etc/kubernetes/kube-proxy.kubeconfig <span class=nv>$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig<span class=p>;</span> <span class=k>done</span>
</span></span></code></pre></div><h3 id=所有k8s节点添加kube-proxy的service文件>所有k8s节点添加kube-proxy的service文件<a hidden class=anchor aria-hidden=true href=#所有k8s节点添加kube-proxy的service文件>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt;  /usr/lib/systemd/system/kube-proxy.service <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=Kubernetes Kube Proxy
</span></span></span><span class=line><span class=cl><span class=s>Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span class=line><span class=cl><span class=s>After=network.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/bin/kube-proxy \\
</span></span></span><span class=line><span class=cl><span class=s>  --config=/etc/kubernetes/kube-proxy.yaml \\
</span></span></span><span class=line><span class=cl><span class=s>  --v=2
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>Restart=always
</span></span></span><span class=line><span class=cl><span class=s>RestartSec=10s
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h3 id=所有k8s节点添加kube-proxy的配置>所有k8s节点添加kube-proxy的配置<a hidden class=anchor aria-hidden=true href=#所有k8s节点添加kube-proxy的配置>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; /etc/kubernetes/kube-proxy.yaml <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span></span><span class=line><span class=cl><span class=s>bindAddress: 0.0.0.0
</span></span></span><span class=line><span class=cl><span class=s>clientConnection:
</span></span></span><span class=line><span class=cl><span class=s>  acceptContentTypes: &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>  burst: 10
</span></span></span><span class=line><span class=cl><span class=s>  contentType: application/vnd.kubernetes.protobuf
</span></span></span><span class=line><span class=cl><span class=s>  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig
</span></span></span><span class=line><span class=cl><span class=s>  qps: 5
</span></span></span><span class=line><span class=cl><span class=s>clusterCIDR: 172.16.0.0/12,fc00:2222::/112
</span></span></span><span class=line><span class=cl><span class=s>configSyncPeriod: 15m0s
</span></span></span><span class=line><span class=cl><span class=s>conntrack:
</span></span></span><span class=line><span class=cl><span class=s>  max: null
</span></span></span><span class=line><span class=cl><span class=s>  maxPerCore: 32768
</span></span></span><span class=line><span class=cl><span class=s>  min: 131072
</span></span></span><span class=line><span class=cl><span class=s>  tcpCloseWaitTimeout: 1h0m0s
</span></span></span><span class=line><span class=cl><span class=s>  tcpEstablishedTimeout: 24h0m0s
</span></span></span><span class=line><span class=cl><span class=s>enableProfiling: false
</span></span></span><span class=line><span class=cl><span class=s>healthzBindAddress: 0.0.0.0:10256
</span></span></span><span class=line><span class=cl><span class=s>hostnameOverride: &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>iptables:
</span></span></span><span class=line><span class=cl><span class=s>  masqueradeAll: false
</span></span></span><span class=line><span class=cl><span class=s>  masqueradeBit: 14
</span></span></span><span class=line><span class=cl><span class=s>  minSyncPeriod: 0s
</span></span></span><span class=line><span class=cl><span class=s>  syncPeriod: 30s
</span></span></span><span class=line><span class=cl><span class=s>ipvs:
</span></span></span><span class=line><span class=cl><span class=s>  masqueradeAll: true
</span></span></span><span class=line><span class=cl><span class=s>  minSyncPeriod: 5s
</span></span></span><span class=line><span class=cl><span class=s>  scheduler: &#34;rr&#34;
</span></span></span><span class=line><span class=cl><span class=s>  syncPeriod: 30s
</span></span></span><span class=line><span class=cl><span class=s>kind: KubeProxyConfiguration
</span></span></span><span class=line><span class=cl><span class=s>metricsBindAddress: 127.0.0.1:10249
</span></span></span><span class=line><span class=cl><span class=s>mode: &#34;ipvs&#34;
</span></span></span><span class=line><span class=cl><span class=s>nodePortAddresses: null
</span></span></span><span class=line><span class=cl><span class=s>oomScoreAdj: -999
</span></span></span><span class=line><span class=cl><span class=s>portRange: &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>udpIdleTimeout: 250ms
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h3 id=启动kube-proxy>启动kube-proxy<a hidden class=anchor aria-hidden=true href=#启动kube-proxy>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> systemctl daemon-reload
</span></span><span class=line><span class=cl> systemctl restart kube-proxy
</span></span><span class=line><span class=cl> systemctl <span class=nb>enable</span> --now kube-proxy
</span></span><span class=line><span class=cl> systemctl status kube-proxy
</span></span></code></pre></div><h1 id=安装网络插件>安装网络插件<a hidden class=anchor aria-hidden=true href=#安装网络插件>#</a></h1><ul><li><strong>注意: 网络插件calico和cilium二选一即可</strong></li></ul><h2 id=升级runc可选>升级runc(可选)<a hidden class=anchor aria-hidden=true href=#升级runc可选>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># https://github.com/opencontainers/runc/releases</span>
</span></span><span class=line><span class=cl><span class=c1># 升级runc</span>
</span></span><span class=line><span class=cl><span class=c1># wget https://ghproxy.com/https://github.com/opencontainers/runc/releases/download/v1.1.4/runc.amd64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>install -m <span class=m>755</span> runc.amd64 /usr/local/sbin/runc
</span></span><span class=line><span class=cl>cp -p /usr/local/sbin/runc  /usr/local/bin/runc
</span></span><span class=line><span class=cl>cp -p /usr/local/sbin/runc  /usr/bin/runc
</span></span></code></pre></div><h2 id=安装calico>安装Calico<a hidden class=anchor aria-hidden=true href=#安装calico>#</a></h2><h3 id=更改calico网段>更改calico网段<a hidden class=anchor aria-hidden=true href=#更改calico网段>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://ghproxy.com/https://github.com/projectcalico/calico/blob/master/manifests/calico-typha.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp calico-typha.yaml calico.yaml
</span></span><span class=line><span class=cl>cp calico-typha.yaml calico-ipv6.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># vi calico.yaml</span>
</span></span><span class=line><span class=cl><span class=c1># 需要更新以下配置：</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ipam&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;calico-ipam&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    - name: IP
</span></span><span class=line><span class=cl>      value: <span class=s2>&#34;autodetect&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    - name: CALICO_IPV4POOL_CIDR
</span></span><span class=line><span class=cl>      value: <span class=s2>&#34;172.16.0.0/12&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># vi calico-ipv6.yaml</span>
</span></span><span class=line><span class=cl><span class=c1># 需要更新以下配置：</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ipam&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;calico-ipam&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;assign_ipv4&#34;</span>: <span class=s2>&#34;true&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;assign_ipv6&#34;</span>: <span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    - name: IP
</span></span><span class=line><span class=cl>      value: <span class=s2>&#34;autodetect&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    - name: IP6
</span></span><span class=line><span class=cl>      value: <span class=s2>&#34;autodetect&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    - name: CALICO_IPV4POOL_CIDR
</span></span><span class=line><span class=cl>      value: <span class=s2>&#34;172.16.0.0/12&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    - name: CALICO_IPV6POOL_CIDR
</span></span><span class=line><span class=cl>      value: <span class=s2>&#34;fc00::/48&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    - name: FELIX_IPV6SUPPORT
</span></span><span class=line><span class=cl>      value: <span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 若docker镜像拉不下来，可以使用国内的仓库</span>
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s#docker.io/calico/#m.daocloud.io/docker.io/calico/#g&#34;</span> calico.yaml 
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s#docker.io/calico/#m.daocloud.io/docker.io/calico/#g&#34;</span> calico-ipv6.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 本地没有公网 IPv6 使用 calico.yaml</span>
</span></span><span class=line><span class=cl>kubectl apply -f calico.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 本地有公网 IPv6 使用 calico-ipv6.yaml </span>
</span></span><span class=line><span class=cl>kubectl apply -f calico-ipv6.yaml 
</span></span></code></pre></div><h3 id=查看容器状态>查看容器状态<a hidden class=anchor aria-hidden=true href=#查看容器状态>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># calico 初始化会很慢 需要耐心等待一下</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl get pod -A</span>
</span></span><span class=line><span class=cl>NAMESPACE       NAME                                        READY   STATUS      RESTARTS      AGE
</span></span><span class=line><span class=cl>kube-system     calico-kube-controllers-76754ff848-gmx8n    1/1     Running     <span class=m>3</span> <span class=o>(</span>29h ago<span class=o>)</span>   13d
</span></span><span class=line><span class=cl>kube-system     calico-node-845jj                           1/1     Running     <span class=m>2</span> <span class=o>(</span>47h ago<span class=o>)</span>   13d
</span></span><span class=line><span class=cl>kube-system     calico-node-m7p9n                           1/1     Running     <span class=m>2</span> <span class=o>(</span>47h ago<span class=o>)</span>   13d
</span></span><span class=line><span class=cl>kube-system     calico-node-qqj7g                           1/1     Running     <span class=m>2</span> <span class=o>(</span>47h ago<span class=o>)</span>   13d
</span></span><span class=line><span class=cl>kube-system     calico-node-rfq9m                           1/1     Running     <span class=m>4</span> <span class=o>(</span>11m ago<span class=o>)</span>   13d
</span></span><span class=line><span class=cl>kube-system     calico-node-tdnmt                           1/1     Running     <span class=m>3</span> <span class=o>(</span>29h ago<span class=o>)</span>   13d
</span></span><span class=line><span class=cl>kube-system     calico-typha-59d75c5dd4-8fg4d               1/1     Running     <span class=m>2</span> <span class=o>(</span>47h ago<span class=o>)</span>   13d
</span></span></code></pre></div><h2 id=安装cilium示例>安装cilium(示例)<a hidden class=anchor aria-hidden=true href=#安装cilium示例>#</a></h2><h3 id=安装helm示例>安装helm(示例)<a hidden class=anchor aria-hidden=true href=#安装helm示例>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3</span>
</span></span><span class=line><span class=cl><span class=c1># chmod 700 get_helm.sh</span>
</span></span><span class=line><span class=cl><span class=c1># ./get_helm.sh</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>wget https://files.m.daocloud.io/get.helm.sh/helm-v3.12.1-linux-amd64.tar.gz
</span></span><span class=line><span class=cl>tar xvf helm-*-linux-amd64.tar.gz
</span></span><span class=line><span class=cl>cp linux-amd64/helm /usr/local/bin/
</span></span></code></pre></div><h3 id=安装示例>安装(示例)<a hidden class=anchor aria-hidden=true href=#安装示例>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 添加源</span>
</span></span><span class=line><span class=cl>helm repo add cilium https://helm.cilium.io
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改为国内源</span>
</span></span><span class=line><span class=cl>helm pull cilium/cilium
</span></span><span class=line><span class=cl>tar xvf cilium-*.tgz
</span></span><span class=line><span class=cl><span class=nb>cd</span> cilium/
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s#quay.io/#m.daocloud.io/quay.io/#g&#34;</span> values.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 默认参数安装</span>
</span></span><span class=line><span class=cl>helm install  cilium ./cilium/ -n kube-system
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启用ipv6</span>
</span></span><span class=line><span class=cl><span class=c1># helm install cilium cilium/cilium --namespace kube-system --set ipv6.enabled=true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启用路由信息和监控插件</span>
</span></span><span class=line><span class=cl><span class=c1># helm install cilium cilium/cilium --namespace kube-system --set hubble.relay.enabled=true --set hubble.ui.enabled=true --set prometheus.enabled=true --set operator.prometheus.enabled=true --set hubble.enabled=true --set hubble.metrics.enabled=&#34;{dns,drop,tcp,flow,port-distribution,icmp,http}&#34; </span>
</span></span></code></pre></div><h3 id=查看示例>查看(示例)<a hidden class=anchor aria-hidden=true href=#查看示例>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># kubectl  get pod -A | grep cilium</span>
</span></span><span class=line><span class=cl>kube-system   cilium-gmr6c                       1/1     Running       <span class=m>0</span>             5m3s
</span></span><span class=line><span class=cl>kube-system   cilium-kzgdj                       1/1     Running       <span class=m>0</span>             5m3s
</span></span><span class=line><span class=cl>kube-system   cilium-operator-69b677f97c-6pw4k   1/1     Running       <span class=m>0</span>             5m3s
</span></span><span class=line><span class=cl>kube-system   cilium-operator-69b677f97c-xzzdk   1/1     Running       <span class=m>0</span>             5m3s
</span></span><span class=line><span class=cl>kube-system   cilium-q2rnr                       1/1     Running       <span class=m>0</span>             5m3s
</span></span><span class=line><span class=cl>kube-system   cilium-smx5v                       1/1     Running       <span class=m>0</span>             5m3s
</span></span><span class=line><span class=cl>kube-system   cilium-tdjq4                       1/1     Running       <span class=m>0</span>             5m3s
</span></span></code></pre></div><h3 id=下载专属监控面板示例>下载专属监控面板(示例)<a hidden class=anchor aria-hidden=true href=#下载专属监控面板示例>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># wget https://ghproxy.com/https://raw.githubusercontent.com/cilium/cilium/1.12.1/examples/kubernetes/addons/prometheus/monitoring-example.yaml</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># sed -i &#34;s#docker.io/#m.daocloud.io/docker.io/#g&#34; monitoring-example.yaml</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># kubectl  apply -f monitoring-example.yaml</span>
</span></span><span class=line><span class=cl>namespace/cilium-monitoring created
</span></span><span class=line><span class=cl>serviceaccount/prometheus-k8s created
</span></span><span class=line><span class=cl>configmap/grafana-config created
</span></span><span class=line><span class=cl>configmap/grafana-cilium-dashboard created
</span></span><span class=line><span class=cl>configmap/grafana-cilium-operator-dashboard created
</span></span><span class=line><span class=cl>configmap/grafana-hubble-dashboard created
</span></span><span class=line><span class=cl>configmap/prometheus created
</span></span><span class=line><span class=cl>clusterrole.rbac.authorization.k8s.io/prometheus created
</span></span><span class=line><span class=cl>clusterrolebinding.rbac.authorization.k8s.io/prometheus created
</span></span><span class=line><span class=cl>service/grafana created
</span></span><span class=line><span class=cl>service/prometheus created
</span></span><span class=line><span class=cl>deployment.apps/grafana created
</span></span><span class=line><span class=cl>deployment.apps/prometheus created
</span></span></code></pre></div><h3 id=下载部署测试用例示例>下载部署测试用例(示例)<a hidden class=anchor aria-hidden=true href=#下载部署测试用例示例>#</a></h3><ul><li>说明 测试用例 需要在 安装CoreDNS 之后完成</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># wget https://ghproxy.com/https://raw.githubusercontent.com/cilium/cilium/master/examples/kubernetes/connectivity-check/connectivity-check.yaml</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># sed -i &#34;s#google.com#baidu.cn#g&#34; connectivity-check.yaml</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s#quay.io/#m.daocloud.io/quay.io/#g&#34;</span> connectivity-check.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># kubectl  apply -f connectivity-check.yaml</span>
</span></span><span class=line><span class=cl>deployment.apps/echo-a created
</span></span><span class=line><span class=cl>deployment.apps/echo-b created
</span></span><span class=line><span class=cl>deployment.apps/echo-b-host created
</span></span><span class=line><span class=cl>deployment.apps/pod-to-a created
</span></span><span class=line><span class=cl>deployment.apps/pod-to-external-1111 created
</span></span><span class=line><span class=cl>deployment.apps/pod-to-a-denied-cnp created
</span></span><span class=line><span class=cl>deployment.apps/pod-to-a-allowed-cnp created
</span></span><span class=line><span class=cl>deployment.apps/pod-to-external-fqdn-allow-google-cnp created
</span></span><span class=line><span class=cl>deployment.apps/pod-to-b-multi-node-clusterip created
</span></span><span class=line><span class=cl>deployment.apps/pod-to-b-multi-node-headless created
</span></span><span class=line><span class=cl>deployment.apps/host-to-b-multi-node-clusterip created
</span></span><span class=line><span class=cl>deployment.apps/host-to-b-multi-node-headless created
</span></span><span class=line><span class=cl>deployment.apps/pod-to-b-multi-node-nodeport created
</span></span><span class=line><span class=cl>deployment.apps/pod-to-b-intra-node-nodeport created
</span></span><span class=line><span class=cl>service/echo-a created
</span></span><span class=line><span class=cl>service/echo-b created
</span></span><span class=line><span class=cl>service/echo-b-headless created
</span></span><span class=line><span class=cl>service/echo-b-host-headless created
</span></span><span class=line><span class=cl>ciliumnetworkpolicy.cilium.io/pod-to-a-denied-cnp created
</span></span><span class=line><span class=cl>ciliumnetworkpolicy.cilium.io/pod-to-a-allowed-cnp created
</span></span><span class=line><span class=cl>ciliumnetworkpolicy.cilium.io/pod-to-external-fqdn-allow-google-cnp created
</span></span></code></pre></div><h3 id=查看pod示例>查看pod(示例)<a hidden class=anchor aria-hidden=true href=#查看pod示例>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># kubectl  get pod -A</span>
</span></span><span class=line><span class=cl>NAMESPACE           NAME                                                     READY   STATUS    RESTARTS      AGE
</span></span><span class=line><span class=cl>cilium-monitoring   grafana-59957b9549-6zzqh                                 1/1     Running   <span class=m>0</span>             10m
</span></span><span class=line><span class=cl>cilium-monitoring   prometheus-7c8c9684bb-4v9cl                              1/1     Running   <span class=m>0</span>             10m
</span></span><span class=line><span class=cl>default             test-75b5d7fbfb-7zjsr                                    1/1     Running   <span class=m>0</span>             27h
</span></span><span class=line><span class=cl>default             test-75b5d7fbfb-hbvr8                                    1/1     Running   <span class=m>0</span>             27h
</span></span><span class=line><span class=cl>default             test-75b5d7fbfb-ppbzg                                    1/1     Running   <span class=m>0</span>             27h
</span></span><span class=line><span class=cl>default             echo-a-6799dff547-pnx6w                                  1/1     Running   <span class=m>0</span>             10m
</span></span><span class=line><span class=cl>default             echo-b-fc47b659c-4bdg9                                   1/1     Running   <span class=m>0</span>             10m
</span></span><span class=line><span class=cl>default             echo-b-host-67fcfd59b7-28r9s                             1/1     Running   <span class=m>0</span>             10m
</span></span><span class=line><span class=cl>default             host-to-b-multi-node-clusterip-69c57975d6-z4j2z          1/1     Running   <span class=m>0</span>             10m
</span></span><span class=line><span class=cl>default             host-to-b-multi-node-headless-865899f7bb-frrmc           1/1     Running   <span class=m>0</span>             10m
</span></span><span class=line><span class=cl>default             pod-to-a-allowed-cnp-5f9d7d4b9d-hcd8x                    1/1     Running   <span class=m>0</span>             10m
</span></span><span class=line><span class=cl>default             pod-to-a-denied-cnp-65cc5ff97b-2rzb8                     1/1     Running   <span class=m>0</span>             10m
</span></span><span class=line><span class=cl>default             pod-to-a-dfc64f564-p7xcn                                 1/1     Running   <span class=m>0</span>             10m
</span></span><span class=line><span class=cl>default             pod-to-b-intra-node-nodeport-677868746b-trk2l            1/1     Running   <span class=m>0</span>             10m
</span></span><span class=line><span class=cl>default             pod-to-b-multi-node-clusterip-76bbbc677b-knfq2           1/1     Running   <span class=m>0</span>             10m
</span></span><span class=line><span class=cl>default             pod-to-b-multi-node-headless-698c6579fd-mmvd7            1/1     Running   <span class=m>0</span>             10m
</span></span><span class=line><span class=cl>default             pod-to-b-multi-node-nodeport-5dc4b8cfd6-8dxmz            1/1     Running   <span class=m>0</span>             10m
</span></span><span class=line><span class=cl>default             pod-to-external-1111-8459965778-pjt9b                    1/1     Running   <span class=m>0</span>             10m
</span></span><span class=line><span class=cl>default             pod-to-external-fqdn-allow-google-cnp-64df9fb89b-l9l4q   1/1     Running   <span class=m>0</span>             10m
</span></span><span class=line><span class=cl>kube-system         cilium-7rfj6                                             1/1     Running   <span class=m>0</span>             56s
</span></span><span class=line><span class=cl>kube-system         cilium-d4cch                                             1/1     Running   <span class=m>0</span>             56s
</span></span><span class=line><span class=cl>kube-system         cilium-h5x8r                                             1/1     Running   <span class=m>0</span>             56s
</span></span><span class=line><span class=cl>kube-system         cilium-operator-5dbddb6dbf-flpl5                         1/1     Running   <span class=m>0</span>             56s
</span></span><span class=line><span class=cl>kube-system         cilium-operator-5dbddb6dbf-gcznc                         1/1     Running   <span class=m>0</span>             56s
</span></span><span class=line><span class=cl>kube-system         cilium-t2xlz                                             1/1     Running   <span class=m>0</span>             56s
</span></span><span class=line><span class=cl>kube-system         cilium-z65z7                                             1/1     Running   <span class=m>0</span>             56s
</span></span><span class=line><span class=cl>kube-system         coredns-665475b9f8-jkqn8                                 1/1     Running   <span class=m>1</span> <span class=o>(</span>36h ago<span class=o>)</span>   36h
</span></span><span class=line><span class=cl>kube-system         hubble-relay-59d8575-9pl9z                               1/1     Running   <span class=m>0</span>             56s
</span></span><span class=line><span class=cl>kube-system         hubble-ui-64d4995d57-nsv9j                               2/2     Running   <span class=m>0</span>             56s
</span></span><span class=line><span class=cl>kube-system         metrics-server-776f58c94b-c6zgs                          1/1     Running   <span class=m>1</span> <span class=o>(</span>36h ago<span class=o>)</span>   37h
</span></span></code></pre></div><h3 id=修改为nodeport示例>修改为NodePort(示例)<a hidden class=anchor aria-hidden=true href=#修改为nodeport示例>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># kubectl  edit svc  -n kube-system hubble-ui</span>
</span></span><span class=line><span class=cl>service/hubble-ui edited
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># kubectl  edit svc  -n cilium-monitoring grafana</span>
</span></span><span class=line><span class=cl>service/grafana edited
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># kubectl  edit svc  -n cilium-monitoring prometheus</span>
</span></span><span class=line><span class=cl>service/prometheus edited
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>type: NodePort
</span></span></code></pre></div><h3 id=查看端口示例>查看端口(示例)<a hidden class=anchor aria-hidden=true href=#查看端口示例>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># kubectl get svc -A | grep monit</span>
</span></span><span class=line><span class=cl>cilium-monitoring   grafana                NodePort    10.100.250.17    &lt;none&gt;        3000:30707/TCP           15m
</span></span><span class=line><span class=cl>cilium-monitoring   prometheus             NodePort    10.100.131.243   &lt;none&gt;        9090:31155/TCP           15m
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># kubectl get svc -A | grep hubble</span>
</span></span><span class=line><span class=cl>kube-system         hubble-metrics         ClusterIP   None             &lt;none&gt;        9965/TCP                 5m12s
</span></span><span class=line><span class=cl>kube-system         hubble-peer            ClusterIP   10.100.150.29    &lt;none&gt;        443/TCP                  5m12s
</span></span><span class=line><span class=cl>kube-system         hubble-relay           ClusterIP   10.109.251.34    &lt;none&gt;        80/TCP                   5m12s
</span></span><span class=line><span class=cl>kube-system         hubble-ui              NodePort    10.102.253.59    &lt;none&gt;        80:31219/TCP             5m12s
</span></span></code></pre></div><h3 id=访问示例>访问(示例)<a hidden class=anchor aria-hidden=true href=#访问示例>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>http://192.168.100.101:30707
</span></span><span class=line><span class=cl>http://192.168.100.101:31155
</span></span><span class=line><span class=cl>http://192.168.100.101:31219
</span></span></code></pre></div><h1 id=安装coredns>安装CoreDNS<a hidden class=anchor aria-hidden=true href=#安装coredns>#</a></h1><ul><li>以下步骤只在master01操作</li></ul><h2 id=修改文件>修改文件<a hidden class=anchor aria-hidden=true href=#修改文件>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 下载tgz包</span>
</span></span><span class=line><span class=cl>helm repo add coredns https://coredns.github.io/helm
</span></span><span class=line><span class=cl>helm pull coredns/coredns
</span></span><span class=line><span class=cl>tar xvf coredns-*.tgz
</span></span><span class=line><span class=cl><span class=nb>cd</span> coredns/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改IP地址</span>
</span></span><span class=line><span class=cl>vi values.yaml
</span></span><span class=line><span class=cl>cat values.yaml <span class=p>|</span> grep clusterIP:
</span></span><span class=line><span class=cl>clusterIP: <span class=s2>&#34;10.96.0.10&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 示例</span>
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>service:
</span></span><span class=line><span class=cl><span class=c1># clusterIP: &#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># clusterIPs: []</span>
</span></span><span class=line><span class=cl><span class=c1># loadBalancerIP: &#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># externalIPs: []</span>
</span></span><span class=line><span class=cl><span class=c1># externalTrafficPolicy: &#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># ipFamilyPolicy: &#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=c1># The name of the Service</span>
</span></span><span class=line><span class=cl>  <span class=c1># If not set, a name is generated using the fullname template</span>
</span></span><span class=line><span class=cl>  clusterIP: <span class=s2>&#34;10.96.0.10&#34;</span>
</span></span><span class=line><span class=cl>  name: <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>  annotations: <span class=o>{}</span>
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改为国内源 docker源可选</span>
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s#coredns/#m.daocloud.io/docker.io/coredns/#g&#34;</span> values.yaml
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s#registry.k8s.io/#m.daocloud.io/registry.k8s.io/#g&#34;</span> values.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 默认参数安装</span>
</span></span><span class=line><span class=cl>helm install  coredns ./coredns/ -n kube-system
</span></span></code></pre></div><h1 id=安装metrics-server>安装Metrics Server<a hidden class=anchor aria-hidden=true href=#安装metrics-server>#</a></h1><ul><li>以下步骤只在master01操作</li></ul><h2 id=安装>安装<a hidden class=anchor aria-hidden=true href=#安装>#</a></h2><p>在新版的Kubernetes中系统资源的采集均使用Metrics-server，可以通过Metrics采集节点和Pod的内存、磁盘、CPU和网络的使用率</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 单机版 </span>
</span></span><span class=line><span class=cl>wget https://ghproxy.com/https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
</span></span><span class=line><span class=cl><span class=c1># 高可用版本</span>
</span></span><span class=line><span class=cl>wget https://ghproxy.com/https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/high-availability.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改配置</span>
</span></span><span class=line><span class=cl>vim components.yaml
</span></span><span class=line><span class=cl>vim high-availability.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl><span class=c1># 1</span>
</span></span><span class=line><span class=cl>defaultArgs:
</span></span><span class=line><span class=cl>  - --cert-dir<span class=o>=</span>/tmp
</span></span><span class=line><span class=cl>  - --kubelet-preferred-address-types<span class=o>=</span>InternalIP,ExternalIP,Hostname
</span></span><span class=line><span class=cl>  - --kubelet-use-node-status-port
</span></span><span class=line><span class=cl>  - --metric-resolution<span class=o>=</span>15s
</span></span><span class=line><span class=cl>  - --kubelet-insecure-tls
</span></span><span class=line><span class=cl>  - --requestheader-client-ca-file<span class=o>=</span>/etc/kubernetes/pki/front-proxy-ca.pem
</span></span><span class=line><span class=cl>  - --requestheader-username-headers<span class=o>=</span>X-Remote-User
</span></span><span class=line><span class=cl>  - --requestheader-group-headers<span class=o>=</span>X-Remote-Group
</span></span><span class=line><span class=cl>  - --requestheader-extra-headers-prefix<span class=o>=</span>X-Remote-Extra-
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2</span>
</span></span><span class=line><span class=cl>        volumeMounts:
</span></span><span class=line><span class=cl>        - mountPath: /tmp
</span></span><span class=line><span class=cl>          name: tmp-dir
</span></span><span class=line><span class=cl>        - name: ca-ssl
</span></span><span class=line><span class=cl>          mountPath: /etc/kubernetes/pki
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3</span>
</span></span><span class=line><span class=cl>      volumes:
</span></span><span class=line><span class=cl>      - emptyDir: <span class=o>{}</span>
</span></span><span class=line><span class=cl>        name: tmp-dir
</span></span><span class=line><span class=cl>      - name: ca-ssl
</span></span><span class=line><span class=cl>        hostPath:
</span></span><span class=line><span class=cl>          path: /etc/kubernetes/pki
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改为国内源 docker源可选</span>
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s#registry.k8s.io/#m.daocloud.io/registry.k8s.io/#g&#34;</span> *.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 二选一</span>
</span></span><span class=line><span class=cl>kubectl apply -f components.yaml
</span></span><span class=line><span class=cl><span class=c1># kubectl apply -f high-availability.yaml</span>
</span></span></code></pre></div><h2 id=查看状态>查看状态<a hidden class=anchor aria-hidden=true href=#查看状态>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># kubectl top node</span>
</span></span><span class=line><span class=cl>NAME           CPU<span class=o>(</span>cores<span class=o>)</span>   CPU%   MEMORY<span class=o>(</span>bytes<span class=o>)</span>   MEMORY%   
</span></span><span class=line><span class=cl>k8s-master01   94m          2%     1344Mi          35%       
</span></span><span class=line><span class=cl>k8s-master02   98m          2%     1412Mi          36%       
</span></span><span class=line><span class=cl>k8s-master03   87m          2%     1351Mi          35%       
</span></span><span class=line><span class=cl>k8s-node01     51m          1%     756Mi           19%       
</span></span><span class=line><span class=cl>k8s-node02     57m          1%     475Mi           12%       
</span></span></code></pre></div><h1 id=集群验证>集群验证<a hidden class=anchor aria-hidden=true href=#集群验证>#</a></h1><h2 id=部署pod资源>部署pod资源<a hidden class=anchor aria-hidden=true href=#部署pod资源>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat<span class=s>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Pod
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: busybox
</span></span></span><span class=line><span class=cl><span class=s>  namespace: default
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  containers:
</span></span></span><span class=line><span class=cl><span class=s>  - name: busybox
</span></span></span><span class=line><span class=cl><span class=s>    image: docker.io/library/busybox:1.28
</span></span></span><span class=line><span class=cl><span class=s>    command:
</span></span></span><span class=line><span class=cl><span class=s>      - sleep
</span></span></span><span class=line><span class=cl><span class=s>      - &#34;3600&#34;
</span></span></span><span class=line><span class=cl><span class=s>    imagePullPolicy: IfNotPresent
</span></span></span><span class=line><span class=cl><span class=s>  restartPolicy: Always
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl get pod</span>
</span></span><span class=line><span class=cl>NAME      READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>busybox   1/1     Running   <span class=m>0</span>          17s
</span></span></code></pre></div><h2 id=用pod解析默认命名空间中的kubernetes>用pod解析默认命名空间中的kubernetes<a hidden class=anchor aria-hidden=true href=#用pod解析默认命名空间中的kubernetes>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看name</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl get svc</span>
</span></span><span class=line><span class=cl>NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>   AGE
</span></span><span class=line><span class=cl>kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   14d
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进行解析</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl exec  busybox -n default -- nslookup kubernetes</span>
</span></span><span class=line><span class=cl>Server:    10.96.0.10
</span></span><span class=line><span class=cl>Address 1: 10.96.0.10 coredns-coredns.kube-system.svc.cluster.local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Name:      kubernetes
</span></span><span class=line><span class=cl>Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local
</span></span></code></pre></div><h2 id=测试跨命名空间是否可以解析>测试跨命名空间是否可以解析<a hidden class=anchor aria-hidden=true href=#测试跨命名空间是否可以解析>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看有那些name</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl get svc -A</span>
</span></span><span class=line><span class=cl>NAMESPACE       NAME                                 TYPE           CLUSTER-IP       EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>                      AGE
</span></span><span class=line><span class=cl>default         kubernetes                           ClusterIP      10.96.0.1        &lt;none&gt;        443/TCP                      14d
</span></span><span class=line><span class=cl>ingress-nginx   ingress-nginx-controller             LoadBalancer   10.107.76.220    &lt;pending&gt;     80:30451/TCP,443:32101/TCP   13d
</span></span><span class=line><span class=cl>ingress-nginx   ingress-nginx-controller-admission   ClusterIP      10.110.40.24     &lt;none&gt;        443/TCP                      13d
</span></span><span class=line><span class=cl>kube-system     calico-typha                         ClusterIP      10.104.191.196   &lt;none&gt;        5473/TCP                     13d
</span></span><span class=line><span class=cl>kube-system     coredns-coredns                      ClusterIP      10.96.0.10       &lt;none&gt;        53/UDP,53/TCP                13d
</span></span><span class=line><span class=cl>kube-system     default-http-backend                 ClusterIP      10.100.145.35    &lt;none&gt;        80/TCP                       13d
</span></span><span class=line><span class=cl>kube-system     metrics-server                       ClusterIP      10.107.79.100    &lt;none&gt;        443/TCP                      13d
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进行解析</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl exec  busybox -n default -- nslookup coredns-coredns.kube-system</span>
</span></span><span class=line><span class=cl>Server:    10.96.0.10
</span></span><span class=line><span class=cl>Address 1: 10.96.0.10 coredns-coredns.kube-system.svc.cluster.local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Name:      coredns-coredns.kube-system
</span></span><span class=line><span class=cl>Address 1: 10.96.0.10 coredns-coredns.kube-system.svc.cluster.local
</span></span></code></pre></div><h2 id=每个节点都必须要能访问kubernetes的kubernetes-svc-443和kube-dns的service-53>每个节点都必须要能访问Kubernetes的kubernetes svc 443和kube-dns的service 53<a hidden class=anchor aria-hidden=true href=#每个节点都必须要能访问kubernetes的kubernetes-svc-443和kube-dns的service-53>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>telnet 10.96.0.1 <span class=m>443</span>
</span></span><span class=line><span class=cl>Trying 10.96.0.1...
</span></span><span class=line><span class=cl>Connected to 10.96.0.1.
</span></span><span class=line><span class=cl>Escape character is <span class=s1>&#39;^]&#39;</span>.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>telnet 10.96.0.10 <span class=m>53</span>
</span></span><span class=line><span class=cl>Trying 10.96.0.10...
</span></span><span class=line><span class=cl>Connected to 10.96.0.10.
</span></span><span class=line><span class=cl>Escape character is <span class=s1>&#39;^]&#39;</span>.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>curl 10.96.0.10:53
</span></span><span class=line><span class=cl>curl: <span class=o>(</span>52<span class=o>)</span> Empty reply from server
</span></span></code></pre></div><h2 id=pod和pod之间要能通>Pod和Pod之间要能通<a hidden class=anchor aria-hidden=true href=#pod和pod之间要能通>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># kubectl get po -owide</span>
</span></span><span class=line><span class=cl>NAME      READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES
</span></span><span class=line><span class=cl>busybox   1/1     Running   <span class=m>0</span>          18m   172.27.14.202   k8s-node02   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># kubectl get po -n kube-system -owide</span>
</span></span><span class=line><span class=cl>NAME                                       READY   STATUS    RESTARTS      AGE   IP                NODE           NOMINATED NODE   READINESS GATES
</span></span><span class=line><span class=cl>calico-kube-controllers-76754ff848-gmx8n   1/1     Running   <span class=m>3</span> <span class=o>(</span>30h ago<span class=o>)</span>   13d   172.25.244.199    k8s-master01   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>calico-node-845jj                          1/1     Running   <span class=m>2</span> <span class=o>(</span>2d ago<span class=o>)</span>    13d   192.168.100.102   k8s-master02   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>calico-node-m7p9n                          1/1     Running   <span class=m>2</span> <span class=o>(</span>2d ago<span class=o>)</span>    13d   192.168.100.103   k8s-master03   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>calico-node-qqj7g                          1/1     Running   <span class=m>2</span> <span class=o>(</span>2d ago<span class=o>)</span>    13d   192.168.100.104   k8s-node01     &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>calico-node-rfq9m                          1/1     Running   <span class=m>4</span> <span class=o>(</span>53m ago<span class=o>)</span>   13d   192.168.100.105   k8s-node02     &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>calico-node-tdnmt                          1/1     Running   <span class=m>3</span> <span class=o>(</span>30h ago<span class=o>)</span>   13d   192.168.100.101   k8s-master01   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>calico-typha-59d75c5dd4-8fg4d              1/1     Running   <span class=m>2</span> <span class=o>(</span>2d ago<span class=o>)</span>    13d   192.168.100.103   k8s-master03   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>coredns-coredns-5f4fc468-t5l96             1/1     Running   <span class=m>2</span> <span class=o>(</span>2d ago<span class=o>)</span>    13d   172.25.92.73      k8s-master02   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>default-http-backend-cf5544789-7qw27       1/1     Running   <span class=m>2</span> <span class=o>(</span>2d ago<span class=o>)</span>    13d   172.17.125.11     k8s-node01     &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>kubernetes-dashboard-5948b5f5d7-t2nkl      1/1     Running   <span class=m>3</span> <span class=o>(</span>2d ago<span class=o>)</span>    13d   172.25.92.74      k8s-master02   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>metrics-server-65875bc4f9-wcxlv            1/1     Running   <span class=m>4</span> <span class=o>(</span>2d ago<span class=o>)</span>    13d   172.17.125.10     k8s-node01     &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进入busybox ping其他节点上的pod</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#kubectl exec -ti busybox -- sh</span>
</span></span><span class=line><span class=cl><span class=c1># ping 192.168.100.102</span>
</span></span><span class=line><span class=cl>PING 192.168.100.102 <span class=o>(</span>192.168.100.102<span class=o>)</span>: <span class=m>56</span> data bytes
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 192.168.100.102: <span class=nv>seq</span><span class=o>=</span><span class=m>0</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>63</span> <span class=nv>time</span><span class=o>=</span>0.487 ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 192.168.100.102: <span class=nv>seq</span><span class=o>=</span><span class=m>1</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>63</span> <span class=nv>time</span><span class=o>=</span>0.432 ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 192.168.100.102: <span class=nv>seq</span><span class=o>=</span><span class=m>2</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>63</span> <span class=nv>time</span><span class=o>=</span>0.334 ms
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 可以连通证明这个pod是可以跨命名空间和跨主机通信的</span>
</span></span></code></pre></div><h2 id=创建三个副本可以看到3个副本分布在不同的节点上>创建三个副本，可以看到3个副本分布在不同的节点上<a hidden class=anchor aria-hidden=true href=#创建三个副本可以看到3个副本分布在不同的节点上>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; deployments.yaml <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: nginx-deployment
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app: nginx
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 3
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      app: nginx
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        app: nginx
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - name: nginx
</span></span></span><span class=line><span class=cl><span class=s>        image: nginx
</span></span></span><span class=line><span class=cl><span class=s>        ports:
</span></span></span><span class=line><span class=cl><span class=s>        - containerPort: 80
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># kubectl apply -f deployments.yaml </span>
</span></span><span class=line><span class=cl>deployment.apps/nginx-deployment created
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># kubectl get pod </span>
</span></span><span class=line><span class=cl>NAME                               READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>busybox                            1/1     Running   <span class=m>0</span>          21m
</span></span><span class=line><span class=cl>nginx-deployment-55f598f8d-4rnwj   1/1     Running   <span class=m>0</span>          8s
</span></span><span class=line><span class=cl>nginx-deployment-55f598f8d-tvfgk   1/1     Running   <span class=m>0</span>          8s
</span></span><span class=line><span class=cl>nginx-deployment-55f598f8d-xsc9p   1/1     Running   <span class=m>0</span>          8s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除nginx</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl delete -f deployments.yaml </span>
</span></span></code></pre></div><h1 id=安装dashboard>安装dashboard<a hidden class=anchor aria-hidden=true href=#安装dashboard>#</a></h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/
</span></span><span class=line><span class=cl>helm install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard --namespace kube-system
</span></span></code></pre></div><h2 id=更改dashboard的svc为nodeport>更改dashboard的svc为NodePort<a hidden class=anchor aria-hidden=true href=#更改dashboard的svc为nodeport>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># kubectl edit svc kubernetes-dashboard -n kube-system</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  type: NodePort
</span></span></code></pre></div><h2 id=查看端口号>查看端口号<a hidden class=anchor aria-hidden=true href=#查看端口号>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># kubectl get svc kubernetes-dashboard -n kube-system</span>
</span></span><span class=line><span class=cl>NAME                   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>         AGE
</span></span><span class=line><span class=cl>kubernetes-dashboard   NodePort   10.100.112.99   &lt;none&gt;        443:31048/TCP   13d
</span></span></code></pre></div><h2 id=创建token>创建token<a hidden class=anchor aria-hidden=true href=#创建token>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; dashboard-user.yaml <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: ServiceAccount
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: admin-user
</span></span></span><span class=line><span class=cl><span class=s>  namespace: kube-system
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: ClusterRoleBinding
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: admin-user
</span></span></span><span class=line><span class=cl><span class=s>roleRef:
</span></span></span><span class=line><span class=cl><span class=s>  apiGroup: rbac.authorization.k8s.io
</span></span></span><span class=line><span class=cl><span class=s>  kind: ClusterRole
</span></span></span><span class=line><span class=cl><span class=s>  name: cluster-admin
</span></span></span><span class=line><span class=cl><span class=s>subjects:
</span></span></span><span class=line><span class=cl><span class=s>- kind: ServiceAccount
</span></span></span><span class=line><span class=cl><span class=s>  name: admin-user
</span></span></span><span class=line><span class=cl><span class=s>  namespace: kube-system
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># kubectl  apply -f dashboard-user.yaml</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建token</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl -n kube-system create token admin-user</span>
</span></span><span class=line><span class=cl>eyJhbGciOiJSUzI1NiIsImtpZCI6IlA1MVFqS1lwOTU2S1pMSWxC......
</span></span></code></pre></div><h2 id=登录dashboard>登录dashboard<a hidden class=anchor aria-hidden=true href=#登录dashboard>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>https://192.168.100.100:31048
</span></span></code></pre></div><h1 id=ingress安装>ingress安装<a hidden class=anchor aria-hidden=true href=#ingress安装>#</a></h1><h2 id=部署>部署<a hidden class=anchor aria-hidden=true href=#部署>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://ghproxy.com/https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改为国内源 docker源可选</span>
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s#registry.k8s.io/#m.daocloud.io/registry.k8s.io/#g&#34;</span> *.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt; backend.yaml <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: default-http-backend
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/name: default-http-backend
</span></span></span><span class=line><span class=cl><span class=s>  namespace: kube-system
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 1
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      app.kubernetes.io/name: default-http-backend
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        app.kubernetes.io/name: default-http-backend
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      terminationGracePeriodSeconds: 60
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - name: default-http-backend
</span></span></span><span class=line><span class=cl><span class=s>        image: registry.cn-hangzhou.aliyuncs.com/test/defaultbackend-amd64:1.5 
</span></span></span><span class=line><span class=cl><span class=s>        livenessProbe:
</span></span></span><span class=line><span class=cl><span class=s>          httpGet:
</span></span></span><span class=line><span class=cl><span class=s>            path: /healthz
</span></span></span><span class=line><span class=cl><span class=s>            port: 8080
</span></span></span><span class=line><span class=cl><span class=s>            scheme: HTTP
</span></span></span><span class=line><span class=cl><span class=s>          initialDelaySeconds: 30
</span></span></span><span class=line><span class=cl><span class=s>          timeoutSeconds: 5
</span></span></span><span class=line><span class=cl><span class=s>        ports:
</span></span></span><span class=line><span class=cl><span class=s>        - containerPort: 8080
</span></span></span><span class=line><span class=cl><span class=s>        resources:
</span></span></span><span class=line><span class=cl><span class=s>          limits:
</span></span></span><span class=line><span class=cl><span class=s>            cpu: 10m
</span></span></span><span class=line><span class=cl><span class=s>            memory: 20Mi
</span></span></span><span class=line><span class=cl><span class=s>          requests:
</span></span></span><span class=line><span class=cl><span class=s>            cpu: 10m
</span></span></span><span class=line><span class=cl><span class=s>            memory: 20Mi
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Service
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: default-http-backend
</span></span></span><span class=line><span class=cl><span class=s>  namespace: kube-system
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/name: default-http-backend
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  ports:
</span></span></span><span class=line><span class=cl><span class=s>  - port: 80
</span></span></span><span class=line><span class=cl><span class=s>    targetPort: 8080
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    app.kubernetes.io/name: default-http-backend
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl  apply -f deploy.yaml 
</span></span><span class=line><span class=cl>kubectl  apply -f backend.yaml 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt; ingress-demo-app.yaml <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: hello-server
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 2
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      app: hello-server
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        app: hello-server
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - name: hello-server
</span></span></span><span class=line><span class=cl><span class=s>        image: registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/hello-server
</span></span></span><span class=line><span class=cl><span class=s>        ports:
</span></span></span><span class=line><span class=cl><span class=s>        - containerPort: 9000
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app: nginx-demo
</span></span></span><span class=line><span class=cl><span class=s>  name: nginx-demo
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 2
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      app: nginx-demo
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        app: nginx-demo
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - image: nginx
</span></span></span><span class=line><span class=cl><span class=s>        name: nginx
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Service
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app: nginx-demo
</span></span></span><span class=line><span class=cl><span class=s>  name: nginx-demo
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    app: nginx-demo
</span></span></span><span class=line><span class=cl><span class=s>  ports:
</span></span></span><span class=line><span class=cl><span class=s>  - port: 8000
</span></span></span><span class=line><span class=cl><span class=s>    protocol: TCP
</span></span></span><span class=line><span class=cl><span class=s>    targetPort: 80
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Service
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app: hello-server
</span></span></span><span class=line><span class=cl><span class=s>  name: hello-server
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    app: hello-server
</span></span></span><span class=line><span class=cl><span class=s>  ports:
</span></span></span><span class=line><span class=cl><span class=s>  - port: 8000
</span></span></span><span class=line><span class=cl><span class=s>    protocol: TCP
</span></span></span><span class=line><span class=cl><span class=s>    targetPort: 9000
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: networking.k8s.io/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Ingress  
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: ingress-host-bar
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  ingressClassName: nginx
</span></span></span><span class=line><span class=cl><span class=s>  rules:
</span></span></span><span class=line><span class=cl><span class=s>  - host: &#34;hello.test.cn&#34;
</span></span></span><span class=line><span class=cl><span class=s>    http:
</span></span></span><span class=line><span class=cl><span class=s>      paths:
</span></span></span><span class=line><span class=cl><span class=s>      - pathType: Prefix
</span></span></span><span class=line><span class=cl><span class=s>        path: &#34;/&#34;
</span></span></span><span class=line><span class=cl><span class=s>        backend:
</span></span></span><span class=line><span class=cl><span class=s>          service:
</span></span></span><span class=line><span class=cl><span class=s>            name: hello-server
</span></span></span><span class=line><span class=cl><span class=s>            port:
</span></span></span><span class=line><span class=cl><span class=s>              number: 8000
</span></span></span><span class=line><span class=cl><span class=s>  - host: &#34;demo.test.cn&#34;
</span></span></span><span class=line><span class=cl><span class=s>    http:
</span></span></span><span class=line><span class=cl><span class=s>      paths:
</span></span></span><span class=line><span class=cl><span class=s>      - pathType: Prefix
</span></span></span><span class=line><span class=cl><span class=s>        path: &#34;/nginx&#34;  
</span></span></span><span class=line><span class=cl><span class=s>        backend:
</span></span></span><span class=line><span class=cl><span class=s>          service:
</span></span></span><span class=line><span class=cl><span class=s>            name: nginx-demo
</span></span></span><span class=line><span class=cl><span class=s>            port:
</span></span></span><span class=line><span class=cl><span class=s>              number: 8000
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 等创建完成后在执行：</span>
</span></span><span class=line><span class=cl>kubectl apply -f ingress-demo-app.yaml 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl get ingress
</span></span><span class=line><span class=cl>NAME               CLASS   HOSTS                            ADDRESS     PORTS   AGE
</span></span><span class=line><span class=cl>ingress-host-bar   nginx   hello.test.cn,demo.test.cn   192.168.100.102   <span class=m>80</span>      7s
</span></span></code></pre></div><h2 id=过滤查看ingress端口>过滤查看ingress端口<a hidden class=anchor aria-hidden=true href=#过滤查看ingress端口>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 修改为nodeport</span>
</span></span><span class=line><span class=cl>kubectl edit svc -n ingress-nginx   ingress-nginx-controller
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>type: NodePort
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># kubectl  get svc -A | grep ingress</span>
</span></span><span class=line><span class=cl>ingress-nginx   ingress-nginx-controller             LoadBalancer   10.107.76.220    &lt;pending&gt;     80:30451/TCP,443:32101/TCP   13d
</span></span><span class=line><span class=cl>ingress-nginx   ingress-nginx-controller-admission   ClusterIP      10.110.40.24     &lt;none&gt;        443/TCP                      13d
</span></span></code></pre></div><h1 id=ipv6测试示例>IPv6测试(示例)<a hidden class=anchor aria-hidden=true href=#ipv6测试示例>#</a></h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>#部署应用</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat<span class=s>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: test
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 3
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      app: test
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        app: test
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - name: test
</span></span></span><span class=line><span class=cl><span class=s>        image: docker.io/library/nginx
</span></span></span><span class=line><span class=cl><span class=s>        resources:
</span></span></span><span class=line><span class=cl><span class=s>          limits:
</span></span></span><span class=line><span class=cl><span class=s>            memory: &#34;128Mi&#34;
</span></span></span><span class=line><span class=cl><span class=s>            cpu: &#34;500m&#34;
</span></span></span><span class=line><span class=cl><span class=s>        ports:
</span></span></span><span class=line><span class=cl><span class=s>        - containerPort: 80
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>---
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Service
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: test
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  ipFamilyPolicy: PreferDualStack
</span></span></span><span class=line><span class=cl><span class=s>  ipFamilies:
</span></span></span><span class=line><span class=cl><span class=s>  - IPv6
</span></span></span><span class=line><span class=cl><span class=s>  - IPv4
</span></span></span><span class=line><span class=cl><span class=s>  type: NodePort
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    app: test
</span></span></span><span class=line><span class=cl><span class=s>  ports:
</span></span></span><span class=line><span class=cl><span class=s>  - port: 80
</span></span></span><span class=line><span class=cl><span class=s>    targetPort: 80
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#查看端口</span>
</span></span><span class=line><span class=cl><span class=c1># kubectl  get svc</span>
</span></span><span class=line><span class=cl>NAME           TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>        AGE
</span></span><span class=line><span class=cl><span class=nb>test</span>         NodePort    fd00::a29c       &lt;none&gt;        80:30779/TCP   5s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#使用内网访问</span>
</span></span><span class=line><span class=cl><span class=c1># curl -I http://[fd00::a29c]</span>
</span></span><span class=line><span class=cl>HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>Server: nginx/1.21.6
</span></span><span class=line><span class=cl>Date: Thu, <span class=m>05</span> May <span class=m>2022</span> 10:20:35 GMT
</span></span><span class=line><span class=cl>Content-Type: text/html
</span></span><span class=line><span class=cl>Content-Length: <span class=m>615</span>
</span></span><span class=line><span class=cl>Last-Modified: Tue, <span class=m>25</span> Jan <span class=m>2022</span> 15:03:52 GMT
</span></span><span class=line><span class=cl>Connection: keep-alive
</span></span><span class=line><span class=cl>ETag: <span class=s2>&#34;61f01158-267&#34;</span>
</span></span><span class=line><span class=cl>Accept-Ranges: bytes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># curl -I http://192.168.100.101:30779</span>
</span></span><span class=line><span class=cl>HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>Server: nginx/1.21.6
</span></span><span class=line><span class=cl>Date: Thu, <span class=m>05</span> May <span class=m>2022</span> 10:20:59 GMT
</span></span><span class=line><span class=cl>Content-Type: text/html
</span></span><span class=line><span class=cl>Content-Length: <span class=m>615</span>
</span></span><span class=line><span class=cl>Last-Modified: Tue, <span class=m>25</span> Jan <span class=m>2022</span> 15:03:52 GMT
</span></span><span class=line><span class=cl>Connection: keep-alive
</span></span><span class=line><span class=cl>ETag: <span class=s2>&#34;61f01158-267&#34;</span>
</span></span><span class=line><span class=cl>Accept-Ranges: bytes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#使用公网访问</span>
</span></span><span class=line><span class=cl><span class=c1># curl -I http://[2409:8a10:9e18:9020::10]:30779</span>
</span></span><span class=line><span class=cl>HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>Server: nginx/1.21.6
</span></span><span class=line><span class=cl>Date: Thu, <span class=m>05</span> May <span class=m>2022</span> 10:20:54 GMT
</span></span><span class=line><span class=cl>Content-Type: text/html
</span></span><span class=line><span class=cl>Content-Length: <span class=m>615</span>
</span></span><span class=line><span class=cl>Last-Modified: Tue, <span class=m>25</span> Jan <span class=m>2022</span> 15:03:52 GMT
</span></span><span class=line><span class=cl>Connection: keep-alive
</span></span><span class=line><span class=cl>ETag: <span class=s2>&#34;61f01158-267&#34;</span>
</span></span><span class=line><span class=cl>Accept-Ranges: bytes
</span></span></code></pre></div><h1 id=安装命令行自动补全功能可选>安装命令行自动补全功能(可选)<a hidden class=anchor aria-hidden=true href=#安装命令行自动补全功能可选>#</a></h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yum install bash-completion -y
</span></span><span class=line><span class=cl><span class=nb>source</span> /usr/share/bash-completion/bash_completion
</span></span><span class=line><span class=cl><span class=nb>source</span> &lt;<span class=o>(</span>kubectl completion bash<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;source &lt;(kubectl completion bash)&#34;</span> &gt;&gt; ~/.bashrc
</span></span></code></pre></div><h1 id=附录转载>附录(转载)<a hidden class=anchor aria-hidden=true href=#附录转载>#</a></h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 镜像加速器可以使用DaoCloud仓库，替换规则如下</span>
</span></span><span class=line><span class=cl>cr.l5d.io/  <span class=o>===</span>&gt; m.daocloud.io/cr.l5d.io/
</span></span><span class=line><span class=cl>docker.elastic.co/  <span class=o>===</span>&gt; m.daocloud.io/docker.elastic.co/
</span></span><span class=line><span class=cl>docker.io/  <span class=o>===</span>&gt; m.daocloud.io/docker.io/
</span></span><span class=line><span class=cl>gcr.io/  <span class=o>===</span>&gt; m.daocloud.io/gcr.io/
</span></span><span class=line><span class=cl>ghcr.io/  <span class=o>===</span>&gt; m.daocloud.io/ghcr.io/
</span></span><span class=line><span class=cl>k8s.gcr.io/  <span class=o>===</span>&gt; m.daocloud.io/k8s.gcr.io/
</span></span><span class=line><span class=cl>mcr.microsoft.com/  <span class=o>===</span>&gt; m.daocloud.io/mcr.microsoft.com/
</span></span><span class=line><span class=cl>nvcr.io/  <span class=o>===</span>&gt; m.daocloud.io/nvcr.io/
</span></span><span class=line><span class=cl>quay.io/  <span class=o>===</span>&gt; m.daocloud.io/quay.io/
</span></span><span class=line><span class=cl>registry.jujucharms.com/  <span class=o>===</span>&gt; m.daocloud.io/registry.jujucharms.com/
</span></span><span class=line><span class=cl>registry.k8s.io/  <span class=o>===</span>&gt; m.daocloud.io/registry.k8s.io/
</span></span><span class=line><span class=cl>registry.opensource.zalan.do/  <span class=o>===</span>&gt; m.daocloud.io/registry.opensource.zalan.do/
</span></span><span class=line><span class=cl>rocks.canonical.com/  <span class=o>===</span>&gt; m.daocloud.io/rocks.canonical.com/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 镜像版本要自行查看，因为镜像版本是随时更新的，文档无法做到实时更新</span>
</span></span><span class=line><span class=cl><span class=c1># docker pull 镜像</span>
</span></span><span class=line><span class=cl>docker pull registry.cn-hangzhou.aliyuncs.com/test/cni:master 
</span></span><span class=line><span class=cl>docker pull registry.cn-hangzhou.aliyuncs.com/test/node:master
</span></span><span class=line><span class=cl>docker pull registry.cn-hangzhou.aliyuncs.com/test/kube-controllers:master
</span></span><span class=line><span class=cl>docker pull registry.cn-hangzhou.aliyuncs.com/test/typha:master
</span></span><span class=line><span class=cl>docker pull registry.cn-hangzhou.aliyuncs.com/test/coredns:v1.10.0
</span></span><span class=line><span class=cl>docker pull registry.cn-hangzhou.aliyuncs.com/test/pause:3.6
</span></span><span class=line><span class=cl>docker pull registry.cn-hangzhou.aliyuncs.com/test/metrics-server:v0.5.2
</span></span><span class=line><span class=cl>docker pull kubernetesui/dashboard:v2.7.0
</span></span><span class=line><span class=cl>docker pull kubernetesui/metrics-scraper:v1.0.8
</span></span><span class=line><span class=cl>docker pull quay.io/cilium/cilium:v1.12.6
</span></span><span class=line><span class=cl>docker pull quay.io/cilium/certgen:v0.1.8
</span></span><span class=line><span class=cl>docker pull quay.io/cilium/hubble-relay:v1.12.6
</span></span><span class=line><span class=cl>docker pull quay.io/cilium/hubble-ui-backend:v0.9.2
</span></span><span class=line><span class=cl>docker pull quay.io/cilium/hubble-ui:v0.9.2
</span></span><span class=line><span class=cl>docker pull quay.io/cilium/cilium-etcd-operator:v2.0.7
</span></span><span class=line><span class=cl>docker pull quay.io/cilium/operator:v1.12.6
</span></span><span class=line><span class=cl>docker pull quay.io/cilium/clustermesh-apiserver:v1.12.6
</span></span><span class=line><span class=cl>docker pull quay.io/coreos/etcd:v3.5.4
</span></span><span class=line><span class=cl>docker pull quay.io/cilium/startup-script:d69851597ea019af980891a4628fb36b7880ec26
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># docker 保存镜像</span>
</span></span><span class=line><span class=cl>docker save registry.cn-hangzhou.aliyuncs.com/test/cni:master -o cni.tar 
</span></span><span class=line><span class=cl>docker save registry.cn-hangzhou.aliyuncs.com/test/node:master -o node.tar 
</span></span><span class=line><span class=cl>docker save registry.cn-hangzhou.aliyuncs.com/test/typha:master -o typha.tar 
</span></span><span class=line><span class=cl>docker save registry.cn-hangzhou.aliyuncs.com/test/kube-controllers:master -o kube-controllers.tar 
</span></span><span class=line><span class=cl>docker save registry.cn-hangzhou.aliyuncs.com/test/coredns:v1.10.0 -o coredns.tar 
</span></span><span class=line><span class=cl>docker save registry.cn-hangzhou.aliyuncs.com/test/pause:3.6 -o pause.tar 
</span></span><span class=line><span class=cl>docker save registry.cn-hangzhou.aliyuncs.com/test/metrics-server:v0.5.2 -o metrics-server.tar 
</span></span><span class=line><span class=cl>docker save kubernetesui/dashboard:v2.7.0 -o dashboard.tar 
</span></span><span class=line><span class=cl>docker save kubernetesui/metrics-scraper:v1.0.8 -o metrics-scraper.tar 
</span></span><span class=line><span class=cl>docker save quay.io/cilium/cilium:v1.12.6 -o cilium.tar 
</span></span><span class=line><span class=cl>docker save quay.io/cilium/certgen:v0.1.8 -o certgen.tar 
</span></span><span class=line><span class=cl>docker save quay.io/cilium/hubble-relay:v1.12.6 -o hubble-relay.tar 
</span></span><span class=line><span class=cl>docker save quay.io/cilium/hubble-ui-backend:v0.9.2 -o hubble-ui-backend.tar 
</span></span><span class=line><span class=cl>docker save quay.io/cilium/hubble-ui:v0.9.2 -o hubble-ui.tar 
</span></span><span class=line><span class=cl>docker save quay.io/cilium/cilium-etcd-operator:v2.0.7 -o cilium-etcd-operator.tar 
</span></span><span class=line><span class=cl>docker save quay.io/cilium/operator:v1.12.6 -o operator.tar 
</span></span><span class=line><span class=cl>docker save quay.io/cilium/clustermesh-apiserver:v1.12.6 -o clustermesh-apiserver.tar 
</span></span><span class=line><span class=cl>docker save quay.io/coreos/etcd:v3.5.4 -o etcd.tar 
</span></span><span class=line><span class=cl>docker save quay.io/cilium/startup-script:d69851597ea019af980891a4628fb36b7880ec26 -o startup-script.tar 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 传输到各个节点</span>
</span></span><span class=line><span class=cl><span class=k>for</span> NODE in k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02<span class=p>;</span> <span class=k>do</span> scp -r images/  <span class=nv>$NODE</span>:/root/ <span class=p>;</span> <span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建命名空间</span>
</span></span><span class=line><span class=cl>ctr ns create k8s.io
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 导入镜像</span>
</span></span><span class=line><span class=cl>ctr --namespace k8s.io image import images/cni.tar
</span></span><span class=line><span class=cl>ctr --namespace k8s.io image import images/node.tar
</span></span><span class=line><span class=cl>ctr --namespace k8s.io image import images/typha.tar
</span></span><span class=line><span class=cl>ctr --namespace k8s.io image import images/kube-controllers.tar 
</span></span><span class=line><span class=cl>ctr --namespace k8s.io image import images/coredns.tar 
</span></span><span class=line><span class=cl>ctr --namespace k8s.io image import images/pause.tar 
</span></span><span class=line><span class=cl>ctr --namespace k8s.io image import images/metrics-server.tar 
</span></span><span class=line><span class=cl>ctr --namespace k8s.io image import images/dashboard.tar 
</span></span><span class=line><span class=cl>ctr --namespace k8s.io image import images/metrics-scraper.tar 
</span></span><span class=line><span class=cl>ctr --namespace k8s.io image import images/dashboard.tar 
</span></span><span class=line><span class=cl>ctr --namespace k8s.io image import images/metrics-scraper.tar 
</span></span><span class=line><span class=cl>ctr --namespace k8s.io image import images/cilium.tar 
</span></span><span class=line><span class=cl>ctr --namespace k8s.io image import images/certgen.tar 
</span></span><span class=line><span class=cl>ctr --namespace k8s.io image import images/hubble-relay.tar 
</span></span><span class=line><span class=cl>ctr --namespace k8s.io image import images/hubble-ui-backend.tar 
</span></span><span class=line><span class=cl>ctr --namespace k8s.io image import images/hubble-ui.tar 
</span></span><span class=line><span class=cl>ctr --namespace k8s.io image import images/cilium-etcd-operator.tar 
</span></span><span class=line><span class=cl>ctr --namespace k8s.io image import images/operator.tar 
</span></span><span class=line><span class=cl>ctr --namespace k8s.io image import images/clustermesh-apiserver.tar 
</span></span><span class=line><span class=cl>ctr --namespace k8s.io image import images/etcd.tar 
</span></span><span class=line><span class=cl>ctr --namespace k8s.io image import images/startup-script.tar 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># pull tar包 解压后</span>
</span></span><span class=line><span class=cl>helm pull cilium/cilium
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看镜像版本</span>
</span></span><span class=line><span class=cl><span class=c1># cat values.yaml| grep tag: -C1</span>
</span></span><span class=line><span class=cl>  repository: <span class=s2>&#34;quay.io/cilium/cilium&#34;</span>
</span></span><span class=line><span class=cl>  tag: <span class=s2>&#34;v1.12.6&#34;</span>
</span></span><span class=line><span class=cl>  pullPolicy: <span class=s2>&#34;IfNotPresent&#34;</span>
</span></span><span class=line><span class=cl>--
</span></span><span class=line><span class=cl>    repository: <span class=s2>&#34;quay.io/cilium/certgen&#34;</span>
</span></span><span class=line><span class=cl>    tag: <span class=s2>&#34;v0.1.8@sha256:4a456552a5f192992a6edcec2febb1c54870d665173a33dc7d876129b199ddbd&#34;</span>
</span></span><span class=line><span class=cl>    pullPolicy: <span class=s2>&#34;IfNotPresent&#34;</span>
</span></span><span class=line><span class=cl>--
</span></span><span class=line><span class=cl>      repository: <span class=s2>&#34;quay.io/cilium/hubble-relay&#34;</span>
</span></span><span class=line><span class=cl>      tag: <span class=s2>&#34;v1.12.6&#34;</span>
</span></span><span class=line><span class=cl>       <span class=c1># hubble-relay-digest</span>
</span></span><span class=line><span class=cl>--
</span></span><span class=line><span class=cl>        repository: <span class=s2>&#34;quay.io/cilium/hubble-ui-backend&#34;</span>
</span></span><span class=line><span class=cl>        tag: <span class=s2>&#34;v0.9.2@sha256:a3ac4d5b87889c9f7cc6323e86d3126b0d382933bd64f44382a92778b0cde5d7&#34;</span>
</span></span><span class=line><span class=cl>        pullPolicy: <span class=s2>&#34;IfNotPresent&#34;</span>
</span></span><span class=line><span class=cl>--
</span></span><span class=line><span class=cl>        repository: <span class=s2>&#34;quay.io/cilium/hubble-ui&#34;</span>
</span></span><span class=line><span class=cl>        tag: <span class=s2>&#34;v0.9.2@sha256:d3596efc94a41c6b772b9afe6fe47c17417658956e04c3e2a28d293f2670663e&#34;</span>
</span></span><span class=line><span class=cl>        pullPolicy: <span class=s2>&#34;IfNotPresent&#34;</span>
</span></span><span class=line><span class=cl>--
</span></span><span class=line><span class=cl>    repository: <span class=s2>&#34;quay.io/cilium/cilium-etcd-operator&#34;</span>
</span></span><span class=line><span class=cl>    tag: <span class=s2>&#34;v2.0.7@sha256:04b8327f7f992693c2cb483b999041ed8f92efc8e14f2a5f3ab95574a65ea2dc&#34;</span>
</span></span><span class=line><span class=cl>    pullPolicy: <span class=s2>&#34;IfNotPresent&#34;</span>
</span></span><span class=line><span class=cl>--
</span></span><span class=line><span class=cl>    repository: <span class=s2>&#34;quay.io/cilium/operator&#34;</span>
</span></span><span class=line><span class=cl>    tag: <span class=s2>&#34;v1.12.6&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># operator-generic-digest</span>
</span></span><span class=line><span class=cl>--
</span></span><span class=line><span class=cl>    repository: <span class=s2>&#34;quay.io/cilium/startup-script&#34;</span>
</span></span><span class=line><span class=cl>    tag: <span class=s2>&#34;d69851597ea019af980891a4628fb36b7880ec26&#34;</span>
</span></span><span class=line><span class=cl>    pullPolicy: <span class=s2>&#34;IfNotPresent&#34;</span>
</span></span><span class=line><span class=cl>--
</span></span><span class=line><span class=cl>    repository: <span class=s2>&#34;quay.io/cilium/cilium&#34;</span>
</span></span><span class=line><span class=cl>    tag: <span class=s2>&#34;v1.12.6&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># cilium-digest</span>
</span></span><span class=line><span class=cl>--
</span></span><span class=line><span class=cl>      repository: <span class=s2>&#34;quay.io/cilium/clustermesh-apiserver&#34;</span>
</span></span><span class=line><span class=cl>      tag: <span class=s2>&#34;v1.12.6&#34;</span>
</span></span><span class=line><span class=cl>      <span class=c1># clustermesh-apiserver-digest</span>
</span></span><span class=line><span class=cl>--
</span></span><span class=line><span class=cl>        repository: <span class=s2>&#34;quay.io/coreos/etcd&#34;</span>
</span></span><span class=line><span class=cl>        tag: <span class=s2>&#34;v3.5.4@sha256:795d8660c48c439a7c3764c2330ed9222ab5db5bb524d8d0607cac76f7ba82a3&#34;</span>
</span></span><span class=line><span class=cl>        pullPolicy: <span class=s2>&#34;IfNotPresent&#34;</span>
</span></span></code></pre></div><blockquote><p>参考资料: <a href=https://github.com/cby-chen/Kubernetes>https://github.com/cby-chen/Kubernetes</a></p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://gnail89.github.io/tags/kubernetes/>kubernetes</a></li><li><a href=https://gnail89.github.io/tags/etcd/>etcd</a></li><li><a href=https://gnail89.github.io/tags/calico/>calico</a></li></ul><nav class=paginav><a class=prev href=https://gnail89.github.io/posts/ironic_image_userdata/><span class=title>« Prev</span><br><span>ironic image and userdata</span>
</a><a class=next href=https://gnail89.github.io/posts/openssh_upgrade/><span class=title>Next »</span><br><span>OpenSSH 9.3p1编译安装,链接OpenSSL 1.1.1t静态库</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://gnail89.github.io>📕W.'s Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>