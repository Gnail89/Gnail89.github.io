<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>AIPerf åŸºå‡†æµ‹è¯•å·¥å…·å®‰è£… | ğŸ“•W.'s Blog</title>
<meta name=keywords content="aiperf,cuda,cudnn,tensorflow"><meta name=description content='å¼€æºé¡¹ç›®åœ°å€: https://github.com/thu-pacman/AIPerf
åŸºç¡€ç¯å¢ƒ SSHå…å¯† ssh-keygen -t rsa ssh-copy-id -i ~/.ssh/id_rsa.pub server-ip éƒ¨ç½²NFS å®‰è£…è½¯ä»¶åŒ… yum install -y nfs-utils é…ç½®æœåŠ¡ç«¯ mkdir /userhome chmod -R 777 /userhome echo "/userhome *(rw,sync,insecure,no_root_squash)" >> /etc/exports # å¯åŠ¨æœåŠ¡ systemctl enable --now nfs-server systemctl status nfs-server é…ç½®å®¢æˆ·ç«¯ mkdir /userhome mount server-ip:/userhome /userhome å‡†å¤‡æ•°æ®é›† æ•°æ®é›†ä¸‹è½½ Imagenetå®˜æ–¹åœ°å€ï¼šhttp://www.image-net.org/index ä½¿ç”¨ImageNet-2012æ•°æ®é›† cd /userhome/AIPerf/scripts/build_data ./download_imagenet.sh ls ./imagenet åŸå§‹çš„ImageNet-2012åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶: ILSVRC2012_img_val.tar ILSVRC2012_img_train.tar TFReordåˆ¶ä½œ è®­ç»ƒé›†å’ŒéªŒè¯é›†éœ€è¦æŒ‰ç…§1000ä¸ªå­ç›®å½•ä¸‹åŒ…å«å›¾ç‰‡çš„æ ¼å¼ï¼Œå¤„ç†æ­¥éª¤ï¼š å°†train å’Œ val çš„æ•°æ®æŒ‰ç…§æ–‡ä»¶å¤¹åˆ†ç±» æŒ‡å®šå‚æ•°è¿è¡Œbuild_imagenet_data.py # åšéªŒè¯é›† cd /userhome/AIPerf/scripts/build_data mkdir -p ILSVRC2012/raw-data/imagenet-data/validation/ tar -xvf imagenet/ILSVRC2012_img_val.'><meta name=author content><link rel=canonical href=https://gnail89.github.io/posts/aiperf-setup/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://gnail89.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://gnail89.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://gnail89.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://gnail89.github.io/apple-touch-icon.png><link rel=mask-icon href=https://gnail89.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://gnail89.github.io/posts/aiperf-setup/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="AIPerf åŸºå‡†æµ‹è¯•å·¥å…·å®‰è£…"><meta property="og:description" content='å¼€æºé¡¹ç›®åœ°å€: https://github.com/thu-pacman/AIPerf
åŸºç¡€ç¯å¢ƒ SSHå…å¯† ssh-keygen -t rsa ssh-copy-id -i ~/.ssh/id_rsa.pub server-ip éƒ¨ç½²NFS å®‰è£…è½¯ä»¶åŒ… yum install -y nfs-utils é…ç½®æœåŠ¡ç«¯ mkdir /userhome chmod -R 777 /userhome echo "/userhome *(rw,sync,insecure,no_root_squash)" >> /etc/exports # å¯åŠ¨æœåŠ¡ systemctl enable --now nfs-server systemctl status nfs-server é…ç½®å®¢æˆ·ç«¯ mkdir /userhome mount server-ip:/userhome /userhome å‡†å¤‡æ•°æ®é›† æ•°æ®é›†ä¸‹è½½ Imagenetå®˜æ–¹åœ°å€ï¼šhttp://www.image-net.org/index ä½¿ç”¨ImageNet-2012æ•°æ®é›† cd /userhome/AIPerf/scripts/build_data ./download_imagenet.sh ls ./imagenet åŸå§‹çš„ImageNet-2012åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶: ILSVRC2012_img_val.tar ILSVRC2012_img_train.tar TFReordåˆ¶ä½œ è®­ç»ƒé›†å’ŒéªŒè¯é›†éœ€è¦æŒ‰ç…§1000ä¸ªå­ç›®å½•ä¸‹åŒ…å«å›¾ç‰‡çš„æ ¼å¼ï¼Œå¤„ç†æ­¥éª¤ï¼š å°†train å’Œ val çš„æ•°æ®æŒ‰ç…§æ–‡ä»¶å¤¹åˆ†ç±» æŒ‡å®šå‚æ•°è¿è¡Œbuild_imagenet_data.py # åšéªŒè¯é›† cd /userhome/AIPerf/scripts/build_data mkdir -p ILSVRC2012/raw-data/imagenet-data/validation/ tar -xvf imagenet/ILSVRC2012_img_val.'><meta property="og:type" content="article"><meta property="og:url" content="https://gnail89.github.io/posts/aiperf-setup/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-28T15:00:00+08:00"><meta property="article:modified_time" content="2024-11-28T15:00:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="AIPerf åŸºå‡†æµ‹è¯•å·¥å…·å®‰è£…"><meta name=twitter:description content='å¼€æºé¡¹ç›®åœ°å€: https://github.com/thu-pacman/AIPerf
åŸºç¡€ç¯å¢ƒ SSHå…å¯† ssh-keygen -t rsa ssh-copy-id -i ~/.ssh/id_rsa.pub server-ip éƒ¨ç½²NFS å®‰è£…è½¯ä»¶åŒ… yum install -y nfs-utils é…ç½®æœåŠ¡ç«¯ mkdir /userhome chmod -R 777 /userhome echo "/userhome *(rw,sync,insecure,no_root_squash)" >> /etc/exports # å¯åŠ¨æœåŠ¡ systemctl enable --now nfs-server systemctl status nfs-server é…ç½®å®¢æˆ·ç«¯ mkdir /userhome mount server-ip:/userhome /userhome å‡†å¤‡æ•°æ®é›† æ•°æ®é›†ä¸‹è½½ Imagenetå®˜æ–¹åœ°å€ï¼šhttp://www.image-net.org/index ä½¿ç”¨ImageNet-2012æ•°æ®é›† cd /userhome/AIPerf/scripts/build_data ./download_imagenet.sh ls ./imagenet åŸå§‹çš„ImageNet-2012åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶: ILSVRC2012_img_val.tar ILSVRC2012_img_train.tar TFReordåˆ¶ä½œ è®­ç»ƒé›†å’ŒéªŒè¯é›†éœ€è¦æŒ‰ç…§1000ä¸ªå­ç›®å½•ä¸‹åŒ…å«å›¾ç‰‡çš„æ ¼å¼ï¼Œå¤„ç†æ­¥éª¤ï¼š å°†train å’Œ val çš„æ•°æ®æŒ‰ç…§æ–‡ä»¶å¤¹åˆ†ç±» æŒ‡å®šå‚æ•°è¿è¡Œbuild_imagenet_data.py # åšéªŒè¯é›† cd /userhome/AIPerf/scripts/build_data mkdir -p ILSVRC2012/raw-data/imagenet-data/validation/ tar -xvf imagenet/ILSVRC2012_img_val.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://gnail89.github.io/posts/"},{"@type":"ListItem","position":2,"name":"AIPerf åŸºå‡†æµ‹è¯•å·¥å…·å®‰è£…","item":"https://gnail89.github.io/posts/aiperf-setup/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"AIPerf åŸºå‡†æµ‹è¯•å·¥å…·å®‰è£…","name":"AIPerf åŸºå‡†æµ‹è¯•å·¥å…·å®‰è£…","description":"å¼€æºé¡¹ç›®åœ°å€: https://github.com/thu-pacman/AIPerf\nåŸºç¡€ç¯å¢ƒ SSHå…å¯† ssh-keygen -t rsa ssh-copy-id -i ~/.ssh/id_rsa.pub server-ip éƒ¨ç½²NFS å®‰è£…è½¯ä»¶åŒ… yum install -y nfs-utils é…ç½®æœåŠ¡ç«¯ mkdir /userhome chmod -R 777 /userhome echo \u0026#34;/userhome *(rw,sync,insecure,no_root_squash)\u0026#34; \u0026gt;\u0026gt; /etc/exports # å¯åŠ¨æœåŠ¡ systemctl enable --now nfs-server systemctl status nfs-server é…ç½®å®¢æˆ·ç«¯ mkdir /userhome mount server-ip:/userhome /userhome å‡†å¤‡æ•°æ®é›† æ•°æ®é›†ä¸‹è½½ Imagenetå®˜æ–¹åœ°å€ï¼šhttp://www.image-net.org/index ä½¿ç”¨ImageNet-2012æ•°æ®é›† cd /userhome/AIPerf/scripts/build_data ./download_imagenet.sh ls ./imagenet åŸå§‹çš„ImageNet-2012åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶: ILSVRC2012_img_val.tar ILSVRC2012_img_train.tar TFReordåˆ¶ä½œ è®­ç»ƒé›†å’ŒéªŒè¯é›†éœ€è¦æŒ‰ç…§1000ä¸ªå­ç›®å½•ä¸‹åŒ…å«å›¾ç‰‡çš„æ ¼å¼ï¼Œå¤„ç†æ­¥éª¤ï¼š å°†train å’Œ val çš„æ•°æ®æŒ‰ç…§æ–‡ä»¶å¤¹åˆ†ç±» æŒ‡å®šå‚æ•°è¿è¡Œbuild_imagenet_data.py # åšéªŒè¯é›† cd /userhome/AIPerf/scripts/build_data mkdir -p ILSVRC2012/raw-data/imagenet-data/validation/ tar -xvf imagenet/ILSVRC2012_img_val.","keywords":["aiperf","cuda","cudnn","tensorflow"],"articleBody":"å¼€æºé¡¹ç›®åœ°å€: https://github.com/thu-pacman/AIPerf\nåŸºç¡€ç¯å¢ƒ SSHå…å¯† ssh-keygen -t rsa ssh-copy-id -i ~/.ssh/id_rsa.pub server-ip éƒ¨ç½²NFS å®‰è£…è½¯ä»¶åŒ… yum install -y nfs-utils é…ç½®æœåŠ¡ç«¯ mkdir /userhome chmod -R 777 /userhome echo \"/userhome *(rw,sync,insecure,no_root_squash)\" \u003e\u003e /etc/exports # å¯åŠ¨æœåŠ¡ systemctl enable --now nfs-server systemctl status nfs-server é…ç½®å®¢æˆ·ç«¯ mkdir /userhome mount server-ip:/userhome /userhome å‡†å¤‡æ•°æ®é›† æ•°æ®é›†ä¸‹è½½ Imagenetå®˜æ–¹åœ°å€ï¼šhttp://www.image-net.org/index ä½¿ç”¨ImageNet-2012æ•°æ®é›† cd /userhome/AIPerf/scripts/build_data ./download_imagenet.sh ls ./imagenet åŸå§‹çš„ImageNet-2012åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶: ILSVRC2012_img_val.tar ILSVRC2012_img_train.tar TFReordåˆ¶ä½œ è®­ç»ƒé›†å’ŒéªŒè¯é›†éœ€è¦æŒ‰ç…§1000ä¸ªå­ç›®å½•ä¸‹åŒ…å«å›¾ç‰‡çš„æ ¼å¼ï¼Œå¤„ç†æ­¥éª¤ï¼š å°†train å’Œ val çš„æ•°æ®æŒ‰ç…§æ–‡ä»¶å¤¹åˆ†ç±» æŒ‡å®šå‚æ•°è¿è¡Œbuild_imagenet_data.py # åšéªŒè¯é›† cd /userhome/AIPerf/scripts/build_data mkdir -p ILSVRC2012/raw-data/imagenet-data/validation/ tar -xvf imagenet/ILSVRC2012_img_val.tar -C ILSVRC2012/raw-data/imagenet-data/validation/ python preprocess_imagenet_validation_data.py ILSVRC2012/raw-data/imagenet-data/validation/ imagenet_2012_validation_synset_labels.txt # åšè®­ç»ƒé›† mkdir -p ILSVRC2012/raw-data/imagenet-data/train/ tar -xvf imagenet/ILSVRC2012_img_train.tar -C ILSVRC2012/raw-data/imagenet-data/train/ \u0026\u0026 cd ILSVRC2012/raw-data/imagenet-data/train find . -name \"*.tar\" | while read NAE ; do mkdir -p \"${NAE%.tar}\"; tar -xvf \"${NAE}\" -C \"${NAE%.tar}\"; rm -f \"${NAE}\"; done cd /userhome/AIPerf/scripts/build_data # TensorFlowéœ€è¦åˆ¶ä½œTFRecord mkdir -p ILSVRC2012/output python build_imagenet_data.py \\ --train_directory=ILSVRC2012/raw-data/imagenet-data/train \\ --validation_directory=ILSVRC2012/raw-data/imagenet-data/validation \\ --output_directory=ILSVRC2012/output \\ --imagenet_metadata_file=imagenet_metadata.txt \\ --labels_file=imagenet_lsvrc_2015_synsets.txt # åœ¨ILSVRC2012/outputç›®å½•ä¸‹ç”Ÿæˆ128ä¸ªvalidationå¼€å¤´çš„éªŒè¯é›†æ–‡ä»¶å’Œ1024ä¸ªtrainå¼€å¤´çš„è®­ç»ƒé›†æ–‡ä»¶ã€‚ åˆ†å‘æ•°æ®é›† å¯¹TensorFlowï¼Œå°†éªŒè¯é›†å’Œæ•°æ®é›†ç§»åŠ¨åˆ°slaveèŠ‚ç‚¹ã€‚ mkdir -p /root/datasets/imagenet/train mkdir -p /root/datasets/imagenet/val mv ILSVRC2012/output/train-* /root/datasets/imagenet/train mv ILSVRC2012/output/validation-* /root/datasets/imagenet/val å¯¹å…¶ä»–æ¨¡å‹ï¼Œå°†è§£å‹åéªŒè¯é›†å’Œæ•°æ®é›†ç§»åŠ¨åˆ°slaveèŠ‚ç‚¹ï¼Œæ ¹æ®æ¡†æ¶è‡ªè¡Œè°ƒæ•´ã€‚ # å¯¹PyTorch mkdir -p /root/datasets/imagenet/ mv ILSVRC2012/train /root/datasets/imagenet mv ILSVRC2012/val /root/datasets/imagenet é¡¹ç›®å®‰è£… ç¯å¢ƒå˜é‡å£°æ˜ export AIPERF_WORKDIR=/userhome export AIPERF_SLAVE_WORKDIR=/root/ export AIPERF_MASTER_IP=10.0.1.100 export AIPERF_MASTER_PORT=9987 * AIPERF_WORKDIR AIPerfå·¥ä½œç›®å½•ï¼Œå¿…é¡»åœ¨å…±äº«å­˜å‚¨ä¸Šï¼Œèƒ½è¢«æ‰€æœ‰èŠ‚ç‚¹è®¿é—®åˆ° AIPerfä»£ç ï¼Œéƒ¨åˆ†logæ–‡ä»¶ç­‰å°†ä¼šè¢«æ”¾åˆ°è¿™ä¸ªç›®å½• * AIPERF_SLAVE_WORKDIR è®¡ç®—èŠ‚ç‚¹å·¥ä½œç›®å½•ï¼Œä¸éœ€è¦åœ¨å…±äº«å­˜å‚¨ä¸Šï¼ˆä¹Ÿå¯ä»¥æ”¾åœ¨å…±äº«å­˜å‚¨ï¼‰ éƒ¨åˆ†è®¡ç®—èŠ‚ç‚¹logæ–‡ä»¶å°†ä¼šè¢«ç”Ÿæˆåˆ°è¿™ä¸ªç›®å½•ä¸‹ * AIPERF_MASTER_IP AIPerfè°ƒåº¦æœåŠ¡IPï¼Œå³æ§åˆ¶èŠ‚ç‚¹IP * AIPERF_MASTER_PORT AIPerfè°ƒåº¦æœåŠ¡ç«¯å£ ä¸‹è½½æºä»£ç  # åœ¨å…±äº«å­˜å‚¨ä¸Šåˆ›å»ºAIPerfå·¥ä½œç›®å½• mkdir -p $AIPERF_WORKDIR # ä¸‹è½½æºä»£ç  git clone https://github.com/thu-pacman/AIPerf.git $AIPERF_WORKDIR/AIPerf AIPerfç›®å½•ä¸‹aiperf_setenv.shè„šæœ¬è®¾ç½®ç¯å¢ƒå˜é‡ã€‚ source $AIPERF_WORKDIR/AIPerf/aiperf_setenv.sh å®‰è£…ä¾èµ–åŒ… å®‰è£…Python wget https://www.python.org/ftp/python/3.8.20/python-3.9.20.tgz tar -zxvf python-3.9.20.tgz # å®‰è£…ä¾èµ–åŒ… yum install -y gcc gcc-c++ make openssl-devel bzip2-devel libffi-devel # ç¼–è¯‘å®‰è£… cd python-3.9.20 ./configure --prefix=/usr/local/python3 \\ --with-ensurepip=install \\ --enable-optimizations make \u0026\u0026 make install # è®¾ç½®ç¯å¢ƒå˜é‡ # ln -s /usr/local/python3/bin/python3.9 /usr/bin/python3 echo 'export PATH=/usr/local/python3/bin:$PATH' \u003e\u003e ~/.bash_profile source ~/.bash_profile # å‡çº§pipå’Œsetuptools # ä¸´æ—¶é•œåƒæº: https://mirrors.tuna.tsinghua.edu.cn/help/pypi/ python3 -m pip install --upgrade pip -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple python3 -m pip install --upgrade setuptools -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple æ§åˆ¶èŠ‚ç‚¹ # python3 -m pip install -r $AIPERF_WORKDIR/AIPerf/requirements_master.txt python3 -m pip install scikit-learn pyyaml django schema colorama ruamel.yaml matplotlib jinja2 zmq torch==1.8.0 hyperopt==0.1.2 json_tricks \"numpy\u003c2.0\" scipy coverage psutil è®¡ç®—èŠ‚ç‚¹ # python3 -m pip install -r $AIPERF_WORKDIR/AIPerf/requirements_slave.txt # æ ¹æ®CUDAå’ŒcuDNNç‰ˆæœ¬é€‰æ‹©è®¡ç®—æ¡†æ¶ç‰ˆæœ¬ï¼Œä¾‹å¦‚å¯¹äºCUDA 11.2ï¼ŒcuDNN 8.1ï¼Œå¯é€‰æ‹©tensorflow 2.5.0 # python3 -m pip install tensorflow==2.5.0 python3 -m pip install zmq scikit-learn psutil dill hyperopt==0.1.2 json_tricks \"numpy\u003c2.0\" scipy coverage tensorflow==2.5.0 torch==1.8.0 # sample install nvidia driver wget https://us.download.nvidia.com/tesla/460.106.00/NVIDIA-Linux-x86_64-460.106.00.run sh NVIDIA-Linux-x86_64-460.106.00.run # CUDA Toolkit 11.2 # https://developer.nvidia.com/cuda-11.2.0-download-archive wget https://developer.download.nvidia.com/compute/cuda/11.2.0/local_installers/cuda_11.2.0_460.27.04_linux.run sh cuda_11.2.0_460.27.04_linux.run # environment variables export PATH=/usr/local/cuda/bin${PATH:+:${PATH}} export LD_LIBRARY_PATH=/usr/local/cuda/lib64${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}} # cuDNN 8.1 # https://developer.nvidia.com/rdp/cudnn-archive # https://developer.nvidia.com/compute/machine-learning/cudnn/secure/8.1.0.77/11.2_20210127/cudnn-11.2-linux-x64-v8.1.0.77.tgz wget https://developer.download.nvidia.com/compute/redist/cudnn/v8.1.0/cudnn-11.2-linux-x64-v8.1.0.77.tgz tar -zvxf cudnn-11.2-linux-x64-v8.1.0.77.tgz cp -P cuda/include/cudnn.h /usr/local/cuda/include cp -P cuda/lib64/libcudnn* /usr/local/cuda/lib64/ chmod a+r /usr/local/cuda/include/cudnn.h #check cuda nvidia-smi #check cudnn nvcc -V å®‰è£…AIPerf æ§åˆ¶èŠ‚ç‚¹ # å®‰è£…AutoMLç»„ä»¶ cd $AIPERF_WORKDIR/AIPerf/src/sdk/pynni/ python3 -m pip install -e . # å®‰è£…aiperfæ§åˆ¶ç»„ä»¶ cd $AIPERF_WORKDIR/AIPerf/src/aiperf_manager/ python3 -m pip install -e . aiperf --help è®¡ç®—èŠ‚ç‚¹ # å®‰è£…AutoMLç»„ä»¶ cd $AIPERF_WORKDIR/AIPerf/src/sdk/pynni/ python3 -m pip install -e . ä¸‹è½½æ¨¡å‹æƒé‡ å°†æƒé‡æ–‡ä»¶resnet50_weights_tf_dim_ordering_tf_kernels.h5ä¸‹è½½å¹¶æ”¾åˆ°$AIPERF_WORKDIRä¸‹ # ç™¾åº¦äº‘ç›˜ https://pan.baidu.com/s/1JBOh2XwetZAalLdmULBN2Q æå–ç : 5nbc mv resnet50_weights_tf_dim_ordering_tf_kernels.h5 $AIPERF_WORKDIR (md5sum: a7b3fe01876f51b976af0dea6bc144eb) å¯åŠ¨æµ‹è¯•(æ§åˆ¶èŠ‚ç‚¹) å¯åŠ¨è°ƒåº¦æœåŠ¡ é…ç½®è®¡ç®—èŠ‚ç‚¹ä¿¡æ¯ ${AIPERF_WORKDIR}/AIPerf/aiperf_ctrl/servers.json # ä¾‹å¦‚ï¼Œé›†ç¾¤æœ‰2ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹æœ‰4å¼ GPUï¼Œåˆ™é…ç½®å¦‚ä¸‹ï¼š [ { \"ip\": \"172.23.33.33\", \"tag\": \"\", \"status\": \"waiting\", \"CUDA_VISIBLE_DEVICES\": \"0,1,2,3\" }, { \"ip\": \"172.23.33.34\", \"tag\": \"\", \"status\": \"waiting\", \"CUDA_VISIBLE_DEVICES\": \"0,1,2,3\" } ] å¯åŠ¨å‘½ä»¤ cd $AIPERF_WORKDIR/AIPerf/aiperf_ctrl python3 manage.py runserver ${AIPERF_MASTER_IP}:${AIPERF_MASTER_PORT} å¯åŠ¨AIPerfæµ‹è¯• æµ‹è¯•åŸºæœ¬æ¡ä»¶ï¼š\n1.æµ‹è¯•è¿è¡Œæ—¶é—´åº”ä¸å°‘äº1å°æ—¶ï¼›\n2.æµ‹è¯•çš„è®¡ç®—ç²¾åº¦ä¸ä½äºFP-16ï¼›\n3.æµ‹è¯•å®Œæˆæ—¶æ‰€å–å¾—çš„æœ€é«˜æ­£ç¡®ç‡åº”å¤§äº70%ï¼›\nåˆå§‹åŒ–é…ç½® ${AIPERF_WORKDIR}/AIPerf/examples/trials/network_morphism/imagenet/config.yml\nå…³é”®å‚æ•°è§£é‡Š:\nå¯é€‰å‚æ•° è¯´æ˜ é»˜è®¤å€¼ 1 trialConcurrency åŒæ—¶è¿è¡Œçš„trialæ•° 1 2 maxExecDuration è®¾ç½®æµ‹è¯•æ—¶é—´(å•ä½ ï¼šh) 12 3 CUDA_VISIBLE_DEVICES æŒ‡å®šæµ‹è¯•ç¨‹åºå¯ç”¨çš„gpuç´¢å¼• 0,1,2,3,4,5,6,7 4 srunï¼šâ€“cpus-per-task=30 å‚æ•°ä¸ºslurmå¯ç”¨cpuæ ¸æ•°å‡ 1 30 5 â€“slave è·Ÿ trialConcurrencyå‚æ•°ä¿æŒä¸€è‡´ 1 6 â€“ip masterèŠ‚ç‚¹ipï¼Œç›´æ¥ä½¿ç”¨é»˜è®¤å€¼ ${AIPERF_MASTER_IP} 7 â€“batch_size batch size 448 8 â€“epochs æ­£å¸¸è®­ç»ƒepochæ•° 60 9 â€“initial_lr åˆå§‹å­¦ä¹ ç‡ 1e-1 10 â€“final_lr æœ€ç»ˆå­¦ä¹ ç‡ 0 11 â€“train_data_dir è®­ç»ƒæ•°æ®é›†è·¯å¾„ None 12 â€“val_data_dir éªŒè¯æ•°æ®é›†è·¯å¾„ None 13 â€“warmup_1 warm upæœºåˆ¶ç¬¬ä¸€è½®epochæ•° 15 14 â€“warmup_2 warm upæœºåˆ¶ç¬¬äºŒè½®epochæ•° 30 15 â€“warmup_3 warm upæœºåˆ¶ç¬¬ä¸‰è½®epochæ•° 45 16 â€“num_parallel_calls tfrecordæ•°æ®åŠ è½½åŠ é€Ÿ 48 # ç¤ºä¾‹ authorName: default experimentName: example_imagenet-network-morphism-test trialConcurrency: 2 maxExecDuration: 24h maxTrialNum: 9999 trainingServicePlatform: local useAnnotation: false logLevel: trace tuner: #choice: TPE, Random, Anneal, Evolution, BatchTuner, NetworkMorphism #SMAC (SMAC should be installed through nnictl) builtinTunerName: NetworkMorphism classArgs: #choice: maximize, minimize optimize_mode: maximize #for now, this tuner only supports cv domain task: cv #input image width input_width: 224 #input image channel input_channel: 3 #number of classes n_output_node: 1000 trial: command: CUDA_VISIBLE_DEVICES=0 \\ python3 imagenet_train.py \\ --slave 2 \\ --ip ${AIPERF_MASTER_IP} \\ --batch_size 448 \\ --epoch 60 \\ --initial_lr 1e-1 \\ --final_lr 0 \\ --train_data_dir /root/datasets/imagenet/train \\ --val_data_dir /root/datasets/imagenet/val codeDir: . gpuNum: 0 # æ³¨æ„é…ç½®æ–‡ä»¶ä¸­slaveå‚æ•°éœ€è¦å’ŒtrialConcurrencyå‚æ•°ä¸€è‡´ï¼Œä¿®æ”¹ä¸ºè®¡ç®—èŠ‚ç‚¹ä¸ªæ•° # ä¿®æ”¹CUDA_VISIBLE_DEVICESä¸ºè®¡ç®—èŠ‚ç‚¹æ‰€ç”¨çš„GPU # éœ€è¦ä¿®æ”¹--train_data_dirå’Œ--var_data_dirçš„ä½ç½®ä»¥æŒ‡å‘è®¡ç®—èŠ‚ç‚¹æ•°æ®é›†å­˜å‚¨ä½ç½® è¿è¡Œbenchmark\nåœ¨${AIPERF_WORKDIR}/AIPerf/examples/trials/network_morphism/imagenet/ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿è¡Œç”¨ä¾‹\næ³¨ï¼šè‹¥ä½¿ç”¨pyTorchï¼Œè¯·åœ¨ ${AIPERF_WORKDIR}/AIPerf/examples/trials/network_morphism/imagenetTorch/ä¸‹æ‰§è¡Œ\n# å¯åŠ¨ aiperf create -c config.yml # åœæ­¢,ctrl-cç»ˆæ­¢ # æ¸…ç†æ‰€æœ‰è®¡ç®—èŠ‚ç‚¹ä¸Šçš„è®­ç»ƒè¿›ç¨‹ aiperf clean æŸ¥çœ‹çŠ¶æ€\nå½“æµ‹è¯•è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œè¿è¡Œä»¥ä¸‹ç¨‹åºä¼šåœ¨ç»ˆç«¯æ‰“å°experimentçš„Errorã€Scoreã€Regulated Scoreç­‰ä¿¡æ¯\npython3 $AIPERF_WORKDIR/AIPerf/scripts/reports/report.py --id experiment_ID åŒæ—¶ä¼šäº§ç”Ÿå®éªŒæŠ¥å‘Šå­˜æ”¾åœ¨experiment_IDçš„å¯¹åº”è·¯å¾„${AIPERF_WORKDIR}/mountdir/nni/experiments/experiment_ID/resultsç›®å½•ä¸‹ã€‚\nå®éªŒæˆåŠŸæ—¶æŠ¥å‘Šä¸º Report_Succeed.htmlã€‚\nå®éªŒå¤±è´¥æ—¶æŠ¥å‘Šä¸º Report_Failed.htmlã€‚\nå®éªŒå¤±è´¥ä¼šæŠ¥å‘Šå¤±è´¥åŸå› ï¼Œè¯·æŸ¥é˜…AI Benchmarkæµ‹è¯•è§„èŒƒåˆ†æå¤±è´¥åŸå› ã€‚ ä¿å­˜æ—¥å¿—\u0026ç»“æœæ•°æ® è¿è¡Œä»¥ä¸‹ç¨‹åºå¯å°†æµ‹è¯•äº§ç”Ÿçš„æ—¥å¿—ä»¥åŠæ•°æ®ç»Ÿä¸€ä¿å­˜åˆ°${AIPERF_WORKDIR}/mountdir/nni/experiments/experiment_ID/results/logsä¸­ï¼Œä¾¿äºå®éªŒåˆ†æã€‚ ç”±äºå®éªŒæ•°æ®åœ¨å¤åˆ¶è¿‡ç¨‹ä¸­ä¼šå¯¼è‡´é¢å¤–çš„ç½‘ç»œã€å†…å­˜ã€cpuç­‰èµ„æºå¼€é”€ï¼Œå»ºè®®åœ¨å®éªŒåœæ­¢/ç»“æŸåå†æ‰§è¡Œæ—¥å¿—ä¿å­˜æ“ä½œã€‚ python3 $AIPERF_WORKDIR/AIPerf/scripts/reports/report.py --id experiment_ID --logs True æµ‹è¯•å‚æ•°è®¾ç½®åŠæ¨èç¯å¢ƒé…ç½®(å®˜æ–¹) å¯å˜è®¾ç½® slaveè®¡ç®—èŠ‚ç‚¹çš„GPUå¡æ•°ï¼šé»˜è®¤å°†å•ä¸ªç‰©ç†æœåŠ¡å™¨ä½œä¸ºä¸€ä¸ªslaveèŠ‚ç‚¹ï¼Œå¹¶ä½¿ç”¨å…¶æ‰€æœ‰GPUï¼› æ·±åº¦å­¦ä¹ æ¡†æ¶ï¼šé»˜è®¤ä½¿ç”¨keras+tensorflowï¼› æ•°æ®é›†åŠ è½½æ–¹å¼ï¼šé»˜è®¤å°†æ•°æ®é¢„å¤„ç†æˆTFRecordæ ¼å¼ï¼Œä»¥åŠ å¿«æ•°æ®åŠ è½½çš„æ•ˆç‡ï¼› æ•°æ®é›†å­˜å‚¨æ–¹å¼ï¼šé»˜è®¤é‡‡ç”¨ç½‘ç»œå…±äº«å­˜å‚¨ï¼› è¶…å‚è®¾ç½®ï¼šé»˜è®¤åˆå§‹batch size=448ï¼Œé»˜è®¤åˆå§‹å­¦ä¹ ç‡=0.1ï¼Œé»˜è®¤æœ€ç»ˆå­¦ä¹ ç‡=0ï¼Œé»˜è®¤æ­£å¸¸è®­ç»ƒepochs=60ï¼Œé»˜è®¤ä»ç¬¬å››è½®trialå¼€å§‹ï¼Œæ¯ä¸ªtrialæœç´¢1æ¬¡ï¼Œé»˜è®¤è¶…å‚ä¸ºkernel sizeå’Œbatch sizeã€‚ æ¨èç¯å¢ƒé…ç½®\nè½¯ä»¶ï¼šTensorFlow2.5.0ï¼ŒCUDA11.2ï¼ŒcuDNN8.1ï¼Œpython3.8\n","wordCount":"706","inLanguage":"en","datePublished":"2024-11-28T15:00:00+08:00","dateModified":"2024-11-28T15:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://gnail89.github.io/posts/aiperf-setup/"},"publisher":{"@type":"Organization","name":"ğŸ“•W.'s Blog","logo":{"@type":"ImageObject","url":"https://gnail89.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://gnail89.github.io/ accesskey=h title="ğŸ“•W.'s Blog (Alt + H)">ğŸ“•W.'s Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://gnail89.github.io/search/ title=ğŸ”Search><span>ğŸ”Search</span></a></li><li><a href=https://gnail89.github.io/archives/ title=ğŸ“šArchive><span>ğŸ“šArchive</span></a></li><li><a href=https://gnail89.github.io/tags/ title=ğŸ”–Tags><span>ğŸ”–Tags</span></a></li><li><a href=https://gnail89.github.io/categories/ title=ğŸ§©Categories><span>ğŸ§©Categories</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://gnail89.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://gnail89.github.io/posts/>Posts</a></div><h1 class=post-title>AIPerf åŸºå‡†æµ‹è¯•å·¥å…·å®‰è£…</h1></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%9f%ba%e7%a1%80%e7%8e%af%e5%a2%83 aria-label=åŸºç¡€ç¯å¢ƒ>åŸºç¡€ç¯å¢ƒ</a><ul><li><a href=#ssh%e5%85%8d%e5%af%86 aria-label=SSHå…å¯†>SSHå…å¯†</a></li><li><a href=#%e9%83%a8%e7%bd%b2nfs aria-label=éƒ¨ç½²NFS>éƒ¨ç½²NFS</a></li></ul></li><li><a href=#%e5%87%86%e5%a4%87%e6%95%b0%e6%8d%ae%e9%9b%86 aria-label=å‡†å¤‡æ•°æ®é›†>å‡†å¤‡æ•°æ®é›†</a><ul><li><a href=#%e6%95%b0%e6%8d%ae%e9%9b%86%e4%b8%8b%e8%bd%bd aria-label=æ•°æ®é›†ä¸‹è½½>æ•°æ®é›†ä¸‹è½½</a></li><li><a href=#tfreord%e5%88%b6%e4%bd%9c aria-label=TFReordåˆ¶ä½œ>TFReordåˆ¶ä½œ</a></li><li><a href=#%e5%88%86%e5%8f%91%e6%95%b0%e6%8d%ae%e9%9b%86 aria-label=åˆ†å‘æ•°æ®é›†>åˆ†å‘æ•°æ®é›†</a></li></ul></li><li><a href=#%e9%a1%b9%e7%9b%ae%e5%ae%89%e8%a3%85 aria-label=é¡¹ç›®å®‰è£…>é¡¹ç›®å®‰è£…</a><ul><li><a href=#%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e5%a3%b0%e6%98%8e aria-label=ç¯å¢ƒå˜é‡å£°æ˜>ç¯å¢ƒå˜é‡å£°æ˜</a></li><li><a href=#%e4%b8%8b%e8%bd%bd%e6%ba%90%e4%bb%a3%e7%a0%81 aria-label=ä¸‹è½½æºä»£ç >ä¸‹è½½æºä»£ç </a></li><li><a href=#%e5%ae%89%e8%a3%85%e4%be%9d%e8%b5%96%e5%8c%85 aria-label=å®‰è£…ä¾èµ–åŒ…>å®‰è£…ä¾èµ–åŒ…</a><ul><li><a href=#%e5%ae%89%e8%a3%85python aria-label=å®‰è£…Python>å®‰è£…Python</a></li><li><a href=#%e6%8e%a7%e5%88%b6%e8%8a%82%e7%82%b9 aria-label=æ§åˆ¶èŠ‚ç‚¹>æ§åˆ¶èŠ‚ç‚¹</a></li><li><a href=#%e8%ae%a1%e7%ae%97%e8%8a%82%e7%82%b9 aria-label=è®¡ç®—èŠ‚ç‚¹>è®¡ç®—èŠ‚ç‚¹</a></li></ul></li><li><a href=#%e5%ae%89%e8%a3%85aiperf aria-label=å®‰è£…AIPerf>å®‰è£…AIPerf</a><ul><li><a href=#%e6%8e%a7%e5%88%b6%e8%8a%82%e7%82%b9-1 aria-label=æ§åˆ¶èŠ‚ç‚¹>æ§åˆ¶èŠ‚ç‚¹</a></li><li><a href=#%e8%ae%a1%e7%ae%97%e8%8a%82%e7%82%b9-1 aria-label=è®¡ç®—èŠ‚ç‚¹>è®¡ç®—èŠ‚ç‚¹</a></li><li><a href=#%e4%b8%8b%e8%bd%bd%e6%a8%a1%e5%9e%8b%e6%9d%83%e9%87%8d aria-label=ä¸‹è½½æ¨¡å‹æƒé‡>ä¸‹è½½æ¨¡å‹æƒé‡</a></li></ul></li><li><a href=#%e5%90%af%e5%8a%a8%e6%b5%8b%e8%af%95%e6%8e%a7%e5%88%b6%e8%8a%82%e7%82%b9 aria-label=å¯åŠ¨æµ‹è¯•(æ§åˆ¶èŠ‚ç‚¹)>å¯åŠ¨æµ‹è¯•(æ§åˆ¶èŠ‚ç‚¹)</a><ul><li><a href=#%e5%90%af%e5%8a%a8%e8%b0%83%e5%ba%a6%e6%9c%8d%e5%8a%a1 aria-label=å¯åŠ¨è°ƒåº¦æœåŠ¡>å¯åŠ¨è°ƒåº¦æœåŠ¡</a></li><li><a href=#%e5%90%af%e5%8a%a8aiperf%e6%b5%8b%e8%af%95 aria-label=å¯åŠ¨AIPerfæµ‹è¯•>å¯åŠ¨AIPerfæµ‹è¯•</a></li></ul></li></ul></li><li><a href=#%e4%bf%9d%e5%ad%98%e6%97%a5%e5%bf%97%e7%bb%93%e6%9e%9c%e6%95%b0%e6%8d%ae aria-label=ä¿å­˜æ—¥å¿—&amp;amp;ç»“æœæ•°æ®>ä¿å­˜æ—¥å¿—&ç»“æœæ•°æ®</a></li><li><a href=#%e6%b5%8b%e8%af%95%e5%8f%82%e6%95%b0%e8%ae%be%e7%bd%ae%e5%8f%8a%e6%8e%a8%e8%8d%90%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae%e5%ae%98%e6%96%b9 aria-label=æµ‹è¯•å‚æ•°è®¾ç½®åŠæ¨èç¯å¢ƒé…ç½®(å®˜æ–¹)>æµ‹è¯•å‚æ•°è®¾ç½®åŠæ¨èç¯å¢ƒé…ç½®(å®˜æ–¹)</a></li></ul></div></details></div><div class=post-content><p><em>å¼€æºé¡¹ç›®åœ°å€: <a href=https://github.com/thu-pacman/AIPerf>https://github.com/thu-pacman/AIPerf</a></em></p><h1 id=åŸºç¡€ç¯å¢ƒ>åŸºç¡€ç¯å¢ƒ<a hidden class=anchor aria-hidden=true href=#åŸºç¡€ç¯å¢ƒ>#</a></h1><h2 id=sshå…å¯†>SSHå…å¯†<a hidden class=anchor aria-hidden=true href=#sshå…å¯†>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh-keygen -t rsa
</span></span><span class=line><span class=cl>ssh-copy-id -i ~/.ssh/id_rsa.pub server-ip
</span></span></code></pre></div><h2 id=éƒ¨ç½²nfs>éƒ¨ç½²NFS<a hidden class=anchor aria-hidden=true href=#éƒ¨ç½²nfs>#</a></h2><ul><li>å®‰è£…è½¯ä»¶åŒ…</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yum install -y nfs-utils
</span></span></code></pre></div><ul><li>é…ç½®æœåŠ¡ç«¯</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir /userhome
</span></span><span class=line><span class=cl>chmod -R <span class=m>777</span> /userhome
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;/userhome *(rw,sync,insecure,no_root_squash)&#34;</span> &gt;&gt; /etc/exports
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å¯åŠ¨æœåŠ¡</span>
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> --now nfs-server
</span></span><span class=line><span class=cl>systemctl status nfs-server
</span></span></code></pre></div><ul><li>é…ç½®å®¢æˆ·ç«¯</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir /userhome
</span></span><span class=line><span class=cl>mount server-ip:/userhome /userhome
</span></span></code></pre></div><h1 id=å‡†å¤‡æ•°æ®é›†>å‡†å¤‡æ•°æ®é›†<a hidden class=anchor aria-hidden=true href=#å‡†å¤‡æ•°æ®é›†>#</a></h1><h2 id=æ•°æ®é›†ä¸‹è½½>æ•°æ®é›†ä¸‹è½½<a hidden class=anchor aria-hidden=true href=#æ•°æ®é›†ä¸‹è½½>#</a></h2><ul><li>Imagenetå®˜æ–¹åœ°å€ï¼šhttp://www.image-net.org/index</li><li>ä½¿ç”¨ImageNet-2012æ•°æ®é›†</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span>  /userhome/AIPerf/scripts/build_data
</span></span><span class=line><span class=cl>./download_imagenet.sh
</span></span><span class=line><span class=cl>ls ./imagenet
</span></span></code></pre></div><ul><li>åŸå§‹çš„ImageNet-2012åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶:</li><li>ILSVRC2012_img_val.tar</li><li>ILSVRC2012_img_train.tar</li></ul><h2 id=tfreordåˆ¶ä½œ>TFReordåˆ¶ä½œ<a hidden class=anchor aria-hidden=true href=#tfreordåˆ¶ä½œ>#</a></h2><ul><li>è®­ç»ƒé›†å’ŒéªŒè¯é›†éœ€è¦æŒ‰ç…§1000ä¸ªå­ç›®å½•ä¸‹åŒ…å«å›¾ç‰‡çš„æ ¼å¼ï¼Œå¤„ç†æ­¥éª¤ï¼š</li></ul><ol><li>å°†train å’Œ val çš„æ•°æ®æŒ‰ç…§æ–‡ä»¶å¤¹åˆ†ç±»</li><li>æŒ‡å®šå‚æ•°è¿è¡Œbuild_imagenet_data.py</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># åšéªŒè¯é›†</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span>  /userhome/AIPerf/scripts/build_data
</span></span><span class=line><span class=cl>mkdir -p ILSVRC2012/raw-data/imagenet-data/validation/  
</span></span><span class=line><span class=cl>tar -xvf imagenet/ILSVRC2012_img_val.tar -C ILSVRC2012/raw-data/imagenet-data/validation/
</span></span><span class=line><span class=cl>python preprocess_imagenet_validation_data.py ILSVRC2012/raw-data/imagenet-data/validation/ imagenet_2012_validation_synset_labels.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åšè®­ç»ƒé›†</span>
</span></span><span class=line><span class=cl>mkdir -p ILSVRC2012/raw-data/imagenet-data/train/
</span></span><span class=line><span class=cl>tar -xvf imagenet/ILSVRC2012_img_train.tar -C ILSVRC2012/raw-data/imagenet-data/train/ <span class=o>&amp;&amp;</span> <span class=nb>cd</span> ILSVRC2012/raw-data/imagenet-data/train
</span></span><span class=line><span class=cl>find . -name <span class=s2>&#34;*.tar&#34;</span> <span class=p>|</span> <span class=k>while</span> <span class=nb>read</span> NAE <span class=p>;</span> <span class=k>do</span> mkdir -p <span class=s2>&#34;</span><span class=si>${</span><span class=nv>NAE</span><span class=p>%.tar</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span> tar -xvf <span class=s2>&#34;</span><span class=si>${</span><span class=nv>NAE</span><span class=si>}</span><span class=s2>&#34;</span> -C <span class=s2>&#34;</span><span class=si>${</span><span class=nv>NAE</span><span class=p>%.tar</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span> rm -f <span class=s2>&#34;</span><span class=si>${</span><span class=nv>NAE</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>done</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /userhome/AIPerf/scripts/build_data
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># TensorFlowéœ€è¦åˆ¶ä½œTFRecord</span>
</span></span><span class=line><span class=cl>mkdir -p ILSVRC2012/output
</span></span><span class=line><span class=cl>python build_imagenet_data.py <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--train_directory<span class=o>=</span>ILSVRC2012/raw-data/imagenet-data/train <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--validation_directory<span class=o>=</span>ILSVRC2012/raw-data/imagenet-data/validation <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--output_directory<span class=o>=</span>ILSVRC2012/output <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--imagenet_metadata_file<span class=o>=</span>imagenet_metadata.txt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--labels_file<span class=o>=</span>imagenet_lsvrc_2015_synsets.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åœ¨ILSVRC2012/outputç›®å½•ä¸‹ç”Ÿæˆ128ä¸ªvalidationå¼€å¤´çš„éªŒè¯é›†æ–‡ä»¶å’Œ1024ä¸ªtrainå¼€å¤´çš„è®­ç»ƒé›†æ–‡ä»¶ã€‚</span>
</span></span></code></pre></div><h2 id=åˆ†å‘æ•°æ®é›†>åˆ†å‘æ•°æ®é›†<a hidden class=anchor aria-hidden=true href=#åˆ†å‘æ•°æ®é›†>#</a></h2><ul><li><strong>å¯¹TensorFlow</strong>ï¼Œå°†éªŒè¯é›†å’Œæ•°æ®é›†ç§»åŠ¨åˆ°slaveèŠ‚ç‚¹ã€‚</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -p /root/datasets/imagenet/train
</span></span><span class=line><span class=cl>mkdir -p /root/datasets/imagenet/val
</span></span><span class=line><span class=cl>mv ILSVRC2012/output/train-* /root/datasets/imagenet/train
</span></span><span class=line><span class=cl>mv ILSVRC2012/output/validation-* /root/datasets/imagenet/val
</span></span></code></pre></div><ul><li><strong>å¯¹å…¶ä»–æ¨¡å‹</strong>ï¼Œå°†è§£å‹åéªŒè¯é›†å’Œæ•°æ®é›†ç§»åŠ¨åˆ°slaveèŠ‚ç‚¹ï¼Œæ ¹æ®æ¡†æ¶è‡ªè¡Œè°ƒæ•´ã€‚</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># å¯¹PyTorch</span>
</span></span><span class=line><span class=cl>mkdir -p /root/datasets/imagenet/
</span></span><span class=line><span class=cl>mv ILSVRC2012/train /root/datasets/imagenet
</span></span><span class=line><span class=cl>mv ILSVRC2012/val /root/datasets/imagenet
</span></span></code></pre></div><h1 id=é¡¹ç›®å®‰è£…>é¡¹ç›®å®‰è£…<a hidden class=anchor aria-hidden=true href=#é¡¹ç›®å®‰è£…>#</a></h1><h2 id=ç¯å¢ƒå˜é‡å£°æ˜>ç¯å¢ƒå˜é‡å£°æ˜<a hidden class=anchor aria-hidden=true href=#ç¯å¢ƒå˜é‡å£°æ˜>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>AIPERF_WORKDIR</span><span class=o>=</span>/userhome
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>AIPERF_SLAVE_WORKDIR</span><span class=o>=</span>/root/
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>AIPERF_MASTER_IP</span><span class=o>=</span>10.0.1.100
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>AIPERF_MASTER_PORT</span><span class=o>=</span><span class=m>9987</span>
</span></span></code></pre></div><pre tabindex=0><code>* AIPERF_WORKDIR
  AIPerfå·¥ä½œç›®å½•ï¼Œå¿…é¡»åœ¨å…±äº«å­˜å‚¨ä¸Šï¼Œèƒ½è¢«æ‰€æœ‰èŠ‚ç‚¹è®¿é—®åˆ°
  AIPerfä»£ç ï¼Œéƒ¨åˆ†logæ–‡ä»¶ç­‰å°†ä¼šè¢«æ”¾åˆ°è¿™ä¸ªç›®å½•

* AIPERF_SLAVE_WORKDIR
  è®¡ç®—èŠ‚ç‚¹å·¥ä½œç›®å½•ï¼Œä¸éœ€è¦åœ¨å…±äº«å­˜å‚¨ä¸Šï¼ˆä¹Ÿå¯ä»¥æ”¾åœ¨å…±äº«å­˜å‚¨ï¼‰
  éƒ¨åˆ†è®¡ç®—èŠ‚ç‚¹logæ–‡ä»¶å°†ä¼šè¢«ç”Ÿæˆåˆ°è¿™ä¸ªç›®å½•ä¸‹

* AIPERF_MASTER_IP
  AIPerfè°ƒåº¦æœåŠ¡IPï¼Œå³æ§åˆ¶èŠ‚ç‚¹IP

* AIPERF_MASTER_PORT
  AIPerfè°ƒåº¦æœåŠ¡ç«¯å£
</code></pre><h2 id=ä¸‹è½½æºä»£ç >ä¸‹è½½æºä»£ç <a hidden class=anchor aria-hidden=true href=#ä¸‹è½½æºä»£ç >#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># åœ¨å…±äº«å­˜å‚¨ä¸Šåˆ›å»ºAIPerfå·¥ä½œç›®å½•</span>
</span></span><span class=line><span class=cl>mkdir -p <span class=nv>$AIPERF_WORKDIR</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ä¸‹è½½æºä»£ç </span>
</span></span><span class=line><span class=cl>git clone https://github.com/thu-pacman/AIPerf.git <span class=nv>$AIPERF_WORKDIR</span>/AIPerf
</span></span></code></pre></div><ul><li>AIPerfç›®å½•ä¸‹<code>aiperf_setenv.sh</code>è„šæœ¬è®¾ç½®ç¯å¢ƒå˜é‡ã€‚</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>source</span> <span class=nv>$AIPERF_WORKDIR</span>/AIPerf/aiperf_setenv.sh
</span></span></code></pre></div><h2 id=å®‰è£…ä¾èµ–åŒ…>å®‰è£…ä¾èµ–åŒ…<a hidden class=anchor aria-hidden=true href=#å®‰è£…ä¾èµ–åŒ…>#</a></h2><h3 id=å®‰è£…python>å®‰è£…Python<a hidden class=anchor aria-hidden=true href=#å®‰è£…python>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://www.python.org/ftp/python/3.8.20/python-3.9.20.tgz
</span></span><span class=line><span class=cl>tar -zxvf python-3.9.20.tgz
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å®‰è£…ä¾èµ–åŒ…</span>
</span></span><span class=line><span class=cl>yum install -y gcc gcc-c++ make openssl-devel bzip2-devel libffi-devel
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ç¼–è¯‘å®‰è£…</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> python-3.9.20
</span></span><span class=line><span class=cl>./configure --prefix<span class=o>=</span>/usr/local/python3 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-ensurepip<span class=o>=</span>install <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-optimizations
</span></span><span class=line><span class=cl>make <span class=o>&amp;&amp;</span> make install
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è®¾ç½®ç¯å¢ƒå˜é‡</span>
</span></span><span class=line><span class=cl><span class=c1># ln -s /usr/local/python3/bin/python3.9 /usr/bin/python3</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;export PATH=/usr/local/python3/bin:$PATH&#39;</span> &gt;&gt; ~/.bash_profile
</span></span><span class=line><span class=cl><span class=nb>source</span> ~/.bash_profile
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å‡çº§pipå’Œsetuptools</span>
</span></span><span class=line><span class=cl><span class=c1># ä¸´æ—¶é•œåƒæº: https://mirrors.tuna.tsinghua.edu.cn/help/pypi/</span>
</span></span><span class=line><span class=cl>python3 -m pip install --upgrade pip -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple
</span></span><span class=line><span class=cl>python3 -m pip install --upgrade setuptools -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple
</span></span></code></pre></div><h3 id=æ§åˆ¶èŠ‚ç‚¹>æ§åˆ¶èŠ‚ç‚¹<a hidden class=anchor aria-hidden=true href=#æ§åˆ¶èŠ‚ç‚¹>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># python3 -m pip install -r $AIPERF_WORKDIR/AIPerf/requirements_master.txt</span>
</span></span><span class=line><span class=cl>python3 -m pip install scikit-learn pyyaml django schema colorama ruamel.yaml matplotlib jinja2 zmq <span class=nv>torch</span><span class=o>==</span>1.8.0 <span class=nv>hyperopt</span><span class=o>==</span>0.1.2 json_tricks <span class=s2>&#34;numpy&lt;2.0&#34;</span> scipy coverage psutil
</span></span></code></pre></div><h3 id=è®¡ç®—èŠ‚ç‚¹>è®¡ç®—èŠ‚ç‚¹<a hidden class=anchor aria-hidden=true href=#è®¡ç®—èŠ‚ç‚¹>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># python3 -m pip install -r $AIPERF_WORKDIR/AIPerf/requirements_slave.txt</span>
</span></span><span class=line><span class=cl><span class=c1># æ ¹æ®CUDAå’ŒcuDNNç‰ˆæœ¬é€‰æ‹©è®¡ç®—æ¡†æ¶ç‰ˆæœ¬ï¼Œä¾‹å¦‚å¯¹äºCUDA 11.2ï¼ŒcuDNN 8.1ï¼Œå¯é€‰æ‹©tensorflow 2.5.0</span>
</span></span><span class=line><span class=cl><span class=c1># python3 -m pip install tensorflow==2.5.0</span>
</span></span><span class=line><span class=cl>python3 -m pip install zmq scikit-learn psutil dill <span class=nv>hyperopt</span><span class=o>==</span>0.1.2 json_tricks <span class=s2>&#34;numpy&lt;2.0&#34;</span> scipy coverage <span class=nv>tensorflow</span><span class=o>==</span>2.5.0 <span class=nv>torch</span><span class=o>==</span>1.8.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># sample install nvidia driver</span>
</span></span><span class=line><span class=cl>wget https://us.download.nvidia.com/tesla/460.106.00/NVIDIA-Linux-x86_64-460.106.00.run
</span></span><span class=line><span class=cl>sh NVIDIA-Linux-x86_64-460.106.00.run
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># CUDA Toolkit 11.2</span>
</span></span><span class=line><span class=cl><span class=c1># https://developer.nvidia.com/cuda-11.2.0-download-archive</span>
</span></span><span class=line><span class=cl>wget https://developer.download.nvidia.com/compute/cuda/11.2.0/local_installers/cuda_11.2.0_460.27.04_linux.run
</span></span><span class=line><span class=cl>sh cuda_11.2.0_460.27.04_linux.run
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># environment variables</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span>/usr/local/cuda/bin<span class=si>${</span><span class=nv>PATH</span><span class=p>:+:</span><span class=si>${</span><span class=nv>PATH</span><span class=si>}}</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>LD_LIBRARY_PATH</span><span class=o>=</span>/usr/local/cuda/lib64<span class=si>${</span><span class=nv>LD_LIBRARY_PATH</span><span class=p>:+:</span><span class=si>${</span><span class=nv>LD_LIBRARY_PATH</span><span class=si>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># cuDNN 8.1</span>
</span></span><span class=line><span class=cl><span class=c1># https://developer.nvidia.com/rdp/cudnn-archive</span>
</span></span><span class=line><span class=cl><span class=c1># https://developer.nvidia.com/compute/machine-learning/cudnn/secure/8.1.0.77/11.2_20210127/cudnn-11.2-linux-x64-v8.1.0.77.tgz</span>
</span></span><span class=line><span class=cl>wget https://developer.download.nvidia.com/compute/redist/cudnn/v8.1.0/cudnn-11.2-linux-x64-v8.1.0.77.tgz
</span></span><span class=line><span class=cl>tar -zvxf cudnn-11.2-linux-x64-v8.1.0.77.tgz
</span></span><span class=line><span class=cl>cp -P cuda/include/cudnn.h /usr/local/cuda/include
</span></span><span class=line><span class=cl>cp -P cuda/lib64/libcudnn* /usr/local/cuda/lib64/
</span></span><span class=line><span class=cl>chmod a+r /usr/local/cuda/include/cudnn.h
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#check cuda</span>
</span></span><span class=line><span class=cl>nvidia-smi
</span></span><span class=line><span class=cl><span class=c1>#check cudnn</span>
</span></span><span class=line><span class=cl>nvcc -V
</span></span></code></pre></div><h2 id=å®‰è£…aiperf>å®‰è£…AIPerf<a hidden class=anchor aria-hidden=true href=#å®‰è£…aiperf>#</a></h2><h3 id=æ§åˆ¶èŠ‚ç‚¹-1>æ§åˆ¶èŠ‚ç‚¹<a hidden class=anchor aria-hidden=true href=#æ§åˆ¶èŠ‚ç‚¹-1>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># å®‰è£…AutoMLç»„ä»¶</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=nv>$AIPERF_WORKDIR</span>/AIPerf/src/sdk/pynni/
</span></span><span class=line><span class=cl>python3 -m pip install -e .
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å®‰è£…aiperfæ§åˆ¶ç»„ä»¶</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=nv>$AIPERF_WORKDIR</span>/AIPerf/src/aiperf_manager/
</span></span><span class=line><span class=cl>python3 -m pip install -e .
</span></span><span class=line><span class=cl>aiperf --help
</span></span></code></pre></div><h3 id=è®¡ç®—èŠ‚ç‚¹-1>è®¡ç®—èŠ‚ç‚¹<a hidden class=anchor aria-hidden=true href=#è®¡ç®—èŠ‚ç‚¹-1>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># å®‰è£…AutoMLç»„ä»¶</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=nv>$AIPERF_WORKDIR</span>/AIPerf/src/sdk/pynni/
</span></span><span class=line><span class=cl>python3 -m pip install -e .
</span></span></code></pre></div><h3 id=ä¸‹è½½æ¨¡å‹æƒé‡>ä¸‹è½½æ¨¡å‹æƒé‡<a hidden class=anchor aria-hidden=true href=#ä¸‹è½½æ¨¡å‹æƒé‡>#</a></h3><ul><li>å°†æƒé‡æ–‡ä»¶resnet50_weights_tf_dim_ordering_tf_kernels.h5ä¸‹è½½å¹¶æ”¾åˆ°$AIPERF_WORKDIRä¸‹</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ç™¾åº¦äº‘ç›˜ https://pan.baidu.com/s/1JBOh2XwetZAalLdmULBN2Q æå–ç : 5nbc</span>
</span></span><span class=line><span class=cl>mv resnet50_weights_tf_dim_ordering_tf_kernels.h5 <span class=nv>$AIPERF_WORKDIR</span>
</span></span><span class=line><span class=cl><span class=o>(</span>md5sum: a7b3fe01876f51b976af0dea6bc144eb<span class=o>)</span>
</span></span></code></pre></div><h2 id=å¯åŠ¨æµ‹è¯•æ§åˆ¶èŠ‚ç‚¹>å¯åŠ¨æµ‹è¯•(æ§åˆ¶èŠ‚ç‚¹)<a hidden class=anchor aria-hidden=true href=#å¯åŠ¨æµ‹è¯•æ§åˆ¶èŠ‚ç‚¹>#</a></h2><h3 id=å¯åŠ¨è°ƒåº¦æœåŠ¡>å¯åŠ¨è°ƒåº¦æœåŠ¡<a hidden class=anchor aria-hidden=true href=#å¯åŠ¨è°ƒåº¦æœåŠ¡>#</a></h3><ul><li>é…ç½®è®¡ç®—èŠ‚ç‚¹ä¿¡æ¯ ${AIPERF_WORKDIR}/AIPerf/aiperf_ctrl/servers.json</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ä¾‹å¦‚ï¼Œé›†ç¾¤æœ‰2ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹æœ‰4å¼ GPUï¼Œåˆ™é…ç½®å¦‚ä¸‹ï¼š</span>
</span></span><span class=line><span class=cl><span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ip&#34;</span>: <span class=s2>&#34;172.23.33.33&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag&#34;</span>: <span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;status&#34;</span>: <span class=s2>&#34;waiting&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;CUDA_VISIBLE_DEVICES&#34;</span>: <span class=s2>&#34;0,1,2,3&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ip&#34;</span>: <span class=s2>&#34;172.23.33.34&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag&#34;</span>: <span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;status&#34;</span>: <span class=s2>&#34;waiting&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;CUDA_VISIBLE_DEVICES&#34;</span>: <span class=s2>&#34;0,1,2,3&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>   
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span></code></pre></div><ul><li>å¯åŠ¨å‘½ä»¤</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> <span class=nv>$AIPERF_WORKDIR</span>/AIPerf/aiperf_ctrl
</span></span><span class=line><span class=cl>python3 manage.py runserver <span class=si>${</span><span class=nv>AIPERF_MASTER_IP</span><span class=si>}</span>:<span class=si>${</span><span class=nv>AIPERF_MASTER_PORT</span><span class=si>}</span>
</span></span></code></pre></div><h3 id=å¯åŠ¨aiperfæµ‹è¯•>å¯åŠ¨AIPerfæµ‹è¯•<a hidden class=anchor aria-hidden=true href=#å¯åŠ¨aiperfæµ‹è¯•>#</a></h3><ul><li><p>æµ‹è¯•åŸºæœ¬æ¡ä»¶ï¼š<br>1.æµ‹è¯•è¿è¡Œæ—¶é—´åº”ä¸å°‘äº1å°æ—¶ï¼›<br>2.æµ‹è¯•çš„è®¡ç®—ç²¾åº¦ä¸ä½äºFP-16ï¼›<br>3.æµ‹è¯•å®Œæˆæ—¶æ‰€å–å¾—çš„æœ€é«˜æ­£ç¡®ç‡åº”å¤§äº70%ï¼›</p></li><li><p>åˆå§‹åŒ–é…ç½® ${AIPERF_WORKDIR}/AIPerf/examples/trials/network_morphism/imagenet/config.yml</p><p>å…³é”®å‚æ•°è§£é‡Š:</p></li></ul><table><thead><tr><th></th><th style=text-align:center>å¯é€‰å‚æ•°</th><th style=text-align:center>è¯´æ˜</th><th style=text-align:center>é»˜è®¤å€¼</th></tr></thead><tbody><tr><td>1</td><td style=text-align:center>trialConcurrency</td><td style=text-align:center>åŒæ—¶è¿è¡Œçš„trialæ•°</td><td style=text-align:center>1</td></tr><tr><td>2</td><td style=text-align:center>maxExecDuration</td><td style=text-align:center>è®¾ç½®æµ‹è¯•æ—¶é—´(å•ä½ ï¼šh)</td><td style=text-align:center>12</td></tr><tr><td>3</td><td style=text-align:center>CUDA_VISIBLE_DEVICES</td><td style=text-align:center>æŒ‡å®šæµ‹è¯•ç¨‹åºå¯ç”¨çš„gpuç´¢å¼•</td><td style=text-align:center>0,1,2,3,4,5,6,7</td></tr><tr><td>4</td><td style=text-align:center>srunï¼š&ndash;cpus-per-task=30</td><td style=text-align:center>å‚æ•°ä¸ºslurmå¯ç”¨cpuæ ¸æ•°å‡ 1</td><td style=text-align:center>30</td></tr><tr><td>5</td><td style=text-align:center>&ndash;slave</td><td style=text-align:center><strong>è·Ÿ trialConcurrencyå‚æ•°ä¿æŒä¸€è‡´</strong></td><td style=text-align:center>1</td></tr><tr><td>6</td><td style=text-align:center>&ndash;ip</td><td style=text-align:center>masterèŠ‚ç‚¹ipï¼Œç›´æ¥ä½¿ç”¨é»˜è®¤å€¼</td><td style=text-align:center>${AIPERF_MASTER_IP}</td></tr><tr><td>7</td><td style=text-align:center>&ndash;batch_size</td><td style=text-align:center>batch size</td><td style=text-align:center>448</td></tr><tr><td>8</td><td style=text-align:center>&ndash;epochs</td><td style=text-align:center>æ­£å¸¸è®­ç»ƒepochæ•°</td><td style=text-align:center>60</td></tr><tr><td>9</td><td style=text-align:center>&ndash;initial_lr</td><td style=text-align:center>åˆå§‹å­¦ä¹ ç‡</td><td style=text-align:center>1e-1</td></tr><tr><td>10</td><td style=text-align:center>&ndash;final_lr</td><td style=text-align:center>æœ€ç»ˆå­¦ä¹ ç‡</td><td style=text-align:center>0</td></tr><tr><td>11</td><td style=text-align:center>&ndash;train_data_dir</td><td style=text-align:center>è®­ç»ƒæ•°æ®é›†è·¯å¾„</td><td style=text-align:center>None</td></tr><tr><td>12</td><td style=text-align:center>&ndash;val_data_dir</td><td style=text-align:center>éªŒè¯æ•°æ®é›†è·¯å¾„</td><td style=text-align:center>None</td></tr><tr><td>13</td><td style=text-align:center>&ndash;warmup_1</td><td style=text-align:center>warm upæœºåˆ¶ç¬¬ä¸€è½®epochæ•°</td><td style=text-align:center>15</td></tr><tr><td>14</td><td style=text-align:center>&ndash;warmup_2</td><td style=text-align:center>warm upæœºåˆ¶ç¬¬äºŒè½®epochæ•°</td><td style=text-align:center>30</td></tr><tr><td>15</td><td style=text-align:center>&ndash;warmup_3</td><td style=text-align:center>warm upæœºåˆ¶ç¬¬ä¸‰è½®epochæ•°</td><td style=text-align:center>45</td></tr><tr><td>16</td><td style=text-align:center>&ndash;num_parallel_calls</td><td style=text-align:center>tfrecordæ•°æ®åŠ è½½åŠ é€Ÿ</td><td style=text-align:center>48</td></tr></tbody></table><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ç¤ºä¾‹</span>
</span></span><span class=line><span class=cl>authorName: default
</span></span><span class=line><span class=cl>experimentName: example_imagenet-network-morphism-test
</span></span><span class=line><span class=cl>trialConcurrency: <span class=m>2</span>
</span></span><span class=line><span class=cl>maxExecDuration: 24h
</span></span><span class=line><span class=cl>maxTrialNum: <span class=m>9999</span>
</span></span><span class=line><span class=cl>trainingServicePlatform: <span class=nb>local</span>
</span></span><span class=line><span class=cl>useAnnotation: <span class=nb>false</span>
</span></span><span class=line><span class=cl>logLevel: trace
</span></span><span class=line><span class=cl>tuner:
</span></span><span class=line><span class=cl>  <span class=c1>#choice: TPE, Random, Anneal, Evolution, BatchTuner, NetworkMorphism</span>
</span></span><span class=line><span class=cl>  <span class=c1>#SMAC (SMAC should be installed through nnictl)</span>
</span></span><span class=line><span class=cl>  builtinTunerName: NetworkMorphism
</span></span><span class=line><span class=cl>  classArgs:
</span></span><span class=line><span class=cl>    <span class=c1>#choice: maximize, minimize</span>
</span></span><span class=line><span class=cl>    optimize_mode: maximize
</span></span><span class=line><span class=cl>    <span class=c1>#for now, this tuner only supports cv domain</span>
</span></span><span class=line><span class=cl>    task: cv
</span></span><span class=line><span class=cl>    <span class=c1>#input image width</span>
</span></span><span class=line><span class=cl>    input_width: <span class=m>224</span>
</span></span><span class=line><span class=cl>    <span class=c1>#input image channel</span>
</span></span><span class=line><span class=cl>    input_channel: <span class=m>3</span>
</span></span><span class=line><span class=cl>    <span class=c1>#number of classes</span>
</span></span><span class=line><span class=cl>    n_output_node: <span class=m>1000</span>
</span></span><span class=line><span class=cl>trial:
</span></span><span class=line><span class=cl>  command: <span class=nv>CUDA_VISIBLE_DEVICES</span><span class=o>=</span><span class=m>0</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           python3 imagenet_train.py <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           --slave <span class=m>2</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           --ip <span class=si>${</span><span class=nv>AIPERF_MASTER_IP</span><span class=si>}</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           --batch_size <span class=m>448</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           --epoch <span class=m>60</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           --initial_lr 1e-1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           --final_lr <span class=m>0</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           --train_data_dir /root/datasets/imagenet/train <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           --val_data_dir /root/datasets/imagenet/val
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  codeDir: .
</span></span><span class=line><span class=cl>  gpuNum: <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ³¨æ„é…ç½®æ–‡ä»¶ä¸­slaveå‚æ•°éœ€è¦å’ŒtrialConcurrencyå‚æ•°ä¸€è‡´ï¼Œä¿®æ”¹ä¸ºè®¡ç®—èŠ‚ç‚¹ä¸ªæ•°</span>
</span></span><span class=line><span class=cl><span class=c1># ä¿®æ”¹CUDA_VISIBLE_DEVICESä¸ºè®¡ç®—èŠ‚ç‚¹æ‰€ç”¨çš„GPU</span>
</span></span><span class=line><span class=cl><span class=c1># éœ€è¦ä¿®æ”¹--train_data_dirå’Œ--var_data_dirçš„ä½ç½®ä»¥æŒ‡å‘è®¡ç®—èŠ‚ç‚¹æ•°æ®é›†å­˜å‚¨ä½ç½®</span>
</span></span></code></pre></div><ul><li><p>è¿è¡Œbenchmark</p><p>åœ¨${AIPERF_WORKDIR}/AIPerf/examples/trials/network_morphism/imagenet/ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿è¡Œç”¨ä¾‹</p><p>æ³¨ï¼šè‹¥ä½¿ç”¨pyTorchï¼Œè¯·åœ¨ ${AIPERF_WORKDIR}/AIPerf/examples/trials/network_morphism/imagenetTorch/ä¸‹æ‰§è¡Œ</p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># å¯åŠ¨</span>
</span></span><span class=line><span class=cl>aiperf create -c config.yml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åœæ­¢,ctrl-cç»ˆæ­¢</span>
</span></span><span class=line><span class=cl><span class=c1># æ¸…ç†æ‰€æœ‰è®¡ç®—èŠ‚ç‚¹ä¸Šçš„è®­ç»ƒè¿›ç¨‹</span>
</span></span><span class=line><span class=cl>aiperf clean
</span></span></code></pre></div><ul><li><p>æŸ¥çœ‹çŠ¶æ€</p><p>å½“æµ‹è¯•è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œè¿è¡Œä»¥ä¸‹ç¨‹åºä¼šåœ¨ç»ˆç«¯æ‰“å°experimentçš„Errorã€Scoreã€Regulated Scoreç­‰ä¿¡æ¯</p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python3 <span class=nv>$AIPERF_WORKDIR</span>/AIPerf/scripts/reports/report.py --id  experiment_ID  
</span></span></code></pre></div><ul><li>åŒæ—¶ä¼šäº§ç”Ÿå®éªŒæŠ¥å‘Šå­˜æ”¾åœ¨experiment_IDçš„å¯¹åº”è·¯å¾„${AIPERF_WORKDIR}/mountdir/nni/experiments/experiment_ID/resultsç›®å½•ä¸‹ã€‚<br>å®éªŒæˆåŠŸæ—¶æŠ¥å‘Šä¸º Report_Succeed.htmlã€‚<br>å®éªŒå¤±è´¥æ—¶æŠ¥å‘Šä¸º Report_Failed.htmlã€‚<br>å®éªŒå¤±è´¥ä¼šæŠ¥å‘Šå¤±è´¥åŸå› ï¼Œè¯·æŸ¥é˜…AI Benchmarkæµ‹è¯•è§„èŒƒåˆ†æå¤±è´¥åŸå› ã€‚</li></ul><h1 id=ä¿å­˜æ—¥å¿—ç»“æœæ•°æ®>ä¿å­˜æ—¥å¿—&ç»“æœæ•°æ®<a hidden class=anchor aria-hidden=true href=#ä¿å­˜æ—¥å¿—ç»“æœæ•°æ®>#</a></h1><ul><li>è¿è¡Œä»¥ä¸‹ç¨‹åºå¯å°†æµ‹è¯•äº§ç”Ÿçš„æ—¥å¿—ä»¥åŠæ•°æ®ç»Ÿä¸€ä¿å­˜åˆ°${AIPERF_WORKDIR}/mountdir/nni/experiments/experiment_ID/results/logsä¸­ï¼Œä¾¿äºå®éªŒåˆ†æã€‚
ç”±äºå®éªŒæ•°æ®åœ¨å¤åˆ¶è¿‡ç¨‹ä¸­ä¼šå¯¼è‡´é¢å¤–çš„ç½‘ç»œã€å†…å­˜ã€cpuç­‰èµ„æºå¼€é”€ï¼Œå»ºè®®åœ¨å®éªŒåœæ­¢/ç»“æŸåå†æ‰§è¡Œæ—¥å¿—ä¿å­˜æ“ä½œã€‚</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python3 <span class=nv>$AIPERF_WORKDIR</span>/AIPerf/scripts/reports/report.py --id  experiment_ID  --logs True
</span></span></code></pre></div><h1 id=æµ‹è¯•å‚æ•°è®¾ç½®åŠæ¨èç¯å¢ƒé…ç½®å®˜æ–¹>æµ‹è¯•å‚æ•°è®¾ç½®åŠæ¨èç¯å¢ƒé…ç½®(å®˜æ–¹)<a hidden class=anchor aria-hidden=true href=#æµ‹è¯•å‚æ•°è®¾ç½®åŠæ¨èç¯å¢ƒé…ç½®å®˜æ–¹>#</a></h1><ul><li>å¯å˜è®¾ç½®</li></ul><ol><li>slaveè®¡ç®—èŠ‚ç‚¹çš„GPUå¡æ•°ï¼šé»˜è®¤å°†å•ä¸ªç‰©ç†æœåŠ¡å™¨ä½œä¸ºä¸€ä¸ªslaveèŠ‚ç‚¹ï¼Œå¹¶ä½¿ç”¨å…¶æ‰€æœ‰GPUï¼›</li><li>æ·±åº¦å­¦ä¹ æ¡†æ¶ï¼šé»˜è®¤ä½¿ç”¨keras+tensorflowï¼›</li><li>æ•°æ®é›†åŠ è½½æ–¹å¼ï¼šé»˜è®¤å°†æ•°æ®é¢„å¤„ç†æˆTFRecordæ ¼å¼ï¼Œä»¥åŠ å¿«æ•°æ®åŠ è½½çš„æ•ˆç‡ï¼›</li><li>æ•°æ®é›†å­˜å‚¨æ–¹å¼ï¼šé»˜è®¤é‡‡ç”¨ç½‘ç»œå…±äº«å­˜å‚¨ï¼›</li><li>è¶…å‚è®¾ç½®ï¼šé»˜è®¤åˆå§‹batch size=448ï¼Œé»˜è®¤åˆå§‹å­¦ä¹ ç‡=0.1ï¼Œé»˜è®¤æœ€ç»ˆå­¦ä¹ ç‡=0ï¼Œé»˜è®¤æ­£å¸¸è®­ç»ƒepochs=60ï¼Œé»˜è®¤ä»ç¬¬å››è½®trialå¼€å§‹ï¼Œæ¯ä¸ªtrialæœç´¢1æ¬¡ï¼Œé»˜è®¤è¶…å‚ä¸ºkernel sizeå’Œbatch sizeã€‚</li></ol><ul><li><p>æ¨èç¯å¢ƒé…ç½®</p><p>è½¯ä»¶ï¼šTensorFlow2.5.0ï¼ŒCUDA11.2ï¼ŒcuDNN8.1ï¼Œpython3.8</p></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://gnail89.github.io/tags/aiperf/>Aiperf</a></li><li><a href=https://gnail89.github.io/tags/cuda/>Cuda</a></li><li><a href=https://gnail89.github.io/tags/cudnn/>Cudnn</a></li><li><a href=https://gnail89.github.io/tags/tensorflow/>Tensorflow</a></li></ul><nav class=paginav><a class=prev href=https://gnail89.github.io/posts/cve-1999-0524/><span class=title>Â« Prev</span><br><span>CVE-1999-0524</span>
</a><a class=next href=https://gnail89.github.io/posts/kubectl-study/><span class=title>Next Â»</span><br><span>Kubectl Study</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://gnail89.github.io/>ğŸ“•W.'s Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>