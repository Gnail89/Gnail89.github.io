<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>AIPerf 基准测试工具安装 | 📕W.'s Blog</title>
<meta name=keywords content="aiperf,cuda,cudnn,tensorflow"><meta name=description content='开源项目地址: https://github.com/thu-pacman/AIPerf
基础环境 SSH免密 ssh-keygen -t rsa ssh-copy-id -i ~/.ssh/id_rsa.pub server-ip 部署NFS 安装软件包 yum install -y nfs-utils 配置服务端 mkdir /userhome chmod -R 777 /userhome echo "/userhome *(rw,sync,insecure,no_root_squash)" >> /etc/exports # 启动服务 systemctl enable --now nfs-server systemctl status nfs-server 配置客户端 mkdir /userhome mount server-ip:/userhome /userhome 准备数据集 数据集下载 Imagenet官方地址：http://www.image-net.org/index 使用ImageNet-2012数据集 cd /userhome/AIPerf/scripts/build_data ./download_imagenet.sh ls ./imagenet 原始的ImageNet-2012包含以下两个文件: ILSVRC2012_img_val.tar ILSVRC2012_img_train.tar TFReord制作 训练集和验证集需要按照1000个子目录下包含图片的格式，处理步骤： 将train 和 val 的数据按照文件夹分类 指定参数运行build_imagenet_data.py # 做验证集 cd /userhome/AIPerf/scripts/build_data mkdir -p ILSVRC2012/raw-data/imagenet-data/validation/ tar -xvf imagenet/ILSVRC2012_img_val.'><meta name=author content><link rel=canonical href=https://gnail89.github.io/posts/aiperf-setup/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://gnail89.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://gnail89.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://gnail89.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://gnail89.github.io/apple-touch-icon.png><link rel=mask-icon href=https://gnail89.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://gnail89.github.io/posts/aiperf-setup/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="AIPerf 基准测试工具安装"><meta property="og:description" content='开源项目地址: https://github.com/thu-pacman/AIPerf
基础环境 SSH免密 ssh-keygen -t rsa ssh-copy-id -i ~/.ssh/id_rsa.pub server-ip 部署NFS 安装软件包 yum install -y nfs-utils 配置服务端 mkdir /userhome chmod -R 777 /userhome echo "/userhome *(rw,sync,insecure,no_root_squash)" >> /etc/exports # 启动服务 systemctl enable --now nfs-server systemctl status nfs-server 配置客户端 mkdir /userhome mount server-ip:/userhome /userhome 准备数据集 数据集下载 Imagenet官方地址：http://www.image-net.org/index 使用ImageNet-2012数据集 cd /userhome/AIPerf/scripts/build_data ./download_imagenet.sh ls ./imagenet 原始的ImageNet-2012包含以下两个文件: ILSVRC2012_img_val.tar ILSVRC2012_img_train.tar TFReord制作 训练集和验证集需要按照1000个子目录下包含图片的格式，处理步骤： 将train 和 val 的数据按照文件夹分类 指定参数运行build_imagenet_data.py # 做验证集 cd /userhome/AIPerf/scripts/build_data mkdir -p ILSVRC2012/raw-data/imagenet-data/validation/ tar -xvf imagenet/ILSVRC2012_img_val.'><meta property="og:type" content="article"><meta property="og:url" content="https://gnail89.github.io/posts/aiperf-setup/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-28T15:00:00+08:00"><meta property="article:modified_time" content="2024-11-28T15:00:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="AIPerf 基准测试工具安装"><meta name=twitter:description content='开源项目地址: https://github.com/thu-pacman/AIPerf
基础环境 SSH免密 ssh-keygen -t rsa ssh-copy-id -i ~/.ssh/id_rsa.pub server-ip 部署NFS 安装软件包 yum install -y nfs-utils 配置服务端 mkdir /userhome chmod -R 777 /userhome echo "/userhome *(rw,sync,insecure,no_root_squash)" >> /etc/exports # 启动服务 systemctl enable --now nfs-server systemctl status nfs-server 配置客户端 mkdir /userhome mount server-ip:/userhome /userhome 准备数据集 数据集下载 Imagenet官方地址：http://www.image-net.org/index 使用ImageNet-2012数据集 cd /userhome/AIPerf/scripts/build_data ./download_imagenet.sh ls ./imagenet 原始的ImageNet-2012包含以下两个文件: ILSVRC2012_img_val.tar ILSVRC2012_img_train.tar TFReord制作 训练集和验证集需要按照1000个子目录下包含图片的格式，处理步骤： 将train 和 val 的数据按照文件夹分类 指定参数运行build_imagenet_data.py # 做验证集 cd /userhome/AIPerf/scripts/build_data mkdir -p ILSVRC2012/raw-data/imagenet-data/validation/ tar -xvf imagenet/ILSVRC2012_img_val.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://gnail89.github.io/posts/"},{"@type":"ListItem","position":2,"name":"AIPerf 基准测试工具安装","item":"https://gnail89.github.io/posts/aiperf-setup/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"AIPerf 基准测试工具安装","name":"AIPerf 基准测试工具安装","description":"开源项目地址: https://github.com/thu-pacman/AIPerf\n基础环境 SSH免密 ssh-keygen -t rsa ssh-copy-id -i ~/.ssh/id_rsa.pub server-ip 部署NFS 安装软件包 yum install -y nfs-utils 配置服务端 mkdir /userhome chmod -R 777 /userhome echo \u0026#34;/userhome *(rw,sync,insecure,no_root_squash)\u0026#34; \u0026gt;\u0026gt; /etc/exports # 启动服务 systemctl enable --now nfs-server systemctl status nfs-server 配置客户端 mkdir /userhome mount server-ip:/userhome /userhome 准备数据集 数据集下载 Imagenet官方地址：http://www.image-net.org/index 使用ImageNet-2012数据集 cd /userhome/AIPerf/scripts/build_data ./download_imagenet.sh ls ./imagenet 原始的ImageNet-2012包含以下两个文件: ILSVRC2012_img_val.tar ILSVRC2012_img_train.tar TFReord制作 训练集和验证集需要按照1000个子目录下包含图片的格式，处理步骤： 将train 和 val 的数据按照文件夹分类 指定参数运行build_imagenet_data.py # 做验证集 cd /userhome/AIPerf/scripts/build_data mkdir -p ILSVRC2012/raw-data/imagenet-data/validation/ tar -xvf imagenet/ILSVRC2012_img_val.","keywords":["aiperf","cuda","cudnn","tensorflow"],"articleBody":"开源项目地址: https://github.com/thu-pacman/AIPerf\n基础环境 SSH免密 ssh-keygen -t rsa ssh-copy-id -i ~/.ssh/id_rsa.pub server-ip 部署NFS 安装软件包 yum install -y nfs-utils 配置服务端 mkdir /userhome chmod -R 777 /userhome echo \"/userhome *(rw,sync,insecure,no_root_squash)\" \u003e\u003e /etc/exports # 启动服务 systemctl enable --now nfs-server systemctl status nfs-server 配置客户端 mkdir /userhome mount server-ip:/userhome /userhome 准备数据集 数据集下载 Imagenet官方地址：http://www.image-net.org/index 使用ImageNet-2012数据集 cd /userhome/AIPerf/scripts/build_data ./download_imagenet.sh ls ./imagenet 原始的ImageNet-2012包含以下两个文件: ILSVRC2012_img_val.tar ILSVRC2012_img_train.tar TFReord制作 训练集和验证集需要按照1000个子目录下包含图片的格式，处理步骤： 将train 和 val 的数据按照文件夹分类 指定参数运行build_imagenet_data.py # 做验证集 cd /userhome/AIPerf/scripts/build_data mkdir -p ILSVRC2012/raw-data/imagenet-data/validation/ tar -xvf imagenet/ILSVRC2012_img_val.tar -C ILSVRC2012/raw-data/imagenet-data/validation/ python preprocess_imagenet_validation_data.py ILSVRC2012/raw-data/imagenet-data/validation/ imagenet_2012_validation_synset_labels.txt # 做训练集 mkdir -p ILSVRC2012/raw-data/imagenet-data/train/ tar -xvf imagenet/ILSVRC2012_img_train.tar -C ILSVRC2012/raw-data/imagenet-data/train/ \u0026\u0026 cd ILSVRC2012/raw-data/imagenet-data/train find . -name \"*.tar\" | while read NAE ; do mkdir -p \"${NAE%.tar}\"; tar -xvf \"${NAE}\" -C \"${NAE%.tar}\"; rm -f \"${NAE}\"; done cd /userhome/AIPerf/scripts/build_data # TensorFlow需要制作TFRecord mkdir -p ILSVRC2012/output python build_imagenet_data.py \\ --train_directory=ILSVRC2012/raw-data/imagenet-data/train \\ --validation_directory=ILSVRC2012/raw-data/imagenet-data/validation \\ --output_directory=ILSVRC2012/output \\ --imagenet_metadata_file=imagenet_metadata.txt \\ --labels_file=imagenet_lsvrc_2015_synsets.txt # 在ILSVRC2012/output目录下生成128个validation开头的验证集文件和1024个train开头的训练集文件。 分发数据集 对TensorFlow，将验证集和数据集移动到slave节点。 mkdir -p /root/datasets/imagenet/train mkdir -p /root/datasets/imagenet/val mv ILSVRC2012/output/train-* /root/datasets/imagenet/train mv ILSVRC2012/output/validation-* /root/datasets/imagenet/val 对其他模型，将解压后验证集和数据集移动到slave节点，根据框架自行调整。 # 对PyTorch mkdir -p /root/datasets/imagenet/ mv ILSVRC2012/train /root/datasets/imagenet mv ILSVRC2012/val /root/datasets/imagenet 项目安装 环境变量声明 export AIPERF_WORKDIR=/userhome export AIPERF_SLAVE_WORKDIR=/root/ export AIPERF_MASTER_IP=10.0.1.100 export AIPERF_MASTER_PORT=9987 * AIPERF_WORKDIR AIPerf工作目录，必须在共享存储上，能被所有节点访问到 AIPerf代码，部分log文件等将会被放到这个目录 * AIPERF_SLAVE_WORKDIR 计算节点工作目录，不需要在共享存储上（也可以放在共享存储） 部分计算节点log文件将会被生成到这个目录下 * AIPERF_MASTER_IP AIPerf调度服务IP，即控制节点IP * AIPERF_MASTER_PORT AIPerf调度服务端口 下载源代码 # 在共享存储上创建AIPerf工作目录 mkdir -p $AIPERF_WORKDIR # 下载源代码 git clone https://github.com/thu-pacman/AIPerf.git $AIPERF_WORKDIR/AIPerf AIPerf目录下aiperf_setenv.sh脚本设置环境变量。 source $AIPERF_WORKDIR/AIPerf/aiperf_setenv.sh 安装依赖包 安装Python wget https://www.python.org/ftp/python/3.8.20/python-3.9.20.tgz tar -zxvf python-3.9.20.tgz # 安装依赖包 yum install -y gcc gcc-c++ make openssl-devel bzip2-devel libffi-devel # 编译安装 cd python-3.9.20 ./configure --prefix=/usr/local/python3 \\ --with-ensurepip=install \\ --enable-optimizations make \u0026\u0026 make install # 设置环境变量 # ln -s /usr/local/python3/bin/python3.9 /usr/bin/python3 echo 'export PATH=/usr/local/python3/bin:$PATH' \u003e\u003e ~/.bash_profile source ~/.bash_profile # 升级pip和setuptools # 临时镜像源: https://mirrors.tuna.tsinghua.edu.cn/help/pypi/ python3 -m pip install --upgrade pip -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple python3 -m pip install --upgrade setuptools -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple 控制节点 # python3 -m pip install -r $AIPERF_WORKDIR/AIPerf/requirements_master.txt python3 -m pip install scikit-learn pyyaml django schema colorama ruamel.yaml matplotlib jinja2 zmq torch==1.8.0 hyperopt==0.1.2 json_tricks \"numpy\u003c2.0\" scipy coverage psutil 计算节点 # python3 -m pip install -r $AIPERF_WORKDIR/AIPerf/requirements_slave.txt # 根据CUDA和cuDNN版本选择计算框架版本，例如对于CUDA 11.2，cuDNN 8.1，可选择tensorflow 2.5.0 # python3 -m pip install tensorflow==2.5.0 python3 -m pip install zmq scikit-learn psutil dill hyperopt==0.1.2 json_tricks \"numpy\u003c2.0\" scipy coverage tensorflow==2.5.0 torch==1.8.0 # sample install nvidia driver wget https://us.download.nvidia.com/tesla/460.106.00/NVIDIA-Linux-x86_64-460.106.00.run sh NVIDIA-Linux-x86_64-460.106.00.run # CUDA Toolkit 11.2 # https://developer.nvidia.com/cuda-11.2.0-download-archive wget https://developer.download.nvidia.com/compute/cuda/11.2.0/local_installers/cuda_11.2.0_460.27.04_linux.run sh cuda_11.2.0_460.27.04_linux.run # environment variables export PATH=/usr/local/cuda/bin${PATH:+:${PATH}} export LD_LIBRARY_PATH=/usr/local/cuda/lib64${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}} # cuDNN 8.1 # https://developer.nvidia.com/rdp/cudnn-archive # https://developer.nvidia.com/compute/machine-learning/cudnn/secure/8.1.0.77/11.2_20210127/cudnn-11.2-linux-x64-v8.1.0.77.tgz wget https://developer.download.nvidia.com/compute/redist/cudnn/v8.1.0/cudnn-11.2-linux-x64-v8.1.0.77.tgz tar -zvxf cudnn-11.2-linux-x64-v8.1.0.77.tgz cp -P cuda/include/cudnn.h /usr/local/cuda/include cp -P cuda/lib64/libcudnn* /usr/local/cuda/lib64/ chmod a+r /usr/local/cuda/include/cudnn.h #check cuda nvidia-smi #check cudnn nvcc -V 安装AIPerf 控制节点 # 安装AutoML组件 cd $AIPERF_WORKDIR/AIPerf/src/sdk/pynni/ python3 -m pip install -e . # 安装aiperf控制组件 cd $AIPERF_WORKDIR/AIPerf/src/aiperf_manager/ python3 -m pip install -e . aiperf --help 计算节点 # 安装AutoML组件 cd $AIPERF_WORKDIR/AIPerf/src/sdk/pynni/ python3 -m pip install -e . 下载模型权重 将权重文件resnet50_weights_tf_dim_ordering_tf_kernels.h5下载并放到$AIPERF_WORKDIR下 # 百度云盘 https://pan.baidu.com/s/1JBOh2XwetZAalLdmULBN2Q 提取码: 5nbc mv resnet50_weights_tf_dim_ordering_tf_kernels.h5 $AIPERF_WORKDIR (md5sum: a7b3fe01876f51b976af0dea6bc144eb) 启动测试(控制节点) 启动调度服务 配置计算节点信息 ${AIPERF_WORKDIR}/AIPerf/aiperf_ctrl/servers.json # 例如，集群有2个节点，每个节点有4张GPU，则配置如下： [ { \"ip\": \"172.23.33.33\", \"tag\": \"\", \"status\": \"waiting\", \"CUDA_VISIBLE_DEVICES\": \"0,1,2,3\" }, { \"ip\": \"172.23.33.34\", \"tag\": \"\", \"status\": \"waiting\", \"CUDA_VISIBLE_DEVICES\": \"0,1,2,3\" } ] 启动命令 cd $AIPERF_WORKDIR/AIPerf/aiperf_ctrl python3 manage.py runserver ${AIPERF_MASTER_IP}:${AIPERF_MASTER_PORT} 启动AIPerf测试 测试基本条件：\n1.测试运行时间应不少于1小时；\n2.测试的计算精度不低于FP-16；\n3.测试完成时所取得的最高正确率应大于70%；\n初始化配置 ${AIPERF_WORKDIR}/AIPerf/examples/trials/network_morphism/imagenet/config.yml\n关键参数解释:\n可选参数 说明 默认值 1 trialConcurrency 同时运行的trial数 1 2 maxExecDuration 设置测试时间(单位 ：h) 12 3 CUDA_VISIBLE_DEVICES 指定测试程序可用的gpu索引 0,1,2,3,4,5,6,7 4 srun：–cpus-per-task=30 参数为slurm可用cpu核数减 1 30 5 –slave 跟 trialConcurrency参数保持一致 1 6 –ip master节点ip，直接使用默认值 ${AIPERF_MASTER_IP} 7 –batch_size batch size 448 8 –epochs 正常训练epoch数 60 9 –initial_lr 初始学习率 1e-1 10 –final_lr 最终学习率 0 11 –train_data_dir 训练数据集路径 None 12 –val_data_dir 验证数据集路径 None 13 –warmup_1 warm up机制第一轮epoch数 15 14 –warmup_2 warm up机制第二轮epoch数 30 15 –warmup_3 warm up机制第三轮epoch数 45 16 –num_parallel_calls tfrecord数据加载加速 48 # 示例 authorName: default experimentName: example_imagenet-network-morphism-test trialConcurrency: 2 maxExecDuration: 24h maxTrialNum: 9999 trainingServicePlatform: local useAnnotation: false logLevel: trace tuner: #choice: TPE, Random, Anneal, Evolution, BatchTuner, NetworkMorphism #SMAC (SMAC should be installed through nnictl) builtinTunerName: NetworkMorphism classArgs: #choice: maximize, minimize optimize_mode: maximize #for now, this tuner only supports cv domain task: cv #input image width input_width: 224 #input image channel input_channel: 3 #number of classes n_output_node: 1000 trial: command: CUDA_VISIBLE_DEVICES=0 \\ python3 imagenet_train.py \\ --slave 2 \\ --ip ${AIPERF_MASTER_IP} \\ --batch_size 448 \\ --epoch 60 \\ --initial_lr 1e-1 \\ --final_lr 0 \\ --train_data_dir /root/datasets/imagenet/train \\ --val_data_dir /root/datasets/imagenet/val codeDir: . gpuNum: 0 # 注意配置文件中slave参数需要和trialConcurrency参数一致，修改为计算节点个数 # 修改CUDA_VISIBLE_DEVICES为计算节点所用的GPU # 需要修改--train_data_dir和--var_data_dir的位置以指向计算节点数据集存储位置 运行benchmark\n在${AIPERF_WORKDIR}/AIPerf/examples/trials/network_morphism/imagenet/目录下执行以下命令运行用例\n注：若使用pyTorch，请在 ${AIPERF_WORKDIR}/AIPerf/examples/trials/network_morphism/imagenetTorch/下执行\n# 启动 aiperf create -c config.yml # 停止,ctrl-c终止 # 清理所有计算节点上的训练进程 aiperf clean 查看状态\n当测试运行过程中，运行以下程序会在终端打印experiment的Error、Score、Regulated Score等信息\npython3 $AIPERF_WORKDIR/AIPerf/scripts/reports/report.py --id experiment_ID 同时会产生实验报告存放在experiment_ID的对应路径${AIPERF_WORKDIR}/mountdir/nni/experiments/experiment_ID/results目录下。\n实验成功时报告为 Report_Succeed.html。\n实验失败时报告为 Report_Failed.html。\n实验失败会报告失败原因，请查阅AI Benchmark测试规范分析失败原因。 保存日志\u0026结果数据 运行以下程序可将测试产生的日志以及数据统一保存到${AIPERF_WORKDIR}/mountdir/nni/experiments/experiment_ID/results/logs中，便于实验分析。 由于实验数据在复制过程中会导致额外的网络、内存、cpu等资源开销，建议在实验停止/结束后再执行日志保存操作。 python3 $AIPERF_WORKDIR/AIPerf/scripts/reports/report.py --id experiment_ID --logs True 测试参数设置及推荐环境配置(官方) 可变设置 slave计算节点的GPU卡数：默认将单个物理服务器作为一个slave节点，并使用其所有GPU； 深度学习框架：默认使用keras+tensorflow； 数据集加载方式：默认将数据预处理成TFRecord格式，以加快数据加载的效率； 数据集存储方式：默认采用网络共享存储； 超参设置：默认初始batch size=448，默认初始学习率=0.1，默认最终学习率=0，默认正常训练epochs=60，默认从第四轮trial开始，每个trial搜索1次，默认超参为kernel size和batch size。 推荐环境配置\n软件：TensorFlow2.5.0，CUDA11.2，cuDNN8.1，python3.8\n","wordCount":"706","inLanguage":"en","datePublished":"2024-11-28T15:00:00+08:00","dateModified":"2024-11-28T15:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://gnail89.github.io/posts/aiperf-setup/"},"publisher":{"@type":"Organization","name":"📕W.'s Blog","logo":{"@type":"ImageObject","url":"https://gnail89.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://gnail89.github.io/ accesskey=h title="📕W.'s Blog (Alt + H)">📕W.'s Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://gnail89.github.io/search/ title=🔍Search><span>🔍Search</span></a></li><li><a href=https://gnail89.github.io/archives/ title=📚Archive><span>📚Archive</span></a></li><li><a href=https://gnail89.github.io/tags/ title=🔖Tags><span>🔖Tags</span></a></li><li><a href=https://gnail89.github.io/categories/ title=🧩Categories><span>🧩Categories</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://gnail89.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://gnail89.github.io/posts/>Posts</a></div><h1 class=post-title>AIPerf 基准测试工具安装</h1></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%9f%ba%e7%a1%80%e7%8e%af%e5%a2%83 aria-label=基础环境>基础环境</a><ul><li><a href=#ssh%e5%85%8d%e5%af%86 aria-label=SSH免密>SSH免密</a></li><li><a href=#%e9%83%a8%e7%bd%b2nfs aria-label=部署NFS>部署NFS</a></li></ul></li><li><a href=#%e5%87%86%e5%a4%87%e6%95%b0%e6%8d%ae%e9%9b%86 aria-label=准备数据集>准备数据集</a><ul><li><a href=#%e6%95%b0%e6%8d%ae%e9%9b%86%e4%b8%8b%e8%bd%bd aria-label=数据集下载>数据集下载</a></li><li><a href=#tfreord%e5%88%b6%e4%bd%9c aria-label=TFReord制作>TFReord制作</a></li><li><a href=#%e5%88%86%e5%8f%91%e6%95%b0%e6%8d%ae%e9%9b%86 aria-label=分发数据集>分发数据集</a></li></ul></li><li><a href=#%e9%a1%b9%e7%9b%ae%e5%ae%89%e8%a3%85 aria-label=项目安装>项目安装</a><ul><li><a href=#%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e5%a3%b0%e6%98%8e aria-label=环境变量声明>环境变量声明</a></li><li><a href=#%e4%b8%8b%e8%bd%bd%e6%ba%90%e4%bb%a3%e7%a0%81 aria-label=下载源代码>下载源代码</a></li><li><a href=#%e5%ae%89%e8%a3%85%e4%be%9d%e8%b5%96%e5%8c%85 aria-label=安装依赖包>安装依赖包</a><ul><li><a href=#%e5%ae%89%e8%a3%85python aria-label=安装Python>安装Python</a></li><li><a href=#%e6%8e%a7%e5%88%b6%e8%8a%82%e7%82%b9 aria-label=控制节点>控制节点</a></li><li><a href=#%e8%ae%a1%e7%ae%97%e8%8a%82%e7%82%b9 aria-label=计算节点>计算节点</a></li></ul></li><li><a href=#%e5%ae%89%e8%a3%85aiperf aria-label=安装AIPerf>安装AIPerf</a><ul><li><a href=#%e6%8e%a7%e5%88%b6%e8%8a%82%e7%82%b9-1 aria-label=控制节点>控制节点</a></li><li><a href=#%e8%ae%a1%e7%ae%97%e8%8a%82%e7%82%b9-1 aria-label=计算节点>计算节点</a></li><li><a href=#%e4%b8%8b%e8%bd%bd%e6%a8%a1%e5%9e%8b%e6%9d%83%e9%87%8d aria-label=下载模型权重>下载模型权重</a></li></ul></li><li><a href=#%e5%90%af%e5%8a%a8%e6%b5%8b%e8%af%95%e6%8e%a7%e5%88%b6%e8%8a%82%e7%82%b9 aria-label=启动测试(控制节点)>启动测试(控制节点)</a><ul><li><a href=#%e5%90%af%e5%8a%a8%e8%b0%83%e5%ba%a6%e6%9c%8d%e5%8a%a1 aria-label=启动调度服务>启动调度服务</a></li><li><a href=#%e5%90%af%e5%8a%a8aiperf%e6%b5%8b%e8%af%95 aria-label=启动AIPerf测试>启动AIPerf测试</a></li></ul></li></ul></li><li><a href=#%e4%bf%9d%e5%ad%98%e6%97%a5%e5%bf%97%e7%bb%93%e6%9e%9c%e6%95%b0%e6%8d%ae aria-label=保存日志&amp;amp;结果数据>保存日志&结果数据</a></li><li><a href=#%e6%b5%8b%e8%af%95%e5%8f%82%e6%95%b0%e8%ae%be%e7%bd%ae%e5%8f%8a%e6%8e%a8%e8%8d%90%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae%e5%ae%98%e6%96%b9 aria-label=测试参数设置及推荐环境配置(官方)>测试参数设置及推荐环境配置(官方)</a></li></ul></div></details></div><div class=post-content><p><em>开源项目地址: <a href=https://github.com/thu-pacman/AIPerf>https://github.com/thu-pacman/AIPerf</a></em></p><h1 id=基础环境>基础环境<a hidden class=anchor aria-hidden=true href=#基础环境>#</a></h1><h2 id=ssh免密>SSH免密<a hidden class=anchor aria-hidden=true href=#ssh免密>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh-keygen -t rsa
</span></span><span class=line><span class=cl>ssh-copy-id -i ~/.ssh/id_rsa.pub server-ip
</span></span></code></pre></div><h2 id=部署nfs>部署NFS<a hidden class=anchor aria-hidden=true href=#部署nfs>#</a></h2><ul><li>安装软件包</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yum install -y nfs-utils
</span></span></code></pre></div><ul><li>配置服务端</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir /userhome
</span></span><span class=line><span class=cl>chmod -R <span class=m>777</span> /userhome
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;/userhome *(rw,sync,insecure,no_root_squash)&#34;</span> &gt;&gt; /etc/exports
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启动服务</span>
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> --now nfs-server
</span></span><span class=line><span class=cl>systemctl status nfs-server
</span></span></code></pre></div><ul><li>配置客户端</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir /userhome
</span></span><span class=line><span class=cl>mount server-ip:/userhome /userhome
</span></span></code></pre></div><h1 id=准备数据集>准备数据集<a hidden class=anchor aria-hidden=true href=#准备数据集>#</a></h1><h2 id=数据集下载>数据集下载<a hidden class=anchor aria-hidden=true href=#数据集下载>#</a></h2><ul><li>Imagenet官方地址：http://www.image-net.org/index</li><li>使用ImageNet-2012数据集</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span>  /userhome/AIPerf/scripts/build_data
</span></span><span class=line><span class=cl>./download_imagenet.sh
</span></span><span class=line><span class=cl>ls ./imagenet
</span></span></code></pre></div><ul><li>原始的ImageNet-2012包含以下两个文件:</li><li>ILSVRC2012_img_val.tar</li><li>ILSVRC2012_img_train.tar</li></ul><h2 id=tfreord制作>TFReord制作<a hidden class=anchor aria-hidden=true href=#tfreord制作>#</a></h2><ul><li>训练集和验证集需要按照1000个子目录下包含图片的格式，处理步骤：</li></ul><ol><li>将train 和 val 的数据按照文件夹分类</li><li>指定参数运行build_imagenet_data.py</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 做验证集</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span>  /userhome/AIPerf/scripts/build_data
</span></span><span class=line><span class=cl>mkdir -p ILSVRC2012/raw-data/imagenet-data/validation/  
</span></span><span class=line><span class=cl>tar -xvf imagenet/ILSVRC2012_img_val.tar -C ILSVRC2012/raw-data/imagenet-data/validation/
</span></span><span class=line><span class=cl>python preprocess_imagenet_validation_data.py ILSVRC2012/raw-data/imagenet-data/validation/ imagenet_2012_validation_synset_labels.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 做训练集</span>
</span></span><span class=line><span class=cl>mkdir -p ILSVRC2012/raw-data/imagenet-data/train/
</span></span><span class=line><span class=cl>tar -xvf imagenet/ILSVRC2012_img_train.tar -C ILSVRC2012/raw-data/imagenet-data/train/ <span class=o>&amp;&amp;</span> <span class=nb>cd</span> ILSVRC2012/raw-data/imagenet-data/train
</span></span><span class=line><span class=cl>find . -name <span class=s2>&#34;*.tar&#34;</span> <span class=p>|</span> <span class=k>while</span> <span class=nb>read</span> NAE <span class=p>;</span> <span class=k>do</span> mkdir -p <span class=s2>&#34;</span><span class=si>${</span><span class=nv>NAE</span><span class=p>%.tar</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span> tar -xvf <span class=s2>&#34;</span><span class=si>${</span><span class=nv>NAE</span><span class=si>}</span><span class=s2>&#34;</span> -C <span class=s2>&#34;</span><span class=si>${</span><span class=nv>NAE</span><span class=p>%.tar</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span> rm -f <span class=s2>&#34;</span><span class=si>${</span><span class=nv>NAE</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>done</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /userhome/AIPerf/scripts/build_data
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># TensorFlow需要制作TFRecord</span>
</span></span><span class=line><span class=cl>mkdir -p ILSVRC2012/output
</span></span><span class=line><span class=cl>python build_imagenet_data.py <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--train_directory<span class=o>=</span>ILSVRC2012/raw-data/imagenet-data/train <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--validation_directory<span class=o>=</span>ILSVRC2012/raw-data/imagenet-data/validation <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--output_directory<span class=o>=</span>ILSVRC2012/output <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--imagenet_metadata_file<span class=o>=</span>imagenet_metadata.txt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--labels_file<span class=o>=</span>imagenet_lsvrc_2015_synsets.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在ILSVRC2012/output目录下生成128个validation开头的验证集文件和1024个train开头的训练集文件。</span>
</span></span></code></pre></div><h2 id=分发数据集>分发数据集<a hidden class=anchor aria-hidden=true href=#分发数据集>#</a></h2><ul><li><strong>对TensorFlow</strong>，将验证集和数据集移动到slave节点。</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -p /root/datasets/imagenet/train
</span></span><span class=line><span class=cl>mkdir -p /root/datasets/imagenet/val
</span></span><span class=line><span class=cl>mv ILSVRC2012/output/train-* /root/datasets/imagenet/train
</span></span><span class=line><span class=cl>mv ILSVRC2012/output/validation-* /root/datasets/imagenet/val
</span></span></code></pre></div><ul><li><strong>对其他模型</strong>，将解压后验证集和数据集移动到slave节点，根据框架自行调整。</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 对PyTorch</span>
</span></span><span class=line><span class=cl>mkdir -p /root/datasets/imagenet/
</span></span><span class=line><span class=cl>mv ILSVRC2012/train /root/datasets/imagenet
</span></span><span class=line><span class=cl>mv ILSVRC2012/val /root/datasets/imagenet
</span></span></code></pre></div><h1 id=项目安装>项目安装<a hidden class=anchor aria-hidden=true href=#项目安装>#</a></h1><h2 id=环境变量声明>环境变量声明<a hidden class=anchor aria-hidden=true href=#环境变量声明>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>AIPERF_WORKDIR</span><span class=o>=</span>/userhome
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>AIPERF_SLAVE_WORKDIR</span><span class=o>=</span>/root/
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>AIPERF_MASTER_IP</span><span class=o>=</span>10.0.1.100
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>AIPERF_MASTER_PORT</span><span class=o>=</span><span class=m>9987</span>
</span></span></code></pre></div><pre tabindex=0><code>* AIPERF_WORKDIR
  AIPerf工作目录，必须在共享存储上，能被所有节点访问到
  AIPerf代码，部分log文件等将会被放到这个目录

* AIPERF_SLAVE_WORKDIR
  计算节点工作目录，不需要在共享存储上（也可以放在共享存储）
  部分计算节点log文件将会被生成到这个目录下

* AIPERF_MASTER_IP
  AIPerf调度服务IP，即控制节点IP

* AIPERF_MASTER_PORT
  AIPerf调度服务端口
</code></pre><h2 id=下载源代码>下载源代码<a hidden class=anchor aria-hidden=true href=#下载源代码>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 在共享存储上创建AIPerf工作目录</span>
</span></span><span class=line><span class=cl>mkdir -p <span class=nv>$AIPERF_WORKDIR</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 下载源代码</span>
</span></span><span class=line><span class=cl>git clone https://github.com/thu-pacman/AIPerf.git <span class=nv>$AIPERF_WORKDIR</span>/AIPerf
</span></span></code></pre></div><ul><li>AIPerf目录下<code>aiperf_setenv.sh</code>脚本设置环境变量。</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>source</span> <span class=nv>$AIPERF_WORKDIR</span>/AIPerf/aiperf_setenv.sh
</span></span></code></pre></div><h2 id=安装依赖包>安装依赖包<a hidden class=anchor aria-hidden=true href=#安装依赖包>#</a></h2><h3 id=安装python>安装Python<a hidden class=anchor aria-hidden=true href=#安装python>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://www.python.org/ftp/python/3.8.20/python-3.9.20.tgz
</span></span><span class=line><span class=cl>tar -zxvf python-3.9.20.tgz
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 安装依赖包</span>
</span></span><span class=line><span class=cl>yum install -y gcc gcc-c++ make openssl-devel bzip2-devel libffi-devel
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 编译安装</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> python-3.9.20
</span></span><span class=line><span class=cl>./configure --prefix<span class=o>=</span>/usr/local/python3 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-ensurepip<span class=o>=</span>install <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enable-optimizations
</span></span><span class=line><span class=cl>make <span class=o>&amp;&amp;</span> make install
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置环境变量</span>
</span></span><span class=line><span class=cl><span class=c1># ln -s /usr/local/python3/bin/python3.9 /usr/bin/python3</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;export PATH=/usr/local/python3/bin:$PATH&#39;</span> &gt;&gt; ~/.bash_profile
</span></span><span class=line><span class=cl><span class=nb>source</span> ~/.bash_profile
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 升级pip和setuptools</span>
</span></span><span class=line><span class=cl><span class=c1># 临时镜像源: https://mirrors.tuna.tsinghua.edu.cn/help/pypi/</span>
</span></span><span class=line><span class=cl>python3 -m pip install --upgrade pip -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple
</span></span><span class=line><span class=cl>python3 -m pip install --upgrade setuptools -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple
</span></span></code></pre></div><h3 id=控制节点>控制节点<a hidden class=anchor aria-hidden=true href=#控制节点>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># python3 -m pip install -r $AIPERF_WORKDIR/AIPerf/requirements_master.txt</span>
</span></span><span class=line><span class=cl>python3 -m pip install scikit-learn pyyaml django schema colorama ruamel.yaml matplotlib jinja2 zmq <span class=nv>torch</span><span class=o>==</span>1.8.0 <span class=nv>hyperopt</span><span class=o>==</span>0.1.2 json_tricks <span class=s2>&#34;numpy&lt;2.0&#34;</span> scipy coverage psutil
</span></span></code></pre></div><h3 id=计算节点>计算节点<a hidden class=anchor aria-hidden=true href=#计算节点>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># python3 -m pip install -r $AIPERF_WORKDIR/AIPerf/requirements_slave.txt</span>
</span></span><span class=line><span class=cl><span class=c1># 根据CUDA和cuDNN版本选择计算框架版本，例如对于CUDA 11.2，cuDNN 8.1，可选择tensorflow 2.5.0</span>
</span></span><span class=line><span class=cl><span class=c1># python3 -m pip install tensorflow==2.5.0</span>
</span></span><span class=line><span class=cl>python3 -m pip install zmq scikit-learn psutil dill <span class=nv>hyperopt</span><span class=o>==</span>0.1.2 json_tricks <span class=s2>&#34;numpy&lt;2.0&#34;</span> scipy coverage <span class=nv>tensorflow</span><span class=o>==</span>2.5.0 <span class=nv>torch</span><span class=o>==</span>1.8.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># sample install nvidia driver</span>
</span></span><span class=line><span class=cl>wget https://us.download.nvidia.com/tesla/460.106.00/NVIDIA-Linux-x86_64-460.106.00.run
</span></span><span class=line><span class=cl>sh NVIDIA-Linux-x86_64-460.106.00.run
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># CUDA Toolkit 11.2</span>
</span></span><span class=line><span class=cl><span class=c1># https://developer.nvidia.com/cuda-11.2.0-download-archive</span>
</span></span><span class=line><span class=cl>wget https://developer.download.nvidia.com/compute/cuda/11.2.0/local_installers/cuda_11.2.0_460.27.04_linux.run
</span></span><span class=line><span class=cl>sh cuda_11.2.0_460.27.04_linux.run
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># environment variables</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span>/usr/local/cuda/bin<span class=si>${</span><span class=nv>PATH</span><span class=p>:+:</span><span class=si>${</span><span class=nv>PATH</span><span class=si>}}</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>LD_LIBRARY_PATH</span><span class=o>=</span>/usr/local/cuda/lib64<span class=si>${</span><span class=nv>LD_LIBRARY_PATH</span><span class=p>:+:</span><span class=si>${</span><span class=nv>LD_LIBRARY_PATH</span><span class=si>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># cuDNN 8.1</span>
</span></span><span class=line><span class=cl><span class=c1># https://developer.nvidia.com/rdp/cudnn-archive</span>
</span></span><span class=line><span class=cl><span class=c1># https://developer.nvidia.com/compute/machine-learning/cudnn/secure/8.1.0.77/11.2_20210127/cudnn-11.2-linux-x64-v8.1.0.77.tgz</span>
</span></span><span class=line><span class=cl>wget https://developer.download.nvidia.com/compute/redist/cudnn/v8.1.0/cudnn-11.2-linux-x64-v8.1.0.77.tgz
</span></span><span class=line><span class=cl>tar -zvxf cudnn-11.2-linux-x64-v8.1.0.77.tgz
</span></span><span class=line><span class=cl>cp -P cuda/include/cudnn.h /usr/local/cuda/include
</span></span><span class=line><span class=cl>cp -P cuda/lib64/libcudnn* /usr/local/cuda/lib64/
</span></span><span class=line><span class=cl>chmod a+r /usr/local/cuda/include/cudnn.h
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#check cuda</span>
</span></span><span class=line><span class=cl>nvidia-smi
</span></span><span class=line><span class=cl><span class=c1>#check cudnn</span>
</span></span><span class=line><span class=cl>nvcc -V
</span></span></code></pre></div><h2 id=安装aiperf>安装AIPerf<a hidden class=anchor aria-hidden=true href=#安装aiperf>#</a></h2><h3 id=控制节点-1>控制节点<a hidden class=anchor aria-hidden=true href=#控制节点-1>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 安装AutoML组件</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=nv>$AIPERF_WORKDIR</span>/AIPerf/src/sdk/pynni/
</span></span><span class=line><span class=cl>python3 -m pip install -e .
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 安装aiperf控制组件</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=nv>$AIPERF_WORKDIR</span>/AIPerf/src/aiperf_manager/
</span></span><span class=line><span class=cl>python3 -m pip install -e .
</span></span><span class=line><span class=cl>aiperf --help
</span></span></code></pre></div><h3 id=计算节点-1>计算节点<a hidden class=anchor aria-hidden=true href=#计算节点-1>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 安装AutoML组件</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=nv>$AIPERF_WORKDIR</span>/AIPerf/src/sdk/pynni/
</span></span><span class=line><span class=cl>python3 -m pip install -e .
</span></span></code></pre></div><h3 id=下载模型权重>下载模型权重<a hidden class=anchor aria-hidden=true href=#下载模型权重>#</a></h3><ul><li>将权重文件resnet50_weights_tf_dim_ordering_tf_kernels.h5下载并放到$AIPERF_WORKDIR下</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 百度云盘 https://pan.baidu.com/s/1JBOh2XwetZAalLdmULBN2Q 提取码: 5nbc</span>
</span></span><span class=line><span class=cl>mv resnet50_weights_tf_dim_ordering_tf_kernels.h5 <span class=nv>$AIPERF_WORKDIR</span>
</span></span><span class=line><span class=cl><span class=o>(</span>md5sum: a7b3fe01876f51b976af0dea6bc144eb<span class=o>)</span>
</span></span></code></pre></div><h2 id=启动测试控制节点>启动测试(控制节点)<a hidden class=anchor aria-hidden=true href=#启动测试控制节点>#</a></h2><h3 id=启动调度服务>启动调度服务<a hidden class=anchor aria-hidden=true href=#启动调度服务>#</a></h3><ul><li>配置计算节点信息 ${AIPERF_WORKDIR}/AIPerf/aiperf_ctrl/servers.json</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 例如，集群有2个节点，每个节点有4张GPU，则配置如下：</span>
</span></span><span class=line><span class=cl><span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ip&#34;</span>: <span class=s2>&#34;172.23.33.33&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag&#34;</span>: <span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;status&#34;</span>: <span class=s2>&#34;waiting&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;CUDA_VISIBLE_DEVICES&#34;</span>: <span class=s2>&#34;0,1,2,3&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ip&#34;</span>: <span class=s2>&#34;172.23.33.34&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;tag&#34;</span>: <span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;status&#34;</span>: <span class=s2>&#34;waiting&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;CUDA_VISIBLE_DEVICES&#34;</span>: <span class=s2>&#34;0,1,2,3&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>   
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span></code></pre></div><ul><li>启动命令</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> <span class=nv>$AIPERF_WORKDIR</span>/AIPerf/aiperf_ctrl
</span></span><span class=line><span class=cl>python3 manage.py runserver <span class=si>${</span><span class=nv>AIPERF_MASTER_IP</span><span class=si>}</span>:<span class=si>${</span><span class=nv>AIPERF_MASTER_PORT</span><span class=si>}</span>
</span></span></code></pre></div><h3 id=启动aiperf测试>启动AIPerf测试<a hidden class=anchor aria-hidden=true href=#启动aiperf测试>#</a></h3><ul><li><p>测试基本条件：<br>1.测试运行时间应不少于1小时；<br>2.测试的计算精度不低于FP-16；<br>3.测试完成时所取得的最高正确率应大于70%；</p></li><li><p>初始化配置 ${AIPERF_WORKDIR}/AIPerf/examples/trials/network_morphism/imagenet/config.yml</p><p>关键参数解释:</p></li></ul><table><thead><tr><th></th><th style=text-align:center>可选参数</th><th style=text-align:center>说明</th><th style=text-align:center>默认值</th></tr></thead><tbody><tr><td>1</td><td style=text-align:center>trialConcurrency</td><td style=text-align:center>同时运行的trial数</td><td style=text-align:center>1</td></tr><tr><td>2</td><td style=text-align:center>maxExecDuration</td><td style=text-align:center>设置测试时间(单位 ：h)</td><td style=text-align:center>12</td></tr><tr><td>3</td><td style=text-align:center>CUDA_VISIBLE_DEVICES</td><td style=text-align:center>指定测试程序可用的gpu索引</td><td style=text-align:center>0,1,2,3,4,5,6,7</td></tr><tr><td>4</td><td style=text-align:center>srun：&ndash;cpus-per-task=30</td><td style=text-align:center>参数为slurm可用cpu核数减 1</td><td style=text-align:center>30</td></tr><tr><td>5</td><td style=text-align:center>&ndash;slave</td><td style=text-align:center><strong>跟 trialConcurrency参数保持一致</strong></td><td style=text-align:center>1</td></tr><tr><td>6</td><td style=text-align:center>&ndash;ip</td><td style=text-align:center>master节点ip，直接使用默认值</td><td style=text-align:center>${AIPERF_MASTER_IP}</td></tr><tr><td>7</td><td style=text-align:center>&ndash;batch_size</td><td style=text-align:center>batch size</td><td style=text-align:center>448</td></tr><tr><td>8</td><td style=text-align:center>&ndash;epochs</td><td style=text-align:center>正常训练epoch数</td><td style=text-align:center>60</td></tr><tr><td>9</td><td style=text-align:center>&ndash;initial_lr</td><td style=text-align:center>初始学习率</td><td style=text-align:center>1e-1</td></tr><tr><td>10</td><td style=text-align:center>&ndash;final_lr</td><td style=text-align:center>最终学习率</td><td style=text-align:center>0</td></tr><tr><td>11</td><td style=text-align:center>&ndash;train_data_dir</td><td style=text-align:center>训练数据集路径</td><td style=text-align:center>None</td></tr><tr><td>12</td><td style=text-align:center>&ndash;val_data_dir</td><td style=text-align:center>验证数据集路径</td><td style=text-align:center>None</td></tr><tr><td>13</td><td style=text-align:center>&ndash;warmup_1</td><td style=text-align:center>warm up机制第一轮epoch数</td><td style=text-align:center>15</td></tr><tr><td>14</td><td style=text-align:center>&ndash;warmup_2</td><td style=text-align:center>warm up机制第二轮epoch数</td><td style=text-align:center>30</td></tr><tr><td>15</td><td style=text-align:center>&ndash;warmup_3</td><td style=text-align:center>warm up机制第三轮epoch数</td><td style=text-align:center>45</td></tr><tr><td>16</td><td style=text-align:center>&ndash;num_parallel_calls</td><td style=text-align:center>tfrecord数据加载加速</td><td style=text-align:center>48</td></tr></tbody></table><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 示例</span>
</span></span><span class=line><span class=cl>authorName: default
</span></span><span class=line><span class=cl>experimentName: example_imagenet-network-morphism-test
</span></span><span class=line><span class=cl>trialConcurrency: <span class=m>2</span>
</span></span><span class=line><span class=cl>maxExecDuration: 24h
</span></span><span class=line><span class=cl>maxTrialNum: <span class=m>9999</span>
</span></span><span class=line><span class=cl>trainingServicePlatform: <span class=nb>local</span>
</span></span><span class=line><span class=cl>useAnnotation: <span class=nb>false</span>
</span></span><span class=line><span class=cl>logLevel: trace
</span></span><span class=line><span class=cl>tuner:
</span></span><span class=line><span class=cl>  <span class=c1>#choice: TPE, Random, Anneal, Evolution, BatchTuner, NetworkMorphism</span>
</span></span><span class=line><span class=cl>  <span class=c1>#SMAC (SMAC should be installed through nnictl)</span>
</span></span><span class=line><span class=cl>  builtinTunerName: NetworkMorphism
</span></span><span class=line><span class=cl>  classArgs:
</span></span><span class=line><span class=cl>    <span class=c1>#choice: maximize, minimize</span>
</span></span><span class=line><span class=cl>    optimize_mode: maximize
</span></span><span class=line><span class=cl>    <span class=c1>#for now, this tuner only supports cv domain</span>
</span></span><span class=line><span class=cl>    task: cv
</span></span><span class=line><span class=cl>    <span class=c1>#input image width</span>
</span></span><span class=line><span class=cl>    input_width: <span class=m>224</span>
</span></span><span class=line><span class=cl>    <span class=c1>#input image channel</span>
</span></span><span class=line><span class=cl>    input_channel: <span class=m>3</span>
</span></span><span class=line><span class=cl>    <span class=c1>#number of classes</span>
</span></span><span class=line><span class=cl>    n_output_node: <span class=m>1000</span>
</span></span><span class=line><span class=cl>trial:
</span></span><span class=line><span class=cl>  command: <span class=nv>CUDA_VISIBLE_DEVICES</span><span class=o>=</span><span class=m>0</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           python3 imagenet_train.py <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           --slave <span class=m>2</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           --ip <span class=si>${</span><span class=nv>AIPERF_MASTER_IP</span><span class=si>}</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           --batch_size <span class=m>448</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           --epoch <span class=m>60</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           --initial_lr 1e-1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           --final_lr <span class=m>0</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           --train_data_dir /root/datasets/imagenet/train <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           --val_data_dir /root/datasets/imagenet/val
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  codeDir: .
</span></span><span class=line><span class=cl>  gpuNum: <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 注意配置文件中slave参数需要和trialConcurrency参数一致，修改为计算节点个数</span>
</span></span><span class=line><span class=cl><span class=c1># 修改CUDA_VISIBLE_DEVICES为计算节点所用的GPU</span>
</span></span><span class=line><span class=cl><span class=c1># 需要修改--train_data_dir和--var_data_dir的位置以指向计算节点数据集存储位置</span>
</span></span></code></pre></div><ul><li><p>运行benchmark</p><p>在${AIPERF_WORKDIR}/AIPerf/examples/trials/network_morphism/imagenet/目录下执行以下命令运行用例</p><p>注：若使用pyTorch，请在 ${AIPERF_WORKDIR}/AIPerf/examples/trials/network_morphism/imagenetTorch/下执行</p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 启动</span>
</span></span><span class=line><span class=cl>aiperf create -c config.yml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 停止,ctrl-c终止</span>
</span></span><span class=line><span class=cl><span class=c1># 清理所有计算节点上的训练进程</span>
</span></span><span class=line><span class=cl>aiperf clean
</span></span></code></pre></div><ul><li><p>查看状态</p><p>当测试运行过程中，运行以下程序会在终端打印experiment的Error、Score、Regulated Score等信息</p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python3 <span class=nv>$AIPERF_WORKDIR</span>/AIPerf/scripts/reports/report.py --id  experiment_ID  
</span></span></code></pre></div><ul><li>同时会产生实验报告存放在experiment_ID的对应路径${AIPERF_WORKDIR}/mountdir/nni/experiments/experiment_ID/results目录下。<br>实验成功时报告为 Report_Succeed.html。<br>实验失败时报告为 Report_Failed.html。<br>实验失败会报告失败原因，请查阅AI Benchmark测试规范分析失败原因。</li></ul><h1 id=保存日志结果数据>保存日志&结果数据<a hidden class=anchor aria-hidden=true href=#保存日志结果数据>#</a></h1><ul><li>运行以下程序可将测试产生的日志以及数据统一保存到${AIPERF_WORKDIR}/mountdir/nni/experiments/experiment_ID/results/logs中，便于实验分析。
由于实验数据在复制过程中会导致额外的网络、内存、cpu等资源开销，建议在实验停止/结束后再执行日志保存操作。</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python3 <span class=nv>$AIPERF_WORKDIR</span>/AIPerf/scripts/reports/report.py --id  experiment_ID  --logs True
</span></span></code></pre></div><h1 id=测试参数设置及推荐环境配置官方>测试参数设置及推荐环境配置(官方)<a hidden class=anchor aria-hidden=true href=#测试参数设置及推荐环境配置官方>#</a></h1><ul><li>可变设置</li></ul><ol><li>slave计算节点的GPU卡数：默认将单个物理服务器作为一个slave节点，并使用其所有GPU；</li><li>深度学习框架：默认使用keras+tensorflow；</li><li>数据集加载方式：默认将数据预处理成TFRecord格式，以加快数据加载的效率；</li><li>数据集存储方式：默认采用网络共享存储；</li><li>超参设置：默认初始batch size=448，默认初始学习率=0.1，默认最终学习率=0，默认正常训练epochs=60，默认从第四轮trial开始，每个trial搜索1次，默认超参为kernel size和batch size。</li></ol><ul><li><p>推荐环境配置</p><p>软件：TensorFlow2.5.0，CUDA11.2，cuDNN8.1，python3.8</p></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://gnail89.github.io/tags/aiperf/>Aiperf</a></li><li><a href=https://gnail89.github.io/tags/cuda/>Cuda</a></li><li><a href=https://gnail89.github.io/tags/cudnn/>Cudnn</a></li><li><a href=https://gnail89.github.io/tags/tensorflow/>Tensorflow</a></li></ul><nav class=paginav><a class=prev href=https://gnail89.github.io/posts/cve-1999-0524/><span class=title>« Prev</span><br><span>CVE-1999-0524</span>
</a><a class=next href=https://gnail89.github.io/posts/kubectl-study/><span class=title>Next »</span><br><span>Kubectl Study</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://gnail89.github.io/>📕W.'s Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>