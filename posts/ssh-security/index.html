<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>SSH Security | 📕W.'s Blog</title>
<meta name=keywords content="ssh,ipset,iptables"><meta name=description content="分享ssh安全配置实践
1. openssh基本配置 关注安全漏洞信息，定期升级ssh1版本，关键参数配置参考：
cat /etc/ssh/sshd_config Port 22 # 建议更改默认端口 Protocol 2 PermitRootLogin no MaxAuthTries 3 PubkeyAuthentication yes PermitEmptyPasswords no PasswordAuthentication no UsePAM yes X11Forwarding no PrintMotd no ClientAliveInterval 180 ClientAliveCountMax 0 UseDNS no Banner /etc/ssh_banner AllowUsers username 2. 使用PAM模块锁定账户 PAM2模块，pam_tally2和pam_faillock模块功能相似，以pam_faillock模块为例：
cat /etc/pam.d/password-auth #%PAM-1.0 # This file is auto-generated. # User changes will be destroyed the next time authselect is run. auth required pam_env.so auth required pam_faillock.so deny=3 unlock_time=900 even_deny_root root_unlock_time=900 auth sufficient pam_unix."><meta name=author content><link rel=canonical href=https://gnail89.github.io/posts/ssh-security/><link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.5b9ae0304f93db6cc493f51846f012428af399c614b4f2fbdb7fa59dd4d5ef5b.js integrity="sha256-W5rgME+T22zEk/UYRvASQorzmcYUtPL723+lndTV71s=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://gnail89.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://gnail89.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://gnail89.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://gnail89.github.io/apple-touch-icon.png><link rel=mask-icon href=https://gnail89.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.121.1"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="SSH Security"><meta property="og:description" content="分享ssh安全配置实践
1. openssh基本配置 关注安全漏洞信息，定期升级ssh1版本，关键参数配置参考：
cat /etc/ssh/sshd_config Port 22 # 建议更改默认端口 Protocol 2 PermitRootLogin no MaxAuthTries 3 PubkeyAuthentication yes PermitEmptyPasswords no PasswordAuthentication no UsePAM yes X11Forwarding no PrintMotd no ClientAliveInterval 180 ClientAliveCountMax 0 UseDNS no Banner /etc/ssh_banner AllowUsers username 2. 使用PAM模块锁定账户 PAM2模块，pam_tally2和pam_faillock模块功能相似，以pam_faillock模块为例：
cat /etc/pam.d/password-auth #%PAM-1.0 # This file is auto-generated. # User changes will be destroyed the next time authselect is run. auth required pam_env.so auth required pam_faillock.so deny=3 unlock_time=900 even_deny_root root_unlock_time=900 auth sufficient pam_unix."><meta property="og:type" content="article"><meta property="og:url" content="https://gnail89.github.io/posts/ssh-security/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-22T23:34:25+08:00"><meta property="article:modified_time" content="2022-11-22T23:34:25+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="SSH Security"><meta name=twitter:description content="分享ssh安全配置实践
1. openssh基本配置 关注安全漏洞信息，定期升级ssh1版本，关键参数配置参考：
cat /etc/ssh/sshd_config Port 22 # 建议更改默认端口 Protocol 2 PermitRootLogin no MaxAuthTries 3 PubkeyAuthentication yes PermitEmptyPasswords no PasswordAuthentication no UsePAM yes X11Forwarding no PrintMotd no ClientAliveInterval 180 ClientAliveCountMax 0 UseDNS no Banner /etc/ssh_banner AllowUsers username 2. 使用PAM模块锁定账户 PAM2模块，pam_tally2和pam_faillock模块功能相似，以pam_faillock模块为例：
cat /etc/pam.d/password-auth #%PAM-1.0 # This file is auto-generated. # User changes will be destroyed the next time authselect is run. auth required pam_env.so auth required pam_faillock.so deny=3 unlock_time=900 even_deny_root root_unlock_time=900 auth sufficient pam_unix."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://gnail89.github.io/posts/"},{"@type":"ListItem","position":3,"name":"SSH Security","item":"https://gnail89.github.io/posts/ssh-security/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"SSH Security","name":"SSH Security","description":"分享ssh安全配置实践\n1. openssh基本配置 关注安全漏洞信息，定期升级ssh1版本，关键参数配置参考：\ncat /etc/ssh/sshd_config Port 22 # 建议更改默认端口 Protocol 2 PermitRootLogin no MaxAuthTries 3 PubkeyAuthentication yes PermitEmptyPasswords no PasswordAuthentication no UsePAM yes X11Forwarding no PrintMotd no ClientAliveInterval 180 ClientAliveCountMax 0 UseDNS no Banner /etc/ssh_banner AllowUsers username 2. 使用PAM模块锁定账户 PAM2模块，pam_tally2和pam_faillock模块功能相似，以pam_faillock模块为例：\ncat /etc/pam.d/password-auth #%PAM-1.0 # This file is auto-generated. # User changes will be destroyed the next time authselect is run. auth required pam_env.so auth required pam_faillock.so deny=3 unlock_time=900 even_deny_root root_unlock_time=900 auth sufficient pam_unix.","keywords":["ssh","ipset","iptables"],"articleBody":" 分享ssh安全配置实践\n1. openssh基本配置 关注安全漏洞信息，定期升级ssh1版本，关键参数配置参考：\ncat /etc/ssh/sshd_config Port 22 # 建议更改默认端口 Protocol 2 PermitRootLogin no MaxAuthTries 3 PubkeyAuthentication yes PermitEmptyPasswords no PasswordAuthentication no UsePAM yes X11Forwarding no PrintMotd no ClientAliveInterval 180 ClientAliveCountMax 0 UseDNS no Banner /etc/ssh_banner AllowUsers username 2. 使用PAM模块锁定账户 PAM2模块，pam_tally2和pam_faillock模块功能相似，以pam_faillock模块为例：\ncat /etc/pam.d/password-auth #%PAM-1.0 # This file is auto-generated. # User changes will be destroyed the next time authselect is run. auth required pam_env.so auth required pam_faillock.so deny=3 unlock_time=900 even_deny_root root_unlock_time=900 auth sufficient pam_unix.so try_first_pass nullok auth required pam_deny.so account required pam_unix.so ... cat /etc/pam.d/system-auth #%PAM-1.0 # This file is auto-generated. # User changes will be destroyed the next time authselect is run. auth required pam_env.so auth required pam_faillock.so deny=3 unlock_time=900 even_deny_root root_unlock_time=900 auth sufficient pam_unix.so try_first_pass nullok auth required pam_deny.so account required pam_unix.so ... 3. 利用iptables + ipset 启用iptables3，并配置ssh端口阻止策略，示例：\niptables策略 systemctl enable iptables \u0026\u0026 systemctl start iptables cat /etc/sysconfig/iptables # sample configuration for iptables service # you can edit this manually or use system-config-firewall # please do not ask us to add additional ports/services to this default configuration *filter :INPUT ACCEPT [0:0] :FORWARD ACCEPT [0:0] :OUTPUT ACCEPT [0:0] -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT -A INPUT -p icmp -j ACCEPT -A INPUT -i lo -j ACCEPT -A INPUT -m set --match-set banlist src -p tcp -m tcp --dport 22 -j DROP -m comment --comment \"block ipset banlist\" -A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT -A INPUT -j REJECT --reject-with icmp-host-prohibited -A FORWARD -j REJECT --reject-with icmp-host-prohibited COMMIT ipset策略 启用ipset4服务，并新建策略banlist。\n# 安装ipset服务 yum install -y ipset-service systemctl enable ipset # 创建ipset策略 ipset create banlist hash:ip hashsize 4096 maxelem 1000000 timeout 86400 # 保存ipset配置 ipset save \u003e /etc/sysconfig/ipset # 启动ipset服务 systemctl restart ipset #查看ipset策略 ipset list 制定ipset控制脚本 以CentOS 7为例，shell脚本示例如下：\n#!/bin/bash ipset_name=\"banlist\" num=3 date_time=\"$(date -d \"1 hours ago\" \"+%Y-%m-%d %H:%M:%S\")\" [[ $(ipset list ${ipset_name}) ]] || ipset create ${ipset_name} hash:ip hashsize 4096 maxelem 1000000 timeout 86400 ipset_info=\"$(ipset save ${ipset_name})\" lastb -a -s \"${date_time}\" |awk '/ssh/{print $NF}' |sort -n |uniq -c |while read line; do count=\"$(echo $line |awk '{print $1}')\" ipaddr=\"$(echo $line |awk '{print $2}')\" if [ $count -ge $num ] \u0026\u0026 [ $(echo ${ipset_info} |grep -wc \"${ipaddr}\") -eq 0 ]; then /usr/sbin/ipset add ${ipset_name} ${ipaddr} fi done 配置root用户crontab定时任务： crontab -l * * * * * /bin/bash /opt/ban_ssh_ip.sh \u0026\u003e/dev/null openssh ↩︎\nLinux PAM ↩︎\niptables ↩︎\nipset ↩︎\n","wordCount":"380","inLanguage":"en","datePublished":"2022-11-22T23:34:25+08:00","dateModified":"2022-11-22T23:34:25+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://gnail89.github.io/posts/ssh-security/"},"publisher":{"@type":"Organization","name":"📕W.'s Blog","logo":{"@type":"ImageObject","url":"https://gnail89.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://gnail89.github.io accesskey=h title="📕W.'s Blog (Alt + H)">📕W.'s Blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://gnail89.github.io/search/ title=🔍Search><span>🔍Search</span></a></li><li><a href=https://gnail89.github.io/archives/ title=📚Archive><span>📚Archive</span></a></li><li><a href=https://gnail89.github.io/tags/ title=🔖Tags><span>🔖Tags</span></a></li><li><a href=https://gnail89.github.io/categories/ title=🧩Categories><span>🧩Categories</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://gnail89.github.io>Home</a>&nbsp;»&nbsp;<a href=https://gnail89.github.io/posts/>Posts</a></div><h1 class=post-title>SSH Security</h1><div class=post-meta>&lt;span title='2022-11-22 23:34:25 +0800 +0800'>November 22, 2022&lt;/span>&amp;nbsp;·&amp;nbsp;2 min</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1-openssh%e5%9f%ba%e6%9c%ac%e9%85%8d%e7%bd%ae aria-label="1. openssh基本配置">1. openssh基本配置</a></li><li><a href=#2-%e4%bd%bf%e7%94%a8pam%e6%a8%a1%e5%9d%97%e9%94%81%e5%ae%9a%e8%b4%a6%e6%88%b7 aria-label="2. 使用PAM模块锁定账户">2. 使用PAM模块锁定账户</a></li><li><a href=#3-%e5%88%a9%e7%94%a8iptables--ipset aria-label="3. 利用iptables + ipset">3. 利用iptables + ipset</a><ul><li><a href=#iptables%e7%ad%96%e7%95%a5 aria-label=iptables策略>iptables策略</a></li><li><a href=#ipset%e7%ad%96%e7%95%a5 aria-label=ipset策略>ipset策略</a></li><li><a href=#%e5%88%b6%e5%ae%9aipset%e6%8e%a7%e5%88%b6%e8%84%9a%e6%9c%ac aria-label=制定ipset控制脚本>制定ipset控制脚本</a></li></ul></li></ul></div></details></div><div class=post-content><blockquote><p>分享ssh安全配置实践</p></blockquote><h1 id=1-openssh基本配置>1. openssh基本配置<a hidden class=anchor aria-hidden=true href=#1-openssh基本配置>#</a></h1><p>关注安全漏洞信息，定期升级ssh<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>版本，关键参数配置参考：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat /etc/ssh/sshd_config
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Port <span class=m>22</span>     <span class=c1># 建议更改默认端口</span>
</span></span><span class=line><span class=cl>Protocol <span class=m>2</span>
</span></span><span class=line><span class=cl>PermitRootLogin no
</span></span><span class=line><span class=cl>MaxAuthTries <span class=m>3</span>
</span></span><span class=line><span class=cl>PubkeyAuthentication yes
</span></span><span class=line><span class=cl>PermitEmptyPasswords no
</span></span><span class=line><span class=cl>PasswordAuthentication no
</span></span><span class=line><span class=cl>UsePAM yes
</span></span><span class=line><span class=cl>X11Forwarding no
</span></span><span class=line><span class=cl>PrintMotd no
</span></span><span class=line><span class=cl>ClientAliveInterval <span class=m>180</span>
</span></span><span class=line><span class=cl>ClientAliveCountMax <span class=m>0</span>
</span></span><span class=line><span class=cl>UseDNS no
</span></span><span class=line><span class=cl>Banner /etc/ssh_banner
</span></span><span class=line><span class=cl>AllowUsers username
</span></span></code></pre></div><h1 id=2-使用pam模块锁定账户>2. 使用PAM模块锁定账户<a hidden class=anchor aria-hidden=true href=#2-使用pam模块锁定账户>#</a></h1><p>PAM<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>模块，pam_tally2和pam_faillock模块功能相似，以pam_faillock模块为例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat /etc/pam.d/password-auth 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#%PAM-1.0</span>
</span></span><span class=line><span class=cl><span class=c1># This file is auto-generated.</span>
</span></span><span class=line><span class=cl><span class=c1># User changes will be destroyed the next time authselect is run.</span>
</span></span><span class=line><span class=cl>auth        required      pam_env.so
</span></span><span class=line><span class=cl>auth        required      pam_faillock.so <span class=nv>deny</span><span class=o>=</span><span class=m>3</span> <span class=nv>unlock_time</span><span class=o>=</span><span class=m>900</span> even_deny_root <span class=nv>root_unlock_time</span><span class=o>=</span><span class=m>900</span>
</span></span><span class=line><span class=cl>auth        sufficient    pam_unix.so try_first_pass nullok
</span></span><span class=line><span class=cl>auth        required      pam_deny.so
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>account     required      pam_unix.so
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat /etc/pam.d/system-auth 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#%PAM-1.0</span>
</span></span><span class=line><span class=cl><span class=c1># This file is auto-generated.</span>
</span></span><span class=line><span class=cl><span class=c1># User changes will be destroyed the next time authselect is run.</span>
</span></span><span class=line><span class=cl>auth        required      pam_env.so
</span></span><span class=line><span class=cl>auth        required      pam_faillock.so <span class=nv>deny</span><span class=o>=</span><span class=m>3</span> <span class=nv>unlock_time</span><span class=o>=</span><span class=m>900</span> even_deny_root <span class=nv>root_unlock_time</span><span class=o>=</span><span class=m>900</span>
</span></span><span class=line><span class=cl>auth        sufficient    pam_unix.so try_first_pass nullok
</span></span><span class=line><span class=cl>auth        required      pam_deny.so
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>account     required      pam_unix.so
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><h1 id=3-利用iptables--ipset>3. 利用iptables + ipset<a hidden class=anchor aria-hidden=true href=#3-利用iptables--ipset>#</a></h1><p>启用iptables<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>，并配置ssh端口阻止策略，示例：</p><h2 id=iptables策略>iptables策略<a hidden class=anchor aria-hidden=true href=#iptables策略>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl <span class=nb>enable</span> iptables <span class=o>&amp;&amp;</span> systemctl start iptables
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat /etc/sysconfig/iptables
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># sample configuration for iptables service</span>
</span></span><span class=line><span class=cl><span class=c1># you can edit this manually or use system-config-firewall</span>
</span></span><span class=line><span class=cl><span class=c1># please do not ask us to add additional ports/services to this default configuration</span>
</span></span><span class=line><span class=cl>*filter
</span></span><span class=line><span class=cl>:INPUT ACCEPT <span class=o>[</span>0:0<span class=o>]</span>
</span></span><span class=line><span class=cl>:FORWARD ACCEPT <span class=o>[</span>0:0<span class=o>]</span>
</span></span><span class=line><span class=cl>:OUTPUT ACCEPT <span class=o>[</span>0:0<span class=o>]</span>
</span></span><span class=line><span class=cl>-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
</span></span><span class=line><span class=cl>-A INPUT -p icmp -j ACCEPT
</span></span><span class=line><span class=cl>-A INPUT -i lo -j ACCEPT
</span></span><span class=line><span class=cl>-A INPUT -m <span class=nb>set</span> --match-set banlist src -p tcp -m tcp --dport <span class=m>22</span> -j DROP -m comment --comment <span class=s2>&#34;block ipset banlist&#34;</span>
</span></span><span class=line><span class=cl>-A INPUT -p tcp -m state --state NEW -m tcp --dport <span class=m>22</span> -j ACCEPT
</span></span><span class=line><span class=cl>-A INPUT -j REJECT --reject-with icmp-host-prohibited
</span></span><span class=line><span class=cl>-A FORWARD -j REJECT --reject-with icmp-host-prohibited
</span></span><span class=line><span class=cl>COMMIT
</span></span></code></pre></div><h2 id=ipset策略>ipset策略<a hidden class=anchor aria-hidden=true href=#ipset策略>#</a></h2><p>启用ipset<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>服务，并新建策略<code>banlist</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 安装ipset服务</span>
</span></span><span class=line><span class=cl>yum install -y ipset-service
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> ipset
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建ipset策略</span>
</span></span><span class=line><span class=cl>ipset create banlist hash:ip hashsize <span class=m>4096</span> maxelem <span class=m>1000000</span> timeout <span class=m>86400</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 保存ipset配置</span>
</span></span><span class=line><span class=cl>ipset save &gt; /etc/sysconfig/ipset
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启动ipset服务</span>
</span></span><span class=line><span class=cl>systemctl restart ipset
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#查看ipset策略</span>
</span></span><span class=line><span class=cl>ipset list
</span></span></code></pre></div><h2 id=制定ipset控制脚本>制定ipset控制脚本<a hidden class=anchor aria-hidden=true href=#制定ipset控制脚本>#</a></h2><p>以CentOS 7为例，shell脚本示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=nv>ipset_name</span><span class=o>=</span><span class=s2>&#34;banlist&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>num</span><span class=o>=</span><span class=m>3</span>
</span></span><span class=line><span class=cl><span class=nv>date_time</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span>date -d <span class=s2>&#34;1 hours ago&#34;</span> <span class=s2>&#34;+%Y-%m-%d %H:%M:%S&#34;</span><span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[[</span> <span class=k>$(</span>ipset list <span class=si>${</span><span class=nv>ipset_name</span><span class=si>}</span><span class=k>)</span> <span class=o>]]</span> <span class=o>||</span> ipset create <span class=si>${</span><span class=nv>ipset_name</span><span class=si>}</span> hash:ip hashsize <span class=m>4096</span> maxelem <span class=m>1000000</span> timeout <span class=m>86400</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>ipset_info</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span>ipset save <span class=si>${</span><span class=nv>ipset_name</span><span class=si>}</span><span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>lastb -a -s <span class=s2>&#34;</span><span class=si>${</span><span class=nv>date_time</span><span class=si>}</span><span class=s2>&#34;</span> <span class=p>|</span>awk <span class=s1>&#39;/ssh/{print $NF}&#39;</span> <span class=p>|</span>sort -n <span class=p>|</span>uniq -c <span class=p>|</span><span class=k>while</span> <span class=nb>read</span> line<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nv>count</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$line</span> <span class=p>|</span>awk <span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>ipaddr</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$line</span> <span class=p>|</span>awk <span class=s1>&#39;{print $2}&#39;</span><span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=nv>$count</span> -ge <span class=nv>$num</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=o>[</span> <span class=k>$(</span><span class=nb>echo</span> <span class=si>${</span><span class=nv>ipset_info</span><span class=si>}</span> <span class=p>|</span>grep -wc <span class=s2>&#34;</span><span class=si>${</span><span class=nv>ipaddr</span><span class=si>}</span><span class=s2>&#34;</span><span class=k>)</span> -eq <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        /usr/sbin/ipset add <span class=si>${</span><span class=nv>ipset_name</span><span class=si>}</span> <span class=si>${</span><span class=nv>ipaddr</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></div><ul><li>配置root用户crontab定时任务：</li></ul><pre tabindex=0><code>crontab -l

* * * * * /bin/bash /opt/ban_ssh_ip.sh &amp;&gt;/dev/null
</code></pre><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://www.openssh.com>openssh</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://en.wikipedia.org/wiki/Linux_PAM>Linux PAM</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://www.netfilter.org>iptables</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://ipset.netfilter.org>ipset</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://gnail89.github.io/tags/ssh/>ssh</a></li><li><a href=https://gnail89.github.io/tags/ipset/>ipset</a></li><li><a href=https://gnail89.github.io/tags/iptables/>iptables</a></li></ul><nav class=paginav><a class=prev href=https://gnail89.github.io/posts/find-disk-slot/><span class=title>« Prev Page</span><br><span>硬盘驱动器与物理硬盘对应关系</span>
</a><a class=next href=https://gnail89.github.io/posts/install-ceph-octopus-with-cephadm/><span class=title>Next Page »</span><br><span>Install Ceph Octopus With Cephadm</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://gnail89.github.io>📕W.'s Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>