<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Openstack_mk_vm | 📕W.'s Blog</title>
<meta name=keywords content="OpenStack"><meta name=description content='引导虚拟机实例简单流程(AI) #!/bin/bash set -Eeuo pipefail basepath=$(cd `dirname $0`;pwd) readonly VM_FORMAT_FILE="vm_info_format.txt" readonly HYPERVISOR_FILE="env_available_host_list.txt" readonly VOL_TYPE_FILE="env_cinder_volume_type.txt" readonly IMAGES_FILE="env_image_list.txt" readonly DATA_SEPARATOR="+" readonly MAX_PARALLEL=2 log() { local lvl="$1" msg="$2" printf "%s [%4s] %s\n" "$(date +&#39;%F %T&#39;)" "$lvl" "$msg" >&amp;2 && return 0 [[ "$lvl" == "ERROR" ]] && exit 1 } trap &#39;log ERROR "Script aborted in $FUNCNAME at line $LINENO"&#39; ERR require_cmd() { command -v "$1" &>/dev/null || log ERROR "缺少命令: $1";} init_deps() { for cmd in openstack nova awk grep sed tee; do require_cmd "$cmd"; done; } check_volumes(){ local retries=$1 count=0 vol_ids=("${@:2}") for ((i=0; i<retries; i++)); do count=0 for vid in "${vol_ids[@]}"; do [[ -z "$vid" || "$vid" == "None" ]] && log ERROR "无效的卷ID" local st; st=$(openstack volume show -f value --column status "$vid") case "$st" in available) count=$((count+1)) ;; error*) log ERROR "卷状态显示error, ID: $vid" ;; esac done [[ $count -eq ${#vol_ids[@]} ]] && { echo ok; return 0; } sleep 30 done echo "None" return 0 } export_volume_types(){ > "$1" log INFO "正在导出卷类型列表" openstack volume type list -f value --column Name | grep -Ev &#39;^(#|$)&#39; > "$1" || echo "None" > "$1" } export_hypervisors(){ > "$1" log INFO "正在导出可用的宿主机列表" openstack compute service list -f value --service nova-compute \ | awk &#39;$5 == "enabled" && $6 == "up" {print $4":"$3}&#39; | grep -Ev &#39;^(#|$)&#39; > "$1" || echo "None" > "$1" } export_images(){ > "$1" log INFO "正在导出镜像列表" openstack image list -f value --column Name | grep -Ev &#39;^(#|$)&#39; > "$1" || echo "None" > "$1" } create_boot_volume(){ local name=$1 size=$2 image=$3 type=$4 [[ -z "$name" || -z "$size" || -z "$image" || -z "$type" ]] && log ERROR "缺少卷创建参数" local vol_name="${name}-sysvol" log INFO "创建启动卷: $vol_name" local opts=(--size "$size" --image "$(openstack image show -f value --column id "$image")") [[ "$type" !'><meta name=author content><link rel=canonical href=https://gnail89.github.io/posts/openstack_mk_vm/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://gnail89.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://gnail89.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://gnail89.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://gnail89.github.io/apple-touch-icon.png><link rel=mask-icon href=https://gnail89.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://gnail89.github.io/posts/openstack_mk_vm/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Openstack_mk_vm"><meta property="og:description" content='引导虚拟机实例简单流程(AI) #!/bin/bash set -Eeuo pipefail basepath=$(cd `dirname $0`;pwd) readonly VM_FORMAT_FILE="vm_info_format.txt" readonly HYPERVISOR_FILE="env_available_host_list.txt" readonly VOL_TYPE_FILE="env_cinder_volume_type.txt" readonly IMAGES_FILE="env_image_list.txt" readonly DATA_SEPARATOR="+" readonly MAX_PARALLEL=2 log() { local lvl="$1" msg="$2" printf "%s [%4s] %s\n" "$(date +&#39;%F %T&#39;)" "$lvl" "$msg" >&amp;2 && return 0 [[ "$lvl" == "ERROR" ]] && exit 1 } trap &#39;log ERROR "Script aborted in $FUNCNAME at line $LINENO"&#39; ERR require_cmd() { command -v "$1" &>/dev/null || log ERROR "缺少命令: $1";} init_deps() { for cmd in openstack nova awk grep sed tee; do require_cmd "$cmd"; done; } check_volumes(){ local retries=$1 count=0 vol_ids=("${@:2}") for ((i=0; i<retries; i++)); do count=0 for vid in "${vol_ids[@]}"; do [[ -z "$vid" || "$vid" == "None" ]] && log ERROR "无效的卷ID" local st; st=$(openstack volume show -f value --column status "$vid") case "$st" in available) count=$((count+1)) ;; error*) log ERROR "卷状态显示error, ID: $vid" ;; esac done [[ $count -eq ${#vol_ids[@]} ]] && { echo ok; return 0; } sleep 30 done echo "None" return 0 } export_volume_types(){ > "$1" log INFO "正在导出卷类型列表" openstack volume type list -f value --column Name | grep -Ev &#39;^(#|$)&#39; > "$1" || echo "None" > "$1" } export_hypervisors(){ > "$1" log INFO "正在导出可用的宿主机列表" openstack compute service list -f value --service nova-compute \ | awk &#39;$5 == "enabled" && $6 == "up" {print $4":"$3}&#39; | grep -Ev &#39;^(#|$)&#39; > "$1" || echo "None" > "$1" } export_images(){ > "$1" log INFO "正在导出镜像列表" openstack image list -f value --column Name | grep -Ev &#39;^(#|$)&#39; > "$1" || echo "None" > "$1" } create_boot_volume(){ local name=$1 size=$2 image=$3 type=$4 [[ -z "$name" || -z "$size" || -z "$image" || -z "$type" ]] && log ERROR "缺少卷创建参数" local vol_name="${name}-sysvol" log INFO "创建启动卷: $vol_name" local opts=(--size "$size" --image "$(openstack image show -f value --column id "$image")") [[ "$type" !'><meta property="og:type" content="article"><meta property="og:url" content="https://gnail89.github.io/posts/openstack_mk_vm/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-12T00:00:00+08:00"><meta property="article:modified_time" content="2025-08-12T00:00:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Openstack_mk_vm"><meta name=twitter:description content='引导虚拟机实例简单流程(AI) #!/bin/bash set -Eeuo pipefail basepath=$(cd `dirname $0`;pwd) readonly VM_FORMAT_FILE="vm_info_format.txt" readonly HYPERVISOR_FILE="env_available_host_list.txt" readonly VOL_TYPE_FILE="env_cinder_volume_type.txt" readonly IMAGES_FILE="env_image_list.txt" readonly DATA_SEPARATOR="+" readonly MAX_PARALLEL=2 log() { local lvl="$1" msg="$2" printf "%s [%4s] %s\n" "$(date +&#39;%F %T&#39;)" "$lvl" "$msg" >&amp;2 && return 0 [[ "$lvl" == "ERROR" ]] && exit 1 } trap &#39;log ERROR "Script aborted in $FUNCNAME at line $LINENO"&#39; ERR require_cmd() { command -v "$1" &>/dev/null || log ERROR "缺少命令: $1";} init_deps() { for cmd in openstack nova awk grep sed tee; do require_cmd "$cmd"; done; } check_volumes(){ local retries=$1 count=0 vol_ids=("${@:2}") for ((i=0; i<retries; i++)); do count=0 for vid in "${vol_ids[@]}"; do [[ -z "$vid" || "$vid" == "None" ]] && log ERROR "无效的卷ID" local st; st=$(openstack volume show -f value --column status "$vid") case "$st" in available) count=$((count+1)) ;; error*) log ERROR "卷状态显示error, ID: $vid" ;; esac done [[ $count -eq ${#vol_ids[@]} ]] && { echo ok; return 0; } sleep 30 done echo "None" return 0 } export_volume_types(){ > "$1" log INFO "正在导出卷类型列表" openstack volume type list -f value --column Name | grep -Ev &#39;^(#|$)&#39; > "$1" || echo "None" > "$1" } export_hypervisors(){ > "$1" log INFO "正在导出可用的宿主机列表" openstack compute service list -f value --service nova-compute \ | awk &#39;$5 == "enabled" && $6 == "up" {print $4":"$3}&#39; | grep -Ev &#39;^(#|$)&#39; > "$1" || echo "None" > "$1" } export_images(){ > "$1" log INFO "正在导出镜像列表" openstack image list -f value --column Name | grep -Ev &#39;^(#|$)&#39; > "$1" || echo "None" > "$1" } create_boot_volume(){ local name=$1 size=$2 image=$3 type=$4 [[ -z "$name" || -z "$size" || -z "$image" || -z "$type" ]] && log ERROR "缺少卷创建参数" local vol_name="${name}-sysvol" log INFO "创建启动卷: $vol_name" local opts=(--size "$size" --image "$(openstack image show -f value --column id "$image")") [[ "$type" !'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://gnail89.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Openstack_mk_vm","item":"https://gnail89.github.io/posts/openstack_mk_vm/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Openstack_mk_vm","name":"Openstack_mk_vm","description":"引导虚拟机实例简单流程(AI) #!/bin/bash set -Eeuo pipefail basepath=$(cd `dirname $0`;pwd) readonly VM_FORMAT_FILE=\u0026#34;vm_info_format.txt\u0026#34; readonly HYPERVISOR_FILE=\u0026#34;env_available_host_list.txt\u0026#34; readonly VOL_TYPE_FILE=\u0026#34;env_cinder_volume_type.txt\u0026#34; readonly IMAGES_FILE=\u0026#34;env_image_list.txt\u0026#34; readonly DATA_SEPARATOR=\u0026#34;+\u0026#34; readonly MAX_PARALLEL=2 log() { local lvl=\u0026#34;$1\u0026#34; msg=\u0026#34;$2\u0026#34; printf \u0026#34;%s [%4s] %s\\n\u0026#34; \u0026#34;$(date +\u0026#39;%F %T\u0026#39;)\u0026#34; \u0026#34;$lvl\u0026#34; \u0026#34;$msg\u0026#34; \u0026gt;\u0026amp;2 \u0026amp;\u0026amp; return 0 [[ \u0026#34;$lvl\u0026#34; == \u0026#34;ERROR\u0026#34; ]] \u0026amp;\u0026amp; exit 1 } trap \u0026#39;log ERROR \u0026#34;Script aborted in $FUNCNAME at line $LINENO\u0026#34;\u0026#39; ERR require_cmd() { command -v \u0026#34;$1\u0026#34; \u0026amp;\u0026gt;/dev/null || log ERROR \u0026#34;缺少命令: $1\u0026#34;;} init_deps() { for cmd in openstack nova awk grep sed tee; do require_cmd \u0026#34;$cmd\u0026#34;; done; } check_volumes(){ local retries=$1 count=0 vol_ids=(\u0026#34;${@:2}\u0026#34;) for ((i=0; i\u0026lt;retries; i++)); do count=0 for vid in \u0026#34;${vol_ids[@]}\u0026#34;; do [[ -z \u0026#34;$vid\u0026#34; || \u0026#34;$vid\u0026#34; == \u0026#34;None\u0026#34; ]] \u0026amp;\u0026amp; log ERROR \u0026#34;无效的卷ID\u0026#34; local st; st=$(openstack volume show -f value --column status \u0026#34;$vid\u0026#34;) case \u0026#34;$st\u0026#34; in available) count=$((count+1)) ;; error*) log ERROR \u0026#34;卷状态显示error, ID: $vid\u0026#34; ;; esac done [[ $count -eq ${#vol_ids[@]} ]] \u0026amp;\u0026amp; { echo ok; return 0; } sleep 30 done echo \u0026#34;None\u0026#34; return 0 } export_volume_types(){ \u0026gt; \u0026#34;$1\u0026#34; log INFO \u0026#34;正在导出卷类型列表\u0026#34; openstack volume type list -f value --column Name | grep -Ev \u0026#39;^(#|$)\u0026#39; \u0026gt; \u0026#34;$1\u0026#34; || echo \u0026#34;None\u0026#34; \u0026gt; \u0026#34;$1\u0026#34; } export_hypervisors(){ \u0026gt; \u0026#34;$1\u0026#34; log INFO \u0026#34;正在导出可用的宿主机列表\u0026#34; openstack compute service list -f value --service nova-compute \\ | awk \u0026#39;$5 == \u0026#34;enabled\u0026#34; \u0026amp;\u0026amp; $6 == \u0026#34;up\u0026#34; {print $4\u0026#34;:\u0026#34;$3}\u0026#39; | grep -Ev \u0026#39;^(#|$)\u0026#39; \u0026gt; \u0026#34;$1\u0026#34; || echo \u0026#34;None\u0026#34; \u0026gt; \u0026#34;$1\u0026#34; } export_images(){ \u0026gt; \u0026#34;$1\u0026#34; log INFO \u0026#34;正在导出镜像列表\u0026#34; openstack image list -f value --column Name | grep -Ev \u0026#39;^(#|$)\u0026#39; \u0026gt; \u0026#34;$1\u0026#34; || echo \u0026#34;None\u0026#34; \u0026gt; \u0026#34;$1\u0026#34; } create_boot_volume(){ local name=$1 size=$2 image=$3 type=$4 [[ -z \u0026#34;$name\u0026#34; || -z \u0026#34;$size\u0026#34; || -z \u0026#34;$image\u0026#34; || -z \u0026#34;$type\u0026#34; ]] \u0026amp;\u0026amp; log ERROR \u0026#34;缺少卷创建参数\u0026#34; local vol_name=\u0026#34;${name}-sysvol\u0026#34; log INFO \u0026#34;创建启动卷: $vol_name\u0026#34; local opts=(--size \u0026#34;$size\u0026#34; --image \u0026#34;$(openstack image show -f value --column id \u0026#34;$image\u0026#34;)\u0026#34;) [[ \u0026#34;$type\u0026#34; !","keywords":["OpenStack"],"articleBody":"引导虚拟机实例简单流程(AI) #!/bin/bash set -Eeuo pipefail basepath=$(cd `dirname $0`;pwd) readonly VM_FORMAT_FILE=\"vm_info_format.txt\" readonly HYPERVISOR_FILE=\"env_available_host_list.txt\" readonly VOL_TYPE_FILE=\"env_cinder_volume_type.txt\" readonly IMAGES_FILE=\"env_image_list.txt\" readonly DATA_SEPARATOR=\"+\" readonly MAX_PARALLEL=2 log() { local lvl=\"$1\" msg=\"$2\" printf \"%s [%4s] %s\\n\" \"$(date +'%F %T')\" \"$lvl\" \"$msg\" \u003e\u00262 \u0026\u0026 return 0 [[ \"$lvl\" == \"ERROR\" ]] \u0026\u0026 exit 1 } trap 'log ERROR \"Script aborted in $FUNCNAME at line $LINENO\"' ERR require_cmd() { command -v \"$1\" \u0026\u003e/dev/null || log ERROR \"缺少命令: $1\";} init_deps() { for cmd in openstack nova awk grep sed tee; do require_cmd \"$cmd\"; done; } check_volumes(){ local retries=$1 count=0 vol_ids=(\"${@:2}\") for ((i=0; i","wordCount":"1099","inLanguage":"en","datePublished":"2025-08-12T00:00:00+08:00","dateModified":"2025-08-12T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://gnail89.github.io/posts/openstack_mk_vm/"},"publisher":{"@type":"Organization","name":"📕W.'s Blog","logo":{"@type":"ImageObject","url":"https://gnail89.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://gnail89.github.io/ accesskey=h title="📕W.'s Blog (Alt + H)">📕W.'s Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://gnail89.github.io/search/ title=🔍Search><span>🔍Search</span></a></li><li><a href=https://gnail89.github.io/archives/ title=📚Archive><span>📚Archive</span></a></li><li><a href=https://gnail89.github.io/tags/ title=🔖Tags><span>🔖Tags</span></a></li><li><a href=https://gnail89.github.io/categories/ title=🧩Categories><span>🧩Categories</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://gnail89.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://gnail89.github.io/posts/>Posts</a></div><h1 class=post-title>Openstack_mk_vm</h1></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%bc%95%e5%af%bc%e8%99%9a%e6%8b%9f%e6%9c%ba%e5%ae%9e%e4%be%8b%e7%ae%80%e5%8d%95%e6%b5%81%e7%a8%8bai aria-label=引导虚拟机实例简单流程(AI)>引导虚拟机实例简单流程(AI)</a></li></ul></div></details></div><div class=post-content><h1 id=引导虚拟机实例简单流程ai>引导虚拟机实例简单流程(AI)<a hidden class=anchor aria-hidden=true href=#引导虚拟机实例简单流程ai>#</a></h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=nb>set</span> -Eeuo pipefail
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>basepath</span><span class=o>=</span><span class=k>$(</span><span class=nb>cd</span> <span class=sb>`</span>dirname <span class=nv>$0</span><span class=sb>`</span><span class=p>;</span><span class=nb>pwd</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nb>readonly</span> <span class=nv>VM_FORMAT_FILE</span><span class=o>=</span><span class=s2>&#34;vm_info_format.txt&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>readonly</span> <span class=nv>HYPERVISOR_FILE</span><span class=o>=</span><span class=s2>&#34;env_available_host_list.txt&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>readonly</span> <span class=nv>VOL_TYPE_FILE</span><span class=o>=</span><span class=s2>&#34;env_cinder_volume_type.txt&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>readonly</span> <span class=nv>IMAGES_FILE</span><span class=o>=</span><span class=s2>&#34;env_image_list.txt&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>readonly</span> <span class=nv>DATA_SEPARATOR</span><span class=o>=</span><span class=s2>&#34;+&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>readonly</span> <span class=nv>MAX_PARALLEL</span><span class=o>=</span><span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>log<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>local</span> <span class=nv>lvl</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;%s [%4s] %s\n&#34;</span> <span class=s2>&#34;</span><span class=k>$(</span>date +<span class=s1>&#39;%F %T&#39;</span><span class=k>)</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$lvl</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$msg</span><span class=s2>&#34;</span> &gt;<span class=p>&amp;</span><span class=m>2</span> <span class=o>&amp;&amp;</span> <span class=k>return</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>  <span class=o>[[</span> <span class=s2>&#34;</span><span class=nv>$lvl</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;ERROR&#34;</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>trap</span> <span class=s1>&#39;log ERROR &#34;Script aborted in $FUNCNAME at line $LINENO&#34;&#39;</span> ERR
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>require_cmd<span class=o>()</span> <span class=o>{</span> <span class=nb>command</span> -v <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=p>&amp;</span>&gt;/dev/null <span class=o>||</span> log ERROR <span class=s2>&#34;缺少命令: </span><span class=nv>$1</span><span class=s2>&#34;</span><span class=p>;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>init_deps<span class=o>()</span> <span class=o>{</span> <span class=k>for</span> cmd in openstack nova awk grep sed tee<span class=p>;</span> <span class=k>do</span> require_cmd <span class=s2>&#34;</span><span class=nv>$cmd</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>done</span><span class=p>;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>check_volumes<span class=o>(){</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>retries</span><span class=o>=</span><span class=nv>$1</span> <span class=nv>count</span><span class=o>=</span><span class=m>0</span> <span class=nv>vol_ids</span><span class=o>=(</span><span class=s2>&#34;</span><span class=si>${</span><span class=p>@:</span><span class=nv>2</span><span class=si>}</span><span class=s2>&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>((</span><span class=nv>i</span><span class=o>=</span>0<span class=p>;</span> i&lt;retries<span class=p>;</span> i++<span class=o>))</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=nv>count</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> vid in <span class=s2>&#34;</span><span class=si>${</span><span class=nv>vol_ids</span><span class=p>[@]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>            <span class=o>[[</span> -z <span class=s2>&#34;</span><span class=nv>$vid</span><span class=s2>&#34;</span> <span class=o>||</span> <span class=s2>&#34;</span><span class=nv>$vid</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;None&#34;</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> log ERROR <span class=s2>&#34;无效的卷ID&#34;</span>
</span></span><span class=line><span class=cl>            <span class=nb>local</span> st<span class=p>;</span> <span class=nv>st</span><span class=o>=</span><span class=k>$(</span>openstack volume show -f value --column status <span class=s2>&#34;</span><span class=nv>$vid</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s2>&#34;</span><span class=nv>$st</span><span class=s2>&#34;</span> in
</span></span><span class=line><span class=cl>                available<span class=o>)</span> <span class=nv>count</span><span class=o>=</span><span class=k>$((</span>count+1<span class=k>))</span> <span class=p>;;</span>
</span></span><span class=line><span class=cl>                error*<span class=o>)</span> log ERROR <span class=s2>&#34;卷状态显示error, ID: </span><span class=nv>$vid</span><span class=s2>&#34;</span> <span class=p>;;</span>
</span></span><span class=line><span class=cl>            <span class=k>esac</span>
</span></span><span class=line><span class=cl>        <span class=k>done</span>
</span></span><span class=line><span class=cl>        <span class=o>[[</span> <span class=nv>$count</span> -eq <span class=si>${#</span><span class=nv>vol_ids</span><span class=p>[@]</span><span class=si>}</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> <span class=o>{</span> <span class=nb>echo</span> ok<span class=p>;</span> <span class=k>return</span> 0<span class=p>;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>        sleep <span class=m>30</span>
</span></span><span class=line><span class=cl>    <span class=k>done</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;None&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>export_volume_types<span class=o>(){</span>
</span></span><span class=line><span class=cl>    &gt; <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    log INFO <span class=s2>&#34;正在导出卷类型列表&#34;</span>
</span></span><span class=line><span class=cl>    openstack volume <span class=nb>type</span> list -f value --column Name <span class=p>|</span> grep -Ev <span class=s1>&#39;^(#|$)&#39;</span> &gt; <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=o>||</span> <span class=nb>echo</span> <span class=s2>&#34;None&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>export_hypervisors<span class=o>(){</span>
</span></span><span class=line><span class=cl>    &gt; <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    log INFO <span class=s2>&#34;正在导出可用的宿主机列表&#34;</span>
</span></span><span class=line><span class=cl>    openstack compute service list -f value --service nova-compute <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        <span class=p>|</span> awk <span class=s1>&#39;$5 == &#34;enabled&#34; &amp;&amp; $6 == &#34;up&#34; {print $4&#34;:&#34;$3}&#39;</span> <span class=p>|</span> grep -Ev <span class=s1>&#39;^(#|$)&#39;</span> &gt; <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=o>||</span> <span class=nb>echo</span> <span class=s2>&#34;None&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>export_images<span class=o>(){</span>
</span></span><span class=line><span class=cl>    &gt; <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    log INFO <span class=s2>&#34;正在导出镜像列表&#34;</span>
</span></span><span class=line><span class=cl>    openstack image list -f value --column Name <span class=p>|</span> grep -Ev <span class=s1>&#39;^(#|$)&#39;</span> &gt; <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=o>||</span> <span class=nb>echo</span> <span class=s2>&#34;None&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>create_boot_volume<span class=o>(){</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>name</span><span class=o>=</span><span class=nv>$1</span> <span class=nv>size</span><span class=o>=</span><span class=nv>$2</span> <span class=nv>image</span><span class=o>=</span><span class=nv>$3</span> <span class=nv>type</span><span class=o>=</span><span class=nv>$4</span>
</span></span><span class=line><span class=cl>    <span class=o>[[</span> -z <span class=s2>&#34;</span><span class=nv>$name</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$size</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$image</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$type</span><span class=s2>&#34;</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> log ERROR <span class=s2>&#34;缺少卷创建参数&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>vol_name</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>name</span><span class=si>}</span><span class=s2>-sysvol&#34;</span>
</span></span><span class=line><span class=cl>    log INFO <span class=s2>&#34;创建启动卷: </span><span class=nv>$vol_name</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>opts</span><span class=o>=(</span>--size <span class=s2>&#34;</span><span class=nv>$size</span><span class=s2>&#34;</span> --image <span class=s2>&#34;</span><span class=k>$(</span>openstack image show -f value --column id <span class=s2>&#34;</span><span class=nv>$image</span><span class=s2>&#34;</span><span class=k>)</span><span class=s2>&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>[[</span> <span class=s2>&#34;</span><span class=nv>$type</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=s2>&#34;None&#34;</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> <span class=nv>opts</span><span class=o>+=(</span>--type <span class=s2>&#34;</span><span class=nv>$type</span><span class=s2>&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> id<span class=p>;</span> <span class=nv>id</span><span class=o>=</span><span class=k>$(</span>openstack volume create -f value --column id <span class=s2>&#34;</span><span class=si>${</span><span class=nv>opts</span><span class=p>[@]</span><span class=si>}</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$vol_name</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    log INFO <span class=s2>&#34;启动卷已创建, ID: </span><span class=nv>$id</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$id</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>create_data_vols<span class=o>(){</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>name</span><span class=o>=</span><span class=nv>$1</span> <span class=nv>size_list</span><span class=o>=</span><span class=nv>$2</span> <span class=nv>type</span><span class=o>=</span><span class=nv>$3</span>
</span></span><span class=line><span class=cl>    <span class=o>[[</span> -z <span class=s2>&#34;</span><span class=nv>$name</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$size_list</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$type</span><span class=s2>&#34;</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> log ERROR <span class=s2>&#34;缺少卷创建参数&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>IFS</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$DATA_SEPARATOR</span><span class=s2>&#34;</span> <span class=nb>read</span> -r -a sizes <span class=o>&lt;&lt;&lt;</span><span class=s2>&#34;</span><span class=nv>$size_list</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> s in <span class=s2>&#34;</span><span class=si>${</span><span class=nv>sizes</span><span class=p>[@]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=o>[[</span> <span class=nv>$s</span> -le <span class=m>0</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=nb>local</span> <span class=nv>vol_name</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>name</span><span class=si>}</span><span class=s2>-datavol-</span><span class=si>${</span><span class=nv>s</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        log INFO <span class=s2>&#34;创建数据卷: </span><span class=nv>$vol_name</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>local</span> <span class=nv>opts</span><span class=o>=(</span>--size <span class=s2>&#34;</span><span class=nv>$s</span><span class=s2>&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>[[</span> <span class=s2>&#34;</span><span class=nv>$type</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=s2>&#34;None&#34;</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> <span class=nv>opts</span><span class=o>+=(</span>--type <span class=s2>&#34;</span><span class=nv>$type</span><span class=s2>&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>local</span> id<span class=p>;</span> <span class=nv>id</span><span class=o>=</span><span class=k>$(</span>openstack volume create -f value --column id <span class=s2>&#34;</span><span class=si>${</span><span class=nv>opts</span><span class=p>[@]</span><span class=si>}</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$vol_name</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>        log INFO <span class=s2>&#34;数据卷已创建, ID: </span><span class=nv>$id</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$id</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>done</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>boot_instance<span class=o>(){</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>name</span><span class=o>=</span><span class=nv>$1</span> <span class=nv>ip</span><span class=o>=</span><span class=nv>$2</span> <span class=nv>flavor</span><span class=o>=</span><span class=nv>$3</span> <span class=nv>net</span><span class=o>=</span><span class=nv>$4</span> <span class=nv>zone</span><span class=o>=</span><span class=nv>$5</span><span class=p>;</span> <span class=nb>shift</span> <span class=m>5</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>vol_ids</span><span class=o>=(</span><span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span><span class=o>)</span> <span class=nv>bdevs</span><span class=o>=()</span> <span class=nv>n</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>    <span class=o>[[</span> -z <span class=s2>&#34;</span><span class=nv>$name</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$ip</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$flavor</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$net</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$zone</span><span class=s2>&#34;</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> log ERROR <span class=s2>&#34;缺少启动参数&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> vid in <span class=s2>&#34;</span><span class=si>${</span><span class=nv>vol_ids</span><span class=p>[@]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=nv>bdevs</span><span class=o>+=(</span>--block-device <span class=nv>source</span><span class=o>=</span>volume,id<span class=o>=</span><span class=nv>$vid</span>,dest<span class=o>=</span>volume,shutdown<span class=o>=</span>preserve,bootindex<span class=o>=</span><span class=nv>$n</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>n</span><span class=o>=</span><span class=k>$((</span>n+1<span class=k>))</span>
</span></span><span class=line><span class=cl>    <span class=k>done</span>
</span></span><span class=line><span class=cl>    log INFO <span class=s2>&#34;启动虚拟机: </span><span class=nv>$name</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    log INFO <span class=s2>&#34;虚拟机启动指令: </span><span class=k>$(</span><span class=nb>echo</span> <span class=s2>&#34;nova boot --flavor </span><span class=nv>$flavor</span><span class=s2> </span><span class=si>${</span><span class=nv>bdevs</span><span class=p>[@]</span><span class=si>}</span><span class=s2> --nic net-id=</span><span class=nv>$net</span><span class=s2>,v4-fixed-ip=</span><span class=nv>$ip</span><span class=s2> --availability-zone </span><span class=nv>$zone</span><span class=s2> </span><span class=nv>$name</span><span class=s2>&#34;</span><span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=k>$(</span>openstack server list --ip <span class=s2>&#34;</span><span class=si>${</span><span class=nv>ip</span><span class=si>}</span>$<span class=s2>&#34;</span> -f value 2&gt;/dev/null <span class=p>|</span> wc -l<span class=k>)</span> -ne <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        log INFO <span class=s2>&#34;虚拟机IP已使用, 忽略启动&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    nova boot --flavor <span class=s2>&#34;</span><span class=nv>$flavor</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>bdevs</span><span class=p>[@]</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        --nic net-id<span class=o>=</span><span class=s2>&#34;</span><span class=nv>$net</span><span class=s2>&#34;</span>,v4-fixed-ip<span class=o>=</span><span class=s2>&#34;</span><span class=nv>$ip</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        --availability-zone <span class=s2>&#34;</span><span class=nv>$zone</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$name</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>process_vm_line<span class=o>(){</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>line</span><span class=o>=</span><span class=nv>$1</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>vol_ids</span><span class=o>=()</span>
</span></span><span class=line><span class=cl>    <span class=nv>IFS</span><span class=o>=</span><span class=s1>&#39;,&#39;</span> <span class=nb>read</span> -r image cpu_mem sys data name vlan ip zone voltype <span class=o>&lt;&lt;&lt;</span><span class=s2>&#34;</span><span class=nv>$line</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>vol_ids</span><span class=o>+=(</span> <span class=k>$(</span>create_boot_volume <span class=s2>&#34;</span><span class=nv>$name</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$sys</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$image</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>voltype</span><span class=k>:-</span><span class=nv>None</span><span class=si>}</span><span class=s2>&#34;</span><span class=k>)</span> <span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>vol_ids</span><span class=o>+=(</span> <span class=k>$(</span>create_data_vols <span class=s2>&#34;</span><span class=nv>$name</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$data</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>voltype</span><span class=k>:-</span><span class=nv>None</span><span class=si>}</span><span class=s2>&#34;</span><span class=k>)</span> <span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>[[</span> <span class=s2>&#34;</span><span class=k>$(</span>check_volumes <span class=m>30</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>vol_ids</span><span class=p>[@]</span><span class=si>}</span><span class=s2>&#34;</span><span class=k>)</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;ok&#34;</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        boot_instance <span class=s2>&#34;</span><span class=nv>$name</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$ip</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$cpu_mem</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=k>$(</span>openstack network list -f csv --column ID --column Name <span class=p>|</span>grep -w <span class=s2>&#34;</span><span class=si>${</span><span class=nv>vlan</span><span class=si>}</span><span class=s2>&#34;</span> <span class=p>|</span>awk -F<span class=s1>&#39;\&#34;&#39;</span> <span class=s1>&#39;{print $2}&#39;</span><span class=k>)</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$zone</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>vol_ids</span><span class=p>[@]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>main_vm_task<span class=o>(){</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>infile</span><span class=o>=</span><span class=nv>$1</span>
</span></span><span class=line><span class=cl>    log INFO <span class=s2>&#34;开始并发创建虚拟机流程&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>fifo_file</span><span class=o>=</span><span class=s2>&#34;/tmp/</span><span class=nv>$$</span><span class=s2>.vm_fifo&#34;</span>
</span></span><span class=line><span class=cl>    mkfifo <span class=s2>&#34;</span><span class=nv>$fifo_file</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exec</span> 9&lt;&gt;<span class=s2>&#34;</span><span class=nv>$fifo_file</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    rm -f <span class=s2>&#34;</span><span class=nv>$fifo_file</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>((</span><span class=nv>i</span><span class=o>=</span>0<span class=p>;</span>i&lt;MAX_PARALLEL<span class=p>;</span>i++<span class=o>))</span><span class=p>;</span> <span class=k>do</span> <span class=nb>echo</span> &gt;<span class=p>&amp;</span>9<span class=p>;</span> <span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=nv>IFS</span><span class=o>=</span> <span class=nb>read</span> -r line<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=o>[[</span> -z <span class=nv>$line</span> <span class=o>||</span> <span class=si>${</span><span class=nv>line</span><span class=p>:</span><span class=nv>0</span><span class=p>:</span><span class=nv>1</span><span class=si>}</span> <span class=o>==</span> <span class=s1>&#39;#&#39;</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=nb>read</span> -t <span class=m>1000</span> -u9
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            process_vm_line <span class=s2>&#34;</span><span class=nv>$line</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=nb>echo</span> &gt;<span class=p>&amp;</span><span class=m>9</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=p>&amp;</span>
</span></span><span class=line><span class=cl>    <span class=k>done</span> &lt; <span class=s2>&#34;</span><span class=nv>$infile</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>wait</span>
</span></span><span class=line><span class=cl>    <span class=nb>exec</span> 9&gt;<span class=p>&amp;</span>-
</span></span><span class=line><span class=cl>    log INFO <span class=s2>&#34;所有虚拟机创建流程已执行完成&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>get_item_by_ip<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>ip</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=nv>file</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> ! -r <span class=s2>&#34;</span><span class=nv>$file</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        log WARN <span class=s2>&#34;无法访问文件: </span><span class=nv>$file</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> -n <span class=s2>&#34;None&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>valid_items</span><span class=o>=</span><span class=k>$(</span>awk <span class=s1>&#39;!/^#|^$/ {print $1}&#39;</span> <span class=s2>&#34;</span><span class=nv>$file</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>item_count</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$valid_items</span><span class=s2>&#34;</span> <span class=p>|</span> wc -l<span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$item_count</span><span class=s2>&#34;</span> -gt <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>local</span> <span class=nv>index</span><span class=o>=</span><span class=k>$((</span> <span class=o>(</span><span class=si>${</span><span class=nv>ip</span><span class=p>##*.</span><span class=si>}</span> <span class=o>%</span> item_count<span class=o>)</span> <span class=o>+</span> <span class=m>1</span> <span class=k>))</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> -n <span class=s2>&#34;</span><span class=k>$(</span><span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$valid_items</span><span class=s2>&#34;</span> <span class=p>|</span> sed -n <span class=s2>&#34;</span><span class=si>${</span><span class=nv>index</span><span class=si>}</span><span class=s2>p&#34;</span><span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> -n <span class=s2>&#34;None&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>trim<span class=o>(){</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>str</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$str</span><span class=s2>&#34;</span> <span class=p>|</span> sed <span class=s1>&#39;s/^[[:space:]]*//;s/[[:space:]]*$//&#39;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>main_build_task<span class=o>(){</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>file</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=nv>zone</span><span class=o>=</span><span class=s2>&#34;None&#34;</span> <span class=nv>voltype</span><span class=o>=</span><span class=s2>&#34;None&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>[[</span> ! -f <span class=s2>&#34;</span><span class=nv>$file</span><span class=s2>&#34;</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> log ERROR <span class=s2>&#34;读取虚拟机资产信息失败：</span><span class=nv>$file</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;#镜像名称, 规格名称, 系统盘大小, 数据盘大小, 虚拟机名称, VLAN名称, IP地址, 宿主机, 卷类型&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$VM_FORMAT_FILE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=nv>IFS</span><span class=o>=</span><span class=s1>&#39;,&#39;</span> <span class=nb>read</span> -r -a fields <span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=o>[[</span> <span class=s2>&#34;</span><span class=si>${#</span><span class=nv>fields</span><span class=p>[@]</span><span class=si>}</span><span class=s2>&#34;</span> -eq <span class=m>0</span> <span class=o>||</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>fields</span><span class=p>[0]</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>=</span>~ ^<span class=o>(</span><span class=c1>#|机房和平台) ]] &amp;&amp; continue</span>
</span></span><span class=line><span class=cl>        <span class=o>[[</span> <span class=si>${#</span><span class=nv>fields</span><span class=p>[@]</span><span class=si>}</span> -lt <span class=m>14</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=nv>img</span><span class=o>=</span><span class=k>$(</span>trim <span class=s2>&#34;</span><span class=si>${</span><span class=nv>fields</span><span class=p>[6]</span><span class=si>}</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>cpu</span><span class=o>=</span><span class=k>$(</span>trim <span class=s2>&#34;</span><span class=si>${</span><span class=nv>fields</span><span class=p>[7]</span><span class=si>}</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>mem</span><span class=o>=</span><span class=k>$(</span>trim <span class=s2>&#34;</span><span class=si>${</span><span class=nv>fields</span><span class=p>[8]</span><span class=si>}</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>sys</span><span class=o>=</span><span class=k>$(</span>trim <span class=s2>&#34;</span><span class=si>${</span><span class=nv>fields</span><span class=p>[9]</span><span class=si>}</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>data</span><span class=o>=</span><span class=k>$(</span>trim <span class=s2>&#34;</span><span class=si>${</span><span class=nv>fields</span><span class=p>[10]</span><span class=si>}</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>name</span><span class=o>=</span><span class=k>$(</span>trim <span class=s2>&#34;</span><span class=si>${</span><span class=nv>fields</span><span class=p>[11]</span><span class=si>}</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>net</span><span class=o>=</span><span class=k>$(</span>trim <span class=s2>&#34;</span><span class=si>${</span><span class=nv>fields</span><span class=p>[12]</span><span class=si>}</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>vmip</span><span class=o>=</span><span class=k>$(</span>trim <span class=s2>&#34;</span><span class=si>${</span><span class=nv>fields</span><span class=p>[13]</span><span class=si>}</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>        <span class=o>[[</span> -z <span class=s2>&#34;</span><span class=nv>$img</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$cpu</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$mem</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$sys</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$data</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$name</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$net</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$vmip</span><span class=s2>&#34;</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=nv>flavor</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>cpu</span><span class=si>}</span><span class=s2>C</span><span class=si>${</span><span class=nv>mem</span><span class=si>}</span><span class=s2>G</span><span class=si>${</span><span class=nv>sys</span><span class=si>}</span><span class=s2>G&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[[</span> -n <span class=s2>&#34;</span><span class=nv>$vmip</span><span class=s2>&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            <span class=nv>zone</span><span class=o>=</span><span class=k>$(</span>get_item_by_ip <span class=s2>&#34;</span><span class=nv>$vmip</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$HYPERVISOR_FILE</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>            <span class=nv>voltype</span><span class=o>=</span><span class=k>$(</span>get_item_by_ip <span class=s2>&#34;</span><span class=nv>$vmip</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$VOL_TYPE_FILE</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=k>$(</span>grep -c <span class=s2>&#34;</span><span class=nv>$img</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$IMAGES_FILE</span><span class=s2>&#34;</span><span class=k>)</span><span class=s2>&#34;</span> -eq <span class=m>1</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            <span class=nv>img</span><span class=o>=</span><span class=k>$(</span>grep <span class=s2>&#34;</span><span class=nv>$img</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$IMAGES_FILE</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            log WARN <span class=s2>&#34;镜像: </span><span class=nv>$img</span><span class=s2> 不存在, 已忽略&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$img</span><span class=s2>,</span><span class=nv>$flavor</span><span class=s2>,</span><span class=nv>$sys</span><span class=s2>,</span><span class=nv>$data</span><span class=s2>,</span><span class=nv>$name</span><span class=s2>,</span><span class=nv>$net</span><span class=s2>,</span><span class=nv>$vmip</span><span class=s2>,</span><span class=nv>$zone</span><span class=s2>,</span><span class=nv>$voltype</span><span class=s2>&#34;</span> <span class=p>|</span> tee -a <span class=s2>&#34;</span><span class=nv>$VM_FORMAT_FILE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>done</span> &lt; <span class=s2>&#34;</span><span class=nv>$file</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    log INFO <span class=s2>&#34;---- 【重要】请核查配置文件: </span><span class=si>${</span><span class=nv>VM_FORMAT_FILE</span><span class=si>}</span><span class=s2>, 并修正错误 ----&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>main_review_task<span class=o>(){</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>file</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>[[</span> ! -f <span class=s2>&#34;</span><span class=nv>$file</span><span class=s2>&#34;</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> log ERROR <span class=s2>&#34;读取配置文件失败：</span><span class=nv>$file</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>cluster_images</span><span class=o>=(</span><span class=k>$(</span>openstack image list -f value -c Name<span class=k>)</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>cluster_flavors</span><span class=o>=(</span><span class=k>$(</span>openstack flavor list -f value -c Name<span class=k>)</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>cluster_vlans</span><span class=o>=(</span><span class=k>$(</span>openstack network list -f csv <span class=p>|</span> awk -F<span class=s1>&#39;\&#34;&#39;</span> <span class=s1>&#39;{print $4}&#39;</span><span class=k>)</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>cluster_voltypes</span><span class=o>=(</span><span class=k>$(</span>openstack volume <span class=nb>type</span> list -f value -c Name<span class=k>)</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>[[</span> <span class=s2>&#34;</span><span class=si>${#</span><span class=nv>cluster_voltypes</span><span class=p>[@]</span><span class=si>}</span><span class=s2>&#34;</span> -eq <span class=m>0</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> cluster_voltypes<span class=o>[</span>0<span class=o>]=</span><span class=s2>&#34;None&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=nv>IFS</span><span class=o>=</span><span class=s1>&#39;,&#39;</span> <span class=nb>read</span> -r img flavor sys data name net vmip zone voltype<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=o>[[</span> -z <span class=s2>&#34;</span><span class=nv>$img</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$flavor</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$sys</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$data</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$name</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$net</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$vmip</span><span class=s2>&#34;</span> <span class=o>]]</span> <span class=o>&amp;&amp;</span> <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=o>[[</span> <span class=s2>&#34;</span><span class=nv>$img</span><span class=s2>&#34;</span> <span class=o>=</span>~ ^<span class=o>(</span><span class=c1>#|$) ]] &amp;&amp; continue</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> ! <span class=o>[[</span> <span class=s2>&#34; </span><span class=si>${</span><span class=nv>cluster_images</span><span class=p>[@]</span><span class=si>}</span><span class=s2> &#34;</span> <span class=o>=</span>~ <span class=s2>&#34; </span><span class=si>${</span><span class=nv>img</span><span class=si>}</span><span class=s2> &#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            log WARN <span class=s2>&#34;镜像不存在: </span><span class=si>${</span><span class=nv>img</span><span class=si>}</span><span class=s2> (IP: </span><span class=nv>$vmip</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> ! <span class=o>[[</span> <span class=s2>&#34; </span><span class=si>${</span><span class=nv>cluster_flavors</span><span class=p>[@]</span><span class=si>}</span><span class=s2> &#34;</span> <span class=o>=</span>~ <span class=s2>&#34; </span><span class=si>${</span><span class=nv>flavor</span><span class=si>}</span><span class=s2> &#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            log WARN <span class=s2>&#34;规格不存在: </span><span class=si>${</span><span class=nv>flavor</span><span class=si>}</span><span class=s2> (IP: </span><span class=nv>$vmip</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> ! <span class=o>[[</span> <span class=s2>&#34; </span><span class=si>${</span><span class=nv>cluster_vlans</span><span class=p>[@]</span><span class=si>}</span><span class=s2> &#34;</span> <span class=o>=</span>~ <span class=s2>&#34; </span><span class=si>${</span><span class=nv>net</span><span class=si>}</span><span class=s2> &#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            log WARN <span class=s2>&#34;网络不存在: </span><span class=si>${</span><span class=nv>net</span><span class=si>}</span><span class=s2> (IP: </span><span class=nv>$vmip</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> ! <span class=o>[[</span> <span class=s2>&#34; </span><span class=si>${</span><span class=nv>cluster_voltypes</span><span class=p>[@]</span><span class=si>}</span><span class=s2> &#34;</span> <span class=o>=</span>~ <span class=s2>&#34; </span><span class=si>${</span><span class=nv>voltype</span><span class=si>}</span><span class=s2> &#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            log WARN <span class=s2>&#34;卷类型不存在: </span><span class=si>${</span><span class=nv>voltype</span><span class=si>}</span><span class=s2> (IP: </span><span class=nv>$vmip</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>        <span class=nv>IFS</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$DATA_SEPARATOR</span><span class=s2>&#34;</span> <span class=nb>read</span> -r -a sizes <span class=o>&lt;&lt;&lt;</span><span class=s2>&#34;</span><span class=nv>$data</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1>#local arr=(${data//${DATA_SEPARATOR}/ })</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> size in <span class=s2>&#34;</span><span class=si>${</span><span class=nv>sizes</span><span class=p>[@]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> ! <span class=o>[[</span> <span class=s2>&#34;</span><span class=nv>$size</span><span class=s2>&#34;</span> <span class=o>=</span>~ ^<span class=o>[</span>0-9<span class=o>]</span>+$ <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>                log WARN <span class=s2>&#34;数据盘格式检测异常: </span><span class=nv>$size</span><span class=s2> (IP: </span><span class=nv>$vmip</span><span class=s2>), 间隔符号为: </span><span class=si>${</span><span class=nv>DATA_SEPARATOR</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>fi</span>
</span></span><span class=line><span class=cl>        <span class=k>done</span>
</span></span><span class=line><span class=cl>        log INFO <span class=s2>&#34;IP: </span><span class=si>${</span><span class=nv>vmip</span><span class=si>}</span><span class=s2>, 5项检查流程执行完毕&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>done</span> &lt; <span class=s2>&#34;</span><span class=nv>$file</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>main<span class=o>(){</span>
</span></span><span class=line><span class=cl>    init_deps
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> in
</span></span><span class=line><span class=cl>        init<span class=o>)</span>
</span></span><span class=line><span class=cl>            export_hypervisors <span class=s2>&#34;</span><span class=nv>$HYPERVISOR_FILE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            export_volume_types <span class=s2>&#34;</span><span class=nv>$VOL_TYPE_FILE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            export_images <span class=s2>&#34;</span><span class=nv>$IMAGES_FILE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            log INFO <span class=s2>&#34;【重要】请人工核实生成的系统环境信息文件【重要】&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>;;</span>
</span></span><span class=line><span class=cl>        build<span class=o>)</span>
</span></span><span class=line><span class=cl>            main_build_task <span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>;;</span>
</span></span><span class=line><span class=cl>        review<span class=o>)</span>
</span></span><span class=line><span class=cl>            main_review_task <span class=s2>&#34;</span><span class=nv>$VM_FORMAT_FILE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>;;</span>
</span></span><span class=line><span class=cl>        run<span class=o>)</span>
</span></span><span class=line><span class=cl>            main_vm_task <span class=s2>&#34;</span><span class=nv>$VM_FORMAT_FILE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>;;</span>
</span></span><span class=line><span class=cl>        *<span class=o>)</span>
</span></span><span class=line><span class=cl>            log ERROR <span class=s2>&#34;Usage: </span><span class=nv>$0</span><span class=s2> {init|build &lt;src&gt;|review|run}&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>;;</span>
</span></span><span class=line><span class=cl>    <span class=k>esac</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>main <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://gnail89.github.io/tags/openstack/>OpenStack</a></li></ul><nav class=paginav><a class=prev href=https://gnail89.github.io/posts/start-hugo/><span class=title>« Prev</span><br><span>Start</span>
</a><a class=next href=https://gnail89.github.io/posts/openstack_build_case/><span class=title>Next »</span><br><span>OpenStack build case</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://gnail89.github.io/>📕W.'s Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>