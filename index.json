[{"content":"1. æ¦‚è¿° æ— æ„é—´å‘ç°äº†Hugoï¼Œå°è¯•åå‘ç°æ•ˆæœä¸é”™ï¼ŒåŒæ—¶æŠŠè¿‡ç¨‹è®°å½•ä¸‹æ¥ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆï¼š\nHugo v0.106 hugo-PaperMod v6.0 Github Pages Github Actions 2. å®ç°è¿‡ç¨‹ Hugo Hugoæ˜¯ç”±Goè¯­è¨€å®ç°çš„é™æ€ç½‘ç«™ç”Ÿæˆå™¨ã€‚ç®€å•ã€æ˜“ç”¨ã€é«˜æ•ˆã€æ˜“æ‰©å±•ã€å¿«é€Ÿéƒ¨ç½²ã€‚Hugoè·å–æºæ–‡ä»¶å’Œæ¨¡æ¿ï¼Œå¹¶å°†å®ƒä»¬ä½œä¸ºè¾“å…¥æ¥åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„htmlç½‘ç«™ã€‚\näºŒè¿›åˆ¶å®‰è£…Hugo åˆ° Hugo Releases ä¸‹è½½å¯¹åº”çš„æ“ä½œç³»ç»Ÿç‰ˆæœ¬çš„HugoäºŒè¿›åˆ¶æ–‡ä»¶ã€‚\nç”Ÿæˆç«™ç‚¹ ä½¿ç”¨Hugoå¿«é€Ÿç”Ÿæˆç«™ç‚¹ï¼Œåˆå§‹æ–‡ä»¶éƒ½ç”Ÿæˆåœ¨ç›®å½•é‡Œ/path/to/siteï¼Œé…ç½®æ–‡ä»¶æ ¼å¼ä¸ºyamlã€‚\nhugo new site /path/to/site --format yaml è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶å¤¹å†…å®¹å¦‚ä¸‹ï¼š\n. â”œâ”€â”€ archetypes â”‚ â””â”€â”€ default.md â”œâ”€â”€ config.yaml â”œâ”€â”€ content â”œâ”€â”€ data â”œâ”€â”€ layouts â”œâ”€â”€ static â””â”€â”€ themes åˆ‡æ¢åˆ°ç«™ç‚¹ç›®å½•\ncd /path/to/site åˆ›å»ºç¬¬ä¸€ç¯‡æ–‡ç«  postsæ–‡ä»¶å¤¹ä¼šè‡ªåŠ¨åˆ›å»º\nhugo new posts/about.md è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶åˆ°è·¯å¾„ä¸‹content/posts/about.mdï¼Œæ–‡ä»¶åˆå§‹å†…å®¹ä¸ºï¼š\n--- date: 2022-11-19T23:51:58+08:00 draft: false title: \u0026#34;about\u0026#34; --- # åœ¨æ–‡æœ«è¾“å…¥æ­£æ–‡å†…å®¹ï¼Œä»¥markdownæ ¼å¼ å®‰è£…ä¸»é¢˜ åˆ°å®˜ç½‘Hugo Themesé€‰æ‹©å¿ƒä»ªçš„ä¸»é¢˜ã€‚æ¯”å¦‚PaperModï¼Œæ‰¾åˆ°PaperMod Releasesä¸‹è½½æºç åŒ…ã€‚è§£å‹åˆ°themesç›®å½•ä¸‹ã€‚\ncd themes wget https://github.com/adityatelange/hugo-PaperMod/archive/v6.0.zip unzip v6.0.zip # å°†ä¸»é¢˜æ–‡ä»¶å¤¹é‡å‘½åä¸ºPaperMod ls PaperMod å¯ç”¨ä¸»é¢˜ ä¿®æ”¹é…ç½®æ–‡ä»¶config.yaml\nbaseURL: \u0026#34;https://gnail89.github.io\u0026#34; # ç«™ç‚¹URL languageCode: \u0026#34;en-us\u0026#34; # è¯­è¨€ title: \u0026#34;ğŸ“•W.\u0026#39;s Blog\u0026#34; # ç«™ç‚¹åç§° theme: \u0026#34;PaperMod\u0026#34; # ä¸»é¢˜åï¼Œä¸themesç›®å½•ä¸‹å¯¹åº” paginate: 5 # æ¯é¡µæ˜¾ç¤ºæ–‡ç« æ•°é‡ è¿è¡ŒHugo åœ¨ç«™ç‚¹æ ¹ç›®å½•ä¸‹æ‰§è¡ŒHugoå‘½ä»¤è¿›è¡Œè°ƒè¯•ã€‚\nhugo server -D åœ¨æµè§ˆå™¨é‡Œæ‰“å¼€é¢„è§ˆï¼šhttp://localhost:1313\néƒ¨ç½² ç”Ÿæˆé™æ€é¡µé¢ï¼Œç„¶åå°±å¯ä»¥éƒ¨ç½²åˆ°GitHub Pagesï¼Œåœ¨ç«™ç‚¹æ ¹ç›®å½•ä¸‹æ‰§è¡Œã€‚\n# (å¯é€‰)æ¸…ç©ºpublicç›®å½•ä¸‹çš„æ—§æ–‡ä»¶ï¼Œå…¨éƒ¨é‡æ–°ç”Ÿæˆã€‚ hugo -F --cleanDestinationDir hugo æ‰§è¡Œå®Œæˆåï¼Œä¼šåœ¨publicç›®å½•ä¸‹ç”Ÿæˆé™æ€ç«™ç‚¹æ–‡ä»¶ï¼Œå…¨éƒ¨å¤åˆ¶åˆ°æœåŠ¡å™¨å³å¯ã€‚\nPaperModä¸»é¢˜è®¾ç½® é…ç½®æ–‡ä»¶config.yamlç¤ºä¾‹å‚è€ƒPaperModé…ç½®ç¤ºä¾‹ã€‚\nHugo ä¸»é¢˜é…ç½®å‚æ•°å¤§åŒå°å¼‚ï¼ŒæŒ‰å–œå¥½é…ç½®å³å¯ã€‚\nbaseURL: \u0026#34;https://gnail89.github.io\u0026#34; languageCode: \u0026#34;en-us\u0026#34; title: \u0026#34;ğŸ“•W.\u0026#39;s Blog\u0026#34; theme: \u0026#34;PaperMod\u0026#34; paginate: 5 enableInlineShortcodes: true enableRobotsTXT: true buildDrafts: false buildFuture: false buildExpired: false enableEmoji: true minify: disableXML: true # minifyOutput: true languages: en: languageName: \u0026#34;English\u0026#34; weight: 1 menu: main: - name: \u0026#34;Search\u0026#34; url: search/ weight: 10 - name: \u0026#34;Archive\u0026#34; url: archives/ weight: 20 - name: \u0026#34;Tags\u0026#34; url: tags/ weight: 30 - name: \u0026#34;Categories\u0026#34; url: categories/ weight: 40 outputs: home: - HTML - RSS - JSON params: env: production DateFormat: \u0026#34;2006-01-02\u0026#34; defaultTheme: auto disableThemeToggle: false ShowReadingTime: true ShowShareButtons: true ShowPostNavLinks: true ShowBreadCrumbs: true ShowCodeCopyButtons: true ShowWordCount: true ShowRssButtonInSectionTermList: true UseHugoToc: true disableSpecial1stPost: false disableScrollToTop: false comments: false hidemeta: false hideSummary: false showtoc: true tocopen: true # profile-mode profileMode: enabled: false title: \u0026#34;W.\u0026#39;s Blog\u0026#34; subtitle: \u0026#34;messages\u0026#34; imageUrl: \u0026#34;/images/logo.jpg\u0026#34; # imageWidth: 120 # imageHeight: 120 imageTitle: \u0026#34;image\u0026#34; buttons: - name: \u0026#34;Search\u0026#34; url: search - name: \u0026#34;Posts\u0026#34; url: posts - name: \u0026#34;Archive\u0026#34; url: archives # home-info mode homeInfoParams: Title: \u0026#34;W.\u0026#39;s Blog\u0026#34; Content: \u0026#34;messages\u0026#34; socialIcons: - name: github url: \u0026#34;https://github.com/\u0026#34; - name: email url: \u0026#34;mailto:user@localhost\u0026#34; - name: rss url: \u0026#34;index.xml\u0026#34; # cover: # hidden: true # hide everywhere but not in structured data # hiddenInList: true # hide on list pages and home # hiddenInSingle: true # hide on single page # for search # https://fusejs.io/api/options.html fuseOpts: isCaseSensitive: false shouldSort: true location: 0 distance: 1000 threshold: 0.4 minMatchCharLength: 0 keys: [\u0026#34;title\u0026#34;, \u0026#34;permalink\u0026#34;, \u0026#34;summary\u0026#34;, \u0026#34;content\u0026#34;] menu: main: - identifier: Search name: \u0026#34;Search\u0026#34; url: search/ weight: 10 - identifier: Archive name: \u0026#34;Archive\u0026#34; url: archives/ weight: 20 - identifier: Tags name: \u0026#34;Tags\u0026#34; url: tags/ weight: 30 - identifier: Categories name: \u0026#34;Categories\u0026#34; url: categories/ weight: 40 # Read: https://github.com/adityatelange/hugo-PaperMod/wiki/FAQs#using-hugos-syntax-highlighter-chroma pygmentsUseClasses: true markup: # goldmark: # renderer: # unsafe: true highlight: noClasses: false # anchorLineNos: true # codeFences: true # guessSyntax: true # lineNos: true # style: monokai Github Pages å¿…è¦çš„æ¡ä»¶ï¼š\ngithubè´¦æˆ· åˆ›å»ºGithub Pagesä»“åº“ æ–°å»ºä¸€ä¸ªpublicä»“åº“ï¼Œå¹¶å‘½åä¸ºusername.github.ioï¼Œå…¶ä¸­usernameæŒ‡githubè´¦æˆ·åã€‚\nGitHub Pages é¡¹ç›®éœ€è¦ç¬¦åˆ username.github.io çš„ç‰¹æ®Šå‘½åæ ¼å¼ï¼Œå¦‚æœä»“åº“åå’Œè´¦æˆ·åæ²¡æœ‰å®Œå…¨åŒ¹é…çš„è¯ï¼Œç½‘ç«™å°±ä¸èƒ½è¿è¡Œï¼Œæ‰€ä»¥ä¸€å®šè¦ä¿è¯å®Œå…¨åŒ¹é…ã€‚ Github Actions ä½¿ç”¨Github Actionsæ˜¯ä¸ºäº†å®ç°CI/CDï¼Œè‡ªåŠ¨å‘å¸ƒæ–‡ç« åˆ°ç½‘ç«™ï¼Œå¦‚æœå–œæ¬¢æ‰‹åŠ¨å‘å¸ƒé™æ€é¡µé¢çš„ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚\nå¿…è¦çš„æ¡ä»¶ å‡†å¤‡ä¸€ä¸ªå­˜æ”¾Hogoæºç çš„ç§æœ‰ä»“åº“ åˆ›å»ºå¥½çš„Github Pagesä»“åº“ ä¸»è¦æµç¨‹æ˜¯é…ç½®ç§æœ‰ä»“åº“çš„Github Actionså’Œtoken\né…ç½®ç§æœ‰ä»“åº“çš„Github Actions åœ¨Hugoåšå®¢æ ¹ç›®å½•ä¸‹ï¼Œåˆ›å»ºGithub Actionsé…ç½®æ–‡ä»¶åŠç›®å½•ï¼Œé…ç½®æ–‡ä»¶å‘½åä¸ºgh-pages.ymlï¼Œå®Œæ•´è·¯å¾„ä¸º.github/workflows/gh-pages.ymlï¼Œè¿™å°±æ˜¯Github Actionéœ€è¦çš„ä¸€ä¸ªå·¥ä½œæµçš„é…ç½®ï¼Œå¦‚æœéœ€è¦å¤šä¸ªå·¥ä½œæµå¯ä»¥åˆ›å»ºå¤šä¸ªymlæ–‡ä»¶ã€‚Hugoå®˜æ–¹æ–‡æ¡£Build Hugo With GitHub Actionæœ‰æä¾›é…ç½®æ–‡ä»¶ç¤ºä¾‹ï¼š\nname: github pages on: push: branches: - main # Set a branch that will trigger a deployment pull_request: jobs: deploy: runs-on: ubuntu-22.04 steps: - uses: actions/checkout@v3 with: submodules: true # Fetch Hugo themes (true OR recursive) fetch-depth: 0 # Fetch all history for .GitInfo and .Lastmod - name: Setup Hugo uses: peaceiris/actions-hugo@v2 with: hugo-version: \u0026#39;latest\u0026#39; # extended: true - name: Build run: hugo --minify - name: Deploy uses: peaceiris/actions-gh-pages@v3 if: github.ref == \u0026#39;refs/heads/main\u0026#39; with: github_token: ${{ secrets.GITHUB_TOKEN }} publish_dir: ./public æ•´ä¸ªå·¥ä½œæµåŒ…æ‹¬ä¸»è¦4ä¸ªæ­¥éª¤ï¼š\næ‹‰å–ä»£ç  å‡†å¤‡Hugoç¯å¢ƒ ç¼–è¯‘ç”Ÿæˆé™æ€æ–‡ä»¶ å°†é™æ€æ–‡ä»¶å‘å¸ƒå‡ºå» å¯¹äºä¸ªäººç«™ç‚¹è€Œè¨€ï¼Œç¤ºä¾‹é…ç½®æ–‡ä»¶å·²ç»è¶³å¤Ÿæ»¡è¶³éœ€æ±‚ï¼Œå…¶ä¸­éœ€è¦å°†tokenç±»å‹æ”¹ä¸ºpersonal_tokenã€‚\nç¤ºä¾‹ï¼š\nname: github pages on: push: branches: - main # Set a branch that will trigger a deployment pull_request: jobs: deploy: runs-on: ubuntu-22.04 steps: - uses: actions/checkout@v3 with: submodules: true # Fetch Hugo themes (true OR recursive) fetch-depth: 0 # Fetch all history for .GitInfo and .Lastmod - name: Setup Hugo uses: peaceiris/actions-hugo@v2 with: hugo-version: \u0026#39;latest\u0026#39; # extended: true - name: Build run: hugo --minify - name: Deploy uses: peaceiris/actions-gh-pages@v3 if: github.ref == \u0026#39;refs/heads/main\u0026#39; with: personal_token: ${{ secrets.PERSONAL_TOKEN }} # token name external_repository: username/username.github.io # å‘å¸ƒåˆ°Github Pagesä»“åº“ publish_branch: main # æŒ‡å®šåˆ†æ”¯ publish_dir: ./public # å°†publicç›®å½•å‘å¸ƒå‡ºå» é…ç½®token ç”Ÿæˆä¸€ä¸ªPersonal access tokens\nç™»å½•GitHubï¼Œè¿›å…¥Settings-\u0026gt;Developer settings-\u0026gt;Personal access tokensé¡µé¢ã€‚ ç‚¹å‡»Generate new tokenï¼Œåœ¨Noteä¸­è¾“å…¥åç§°ï¼Œåœ¨Select scopesé€‰æ‹©workflow å°†ç”Ÿæˆçš„tokenä¿å­˜ä¸‹æ¥ï¼Œç¦»å¼€é¡µé¢å°†æ— æ³•æŸ¥çœ‹ã€‚ è¿›å…¥éœ€è¦é…ç½®å·¥ä½œæµçš„ä»“åº“ï¼Œè¿›å…¥Settings-\u0026gt;Secrets-\u0026gt;Actionsé¡µé¢ï¼Œç‚¹å‡»New repository secretæŒ‰é’®ã€‚ åœ¨é¡µé¢ä¸­nameéƒ¨åˆ†è¾“å…¥åœ¨ymlä¸­è®¾ç½®çš„å€¼PERSONAL_TOKENï¼Œåœ¨Secretä¸­è¾“å…¥tokenå€¼ï¼Œç„¶åç‚¹å‡»Add secretæŒ‰é’®ã€‚ 3. æœ€ç»ˆæ•ˆæœ åœ¨æœ¬åœ°Hugoç«™ç‚¹æºç ç›®å½•é‡Œæ–°å¢/æ›´æ–°é¡µé¢ï¼Œæ–‡ä»¶æ ¼å¼ä¸ºmarkdownï¼Œæœ¬åœ°è°ƒè¯•å’Œé¢„è§ˆï¼šhugo server -Dã€‚ é€šè¿‡git pushå°†æºç æ¨é€åˆ°GitHubä»“åº“ã€‚ è§¦å‘GitHub Actionsï¼ŒæŒ‰ç…§workflowæµç¨‹è‡ªåŠ¨ç”Ÿæˆé™æ€æ–‡ä»¶ï¼Œç„¶åæ¨é€çš„GitHub Pagesä»“åº“ã€‚ GitHub Pagesä»“åº“æ›´æ–°åï¼Œè§¦å‘å®˜æ–¹é¡µé¢éƒ¨ç½²CIï¼Œæœ€ç»ˆå®ç°è‡ªåŠ¨å‘å¸ƒã€‚ ","permalink":"https://gnail89.github.io/posts/start-hugo/","summary":"1. æ¦‚è¿° æ— æ„é—´å‘ç°äº†Hugoï¼Œå°è¯•åå‘ç°æ•ˆæœä¸é”™ï¼ŒåŒæ—¶æŠŠè¿‡ç¨‹è®°å½•ä¸‹æ¥ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆï¼š\nHugo v0.106 hugo-PaperMod v6.0 Github Pages Github Actions 2. å®ç°è¿‡ç¨‹ Hugo Hugoæ˜¯ç”±Goè¯­è¨€å®ç°çš„é™æ€ç½‘ç«™ç”Ÿæˆå™¨ã€‚ç®€å•ã€æ˜“ç”¨ã€é«˜æ•ˆã€æ˜“æ‰©å±•ã€å¿«é€Ÿéƒ¨ç½²ã€‚Hugoè·å–æºæ–‡ä»¶å’Œæ¨¡æ¿ï¼Œå¹¶å°†å®ƒä»¬ä½œä¸ºè¾“å…¥æ¥åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„htmlç½‘ç«™ã€‚\näºŒè¿›åˆ¶å®‰è£…Hugo åˆ° Hugo Releases ä¸‹è½½å¯¹åº”çš„æ“ä½œç³»ç»Ÿç‰ˆæœ¬çš„HugoäºŒè¿›åˆ¶æ–‡ä»¶ã€‚\nç”Ÿæˆç«™ç‚¹ ä½¿ç”¨Hugoå¿«é€Ÿç”Ÿæˆç«™ç‚¹ï¼Œåˆå§‹æ–‡ä»¶éƒ½ç”Ÿæˆåœ¨ç›®å½•é‡Œ/path/to/siteï¼Œé…ç½®æ–‡ä»¶æ ¼å¼ä¸ºyamlã€‚\nhugo new site /path/to/site --format yaml è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶å¤¹å†…å®¹å¦‚ä¸‹ï¼š\n. â”œâ”€â”€ archetypes â”‚ â””â”€â”€ default.md â”œâ”€â”€ config.yaml â”œâ”€â”€ content â”œâ”€â”€ data â”œâ”€â”€ layouts â”œâ”€â”€ static â””â”€â”€ themes åˆ‡æ¢åˆ°ç«™ç‚¹ç›®å½•\ncd /path/to/site åˆ›å»ºç¬¬ä¸€ç¯‡æ–‡ç«  postsæ–‡ä»¶å¤¹ä¼šè‡ªåŠ¨åˆ›å»º\nhugo new posts/about.md è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶åˆ°è·¯å¾„ä¸‹content/posts/about.mdï¼Œæ–‡ä»¶åˆå§‹å†…å®¹ä¸ºï¼š\n--- date: 2022-11-19T23:51:58+08:00 draft: false title: \u0026#34;about\u0026#34; --- # åœ¨æ–‡æœ«è¾“å…¥æ­£æ–‡å†…å®¹ï¼Œä»¥markdownæ ¼å¼ å®‰è£…ä¸»é¢˜ åˆ°å®˜ç½‘Hugo Themesé€‰æ‹©å¿ƒä»ªçš„ä¸»é¢˜ã€‚æ¯”å¦‚PaperModï¼Œæ‰¾åˆ°PaperMod Releasesä¸‹è½½æºç åŒ…ã€‚è§£å‹åˆ°themesç›®å½•ä¸‹ã€‚","title":"Start"},{"content":"AIå†™çš„SQLè¡¨ç»“æ„ CREATE TABLE vms ( id INT NOT NULL AUTO_INCREMENT, location VARCHAR(255) NOT NULL, vm_uuid VARCHAR(36) NOT NULL, vm_name VARCHAR(255) NOT NULL, vm_state VARCHAR(255) DEFAULT NULL, power_state VARCHAR(36) DEFAULT NULL, vm_nets VARCHAR(255) DEFAULT NULL, flavor_name VARCHAR(255) DEFAULT NULL, flavor_id VARCHAR(36) DEFAULT NULL, availability_zone VARCHAR(255) DEFAULT NULL, vm_host VARCHAR(255) DEFAULT NULL, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, deleted_at TIMESTAMP DEFAULT NULL, is_deleted BOOLEAN DEFAULT FALSE, PRIMARY KEY (id) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci; CREATE TABLE vms_archive ( id INT NOT NULL, location VARCHAR(255) NOT NULL, vm_uuid VARCHAR(36) NOT NULL, vm_name VARCHAR(255) NOT NULL, vm_state VARCHAR(255) DEFAULT NULL, power_state VARCHAR(36) DEFAULT NULL, vm_nets VARCHAR(255) DEFAULT NULL, flavor_name VARCHAR(255) DEFAULT NULL, flavor_id VARCHAR(36) DEFAULT NULL, availability_zone VARCHAR(255) DEFAULT NULL, vm_host VARCHAR(255) DEFAULT NULL, created_at TIMESTAMP NOT NULL, updated_at TIMESTAMP NOT NULL, deleted_at TIMESTAMP DEFAULT NULL, is_deleted BOOLEAN DEFAULT FALSE, archive_batch TIMESTAMP NOT NULL, PRIMARY KEY (id, archive_batch), INDEX idx_vm_uuid (vm_uuid), INDEX idx_archive_batch (archive_batch), INDEX idx_vm_uuid_batch (vm_uuid, archive_batch), INDEX idx_active_time_batch (vm_state, archive_batch, vm_uuid) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci; AIå†™çš„SQLæŸ¥è¯¢ #æŸ¥è¯¢æŒ‡å®šæ‰¹æ¬¡çš„å·®å¼‚ã€‚ SELECT cur.vm_uuid, cur.vm_name, cur.vm_state AS current_state, cur.archive_batch AS current_batch, prev.vm_state AS previous_state, prev.archive_batch AS previous_batch FROM vms_archive cur JOIN vms_archive prev ON cur.vm_uuid = prev.vm_uuid AND prev.archive_batch = \u0026#39;2025-06-30 00:00:00\u0026#39; AND prev.is_deleted = 0 WHERE cur.archive_batch = \u0026#39;2025-07-01 00:00:00\u0026#39; AND cur.is_deleted = 0 AND cur.vm_state != \u0026#39;ACTIVE\u0026#39; AND prev.vm_state = \u0026#39;ACTIVE\u0026#39;; # ç»Ÿè®¡ SELECT archive_batch, COUNT(vm_uuid) AS \u0026#39;ä¸»æœºACTIVEç›‘æ§\u0026#39; FROM vms_archive WHERE vm_state = \u0026#39;ACTIVE\u0026#39; AND archive_batch \u0026gt;= NOW() - INTERVAL 12 HOUR GROUP BY archive_batch ORDER BY archive_batch; AIå†™çš„shellè„šæœ¬ #!/bin/bash # é…ç½®MySQLè¿æ¥å‚æ•° MYSQL_HOST=\u0026#34;\u0026#34; MYSQL_PORT=\u0026#34;\u0026#34; MYSQL_USER=\u0026#34;\u0026#34; MYSQL_PASSWORD=\u0026#34;\u0026#34; MYSQL_DATABASE=\u0026#34;\u0026#34; MYSQL_CMD=\u0026#34;/usr/bin/mysql\u0026#34; # ç”Ÿæˆå½“å‰æ‰¹æ¬¡å·ï¼ˆUnixæ—¶é—´æˆ³æ ¼å¼ï¼‰ ARCHIVE_BATCH=$(date +%s) ### é˜¶æ®µ1ï¼šæ•°æ®å½’æ¡£ ### ARCHIVE_SQL=$(cat \u0026lt;\u0026lt;SQL -- è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«ç¡®ä¿ä¸€è‡´æ€§ SET TRANSACTION ISOLATION LEVEL REPEATABLE READ; START TRANSACTION; -- æ‰§è¡Œæ•°æ®å½’æ¡£ INSERT INTO vms_archive ( id, location, vm_uuid, vm_name, vm_state, power_state, vm_nets, flavor_name, flavor_id, availability_zone, vm_host, created_at, updated_at, deleted_at, is_deleted, archive_batch ) SELECT id, location, vm_uuid, vm_name, vm_state, power_state, vm_nets, flavor_name, flavor_id, availability_zone, vm_host, created_at, updated_at, deleted_at, is_deleted, FROM_UNIXTIME(${ARCHIVE_BATCH}) FROM vms WHERE is_deleted = 0; COMMIT; SQL ) # æ‰§è¡Œå½’æ¡£ echo \u0026#34;${ARCHIVE_SQL}\u0026#34; | $MYSQL_CMD -h \u0026#34;$MYSQL_HOST\u0026#34; -P \u0026#34;$MYSQL_PORT\u0026#34; \\ -u \u0026#34;$MYSQL_USER\u0026#34; -p\u0026#34;$MYSQL_PASSWORD\u0026#34; -D \u0026#34;$MYSQL_DATABASE\u0026#34; --ssl-mode=DISABLED \u0026gt; /dev/null 2\u0026gt;\u0026amp;1 # æ£€æŸ¥å½’æ¡£ç»“æœ if [ $? -ne 0 ]; then echo \u0026#34;[$(date +\u0026#39;%F %T\u0026#39;)] é”™è¯¯: æ•°æ®å½’æ¡£å¤±è´¥!\u0026#34; \u0026gt;\u0026amp;2 exit 1 fi ### é˜¶æ®µ2ï¼šæ¸…ç†å†å²æ•°æ® ### CLEANUP_SQL=$(cat \u0026lt;\u0026lt;SQL -- å¼€å¯äº‹åŠ¡ç¡®ä¿åŸå­æ€§ START TRANSACTION; -- åˆ é™¤12å°æ—¶å‰çš„å½’æ¡£æ‰¹æ¬¡ DELETE FROM vms_archive WHERE archive_batch \u0026lt; NOW() - INTERVAL 12 HOUR; -- è·å–åˆ é™¤è¡Œæ•° SELECT ROW_COUNT() AS deleted_rows; COMMIT; SQL ) # æ‰§è¡Œæ¸…ç†æ“ä½œå¹¶æ•è·ç»“æœ CLEANUP_RESULT=$(echo \u0026#34;${CLEANUP_SQL}\u0026#34; | $MYSQL_CMD -h \u0026#34;$MYSQL_HOST\u0026#34; -P \u0026#34;$MYSQL_PORT\u0026#34; \\ -u \u0026#34;$MYSQL_USER\u0026#34; -p\u0026#34;$MYSQL_PASSWORD\u0026#34; -D \u0026#34;$MYSQL_DATABASE\u0026#34; --ssl-mode=DISABLED -s -N 2\u0026gt;/dev/null) # æ£€æŸ¥æ¸…ç†ç»“æœ if [ $? -eq 0 ]; then DELETED_ROWS=$(echo \u0026#34;$CLEANUP_RESULT\u0026#34; | awk \u0026#39;NR==1{print $1}\u0026#39;) echo \u0026#34;[$(date +\u0026#39;%F %T\u0026#39;)] å½’æ¡£æˆåŠŸ! æ‰¹æ¬¡: $ARCHIVE_BATCH, æ¸…ç†è®°å½•: $DELETED_ROWS è¡Œ\u0026#34; else echo \u0026#34;[$(date +\u0026#39;%F %T\u0026#39;)] è­¦å‘Š: å½’æ¡£æˆåŠŸä½†æ¸…ç†å¤±è´¥! æ‰¹æ¬¡: $ARCHIVE_BATCH\u0026#34; \u0026gt;\u0026amp;2 fi ","permalink":"https://gnail89.github.io/posts/vm_state_shell_ai/","summary":"AIå†™çš„SQLè¡¨ç»“æ„ CREATE TABLE vms ( id INT NOT NULL AUTO_INCREMENT, location VARCHAR(255) NOT NULL, vm_uuid VARCHAR(36) NOT NULL, vm_name VARCHAR(255) NOT NULL, vm_state VARCHAR(255) DEFAULT NULL, power_state VARCHAR(36) DEFAULT NULL, vm_nets VARCHAR(255) DEFAULT NULL, flavor_name VARCHAR(255) DEFAULT NULL, flavor_id VARCHAR(36) DEFAULT NULL, availability_zone VARCHAR(255) DEFAULT NULL, vm_host VARCHAR(255) DEFAULT NULL, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, deleted_at TIMESTAMP DEFAULT NULL, is_deleted BOOLEAN DEFAULT FALSE, PRIMARY KEY (id) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci; CREATE TABLE vms_archive ( id INT NOT NULL, location VARCHAR(255) NOT NULL, vm_uuid VARCHAR(36) NOT NULL, vm_name VARCHAR(255) NOT NULL, vm_state VARCHAR(255) DEFAULT NULL, power_state VARCHAR(36) DEFAULT NULL, vm_nets VARCHAR(255) DEFAULT NULL, flavor_name VARCHAR(255) DEFAULT NULL, flavor_id VARCHAR(36) DEFAULT NULL, availability_zone VARCHAR(255) DEFAULT NULL, vm_host VARCHAR(255) DEFAULT NULL, created_at TIMESTAMP NOT NULL, updated_at TIMESTAMP NOT NULL, deleted_at TIMESTAMP DEFAULT NULL, is_deleted BOOLEAN DEFAULT FALSE, archive_batch TIMESTAMP NOT NULL, PRIMARY KEY (id, archive_batch), INDEX idx_vm_uuid (vm_uuid), INDEX idx_archive_batch (archive_batch), INDEX idx_vm_uuid_batch (vm_uuid, archive_batch), INDEX idx_active_time_batch (vm_state, archive_batch, vm_uuid) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci; AIå†™çš„SQLæŸ¥è¯¢ #æŸ¥è¯¢æŒ‡å®šæ‰¹æ¬¡çš„å·®å¼‚ã€‚ SELECT cur.","title":"AIå†™shellè„šæœ¬"},{"content":"docker-compose # install the Docker Compose standalone curl -SL https://github.com/docker/compose/releases/download/v2.33.1/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose chmod +x /usr/local/bin/docker-compose docker-ce repoç¤ºä¾‹ # docker-ce/é˜¿é‡Œäº‘ dnf config-manager --add-repo=https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo docker åŠ é€Ÿ # ref: https://github.com/DaoCloud/public-image-mirror # æ·»åŠ åˆ° /etc/docker/daemon.json { \u0026#34;registry-mirrors\u0026#34;: [ \u0026#34;https://docker.m.daocloud.io\u0026#34; ], \u0026#34;ipv6\u0026#34;: false, \u0026#34;fixed-cidr\u0026#34;: \u0026#34;10.10.0.0/24\u0026#34;, \u0026#34;bip\u0026#34;: \u0026#34;10.10.0.1/24\u0026#34;, \u0026#34;log-driver\u0026#34;: \u0026#34;json-file\u0026#34;, \u0026#34;log-opts\u0026#34;: { \u0026#34;max-size\u0026#34;: \u0026#34;100m\u0026#34;, \u0026#34;max-file\u0026#34;: \u0026#34;3\u0026#34; } } epel repoç¤ºä¾‹ # epel(RHEL 8) yum install -y https://mirrors.aliyun.com/epel/epel-release-latest-8.noarch.rpm sed -i \u0026#39;s|^#baseurl=https://download.example/pub|baseurl=https://mirrors.aliyun.com|\u0026#39; /etc/yum.repos.d/epel* sed -i \u0026#39;s|^metalink|#metalink|\u0026#39; /etc/yum.repos.d/epel* # epel(RHEL 7) wget -O /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo # epel(RHEL 6) wget -O /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-archive-6.repo Centos 7 repoç¤ºä¾‹ [base] name=CentOS-7 - Base - Aliyun baseurl=http://mirrors.aliyun.com/centos/7/os/$basearch/ gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7 enabled=1 [updates] name=CentOS-7 - Updates - Aliyun baseurl=http://mirrors.aliyun.com/centos/7/updates/$basearch/ gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7 enabled=1 [extras] name=CentOS-7 - Extras - Aliyun baseurl=http://mirrors.aliyun.com/centos/7/extras/$basearch/ gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7 enabled=1 Centos 6 repoç¤ºä¾‹ [base] name=CentOS-6 - Base - Aliyun baseurl=https://mirrors.aliyun.com/centos-vault/6.10/os/$basearch/ gpgcheck=1 gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-6 enabled=1 [updates] name=CentOS-6 - Updates - Aliyun baseurl=https://mirrors.aliyun.com/centos-vault/6.10/updates/$basearch/ gpgcheck=1 gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-6 enabled=1 [extras] name=CentOS-6 - Extras - Aliyun baseurl=https://mirrors.aliyun.com/centos-vault/6.10/extras/$basearch/ gpgcheck=1 gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-6 enabled=1 ","permalink":"https://gnail89.github.io/posts/setup_repo/","summary":"docker-compose # install the Docker Compose standalone curl -SL https://github.com/docker/compose/releases/download/v2.33.1/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose chmod +x /usr/local/bin/docker-compose docker-ce repoç¤ºä¾‹ # docker-ce/é˜¿é‡Œäº‘ dnf config-manager --add-repo=https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo docker åŠ é€Ÿ # ref: https://github.com/DaoCloud/public-image-mirror # æ·»åŠ åˆ° /etc/docker/daemon.json { \u0026#34;registry-mirrors\u0026#34;: [ \u0026#34;https://docker.m.daocloud.io\u0026#34; ], \u0026#34;ipv6\u0026#34;: false, \u0026#34;fixed-cidr\u0026#34;: \u0026#34;10.10.0.0/24\u0026#34;, \u0026#34;bip\u0026#34;: \u0026#34;10.10.0.1/24\u0026#34;, \u0026#34;log-driver\u0026#34;: \u0026#34;json-file\u0026#34;, \u0026#34;log-opts\u0026#34;: { \u0026#34;max-size\u0026#34;: \u0026#34;100m\u0026#34;, \u0026#34;max-file\u0026#34;: \u0026#34;3\u0026#34; } } epel repoç¤ºä¾‹ # epel(RHEL 8) yum install -y https://mirrors.aliyun.com/epel/epel-release-latest-8.noarch.rpm sed -i \u0026#39;s|^#baseurl=https://download.example/pub|baseurl=https://mirrors.aliyun.com|\u0026#39; /etc/yum.repos.d/epel* sed -i \u0026#39;s|^metalink|#metalink|\u0026#39; /etc/yum.repos.d/epel* # epel(RHEL 7) wget -O /etc/yum.","title":"å¸¸ç”¨è½¯ä»¶æºrepo"},{"content":"rsyncå‡çº§ç®€è¦æ­¥éª¤ ç¼–è¯‘ç¯å¢ƒ: redhat 6.5 x86_64 # å®‰è£…ä¾èµ–åŒ… yum install gcc gcc-c++ make automake acl libacl-devel popt-devel # é…ç½®ï¼Œå»é™¤éƒ¨åˆ†ç‰¹æ€§ ./configure --prefix=/opt/rsync \\ --disable-openssl \\ --disable-xxhash \\ --disable-zstd \\ --disable-lz4 # ç¼–è¯‘ make \u0026amp;\u0026amp; make install # å°†ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶éƒ¨ç½²åˆ°æŒ‡å®šè·¯å¾„ä¸‹è¿›è¡Œæµ‹è¯•: /usr/bin/rsync ","permalink":"https://gnail89.github.io/posts/rsync_notes/","summary":"rsyncå‡çº§ç®€è¦æ­¥éª¤ ç¼–è¯‘ç¯å¢ƒ: redhat 6.5 x86_64 # å®‰è£…ä¾èµ–åŒ… yum install gcc gcc-c++ make automake acl libacl-devel popt-devel # é…ç½®ï¼Œå»é™¤éƒ¨åˆ†ç‰¹æ€§ ./configure --prefix=/opt/rsync \\ --disable-openssl \\ --disable-xxhash \\ --disable-zstd \\ --disable-lz4 # ç¼–è¯‘ make \u0026amp;\u0026amp; make install # å°†ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶éƒ¨ç½²åˆ°æŒ‡å®šè·¯å¾„ä¸‹è¿›è¡Œæµ‹è¯•: /usr/bin/rsync ","title":"rsyncå‡çº§ç®€è¦æ­¥éª¤"},{"content":"OpenStack example # å°†imageé•œåƒè®¾ç½®ä¸ºvgaæ˜¾ç¤ºé©±åŠ¨ï¼Œä»¥æ”¯æŒæ›´å¤§åˆ†è¾¨ç‡ openstack image set --property hw_video_model=vga image_id # å°†volumeå·è®¾ç½®ä¸ºvgaæ˜¾ç¤ºé©±åŠ¨ï¼Œä»¥æ”¯æŒæ›´å¤§åˆ†è¾¨ç‡ï¼ˆå·²æœ‰è™šæ‹Ÿæœºéœ€è¦é‡å»ºï¼‰ openstack volume set --image-property hw_video_model=vga volume_id ","permalink":"https://gnail89.github.io/posts/openstack_notes/","summary":"OpenStack example # å°†imageé•œåƒè®¾ç½®ä¸ºvgaæ˜¾ç¤ºé©±åŠ¨ï¼Œä»¥æ”¯æŒæ›´å¤§åˆ†è¾¨ç‡ openstack image set --property hw_video_model=vga image_id # å°†volumeå·è®¾ç½®ä¸ºvgaæ˜¾ç¤ºé©±åŠ¨ï¼Œä»¥æ”¯æŒæ›´å¤§åˆ†è¾¨ç‡ï¼ˆå·²æœ‰è™šæ‹Ÿæœºéœ€è¦é‡å»ºï¼‰ openstack volume set --image-property hw_video_model=vga volume_id ","title":"OpenStack_notes"},{"content":"ICMP Timestamp Request Remote Date Disclosure Synopsis It is possible to determine the exact time set on the remote host.\nDescription The remote host answers to an ICMP timestamp request. This allows an attacker to know the date that is set on the targeted machine, which may assist an unauthenticated, remote attacker in defeating time-based authentication protocols.\nTimestamps returned from machines running Windows Vista / 7 / 2008 / 2008 R2 are deliberately incorrect, but usually within 1000 seconds of the actual system time.\nSolution Filter out the ICMP timestamp requests (13), and the outgoing ICMP timestamp replies (14).\n# Block ICMP Timestamp requests (type 13) with iptables: iptables -I INPUT -p icmp --icmp-type timestamp-request -j DROP # Block ICMP Timestamp reply (type 14) with iptables: iptables -I OUTPUT -p icmp --icmp-type timestamp-reply -j DROP # firewalld firewall-cmd --zone=public --add-icmp-block={timestamp-request,timestamp-reply} --permanent firewall-cmd --reload References CVE-1999-0524\n","permalink":"https://gnail89.github.io/posts/cve-1999-0524/","summary":"ICMP Timestamp Request Remote Date Disclosure Synopsis It is possible to determine the exact time set on the remote host.\nDescription The remote host answers to an ICMP timestamp request. This allows an attacker to know the date that is set on the targeted machine, which may assist an unauthenticated, remote attacker in defeating time-based authentication protocols.\nTimestamps returned from machines running Windows Vista / 7 / 2008 / 2008 R2 are deliberately incorrect, but usually within 1000 seconds of the actual system time.","title":"CVE-1999-0524"},{"content":"å¼€æºé¡¹ç›®åœ°å€: https://github.com/thu-pacman/AIPerf\nåŸºç¡€ç¯å¢ƒ SSHå…å¯† ssh-keygen -t rsa ssh-copy-id -i ~/.ssh/id_rsa.pub server-ip éƒ¨ç½²NFS å®‰è£…è½¯ä»¶åŒ… yum install -y nfs-utils é…ç½®æœåŠ¡ç«¯ mkdir /userhome chmod -R 777 /userhome echo \u0026#34;/userhome *(rw,sync,insecure,no_root_squash)\u0026#34; \u0026gt;\u0026gt; /etc/exports # å¯åŠ¨æœåŠ¡ systemctl enable --now nfs-server systemctl status nfs-server é…ç½®å®¢æˆ·ç«¯ mkdir /userhome mount server-ip:/userhome /userhome å‡†å¤‡æ•°æ®é›† æ•°æ®é›†ä¸‹è½½ Imagenetå®˜æ–¹åœ°å€ï¼šhttp://www.image-net.org/index ä½¿ç”¨ImageNet-2012æ•°æ®é›† cd /userhome/AIPerf/scripts/build_data ./download_imagenet.sh ls ./imagenet åŸå§‹çš„ImageNet-2012åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶: ILSVRC2012_img_val.tar ILSVRC2012_img_train.tar TFReordåˆ¶ä½œ è®­ç»ƒé›†å’ŒéªŒè¯é›†éœ€è¦æŒ‰ç…§1000ä¸ªå­ç›®å½•ä¸‹åŒ…å«å›¾ç‰‡çš„æ ¼å¼ï¼Œå¤„ç†æ­¥éª¤ï¼š å°†train å’Œ val çš„æ•°æ®æŒ‰ç…§æ–‡ä»¶å¤¹åˆ†ç±» æŒ‡å®šå‚æ•°è¿è¡Œbuild_imagenet_data.py # åšéªŒè¯é›† cd /userhome/AIPerf/scripts/build_data mkdir -p ILSVRC2012/raw-data/imagenet-data/validation/ tar -xvf imagenet/ILSVRC2012_img_val.tar -C ILSVRC2012/raw-data/imagenet-data/validation/ python preprocess_imagenet_validation_data.py ILSVRC2012/raw-data/imagenet-data/validation/ imagenet_2012_validation_synset_labels.txt # åšè®­ç»ƒé›† mkdir -p ILSVRC2012/raw-data/imagenet-data/train/ tar -xvf imagenet/ILSVRC2012_img_train.tar -C ILSVRC2012/raw-data/imagenet-data/train/ \u0026amp;\u0026amp; cd ILSVRC2012/raw-data/imagenet-data/train find . -name \u0026#34;*.tar\u0026#34; | while read NAE ; do mkdir -p \u0026#34;${NAE%.tar}\u0026#34;; tar -xvf \u0026#34;${NAE}\u0026#34; -C \u0026#34;${NAE%.tar}\u0026#34;; rm -f \u0026#34;${NAE}\u0026#34;; done cd /userhome/AIPerf/scripts/build_data # TensorFlowéœ€è¦åˆ¶ä½œTFRecord mkdir -p ILSVRC2012/output python build_imagenet_data.py \\ --train_directory=ILSVRC2012/raw-data/imagenet-data/train \\ --validation_directory=ILSVRC2012/raw-data/imagenet-data/validation \\ --output_directory=ILSVRC2012/output \\ --imagenet_metadata_file=imagenet_metadata.txt \\ --labels_file=imagenet_lsvrc_2015_synsets.txt # åœ¨ILSVRC2012/outputç›®å½•ä¸‹ç”Ÿæˆ128ä¸ªvalidationå¼€å¤´çš„éªŒè¯é›†æ–‡ä»¶å’Œ1024ä¸ªtrainå¼€å¤´çš„è®­ç»ƒé›†æ–‡ä»¶ã€‚ åˆ†å‘æ•°æ®é›† å¯¹TensorFlowï¼Œå°†éªŒè¯é›†å’Œæ•°æ®é›†ç§»åŠ¨åˆ°slaveèŠ‚ç‚¹ã€‚ mkdir -p /root/datasets/imagenet/train mkdir -p /root/datasets/imagenet/val mv ILSVRC2012/output/train-* /root/datasets/imagenet/train mv ILSVRC2012/output/validation-* /root/datasets/imagenet/val å¯¹å…¶ä»–æ¨¡å‹ï¼Œå°†è§£å‹åéªŒè¯é›†å’Œæ•°æ®é›†ç§»åŠ¨åˆ°slaveèŠ‚ç‚¹ï¼Œæ ¹æ®æ¡†æ¶è‡ªè¡Œè°ƒæ•´ã€‚ # å¯¹PyTorch mkdir -p /root/datasets/imagenet/ mv ILSVRC2012/train /root/datasets/imagenet mv ILSVRC2012/val /root/datasets/imagenet é¡¹ç›®å®‰è£… ç¯å¢ƒå˜é‡å£°æ˜ export AIPERF_WORKDIR=/userhome export AIPERF_SLAVE_WORKDIR=/root/ export AIPERF_MASTER_IP=10.0.1.100 export AIPERF_MASTER_PORT=9987 * AIPERF_WORKDIR AIPerfå·¥ä½œç›®å½•ï¼Œå¿…é¡»åœ¨å…±äº«å­˜å‚¨ä¸Šï¼Œèƒ½è¢«æ‰€æœ‰èŠ‚ç‚¹è®¿é—®åˆ° AIPerfä»£ç ï¼Œéƒ¨åˆ†logæ–‡ä»¶ç­‰å°†ä¼šè¢«æ”¾åˆ°è¿™ä¸ªç›®å½• * AIPERF_SLAVE_WORKDIR è®¡ç®—èŠ‚ç‚¹å·¥ä½œç›®å½•ï¼Œä¸éœ€è¦åœ¨å…±äº«å­˜å‚¨ä¸Šï¼ˆä¹Ÿå¯ä»¥æ”¾åœ¨å…±äº«å­˜å‚¨ï¼‰ éƒ¨åˆ†è®¡ç®—èŠ‚ç‚¹logæ–‡ä»¶å°†ä¼šè¢«ç”Ÿæˆåˆ°è¿™ä¸ªç›®å½•ä¸‹ * AIPERF_MASTER_IP AIPerfè°ƒåº¦æœåŠ¡IPï¼Œå³æ§åˆ¶èŠ‚ç‚¹IP * AIPERF_MASTER_PORT AIPerfè°ƒåº¦æœåŠ¡ç«¯å£ ä¸‹è½½æºä»£ç  # åœ¨å…±äº«å­˜å‚¨ä¸Šåˆ›å»ºAIPerfå·¥ä½œç›®å½• mkdir -p $AIPERF_WORKDIR # ä¸‹è½½æºä»£ç  git clone https://github.com/thu-pacman/AIPerf.git $AIPERF_WORKDIR/AIPerf AIPerfç›®å½•ä¸‹aiperf_setenv.shè„šæœ¬è®¾ç½®ç¯å¢ƒå˜é‡ã€‚ source $AIPERF_WORKDIR/AIPerf/aiperf_setenv.sh å®‰è£…ä¾èµ–åŒ… å®‰è£…Python wget https://www.python.org/ftp/python/3.8.20/python-3.9.20.tgz tar -zxvf python-3.9.20.tgz # å®‰è£…ä¾èµ–åŒ… yum install -y gcc gcc-c++ make openssl-devel bzip2-devel libffi-devel # ç¼–è¯‘å®‰è£… cd python-3.9.20 ./configure --prefix=/usr/local/python3 \\ --with-ensurepip=install \\ --enable-optimizations make \u0026amp;\u0026amp; make install # è®¾ç½®ç¯å¢ƒå˜é‡ # ln -s /usr/local/python3/bin/python3.9 /usr/bin/python3 echo \u0026#39;export PATH=/usr/local/python3/bin:$PATH\u0026#39; \u0026gt;\u0026gt; ~/.bash_profile source ~/.bash_profile # å‡çº§pipå’Œsetuptools # ä¸´æ—¶é•œåƒæº: https://mirrors.tuna.tsinghua.edu.cn/help/pypi/ python3 -m pip install --upgrade pip -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple python3 -m pip install --upgrade setuptools -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple æ§åˆ¶èŠ‚ç‚¹ # python3 -m pip install -r $AIPERF_WORKDIR/AIPerf/requirements_master.txt python3 -m pip install scikit-learn pyyaml django schema colorama ruamel.yaml matplotlib jinja2 zmq torch==1.8.0 hyperopt==0.1.2 json_tricks \u0026#34;numpy\u0026lt;2.0\u0026#34; scipy coverage psutil è®¡ç®—èŠ‚ç‚¹ # python3 -m pip install -r $AIPERF_WORKDIR/AIPerf/requirements_slave.txt # æ ¹æ®CUDAå’ŒcuDNNç‰ˆæœ¬é€‰æ‹©è®¡ç®—æ¡†æ¶ç‰ˆæœ¬ï¼Œä¾‹å¦‚å¯¹äºCUDA 11.2ï¼ŒcuDNN 8.1ï¼Œå¯é€‰æ‹©tensorflow 2.5.0 # python3 -m pip install tensorflow==2.5.0 python3 -m pip install zmq scikit-learn psutil dill hyperopt==0.1.2 json_tricks \u0026#34;numpy\u0026lt;2.0\u0026#34; scipy coverage tensorflow==2.5.0 torch==1.8.0 # sample install nvidia driver wget https://us.download.nvidia.com/tesla/460.106.00/NVIDIA-Linux-x86_64-460.106.00.run sh NVIDIA-Linux-x86_64-460.106.00.run # CUDA Toolkit 11.2 # https://developer.nvidia.com/cuda-11.2.0-download-archive wget https://developer.download.nvidia.com/compute/cuda/11.2.0/local_installers/cuda_11.2.0_460.27.04_linux.run sh cuda_11.2.0_460.27.04_linux.run # environment variables export PATH=/usr/local/cuda/bin${PATH:+:${PATH}} export LD_LIBRARY_PATH=/usr/local/cuda/lib64${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}} # cuDNN 8.1 # https://developer.nvidia.com/rdp/cudnn-archive # https://developer.nvidia.com/compute/machine-learning/cudnn/secure/8.1.0.77/11.2_20210127/cudnn-11.2-linux-x64-v8.1.0.77.tgz wget https://developer.download.nvidia.com/compute/redist/cudnn/v8.1.0/cudnn-11.2-linux-x64-v8.1.0.77.tgz tar -zvxf cudnn-11.2-linux-x64-v8.1.0.77.tgz cp -P cuda/include/cudnn.h /usr/local/cuda/include cp -P cuda/lib64/libcudnn* /usr/local/cuda/lib64/ chmod a+r /usr/local/cuda/include/cudnn.h #check cuda nvidia-smi #check cudnn nvcc -V å®‰è£…AIPerf æ§åˆ¶èŠ‚ç‚¹ # å®‰è£…AutoMLç»„ä»¶ cd $AIPERF_WORKDIR/AIPerf/src/sdk/pynni/ python3 -m pip install -e . # å®‰è£…aiperfæ§åˆ¶ç»„ä»¶ cd $AIPERF_WORKDIR/AIPerf/src/aiperf_manager/ python3 -m pip install -e . aiperf --help è®¡ç®—èŠ‚ç‚¹ # å®‰è£…AutoMLç»„ä»¶ cd $AIPERF_WORKDIR/AIPerf/src/sdk/pynni/ python3 -m pip install -e . ä¸‹è½½æ¨¡å‹æƒé‡ å°†æƒé‡æ–‡ä»¶resnet50_weights_tf_dim_ordering_tf_kernels.h5ä¸‹è½½å¹¶æ”¾åˆ°$AIPERF_WORKDIRä¸‹ # ç™¾åº¦äº‘ç›˜ https://pan.baidu.com/s/1JBOh2XwetZAalLdmULBN2Q æå–ç : 5nbc mv resnet50_weights_tf_dim_ordering_tf_kernels.h5 $AIPERF_WORKDIR (md5sum: a7b3fe01876f51b976af0dea6bc144eb) å¯åŠ¨æµ‹è¯•(æ§åˆ¶èŠ‚ç‚¹) å¯åŠ¨è°ƒåº¦æœåŠ¡ é…ç½®è®¡ç®—èŠ‚ç‚¹ä¿¡æ¯ ${AIPERF_WORKDIR}/AIPerf/aiperf_ctrl/servers.json # ä¾‹å¦‚ï¼Œé›†ç¾¤æœ‰2ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹æœ‰4å¼ GPUï¼Œåˆ™é…ç½®å¦‚ä¸‹ï¼š [ { \u0026#34;ip\u0026#34;: \u0026#34;172.23.33.33\u0026#34;, \u0026#34;tag\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;status\u0026#34;: \u0026#34;waiting\u0026#34;, \u0026#34;CUDA_VISIBLE_DEVICES\u0026#34;: \u0026#34;0,1,2,3\u0026#34; }, { \u0026#34;ip\u0026#34;: \u0026#34;172.23.33.34\u0026#34;, \u0026#34;tag\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;status\u0026#34;: \u0026#34;waiting\u0026#34;, \u0026#34;CUDA_VISIBLE_DEVICES\u0026#34;: \u0026#34;0,1,2,3\u0026#34; } ] å¯åŠ¨å‘½ä»¤ cd $AIPERF_WORKDIR/AIPerf/aiperf_ctrl python3 manage.py runserver ${AIPERF_MASTER_IP}:${AIPERF_MASTER_PORT} å¯åŠ¨AIPerfæµ‹è¯• æµ‹è¯•åŸºæœ¬æ¡ä»¶ï¼š\n1.æµ‹è¯•è¿è¡Œæ—¶é—´åº”ä¸å°‘äº1å°æ—¶ï¼›\n2.æµ‹è¯•çš„è®¡ç®—ç²¾åº¦ä¸ä½äºFP-16ï¼›\n3.æµ‹è¯•å®Œæˆæ—¶æ‰€å–å¾—çš„æœ€é«˜æ­£ç¡®ç‡åº”å¤§äº70%ï¼›\nåˆå§‹åŒ–é…ç½® ${AIPERF_WORKDIR}/AIPerf/examples/trials/network_morphism/imagenet/config.yml\nå…³é”®å‚æ•°è§£é‡Š:\nå¯é€‰å‚æ•° è¯´æ˜ é»˜è®¤å€¼ 1 trialConcurrency åŒæ—¶è¿è¡Œçš„trialæ•° 1 2 maxExecDuration è®¾ç½®æµ‹è¯•æ—¶é—´(å•ä½ ï¼šh) 12 3 CUDA_VISIBLE_DEVICES æŒ‡å®šæµ‹è¯•ç¨‹åºå¯ç”¨çš„gpuç´¢å¼• 0,1,2,3,4,5,6,7 4 srunï¼š\u0026ndash;cpus-per-task=30 å‚æ•°ä¸ºslurmå¯ç”¨cpuæ ¸æ•°å‡ 1 30 5 \u0026ndash;slave è·Ÿ trialConcurrencyå‚æ•°ä¿æŒä¸€è‡´ 1 6 \u0026ndash;ip masterèŠ‚ç‚¹ipï¼Œç›´æ¥ä½¿ç”¨é»˜è®¤å€¼ ${AIPERF_MASTER_IP} 7 \u0026ndash;batch_size batch size 448 8 \u0026ndash;epochs æ­£å¸¸è®­ç»ƒepochæ•° 60 9 \u0026ndash;initial_lr åˆå§‹å­¦ä¹ ç‡ 1e-1 10 \u0026ndash;final_lr æœ€ç»ˆå­¦ä¹ ç‡ 0 11 \u0026ndash;train_data_dir è®­ç»ƒæ•°æ®é›†è·¯å¾„ None 12 \u0026ndash;val_data_dir éªŒè¯æ•°æ®é›†è·¯å¾„ None 13 \u0026ndash;warmup_1 warm upæœºåˆ¶ç¬¬ä¸€è½®epochæ•° 15 14 \u0026ndash;warmup_2 warm upæœºåˆ¶ç¬¬äºŒè½®epochæ•° 30 15 \u0026ndash;warmup_3 warm upæœºåˆ¶ç¬¬ä¸‰è½®epochæ•° 45 16 \u0026ndash;num_parallel_calls tfrecordæ•°æ®åŠ è½½åŠ é€Ÿ 48 # ç¤ºä¾‹ authorName: default experimentName: example_imagenet-network-morphism-test trialConcurrency: 2 maxExecDuration: 24h maxTrialNum: 9999 trainingServicePlatform: local useAnnotation: false logLevel: trace tuner: #choice: TPE, Random, Anneal, Evolution, BatchTuner, NetworkMorphism #SMAC (SMAC should be installed through nnictl) builtinTunerName: NetworkMorphism classArgs: #choice: maximize, minimize optimize_mode: maximize #for now, this tuner only supports cv domain task: cv #input image width input_width: 224 #input image channel input_channel: 3 #number of classes n_output_node: 1000 trial: command: CUDA_VISIBLE_DEVICES=0 \\ python3 imagenet_train.py \\ --slave 2 \\ --ip ${AIPERF_MASTER_IP} \\ --batch_size 448 \\ --epoch 60 \\ --initial_lr 1e-1 \\ --final_lr 0 \\ --train_data_dir /root/datasets/imagenet/train \\ --val_data_dir /root/datasets/imagenet/val codeDir: . gpuNum: 0 # æ³¨æ„é…ç½®æ–‡ä»¶ä¸­slaveå‚æ•°éœ€è¦å’ŒtrialConcurrencyå‚æ•°ä¸€è‡´ï¼Œä¿®æ”¹ä¸ºè®¡ç®—èŠ‚ç‚¹ä¸ªæ•° # ä¿®æ”¹CUDA_VISIBLE_DEVICESä¸ºè®¡ç®—èŠ‚ç‚¹æ‰€ç”¨çš„GPU # éœ€è¦ä¿®æ”¹--train_data_dirå’Œ--var_data_dirçš„ä½ç½®ä»¥æŒ‡å‘è®¡ç®—èŠ‚ç‚¹æ•°æ®é›†å­˜å‚¨ä½ç½® è¿è¡Œbenchmark\nåœ¨${AIPERF_WORKDIR}/AIPerf/examples/trials/network_morphism/imagenet/ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿è¡Œç”¨ä¾‹\næ³¨ï¼šè‹¥ä½¿ç”¨pyTorchï¼Œè¯·åœ¨ ${AIPERF_WORKDIR}/AIPerf/examples/trials/network_morphism/imagenetTorch/ä¸‹æ‰§è¡Œ\n# å¯åŠ¨ aiperf create -c config.yml # åœæ­¢,ctrl-cç»ˆæ­¢ # æ¸…ç†æ‰€æœ‰è®¡ç®—èŠ‚ç‚¹ä¸Šçš„è®­ç»ƒè¿›ç¨‹ aiperf clean æŸ¥çœ‹çŠ¶æ€\nå½“æµ‹è¯•è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œè¿è¡Œä»¥ä¸‹ç¨‹åºä¼šåœ¨ç»ˆç«¯æ‰“å°experimentçš„Errorã€Scoreã€Regulated Scoreç­‰ä¿¡æ¯\npython3 $AIPERF_WORKDIR/AIPerf/scripts/reports/report.py --id experiment_ID åŒæ—¶ä¼šäº§ç”Ÿå®éªŒæŠ¥å‘Šå­˜æ”¾åœ¨experiment_IDçš„å¯¹åº”è·¯å¾„${AIPERF_WORKDIR}/mountdir/nni/experiments/experiment_ID/resultsç›®å½•ä¸‹ã€‚\nå®éªŒæˆåŠŸæ—¶æŠ¥å‘Šä¸º Report_Succeed.htmlã€‚\nå®éªŒå¤±è´¥æ—¶æŠ¥å‘Šä¸º Report_Failed.htmlã€‚\nå®éªŒå¤±è´¥ä¼šæŠ¥å‘Šå¤±è´¥åŸå› ï¼Œè¯·æŸ¥é˜…AI Benchmarkæµ‹è¯•è§„èŒƒåˆ†æå¤±è´¥åŸå› ã€‚ ä¿å­˜æ—¥å¿—\u0026amp;ç»“æœæ•°æ® è¿è¡Œä»¥ä¸‹ç¨‹åºå¯å°†æµ‹è¯•äº§ç”Ÿçš„æ—¥å¿—ä»¥åŠæ•°æ®ç»Ÿä¸€ä¿å­˜åˆ°${AIPERF_WORKDIR}/mountdir/nni/experiments/experiment_ID/results/logsä¸­ï¼Œä¾¿äºå®éªŒåˆ†æã€‚ ç”±äºå®éªŒæ•°æ®åœ¨å¤åˆ¶è¿‡ç¨‹ä¸­ä¼šå¯¼è‡´é¢å¤–çš„ç½‘ç»œã€å†…å­˜ã€cpuç­‰èµ„æºå¼€é”€ï¼Œå»ºè®®åœ¨å®éªŒåœæ­¢/ç»“æŸåå†æ‰§è¡Œæ—¥å¿—ä¿å­˜æ“ä½œã€‚ python3 $AIPERF_WORKDIR/AIPerf/scripts/reports/report.py --id experiment_ID --logs True æµ‹è¯•å‚æ•°è®¾ç½®åŠæ¨èç¯å¢ƒé…ç½®(å®˜æ–¹) å¯å˜è®¾ç½® slaveè®¡ç®—èŠ‚ç‚¹çš„GPUå¡æ•°ï¼šé»˜è®¤å°†å•ä¸ªç‰©ç†æœåŠ¡å™¨ä½œä¸ºä¸€ä¸ªslaveèŠ‚ç‚¹ï¼Œå¹¶ä½¿ç”¨å…¶æ‰€æœ‰GPUï¼› æ·±åº¦å­¦ä¹ æ¡†æ¶ï¼šé»˜è®¤ä½¿ç”¨keras+tensorflowï¼› æ•°æ®é›†åŠ è½½æ–¹å¼ï¼šé»˜è®¤å°†æ•°æ®é¢„å¤„ç†æˆTFRecordæ ¼å¼ï¼Œä»¥åŠ å¿«æ•°æ®åŠ è½½çš„æ•ˆç‡ï¼› æ•°æ®é›†å­˜å‚¨æ–¹å¼ï¼šé»˜è®¤é‡‡ç”¨ç½‘ç»œå…±äº«å­˜å‚¨ï¼› è¶…å‚è®¾ç½®ï¼šé»˜è®¤åˆå§‹batch size=448ï¼Œé»˜è®¤åˆå§‹å­¦ä¹ ç‡=0.1ï¼Œé»˜è®¤æœ€ç»ˆå­¦ä¹ ç‡=0ï¼Œé»˜è®¤æ­£å¸¸è®­ç»ƒepochs=60ï¼Œé»˜è®¤ä»ç¬¬å››è½®trialå¼€å§‹ï¼Œæ¯ä¸ªtrialæœç´¢1æ¬¡ï¼Œé»˜è®¤è¶…å‚ä¸ºkernel sizeå’Œbatch sizeã€‚ æ¨èç¯å¢ƒé…ç½®\nè½¯ä»¶ï¼šTensorFlow2.5.0ï¼ŒCUDA11.2ï¼ŒcuDNN8.1ï¼Œpython3.8\n","permalink":"https://gnail89.github.io/posts/aiperf-setup/","summary":"å¼€æºé¡¹ç›®åœ°å€: https://github.com/thu-pacman/AIPerf\nåŸºç¡€ç¯å¢ƒ SSHå…å¯† ssh-keygen -t rsa ssh-copy-id -i ~/.ssh/id_rsa.pub server-ip éƒ¨ç½²NFS å®‰è£…è½¯ä»¶åŒ… yum install -y nfs-utils é…ç½®æœåŠ¡ç«¯ mkdir /userhome chmod -R 777 /userhome echo \u0026#34;/userhome *(rw,sync,insecure,no_root_squash)\u0026#34; \u0026gt;\u0026gt; /etc/exports # å¯åŠ¨æœåŠ¡ systemctl enable --now nfs-server systemctl status nfs-server é…ç½®å®¢æˆ·ç«¯ mkdir /userhome mount server-ip:/userhome /userhome å‡†å¤‡æ•°æ®é›† æ•°æ®é›†ä¸‹è½½ Imagenetå®˜æ–¹åœ°å€ï¼šhttp://www.image-net.org/index ä½¿ç”¨ImageNet-2012æ•°æ®é›† cd /userhome/AIPerf/scripts/build_data ./download_imagenet.sh ls ./imagenet åŸå§‹çš„ImageNet-2012åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶: ILSVRC2012_img_val.tar ILSVRC2012_img_train.tar TFReordåˆ¶ä½œ è®­ç»ƒé›†å’ŒéªŒè¯é›†éœ€è¦æŒ‰ç…§1000ä¸ªå­ç›®å½•ä¸‹åŒ…å«å›¾ç‰‡çš„æ ¼å¼ï¼Œå¤„ç†æ­¥éª¤ï¼š å°†train å’Œ val çš„æ•°æ®æŒ‰ç…§æ–‡ä»¶å¤¹åˆ†ç±» æŒ‡å®šå‚æ•°è¿è¡Œbuild_imagenet_data.py # åšéªŒè¯é›† cd /userhome/AIPerf/scripts/build_data mkdir -p ILSVRC2012/raw-data/imagenet-data/validation/ tar -xvf imagenet/ILSVRC2012_img_val.","title":"AIPerf åŸºå‡†æµ‹è¯•å·¥å…·å®‰è£…"},{"content":"","permalink":"https://gnail89.github.io/posts/kubectl-notes/","summary":"","title":"Kubectl notes"},{"content":"å®‰è£…æ­¥éª¤ ä¸‹è½½äºŒè¿›åˆ¶åŒ… # docker-ce 26.1.3 curl -O https://mirrors.ustc.edu.cn/docker-ce/linux/static/stable/x86_64/docker-26.1.3.tgz # cri-dockerd 0.3.10 curl -O https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.10/cri-dockerd-0.3.10.amd64.tgz éƒ¨ç½²docker-ce # è§£å‹ç¼© tar zxf docker-26.1.3.tgz # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶ cp docker/* /usr/bin/ é…ç½®containerd.serviceæ–‡ä»¶ cat \u0026gt;/etc/systemd/system/containerd.service \u0026lt;\u0026lt;EOF [Unit] Description=containerd container runtime Documentation=https://containerd.io After=network.target local-fs.target [Service] ExecStartPre=-/sbin/modprobe overlay ExecStart=/usr/bin/containerd Type=notify Delegate=yes KillMode=process Restart=always RestartSec=5 LimitNPROC=infinity LimitCORE=infinity LimitNOFILE=1048576 TasksMax=infinity OOMScoreAdjust=-999 [Install] WantedBy=multi-user.target EOF # è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable --now containerd.service é…ç½®docker.serviceæ–‡ä»¶ cat \u0026gt; /etc/systemd/system/docker.service \u0026lt;\u0026lt;EOF [Unit] Description=Docker Application Container Engine Documentation=https://docs.docker.com After=network-online.target firewalld.service cri-docker.service docker.socket containerd.service Wants=network-online.target Requires=docker.socket containerd.service [Service] Type=notify ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock ExecReload=/bin/kill -s HUP $MAINPID TimeoutSec=0 RestartSec=2 Restart=always StartLimitBurst=3 StartLimitInterval=60s LimitNOFILE=infinity LimitNPROC=infinity LimitCORE=infinity TasksMax=infinity Delegate=yes KillMode=process OOMScoreAdjust=-500 [Install] WantedBy=multi-user.target EOF é…ç½®docker.socketæ–‡ä»¶ cat \u0026gt; /etc/systemd/system/docker.socket \u0026lt;\u0026lt;EOF [Unit] Description=Docker Socket for the API [Socket] ListenStream=/var/run/docker.sock SocketMode=0660 SocketUser=root SocketGroup=docker [Install] WantedBy=sockets.target EOF é…ç½®dockerçš„daemon.jsonæ–‡ä»¶ mkdir /etc/docker/ cat \u0026gt;/etc/docker/daemon.json \u0026lt;\u0026lt;EOF { \u0026#34;exec-opts\u0026#34;: [\u0026#34;native.cgroupdriver=systemd\u0026#34;], \u0026#34;registry-mirrors\u0026#34;: [ \u0026#34;https://dockerproxy.com\u0026#34; ], \u0026#34;max-concurrent-downloads\u0026#34;: 10, \u0026#34;log-driver\u0026#34;: \u0026#34;json-file\u0026#34;, \u0026#34;log-level\u0026#34;: \u0026#34;warn\u0026#34;, \u0026#34;log-opts\u0026#34;: { \u0026#34;max-size\u0026#34;: \u0026#34;10m\u0026#34;, \u0026#34;max-file\u0026#34;: \u0026#34;3\u0026#34; }, \u0026#34;data-root\u0026#34;: \u0026#34;/data\u0026#34; } EOF # exec-opts: ç”¨äºè®¾ç½®Dockerå®ˆæŠ¤è¿›ç¨‹çš„é€‰é¡¹ï¼Œnative.cgroupdriver=systemdè¡¨ç¤ºä½¿ç”¨systemdä½œä¸ºCgroupé©±åŠ¨ç¨‹åºã€‚ # registry-mirrors: ç”¨äºæŒ‡å®šDockeré•œåƒçš„é•œåƒæ³¨å†ŒæœåŠ¡å™¨ã€‚ç¤ºä¾‹ï¼šhttps://docker.m.daocloud.ioã€https://docker.mirrors.ustc.edu.cnã€http://hub-mirror.c.163.com # max-concurrent-downloads: ç”¨äºè®¾ç½®åŒæ—¶ä¸‹è½½é•œåƒçš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤å€¼ä¸º3ï¼Œè¿™é‡Œè®¾ç½®ä¸º10ã€‚ # log-driver: ç”¨äºè®¾ç½®Dockerå®ˆæŠ¤è¿›ç¨‹çš„æ—¥å¿—é©±åŠ¨ç¨‹åºï¼Œè¿™é‡Œè®¾ç½®ä¸ºjson-fileã€‚ # log-level: ç”¨äºè®¾ç½®æ—¥å¿—çš„çº§åˆ«ï¼Œè¿™é‡Œè®¾ç½®ä¸ºwarnã€‚ # log-opts: ç”¨äºè®¾ç½®æ—¥å¿—é©±åŠ¨ç¨‹åºçš„é€‰é¡¹ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªé€‰é¡¹ï¼šmax-sizeå’Œmax-fileã€‚max-sizeè¡¨ç¤ºæ¯ä¸ªæ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å¤§å°ï¼Œè¿™é‡Œè®¾ç½®ä¸º10mï¼Œmax-fileè¡¨ç¤ºä¿å­˜çš„æœ€å¤§æ—¥å¿—æ–‡ä»¶æ•°é‡ï¼Œè¿™é‡Œè®¾ç½®ä¸º3ã€‚ # data-root: ç”¨äºè®¾ç½®Dockerå®ˆæŠ¤è¿›ç¨‹çš„æ•°æ®å­˜å‚¨æ ¹ç›®å½•ï¼Œé»˜è®¤ä¸º/var/lib/dockerï¼Œè¿™é‡Œè®¾ç½®ä¸º/dataã€‚ å¯åŠ¨docker # åˆ›å»ºdockerç»„ groupadd docker systemctl daemon-reload systemctl enable --now containerd.service systemctl enable --now docker.socket systemctl enable --now docker.service # éªŒè¯ docker info éƒ¨ç½²cri-dockerd ç”¨äºkubeletäº¤äº’ tar zxf cri-dockerd-0.3.10.amd64.tgz cp -r cri-dockerd/ /usr/bin/ chmod +x /usr/bin/cri-dockerd/cri-dockerd é…ç½®cri-docker.serviceæ–‡ä»¶ cat \u0026gt; /usr/lib/systemd/system/cri-docker.service \u0026lt;\u0026lt;EOF [Unit] Description=CRI Interface for Docker Application Container Engine Documentation=https://docs.mirantis.com After=network-online.target firewalld.service docker.service Wants=network-online.target Requires=cri-docker.socket [Service] Type=notify ExecStart=/usr/bin/cri-dockerd/cri-dockerd --network-plugin=cni --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.7 ExecReload=/bin/kill -s HUP $MAINPID TimeoutSec=0 RestartSec=2 Restart=always StartLimitBurst=3 StartLimitInterval=60s LimitNOFILE=infinity LimitNPROC=infinity LimitCORE=infinity TasksMax=infinity Delegate=yes KillMode=process [Install] WantedBy=multi-user.target EOF é…ç½®cri-docker.socketæ–‡ä»¶ cat \u0026gt; /usr/lib/systemd/system/cri-docker.socket \u0026lt;\u0026lt;EOF [Unit] Description=CRI Docker Socket for the API PartOf=cri-docker.service [Socket] ListenStream=%t/cri-dockerd.sock SocketMode=0660 SocketUser=root SocketGroup=docker [Install] WantedBy=sockets.target EOF å¯åŠ¨cri-docker systemctl daemon-reload systemctl enable --now cri-docker.service systemctl status cri-docker.service ","permalink":"https://gnail89.github.io/posts/docker-ce-static/","summary":"å®‰è£…æ­¥éª¤ ä¸‹è½½äºŒè¿›åˆ¶åŒ… # docker-ce 26.1.3 curl -O https://mirrors.ustc.edu.cn/docker-ce/linux/static/stable/x86_64/docker-26.1.3.tgz # cri-dockerd 0.3.10 curl -O https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.10/cri-dockerd-0.3.10.amd64.tgz éƒ¨ç½²docker-ce # è§£å‹ç¼© tar zxf docker-26.1.3.tgz # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶ cp docker/* /usr/bin/ é…ç½®containerd.serviceæ–‡ä»¶ cat \u0026gt;/etc/systemd/system/containerd.service \u0026lt;\u0026lt;EOF [Unit] Description=containerd container runtime Documentation=https://containerd.io After=network.target local-fs.target [Service] ExecStartPre=-/sbin/modprobe overlay ExecStart=/usr/bin/containerd Type=notify Delegate=yes KillMode=process Restart=always RestartSec=5 LimitNPROC=infinity LimitCORE=infinity LimitNOFILE=1048576 TasksMax=infinity OOMScoreAdjust=-999 [Install] WantedBy=multi-user.target EOF # è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable --now containerd.service é…ç½®docker.serviceæ–‡ä»¶ cat \u0026gt; /etc/systemd/system/docker.service \u0026lt;\u0026lt;EOF [Unit] Description=Docker Application Container Engine Documentation=https://docs.docker.com After=network-online.","title":"docker-ceäºŒè¿›åˆ¶å®‰è£…"},{"content":"Enable TLSv1.2 Registry Windows Registry Editor Version 5.00 [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.2] [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.2\\Server] \u0026#34;Enabled\u0026#34;=dword:00000001 \u0026#34;DisabledByDefault\u0026#34;=dword:00000000 [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.2\\Client] \u0026#34;Enabled\u0026#34;=dword:00000001 \u0026#34;DisabledByDefault\u0026#34;=dword:00000000 Powershell New-Item \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.2\\Server\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.2\\Server\u0026#39; -name \u0026#39;Enabled\u0026#39; -value \u0026#39;1\u0026#39; -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.2\\Server\u0026#39; -name \u0026#39;DisabledByDefault\u0026#39; -value 0 -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null New-Item \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.2\\Client\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.2\\Client\u0026#39; -name \u0026#39;Enabled\u0026#39; -value \u0026#39;1\u0026#39; -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.2\\Client\u0026#39; -name \u0026#39;DisabledByDefault\u0026#39; -value 0 -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null Disable TLS 1.0 Registry Windows Registry Editor Version 5.00 [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.0] [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.0\\Server] \u0026#34;Enabled\u0026#34;=dword:00000000 \u0026#34;DisabledByDefault\u0026#34;=dword:00000001 [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.0\\Client] \u0026#34;Enabled\u0026#34;=dword:00000000 \u0026#34;DisabledByDefault\u0026#34;=dword:00000001 Powershell New-Item \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.0\\Server\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.0\\Server\u0026#39; -name \u0026#39;Enabled\u0026#39; -value \u0026#39;0\u0026#39; -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.0\\Server\u0026#39; -name \u0026#39;DisabledByDefault\u0026#39; -value 1 -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null New-Item \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.0\\Client\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.0\\Client\u0026#39; -name \u0026#39;Enabled\u0026#39; -value \u0026#39;0\u0026#39; -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.0\\Client\u0026#39; -name \u0026#39;DisabledByDefault\u0026#39; -value 1 -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null Disable TLS 1.1 Registry Windows Registry Editor Version 5.00 [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1] [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Server] \u0026#34;Enabled\u0026#34;=dword:00000000 \u0026#34;DisabledByDefault\u0026#34;=dword:00000001 [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Client] \u0026#34;Enabled\u0026#34;=dword:00000000 \u0026#34;DisabledByDefault\u0026#34;=dword:00000001 Powershell New-Item \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Server\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Server\u0026#39; -name \u0026#39;Enabled\u0026#39; -value \u0026#39;0\u0026#39; -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Server\u0026#39; -name \u0026#39;DisabledByDefault\u0026#39; -value 1 -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null New-Item \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Client\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Client\u0026#39; -name \u0026#39;Enabled\u0026#39; -value \u0026#39;0\u0026#39; -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\Client\u0026#39; -name \u0026#39;DisabledByDefault\u0026#39; -value 1 -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null Disabe SSL v2.0 and SSL v3.0 Registry Windows Registry Editor Version 5.00 [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\SSL 2.0] [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\SSL 2.0\\Server] \u0026#34;Enabled\u0026#34;=dword:00000000 \u0026#34;DisabledByDefault\u0026#34;=dword:00000001 [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\SSL 2.0\\Client] \u0026#34;Enabled\u0026#34;=dword:00000000 \u0026#34;DisabledByDefault\u0026#34;=dword:00000001 [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\SSL 3.0] [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\SSL 3.0\\Server] \u0026#34;Enabled\u0026#34;=dword:00000000 \u0026#34;DisabledByDefault\u0026#34;=dword:00000001 [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\SSL 3.0\\Client] \u0026#34;Enabled\u0026#34;=dword:00000000 \u0026#34;DisabledByDefault\u0026#34;=dword:00000001 Powershell New-Item \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\SSL 2.0\\Server\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\SSL 2.0\\Server\u0026#39; -name \u0026#39;Enabled\u0026#39; -value \u0026#39;0\u0026#39; -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\SSL 2.0\\Server\u0026#39; -name \u0026#39;DisabledByDefault\u0026#39; -value 1 -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null New-Item \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\SSL 2.0\\Client\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\SSL 2.0\\Client\u0026#39; -name \u0026#39;Enabled\u0026#39; -value \u0026#39;0\u0026#39; -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\SSL 2.0\\Client\u0026#39; -name \u0026#39;DisabledByDefault\u0026#39; -value 1 -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null New-Item \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\SSL 3.0\\Server\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\SSL 3.0\\Server\u0026#39; -name \u0026#39;Enabled\u0026#39; -value \u0026#39;0\u0026#39; -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\SSL 3.0\\Server\u0026#39; -name \u0026#39;DisabledByDefault\u0026#39; -value 1 -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null New-Item \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\SSL 3.0\\Client\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\SSL 3.0\\Client\u0026#39; -name \u0026#39;Enabled\u0026#39; -value \u0026#39;0\u0026#39; -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\SSL 3.0\\Client\u0026#39; -name \u0026#39;DisabledByDefault\u0026#39; -value 1 -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null Disable Ciphers RC4 AND 3DES Registry Windows Registry Editor Version 5.00 [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Ciphers] [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Ciphers\\RC4 128/128] \u0026#34;Enabled\u0026#34;=dword:00000000 [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Ciphers\\RC4 40/128] \u0026#34;Enabled\u0026#34;=dword:00000000 [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Ciphers\\RC4 56/128] \u0026#34;Enabled\u0026#34;=dword:00000000 [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Ciphers\\RC4 64/128] \u0026#34;Enabled\u0026#34;=dword:00000000 [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Ciphers\\Triple DES 168] \u0026#34;Enabled\u0026#34;=dword:00000000 Cipher Suites in TLS/SSL https://learn.microsoft.com/en-us/windows/win32/secauthn/cipher-suites-in-schannel è¿è¡Œgpedit.mscï¼Œæ‰“å¼€â€œæœ¬åœ°ç»„ç­–ç•¥ç¼–è¾‘å™¨â€-â€œè®¡ç®—æœºé…ç½®â€-â€œç®¡ç†æ¨¡æ¿â€-â€œç½‘ç»œâ€-â€œSSLé…ç½®è®¾ç½®â€ï¼Œ åœ¨â€œSSLå¯†ç å¥—ä»¶é¡ºåºâ€é€‰é¡¹ä¸Šï¼Œå³é”®â€œç¼–è¾‘â€ã€‚ é€‰æ‹©â€œå·²å¯ç”¨â€ï¼Œåœ¨å³ä¾§è¯´æ˜é¡µä¸­æ‰¾åˆ°â€œTLS 1.2 SHA256 and SHA384 cipher suitesâ€å’Œâ€œTLS 1.2 ECC GCM cipher suitesâ€å¤åˆ¶ä¸‹é¢çš„é€‰é¡¹ï¼Œç„¶åä»¥é€—å·åˆ†éš”çš„å½¢å¼å½¢æˆä¸€æ•´ä¸²å­—ç¬¦ä¸²ï¼Œå¡«è‡³å·¦ä¾§è¾“å…¥æ¡†ä¸­ã€‚ ç¤ºä¾‹ï¼š TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256_P256,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256_P384,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256_P521,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384_P384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384_P521,TLS_RSA_WITH_AES_128_CBC_SHA256,TLS_RSA_WITH_AES_256_CBC_SHA256,TLS_RSA_WITH_AES_128_GCM_SHA256,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256_P256,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256_P384,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256_P521,TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384_P256,TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384_P384,TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384_P521,TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256_P256,TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256_P384,TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256_P521,TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384_P384,TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384_P521,TLS_DHE_DSS_WITH_AES_128_CBC_SHA256,TLS_DHE_DSS_WITH_AES_256_CBC_SHA256,TLS_DHE_RSA_WITH_AES_128_GCM_SHA256,TLS_DHE_RSA_WITH_AES_256_GCM_SHA384,TLS_DHE_RSA_WITH_AES_256_CBC_SHA ","permalink":"https://gnail89.github.io/posts/windows-security-for-ssl/","summary":"Enable TLSv1.2 Registry Windows Registry Editor Version 5.00 [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.2] [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.2\\Server] \u0026#34;Enabled\u0026#34;=dword:00000001 \u0026#34;DisabledByDefault\u0026#34;=dword:00000000 [HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.2\\Client] \u0026#34;Enabled\u0026#34;=dword:00000001 \u0026#34;DisabledByDefault\u0026#34;=dword:00000000 Powershell New-Item \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.2\\Server\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.2\\Server\u0026#39; -name \u0026#39;Enabled\u0026#39; -value \u0026#39;1\u0026#39; -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.2\\Server\u0026#39; -name \u0026#39;DisabledByDefault\u0026#39; -value 0 -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null New-Item \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.2\\Client\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.2\\Client\u0026#39; -name \u0026#39;Enabled\u0026#39; -value \u0026#39;1\u0026#39; -PropertyType \u0026#39;DWord\u0026#39; -Force | Out-Null New-ItemProperty -path \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.","title":"Windows Enable TLSv1.2 And Other Disable"},{"content":"NFS Serverç¬”è®° exportsé…ç½® # ro # åªè¯» # rw # è¯»å†™ # sync # åŒæ­¥å†™å…¥èµ„æ–™åˆ°å†…å­˜ä¸ç¡¬ç›˜ä¸­ # async # èµ„æ–™ä¼šå…ˆæš‚å­˜äºå†…å­˜ä¸­ï¼Œè€Œéç›´æ¥å†™å…¥ç¡¬ç›˜ # secure # NFSé€šè¿‡1024ä»¥ä¸‹çš„å®‰å…¨TCP/IPç«¯å£å‘é€ # insecure # NFSé€šè¿‡1024ä»¥ä¸Šçš„ç«¯å£å‘é€ # wdelay #å¦‚æœå¤šä¸ªç”¨æˆ·è¦å†™å…¥NFSç›®å½•ï¼Œåˆ™å½’ç»„å†™å…¥ï¼ˆé»˜è®¤ï¼‰ # no_wdelay # å¦‚æœå¤šä¸ªç”¨æˆ·è¦å†™å…¥NFSç›®å½•ï¼Œåˆ™ç«‹å³å†™å…¥ï¼Œå½“ä½¿ç”¨asyncæ—¶ï¼Œæ— éœ€æ­¤è®¾ç½®ã€‚ # hide # åœ¨NFSå…±äº«ç›®å½•ä¸­ä¸å…±äº«å…¶å­ç›®å½• # no_hide # å…±äº«NFSç›®å½•çš„å­ç›®å½• # subtree_check # å¦‚æœå…±äº«/usr/binä¹‹ç±»çš„å­ç›®å½•æ—¶ï¼Œå¼ºåˆ¶NFSæ£€æŸ¥çˆ¶ç›®å½•çš„æƒé™ # no_subtree_check # åŒä¸Šï¼Œä½†ä¸æ£€æŸ¥çˆ¶ç›®å½•æƒé™ # all_squash # å°†æ‰€æœ‰å…±äº«æ–‡ä»¶çš„UIDå’ŒGIDæ˜ å°„åŒ¿åç”¨æˆ·anonymousï¼Œé€‚åˆå…¬ç”¨ç›®å½•ã€‚ # no_all_squash # ä¿ç•™å…±äº«æ–‡ä»¶çš„UIDå’ŒGIDï¼ˆé»˜è®¤ï¼‰ # root_squash # rootç”¨æˆ·çš„æ‰€æœ‰è¯·æ±‚æ˜ å°„æˆå¦‚anonymousç”¨æˆ·ä¸€æ ·çš„æƒé™ï¼ˆé»˜è®¤ï¼‰ # no_root_squash # rootç”¨æˆ·å…·æœ‰æ ¹ç›®å½•çš„å®Œå…¨ç®¡ç†è®¿é—®æƒé™ # anonuid=xxx # æŒ‡å®šNFSæœåŠ¡å™¨/etc/passwdæ–‡ä»¶ä¸­åŒ¿åç”¨æˆ·çš„UID # anongid=xxx # æŒ‡å®šNFSæœåŠ¡å™¨/etc/passwdæ–‡ä»¶ä¸­åŒ¿åç”¨æˆ·çš„GID # cat /etc/exports /nfs 192.168.1.2(rw,async,no_root_squash) nfs.confé…ç½®æ–‡ä»¶ # åœ¨/etc/nfs.confä¸­é…ç½®threadsçº¿ç¨‹æ•°é‡ [nfsd] threads=64 # æ”¹ç«¯å£ RQUOTAD_PORT=30000 LOCKD_TCPPORT=30001 LOCKD_UDPPORT=30002 MOUNTD_PORT=30003 STATD_PORT=30004 å†…æ ¸å‚æ•°é…ç½® sysctl -w net.core.rmem_default=16777216 sysctl -w net.core.wmem_default=16777216 NFS Clientç¬”è®° æŒ‚è½½å‚æ•°ï¼š # _netdev # æŒ‚è½½æ—¶ç­‰å¾…ç½‘ç»œè®¾å¤‡å°±ç»ª # noatime # ç¦æ­¢atime # nodiratime # ç¦æ­¢diratime # vers=3 # ç‰ˆæœ¬v3 # noac # ç¦ç”¨cacheç¼“å­˜æœºåˆ¶ # rsize=8192 # è¯»ç¼“å­˜å¤§å° # wsize=8192 # å†™ç¼“å­˜å¤§å° # tcp # ä½¿ç”¨tcpåè®® #cat /etc/fstab 192.168.1.1:/nfs /nfs nfs _netdev,noatime,nodiratime,vers=3,noac,rsize=1048576,wsize=1048576 0 0 # mountæŒ‚è½½ mount -t nfs -o vers=3,proto=tcp,async,noatime,nodiratime,wsize=1048576,rsize=1048576,timeo=600 192.168.1.1:/nfs /nfs æŸ¥çœ‹çŠ¶æ€ rpcinfo -p # æŸ¥çœ‹rpcç«¯å£ä½¿ç”¨æƒ…å†µ exportfs -arv # åˆ·æ–°exports nfsstat -r # æŸ¥çœ‹nfsdçŠ¶æ€ nfsstat -s # æŸ¥çœ‹nfsdçŠ¶æ€ nfsstat -c # æŸ¥çœ‹clientçŠ¶æ€ cat /proc/net/rpc/nfsd # æŸ¥çœ‹clientçŠ¶æ€ ","permalink":"https://gnail89.github.io/posts/nfs-optimize/","summary":"NFS Serverç¬”è®° exportsé…ç½® # ro # åªè¯» # rw # è¯»å†™ # sync # åŒæ­¥å†™å…¥èµ„æ–™åˆ°å†…å­˜ä¸ç¡¬ç›˜ä¸­ # async # èµ„æ–™ä¼šå…ˆæš‚å­˜äºå†…å­˜ä¸­ï¼Œè€Œéç›´æ¥å†™å…¥ç¡¬ç›˜ # secure # NFSé€šè¿‡1024ä»¥ä¸‹çš„å®‰å…¨TCP/IPç«¯å£å‘é€ # insecure # NFSé€šè¿‡1024ä»¥ä¸Šçš„ç«¯å£å‘é€ # wdelay #å¦‚æœå¤šä¸ªç”¨æˆ·è¦å†™å…¥NFSç›®å½•ï¼Œåˆ™å½’ç»„å†™å…¥ï¼ˆé»˜è®¤ï¼‰ # no_wdelay # å¦‚æœå¤šä¸ªç”¨æˆ·è¦å†™å…¥NFSç›®å½•ï¼Œåˆ™ç«‹å³å†™å…¥ï¼Œå½“ä½¿ç”¨asyncæ—¶ï¼Œæ— éœ€æ­¤è®¾ç½®ã€‚ # hide # åœ¨NFSå…±äº«ç›®å½•ä¸­ä¸å…±äº«å…¶å­ç›®å½• # no_hide # å…±äº«NFSç›®å½•çš„å­ç›®å½• # subtree_check # å¦‚æœå…±äº«/usr/binä¹‹ç±»çš„å­ç›®å½•æ—¶ï¼Œå¼ºåˆ¶NFSæ£€æŸ¥çˆ¶ç›®å½•çš„æƒé™ # no_subtree_check # åŒä¸Šï¼Œä½†ä¸æ£€æŸ¥çˆ¶ç›®å½•æƒé™ # all_squash # å°†æ‰€æœ‰å…±äº«æ–‡ä»¶çš„UIDå’ŒGIDæ˜ å°„åŒ¿åç”¨æˆ·anonymousï¼Œé€‚åˆå…¬ç”¨ç›®å½•ã€‚ # no_all_squash # ä¿ç•™å…±äº«æ–‡ä»¶çš„UIDå’ŒGIDï¼ˆé»˜è®¤ï¼‰ # root_squash # rootç”¨æˆ·çš„æ‰€æœ‰è¯·æ±‚æ˜ å°„æˆå¦‚anonymousç”¨æˆ·ä¸€æ ·çš„æƒé™ï¼ˆé»˜è®¤ï¼‰ # no_root_squash # rootç”¨æˆ·å…·æœ‰æ ¹ç›®å½•çš„å®Œå…¨ç®¡ç†è®¿é—®æƒé™ # anonuid=xxx # æŒ‡å®šNFSæœåŠ¡å™¨/etc/passwdæ–‡ä»¶ä¸­åŒ¿åç”¨æˆ·çš„UID # anongid=xxx # æŒ‡å®šNFSæœåŠ¡å™¨/etc/passwdæ–‡ä»¶ä¸­åŒ¿åç”¨æˆ·çš„GID # cat /etc/exports /nfs 192.","title":"NFSç¬”è®°"},{"content":"ç¯å¢ƒå˜é‡ï¼š export AWS_ACCESS_KEY_ID= export AWS_SECRET_ACCESS_KEY= export AWS_DEFAULT_REGION= S3åŸºæœ¬æ“ä½œå‘½ä»¤ï¼š # å°†bucketä¸­ç‰¹å®šå‰ç¼€çš„å¯¹è±¡å…¨éƒ¨å¤åˆ¶åˆ°å¦ä¸€ä¸ªbucket aws s3 cp s3://bucket-name/example s3://my-bucket/ # å°†æœ¬åœ°æ–‡ä»¶å¤åˆ¶åˆ°s3å­˜å‚¨ä¸­ aws s3 cp filename.txt s3://bucket-name # å°†s3ä¸­çš„å¯¹è±¡å¤åˆ¶åˆ°æœ¬åœ°ç›®å½• aws s3 cp s3://bucket-name/filename.txt ./ #ä»¥æµå¼ä¼ è¾“åˆ°s3çš„å¯¹è±¡ echo \u0026#34;hello world\u0026#34; | aws s3 cp - s3://bucket-name/filename.txt # ä»¥æµå¼ä¼ è¾“stdoutæ‰“å°åœ¨æ§åˆ¶å°ä¸­ $ aws s3 cp s3://bucket-name/filename.txt - hello world # ä»¥æµå¼ä¼ è¾“å‹ç¼©å¯¹è±¡ aws s3 cp s3://bucket-name/pre - | bzip2 --best | aws s3 cp - s3://bucket-name/key.bz2 # bucketåˆ—è¡¨ aws s3 ls # bucketä¸­çš„å¯¹è±¡åˆ—è¡¨ aws s3 ls s3://bucket-name # bucketä¸­ç‰¹å®šå‰ç¼€çš„å¯¹è±¡åˆ—è¡¨ aws s3 ls s3://bucket-name/example/ # åˆ›å»ºbucket aws s3 mb s3://bucket-name # å°†exampleä¸­æ‰€æœ‰å¯¹è±¡ç§»åŠ¨åˆ°å¦ä¸€ä¸ªbucket aws s3://bucket-name/example s3://my-bucket/ # å°†æœ¬åœ°æ–‡ä»¶ç§»åŠ¨åˆ°s3 bucketä¸­ aws s3 mv filename.txt s3://bucket-name # å°†s3ä¸­çš„å¯¹è±¡ç§»åŠ¨åˆ°æœ¬åœ°ç›®å½• aws s3 mv s3://bucket-name/filename.txt ./ # åˆ é™¤bucketåŠå…¶å¯¹è±¡ aws s3 rb s3://bucket-name --force # åˆ é™¤bucketä¸­çš„å•ä¸ªå¯¹è±¡ aws s3 rm s3://bucket-name/example/filename.txt # åˆ é™¤bucketä¸­ç‰¹å®šå‰ç¼€çš„æ‰€æœ‰å¯¹è±¡ aws s3 rm s3://bucket-name/example --recursive # åŒæ­¥å½“å‰ç›®å½•ä¸­çš„æ–‡ä»¶åˆ°s3ç‰¹å®šå‰ç¼€çš„å†…å®¹ï¼ˆæ›´æ–°å’Œè¿½åŠ å†…å®¹ï¼‰ aws s3 sync . s3://my-bucket/path # å½“å‰ç›®å½•å·²åˆ é™¤çš„ä¸å­˜åœ¨æ–‡ä»¶ï¼Œåœ¨s3ä¸­åŒæ­¥åˆ é™¤ï¼ˆå¼ºä¸€è‡´æ€§ï¼‰ aws s3 sync . s3://my-bucket/path --delete ","permalink":"https://gnail89.github.io/posts/s3-awscli-basic/","summary":"ç¯å¢ƒå˜é‡ï¼š export AWS_ACCESS_KEY_ID= export AWS_SECRET_ACCESS_KEY= export AWS_DEFAULT_REGION= S3åŸºæœ¬æ“ä½œå‘½ä»¤ï¼š # å°†bucketä¸­ç‰¹å®šå‰ç¼€çš„å¯¹è±¡å…¨éƒ¨å¤åˆ¶åˆ°å¦ä¸€ä¸ªbucket aws s3 cp s3://bucket-name/example s3://my-bucket/ # å°†æœ¬åœ°æ–‡ä»¶å¤åˆ¶åˆ°s3å­˜å‚¨ä¸­ aws s3 cp filename.txt s3://bucket-name # å°†s3ä¸­çš„å¯¹è±¡å¤åˆ¶åˆ°æœ¬åœ°ç›®å½• aws s3 cp s3://bucket-name/filename.txt ./ #ä»¥æµå¼ä¼ è¾“åˆ°s3çš„å¯¹è±¡ echo \u0026#34;hello world\u0026#34; | aws s3 cp - s3://bucket-name/filename.txt # ä»¥æµå¼ä¼ è¾“stdoutæ‰“å°åœ¨æ§åˆ¶å°ä¸­ $ aws s3 cp s3://bucket-name/filename.txt - hello world # ä»¥æµå¼ä¼ è¾“å‹ç¼©å¯¹è±¡ aws s3 cp s3://bucket-name/pre - | bzip2 --best | aws s3 cp - s3://bucket-name/key.bz2 # bucketåˆ—è¡¨ aws s3 ls # bucketä¸­çš„å¯¹è±¡åˆ—è¡¨ aws s3 ls s3://bucket-name # bucketä¸­ç‰¹å®šå‰ç¼€çš„å¯¹è±¡åˆ—è¡¨ aws s3 ls s3://bucket-name/example/ # åˆ›å»ºbucket aws s3 mb s3://bucket-name # å°†exampleä¸­æ‰€æœ‰å¯¹è±¡ç§»åŠ¨åˆ°å¦ä¸€ä¸ªbucket aws s3://bucket-name/example s3://my-bucket/ # å°†æœ¬åœ°æ–‡ä»¶ç§»åŠ¨åˆ°s3 bucketä¸­ aws s3 mv filename.","title":"S3 awscli Basic"},{"content":"OpenStack client 3.12.2ç¦»çº¿å®‰è£… ä¸‹è½½pythonæºç åŒ…ï¼šhttps://www.python.org/ftp/python/3.8.18/Python-3.8.18.tgz\næŸ¥æ‰¾pipåŒ…ï¼šhttps://pypi.org/\nOpenStackå„ç‰ˆæœ¬releaseç‰ˆå·ï¼šhttps://releases.openstack.org/\nOpenStackå„ç»„ä»¶releaseç‰ˆå·ï¼šhttps://docs.openstack.org/releasenotes/\nç¼–è¯‘å®‰è£…python tar zxf Python-3.8.18.tgz ./configure --prefix=/opt/python make \u0026amp;\u0026amp; make install é€šè¿‡pipä¸‹è½½ç¦»çº¿å®‰è£…åŒ… åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ python3.8 -m venv /opt/env_cli3.12 source /opt/env_cli3.12/bin/activate #ï¼ˆé€€å‡ºè™šæ‹Ÿç¯å¢ƒä½¿ç”¨deactivateï¼‰ ä¸‹è½½å®‰è£…åŒ… /opt/python/bin/pip3 download \\ -d /opt/python-openstackclient-3.12.2 \\ --index https://mirrors.bfsu.edu.cn/pypi/web/simple/ \\ python-openstackclient==3.12.2 \\ python-novaclient==9.1.3 \\ python-keystoneclient==3.12.0 \\ python-glanceclient==2.8.1 \\ python-cinderclient==3.1.1 \\ openstacksdk==0.9.17 \\ keystoneauth1==3.1.1 \\ os-client-config==1.28.1 \\ osc-lib==1.7.1 \\ oslo.config==4.13.2 \\ oslo.i18n==3.23.1 \\ oslo.serialization==2.20.3 \\ oslo.utils==3.28.4 é€šè¿‡pipæ‰§è¡Œç¦»çº¿å®‰è£… cd /opt/python-openstackclient-3.12.2 /opt/python/bin/pip3 install --no-index -f . * ","permalink":"https://gnail89.github.io/posts/setup-openstackclient-3.12.2-by-pip/","summary":"OpenStack client 3.12.2ç¦»çº¿å®‰è£… ä¸‹è½½pythonæºç åŒ…ï¼šhttps://www.python.org/ftp/python/3.8.18/Python-3.8.18.tgz\næŸ¥æ‰¾pipåŒ…ï¼šhttps://pypi.org/\nOpenStackå„ç‰ˆæœ¬releaseç‰ˆå·ï¼šhttps://releases.openstack.org/\nOpenStackå„ç»„ä»¶releaseç‰ˆå·ï¼šhttps://docs.openstack.org/releasenotes/\nç¼–è¯‘å®‰è£…python tar zxf Python-3.8.18.tgz ./configure --prefix=/opt/python make \u0026amp;\u0026amp; make install é€šè¿‡pipä¸‹è½½ç¦»çº¿å®‰è£…åŒ… åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ python3.8 -m venv /opt/env_cli3.12 source /opt/env_cli3.12/bin/activate #ï¼ˆé€€å‡ºè™šæ‹Ÿç¯å¢ƒä½¿ç”¨deactivateï¼‰ ä¸‹è½½å®‰è£…åŒ… /opt/python/bin/pip3 download \\ -d /opt/python-openstackclient-3.12.2 \\ --index https://mirrors.bfsu.edu.cn/pypi/web/simple/ \\ python-openstackclient==3.12.2 \\ python-novaclient==9.1.3 \\ python-keystoneclient==3.12.0 \\ python-glanceclient==2.8.1 \\ python-cinderclient==3.1.1 \\ openstacksdk==0.9.17 \\ keystoneauth1==3.1.1 \\ os-client-config==1.28.1 \\ osc-lib==1.7.1 \\ oslo.config==4.13.2 \\ oslo.i18n==3.23.1 \\ oslo.serialization==2.20.3 \\ oslo.utils==3.28.4 é€šè¿‡pipæ‰§è¡Œç¦»çº¿å®‰è£… cd /opt/python-openstackclient-3.12.2 /opt/python/bin/pip3 install --no-index -f . * ","title":"Setup Openstackclient 3.12.2 by pip"},{"content":"è£¸é‡‘å±é•œåƒé…ç½® é•œåƒåˆ¶ä½œ type: whole disk image\nå‡†å¤‡ ç³»ç»Ÿé•œåƒISO\nUEFI å¼•å¯¼\nqemu-kvmç¯å¢ƒ\nå‘½åè§„èŒƒ åŒºåŸŸ-ç‰ˆæœ¬-æ¶æ„-å¯åŠ¨ç±»å‹-æ–‡ä»¶ç³»ç»Ÿ-é•œåƒå¤§å°: C01-AnolisOS-8.8-x86_64-UEFI-XFS-LVM-8G-IRONIC-yyymmdd.qcow2\nåˆ†åŒºè§„åˆ’å‚è€ƒ é•œåƒå¤§å°8GB, å¯æŒ‰éœ€æ±‚è¿›è¡Œåˆ†åŒº, åé¢é…åˆuserdataä½¿ç”¨\nFS VG LV SIZE /boot - - 1 GB /boot/efi - - 600 MB / rootvg root 1 GB /usr rootvg usr 4 GB /var rootvg var 1 GB /home rootvg home 1 GB è½¯ä»¶å®‰è£… cloud-init\nqemu-guest-agent (å¯é€‰)\ndnf install -y cloud-init qemu-guest-agent cloud-inité…ç½®æ–‡ä»¶æ›´æ–° # æ›´æ–°çš„å†…å®¹ no_ssh_fingerprints: true disable_root: false ssh_pwauth: true network: config: disabled datasource_list: [OpenStack, ConfigDrive] datasource: OpenStack: metadata_urls: [\u0026#39;http://169.254.169.254\u0026#39;] max_wait: 120 timeout: 5 # ç¤ºä¾‹ sed -i \u0026#39;/# from the distro configuration/a\\no_ssh_fingerprints: true\u0026#39; /etc/cloud/cloud.cfg sed -i \u0026#39;/disable_root: false/a\\ssh_pwauth: 1\u0026#39; /etc/cloud/cloud.cfg echo \u0026#39; network: config: disabled\u0026#39; \u0026gt;\u0026gt; /etc/cloud/cloud.cfg echo \u0026#34; datasource_list: [OpenStack, ConfigDrive] datasource: OpenStack: metadata_urls: [\u0026#39;http://169.254.169.254\u0026#39;] max_wait: 120 timeout: 5\u0026#34; \u0026gt;\u0026gt; /etc/cloud/cloud.cfg # å¼€æœºè‡ªå¯åŠ¨ systemctl enable cloud-init-local.service cloud-init.service cloud-config.service cloud-final.service æ·»åŠ raidé©±åŠ¨ cat \u0026gt; /etc/dracut.conf.d/raid_drives.conf \u0026lt;\u0026lt;EOF logfile=/var/log/dracut.log add_drivers+=\u0026#34; ahci megaraid_sas mpt3sas mpt2sas \u0026#34; EOF dracut -f -N UserDataæ¨¡æ¿ #!/bin/bash node_bond0_macs=\u0026#34;08:30:ce:06:2b:cc 08:30:ce:06:33:aa\u0026#34; node_bond0_mode=\u0026#34;mode=active-backup,miimon=100\u0026#34; node_bond0_ip=\u0026#34;192.168.1.1\u0026#34; node_bond0_prefix=\u0026#34;24\u0026#34; node_bond0_netmask=\u0026#34;255.255.255.0\u0026#34; node_bond0_gw=\u0026#34;192.168.1.1\u0026#34; create_rootvg_partition(){ # ä½¿ç”¨xfsæ–‡ä»¶ç³»ç»Ÿ os_rootvg=\u0026#34;$(lsblk -r |grep -w \u0026#34;/\u0026#34; |awk -F\u0026#39;-\u0026#39; \u0026#39;{print $1}\u0026#39;)\u0026#34; if [ x\u0026#34;${os_rootvg}\u0026#34; != x\u0026#34;\u0026#34; ]; then local parts=\u0026#39; resize|root|/|50G resize|user|/usr|50G resize|var|/var|50G resize|home|/home|50G create|swap|swap|8G create|tmp|/tmp|20G \u0026#39; for line in ${parts};do local type=\u0026#34;$(echo ${line} |awk -F\u0026#39;|\u0026#39; \u0026#39;{print $1}\u0026#39;)\u0026#34; local part_name=\u0026#34;$(echo ${line} |awk -F\u0026#39;|\u0026#39; \u0026#39;{print $2}\u0026#39;)\u0026#34; local part_dir=\u0026#34;$(echo ${line} |awk -F\u0026#39;|\u0026#39; \u0026#39;{print $3}\u0026#39;)\u0026#34; local part_size=\u0026#34;$(echo ${line} |awk -F\u0026#39;|\u0026#39; \u0026#39;{print $4}\u0026#39;)\u0026#34; case ${type} in create) lvcreate -y -L ${part_size} -n ${part_name} ${os_rootvg} mkfs.xfs -f /dev/${os_rootvg}/${part_name} if [ $(grep \u0026#34;/dev/${os_rootvg}/${part_name}\u0026#34; /etc/fstab |wc -l) -eq 0 ]; then [ ! -d ${part_dir} ] \u0026amp;\u0026amp; mkdir -p ${part_dir} echo \u0026#34;/dev/${os_rootvg}/${part_name} ${part_dir} xfs defaults 0 0\u0026#34; \u0026gt;\u0026gt; /etc/fstab fi ;; resize) lvextend -L ${part_size} -n /dev/${os_rootvg}/${part_name} xfs_growfs /dev/${os_rootvg}/${part_name} # xfs_growfs ${part_dir} ;; *) echo \u0026#34;type error\u0026#34; ;; esac done else echo \u0026#34;get rootvg info failed\u0026#34; fi } create_users(){ local users=\u0026#39; user:pass \u0026#39; for line in ${users};do local name=\u0026#34;$(echo ${line} |awk -F\u0026#39;:\u0026#39; \u0026#39;{print $1}\u0026#39;)\u0026#34; useradd -m ${name} echo \u0026#34;${$line}\u0026#34; |chpasswd done } resize_os_partition(){ # è·å–å®‰è£…ç³»ç»Ÿçš„ç£ç›˜ os_disk=\u0026#34;$(lsblk -r |grep -w \u0026#34;/boot\u0026#34; |cut -c1-3)\u0026#34; # è·å–/æ ¹æ–‡ä»¶ç³»ç»Ÿæ‰€åœ¨çš„vg os_rootvg=\u0026#34;$(lsblk -r |grep -w \u0026#34;/\u0026#34; |awk -F\u0026#39;-\u0026#39; \u0026#39;{print $1}\u0026#39;)\u0026#34; # è·å–/æ ¹æ–‡ä»¶ç³»ç»Ÿæ‰€åœ¨çš„ç›˜ç¬¦è·¯å¾„ if [ x\u0026#34;${os_disk}\u0026#34; != x\u0026#34;\u0026#34; ] \u0026amp;\u0026amp; [ x\u0026#34;${os_rootvg}\u0026#34; != x\u0026#34;\u0026#34; ]; then os_rootvg_path=\u0026#34;$(pvs |grep -w \u0026#34;${os_rootvg}\u0026#34; |egrep -o \u0026#34;/dev/${os_disk}[[:digit:]]+\u0026#34;)\u0026#34; else os_rootvg_path=\u0026#34;\u0026#34; fi # è·å–/æ ¹æ–‡ä»¶ç³»ç»Ÿæ‰€åœ¨åˆ†åŒºå· if [ x\u0026#34;${os_rootvg_path}\u0026#34; != x\u0026#34;\u0026#34; ]; then os_rootvg_path_num=\u0026#34;$(lsblk -r |grep -w \u0026#34;$(echo ${os_rootvg_path} |awk -F\u0026#39;/\u0026#39; \u0026#39;{print $NF}\u0026#39;)\u0026#34; |awk \u0026#39;{print $2}\u0026#39; |awk -F\u0026#39;:\u0026#39; \u0026#39;{print $NF}\u0026#39;)\u0026#34; else os_rootvg_path_num=\u0026#34;\u0026#34; fi # resizeç³»ç»Ÿç›˜ï¼Œæ‰©å®¹è‡³100% if [ x\u0026#34;${os_disk}\u0026#34; != x\u0026#34;\u0026#34; ] \u0026amp;\u0026amp; [ x\u0026#34;${os_rootvg_path}\u0026#34; != x\u0026#34;\u0026#34; ] \u0026amp;\u0026amp; [ x\u0026#34;${os_rootvg_path_num}\u0026#34; != x\u0026#34;\u0026#34; ]; then parted /dev/${os_disk} resizepart ${os_rootvg_path_num} 100% pvresize ${os_rootvg_path} else echo \u0026#34;resize root disk failed\u0026#34; fi } net_setup_nmcli(){ if [ x\u0026#34;$(systemctl is-enabled NetworkManager)\u0026#34; != x\u0026#34;enabled\u0026#34; ]; then systemctl enable NetworkManager fi if [ x\u0026#34;$(systemctl is-active NetworkManager)\u0026#34; != x\u0026#34;active\u0026#34; ]; then systemctl restart NetworkManager fi # åˆ é™¤ç°æœ‰ç½‘ç»œé…ç½® nmcli connection delete $(nmcli connection show |awk \u0026#39;{print $(NF-2)}\u0026#39;) # æ ¹æ®MACéå†æ¥å£ local ports=() for m in ${node_bond0_macs};do for i in $(nmcli device status |grep ethernet |awk \u0026#39;{print $1}\u0026#39;);do if [ $(nmcli device show $i |grep -i \u0026#34;${m}\u0026#34; |wc -l) -eq 1 ]; then local n=${#ports[@]} ports[${n}]=\u0026#34;${i}\u0026#34; break fi done done # åˆ›å»ºbond0æ¥å£ nmcli connection add type bond con-name bond0 ifname bond0 autoconnect yes bond.options \u0026#34;${node_bond0_mode}\u0026#34; nmcli connection modify bond0 ipv4.addresses ${node_bond0_ip}/${node_bond0_prefix} ipv4.gateway ${node_bond0_gw} ipv4.method manual # ç»‘å®šå­æ¥å£ for ((i=0;i\u0026lt;${#ports[@]};i++)); do nmcli connection add type ethernet con-name ${ports[${i}]} ifname ${ports[${i}]} master bond0 done # é‡è½½é…ç½® nmcli connection reload nmcli connection down bond0 \u0026amp;\u0026amp; nmcli connection up bond0 } add_repos(){ # å¢åŠ è½¯ä»¶æºé…ç½® if [ -d /etc/yum.repos.d ]; then mkdir -p /etc/yum.repos.d/bak [ -d /etc/yum.repos.d/bak ] \u0026amp;\u0026amp; mv /etc/yum.repos.d/*.repo /etc/yum.repos.d/bak/ cat \u0026gt; /etc/yum.repos.d/base.repo \u0026lt;\u0026lt;EOF [os_base] name=base packages baseurl=http://172.16.1.1:8080/anolis/BaseOS enabled=1 gpgcheck=0 [os_stream] name=stream packages baseurl=http://172.16.1.1:8080/anolis/AppStream enabled=1 gpgcheck=0 EOF fi } main(){ # ç³»ç»Ÿç£ç›˜åˆ†åŒºæ‰©å®¹ resize_os_partition # ç³»ç»Ÿåˆ†åŒºæ‰©å®¹ create_rootvg_partition # é…ç½®bondå’Œip net_setup_nmcli # åˆ›å»ºè´¦å·å¯†ç  create_users # é…ç½®è½¯ä»¶æº add_repos # åœç”¨cloud-init systemctl disable cloud-init-local.service cloud-init.service cloud-config.service cloud-final.service reboot } main ironic nodeæ¨é€ç¤ºä¾‹ # ç¤ºä¾‹ nova boot --config-drive true \\ --user-data ${userdata_file} \\ --flavor ${flavor_id} \\ --image ${image_name} \\ --nic net-name=\u0026#34;${network_name}\u0026#34;,v4-fixed-ip=${instance_ip} \\ --availability-zone nova::${ironic_node_uuid} \\ ${instance_name} ","permalink":"https://gnail89.github.io/posts/ironic_image_userdata/","summary":"è£¸é‡‘å±é•œåƒé…ç½® é•œåƒåˆ¶ä½œ type: whole disk image\nå‡†å¤‡ ç³»ç»Ÿé•œåƒISO\nUEFI å¼•å¯¼\nqemu-kvmç¯å¢ƒ\nå‘½åè§„èŒƒ åŒºåŸŸ-ç‰ˆæœ¬-æ¶æ„-å¯åŠ¨ç±»å‹-æ–‡ä»¶ç³»ç»Ÿ-é•œåƒå¤§å°: C01-AnolisOS-8.8-x86_64-UEFI-XFS-LVM-8G-IRONIC-yyymmdd.qcow2\nåˆ†åŒºè§„åˆ’å‚è€ƒ é•œåƒå¤§å°8GB, å¯æŒ‰éœ€æ±‚è¿›è¡Œåˆ†åŒº, åé¢é…åˆuserdataä½¿ç”¨\nFS VG LV SIZE /boot - - 1 GB /boot/efi - - 600 MB / rootvg root 1 GB /usr rootvg usr 4 GB /var rootvg var 1 GB /home rootvg home 1 GB è½¯ä»¶å®‰è£… cloud-init\nqemu-guest-agent (å¯é€‰)\ndnf install -y cloud-init qemu-guest-agent cloud-inité…ç½®æ–‡ä»¶æ›´æ–° # æ›´æ–°çš„å†…å®¹ no_ssh_fingerprints: true disable_root: false ssh_pwauth: true network: config: disabled datasource_list: [OpenStack, ConfigDrive] datasource: OpenStack: metadata_urls: [\u0026#39;http://169.","title":"ironic image and userdata"},{"content":"ç¯å¢ƒ ä¸»æœºå IPåœ°å€ å¤‡æ³¨ VIP 192.168.100.100 æµ®åŠ¨IP k8s-master01 192.168.100.101 masterèŠ‚ç‚¹ k8s-master02 192.168.100.102 masterèŠ‚ç‚¹ k8s-master03 192.168.100.103 masterèŠ‚ç‚¹ k8s-node01 192.168.100.104 nodeèŠ‚ç‚¹ k8s-node02 192.168.100.105 nodeèŠ‚ç‚¹ ç½‘æ®µè¯´æ˜\nservice: 10.96.0.0/12 pod: 172.16.0.0/12 k8såŸºç¡€ç³»ç»Ÿç¯å¢ƒé…ç½® é…ç½®IP # ç½‘å¡UUIDä¸èƒ½é‡å¤ï¼ŒUUIDé‡å¤æ— æ³•è·å–åˆ°IPV6åœ°å€ # # æŸ¥çœ‹å½“å‰çš„ç½‘å¡åˆ—è¡¨å’Œ UUIDï¼š # nmcli con show # åˆ é™¤è¦æ›´æ”¹ UUID çš„ç½‘ç»œè¿æ¥ï¼š # nmcli con delete uuid \u0026lt;åŸ UUID\u0026gt; # é‡æ–°ç”Ÿæˆ UUIDï¼š # nmcli con add type ethernet ifname \u0026lt;æ¥å£åç§°\u0026gt; con-name \u0026lt;æ–°åç§°\u0026gt; # é‡æ–°å¯ç”¨ç½‘ç»œè¿æ¥ï¼š # nmcli con up \u0026lt;æ–°åç§°\u0026gt; # æ›´æ”¹ç½‘å¡çš„UUID nmcli con delete uuid a5078897-4aae-3fa8-8b7a-0773d924901d;nmcli con add type ethernet ifname ens1 con-name ens1;nmcli con up ens1 nmcli con delete uuid a5078897-4aae-3fa8-8b7a-0773d924901d;nmcli con add type ethernet ifname ens1 con-name ens1;nmcli con up ens1 nmcli con delete uuid a5078897-4aae-3fa8-8b7a-0773d924901d;nmcli con add type ethernet ifname ens1 con-name ens1;nmcli con up ens1 nmcli con delete uuid a5078897-4aae-3fa8-8b7a-0773d924901d;nmcli con add type ethernet ifname ens1 con-name ens1;nmcli con up ens1 nmcli con delete uuid a5078897-4aae-3fa8-8b7a-0773d924901d;nmcli con add type ethernet ifname ens1 con-name ens1;nmcli con up ens1 # ä¿®æ”¹é™æ€çš„IPv4åœ°å€ nmcli con mod ens1 ipv4.addresses 192.168.100.101/24; nmcli con mod ens1 ipv4.gateway 192.168.100.1; nmcli con mod ens1 ipv4.method manual; nmcli con mod ens1 ipv4.dns \u0026#34;192.168.100.1\u0026#34;; nmcli con up ens1 nmcli con mod ens1 ipv4.addresses 192.168.100.102/24; nmcli con mod ens1 ipv4.gateway 192.168.100.1; nmcli con mod ens1 ipv4.method manual; nmcli con mod ens1 ipv4.dns \u0026#34;192.168.100.1\u0026#34;; nmcli con up ens1 nmcli con mod ens1 ipv4.addresses 192.168.100.103/24; nmcli con mod ens1 ipv4.gateway 192.168.100.1; nmcli con mod ens1 ipv4.method manual; nmcli con mod ens1 ipv4.dns \u0026#34;192.168.100.1\u0026#34;; nmcli con up ens1 nmcli con mod ens1 ipv4.addresses 192.168.100.104/24; nmcli con mod ens1 ipv4.gateway 192.168.100.1; nmcli con mod ens1 ipv4.method manual; nmcli con mod ens1 ipv4.dns \u0026#34;192.168.100.1\u0026#34;; nmcli con up ens1 nmcli con mod ens1 ipv4.addresses 192.168.100.105/24; nmcli con mod ens1 ipv4.gateway 192.168.100.1; nmcli con mod ens1 ipv4.method manual; nmcli con mod ens1 ipv4.dns \u0026#34;192.168.100.1\u0026#34;; nmcli con up ens1 # æ²¡æœ‰IPv6ä¸é…ç½®å³å¯(æ²¡æœ‰æµ‹è¯•IPv6) nmcli con mod ens1 ipv6.addresses fc00:43f4:1eea:1::10; nmcli con mod ens1 ipv6.gateway fc00:43f4:1eea:1::1; nmcli con mod ens1 ipv6.method manual; nmcli con mod ens1 ipv6.dns \u0026#34;2400:3200::1\u0026#34;; nmcli con up ens1 nmcli con mod ens1 ipv6.addresses fc00:43f4:1eea:1::20; nmcli con mod ens1 ipv6.gateway fc00:43f4:1eea:1::1; nmcli con mod ens1 ipv6.method manual; nmcli con mod ens1 ipv6.dns \u0026#34;2400:3200::1\u0026#34;; nmcli con up ens1 nmcli con mod ens1 ipv6.addresses fc00:43f4:1eea:1::30; nmcli con mod ens1 ipv6.gateway fc00:43f4:1eea:1::1; nmcli con mod ens1 ipv6.method manual; nmcli con mod ens1 ipv6.dns \u0026#34;2400:3200::1\u0026#34;; nmcli con up ens1 nmcli con mod ens1 ipv6.addresses fc00:43f4:1eea:1::40; nmcli con mod ens1 ipv6.gateway fc00:43f4:1eea:1::1; nmcli con mod ens1 ipv6.method manual; nmcli con mod ens1 ipv6.dns \u0026#34;2400:3200::1\u0026#34;; nmcli con up ens1 nmcli con mod ens1 ipv6.addresses fc00:43f4:1eea:1::50; nmcli con mod ens1 ipv6.gateway fc00:43f4:1eea:1::1; nmcli con mod ens1 ipv6.method manual; nmcli con mod ens1 ipv6.dns \u0026#34;2400:3200::1\u0026#34;; nmcli con up ens1 # æŸ¥çœ‹ç½‘å¡é…ç½® # nmcli device show ens1 # nmcli con show ens1 [root@localhost ~]# cat /etc/sysconfig/network-scripts/ifcfg-ens1 TYPE=Ethernet PROXY_METHOD=none BROWSER_ONLY=no BOOTPROTO=none IPADDR=192.168.100.101 PREFIX=24 GATEWAY=192.168.100.1 DNS1=192.168.100.1 DEFROUTE=yes IPV4_FAILURE_FATAL=no IPV6INIT=yes IPV6_AUTOCONF=yes IPV6_DEFROUTE=yes IPV6_FAILURE_FATAL=no IPV6_ADDR_GEN_MODE=stable-privacy NAME=ens1 UUID=a5078897-4aae-3fa8-8b7a-0773d924901e DEVICE=ens1 ONBOOT=yes AUTOCONNECT_PRIORITY=-999 IPV6ADDR=fc00:43f4:1eea:1::10/128 IPV6_DEFAULTGW=fc00:43f4:1eea:1::1 DNS2=2400:3200::1 è®¾ç½®ä¸»æœºå hostnamectl set-hostname k8s-master01 hostnamectl set-hostname k8s-master02 hostnamectl set-hostname k8s-master03 hostnamectl set-hostname k8s-node01 hostnamectl set-hostname k8s-node02 é…ç½®yumæº sudo sed -e \u0026#39;s|^mirrorlist=|#mirrorlist=|g\u0026#39; \\ -e \u0026#39;s|^#baseurl=http://mirror.centos.org/$contentdir|baseurl=https://mirrors.tuna.tsinghua.edu.cn/centos|g\u0026#39; \\ -i.bak \\ /etc/yum.repos.d/CentOS-*.repo å®‰è£…ä¸€äº›è½¯ä»¶(å¯é€‰) yum update -y \u0026amp;\u0026amp; yum -y install wget psmisc vim net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 git network-scripts tar curl ä¸‹è½½ç¦»çº¿æ–‡ä»¶(å¯é€‰) # ä¸‹è½½å¿…è¦å·¥å…· yum -y install createrepo yum-utils wget epel-release elrepo-release # ä¸‹è½½å…¨é‡ä¾èµ–åŒ… repotrack wget psmisc vim net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 git network-scripts tar curl gcc keepalived haproxy bash-completion chrony sshpass ipvsadm ipset sysstat conntrack libseccomp # åˆ›å»ºyumæºä¿¡æ¯ createrepo -u -d /data/centos8/ # æ‹·è´åŒ…åˆ°å†…ç½‘æœºå™¨ä¸Š scp -r centos8/ root@192.168.100.101: scp -r centos8/ root@192.168.100.102: scp -r centos8/ root@192.168.100.103: scp -r centos8/ root@192.168.100.104: scp -r centos8/ root@192.168.100.105: # åœ¨å†…ç½‘æœºå™¨ä¸Šåˆ›å»ºrepoé…ç½®æ–‡ä»¶ rm -rf /etc/yum.repos.d/* cat \u0026gt; /etc/yum.repos.d/base.repo \u0026lt;\u0026lt; EOF [base] name=CentOS-$releasever - Media baseurl=file:///root/centos8/ gpgcheck=0 enabled=1 EOF # å®‰è£…ä¸‹è½½å¥½çš„åŒ… yum clean all yum makecache yum install -y /root/centos8/* ä¸‹è½½è½¯ä»¶åŒ…(å¿…è¦) #!/bin/bash # æŸ¥çœ‹ç‰ˆæœ¬åœ°å€ï¼š # # https://github.com/containernetworking/plugins/releases/ # https://github.com/containerd/containerd/releases/ # https://github.com/kubernetes-sigs/cri-tools/releases/ # https://github.com/Mirantis/cri-dockerd/releases/ # https://github.com/etcd-io/etcd/releases/ # https://github.com/cloudflare/cfssl/releases/ # https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG # https://download.docker.com/linux/static/stable/x86_64/ # https://github.com/opencontainers/runc/releases/ # https://mirrors.tuna.tsinghua.edu.cn/elrepo/kernel/el7/x86_64/RPMS/ # https://github.com/helm/helm/tags # http://nginx.org/download/ # Version numbers cni_plugins_version=\u0026#39;v1.3.0\u0026#39; cri_containerd_cni_version=\u0026#39;1.7.6\u0026#39; crictl_version=\u0026#39;v1.28.0\u0026#39; cri_dockerd_version=\u0026#39;0.3.4\u0026#39; etcd_version=\u0026#39;v3.5.9\u0026#39; cfssl_version=\u0026#39;1.6.4\u0026#39; kubernetes_server_version=\u0026#39;1.27.6\u0026#39; docker_version=\u0026#39;24.0.6\u0026#39; runc_version=\u0026#39;1.1.9\u0026#39; kernel_version=\u0026#39;5.4.256\u0026#39; helm_version=\u0026#39;3.12.3\u0026#39; nginx_version=\u0026#39;1.25.2\u0026#39; # URLs base_url=\u0026#39;https://ghproxy.com/https://github.com\u0026#39; kernel_url=\u0026#34;http://mirrors.tuna.tsinghua.edu.cn/elrepo/kernel/el7/x86_64/RPMS/kernel-lt-${kernel_version}-1.el7.elrepo.x86_64.rpm\u0026#34; runc_url=\u0026#34;${base_url}/opencontainers/runc/releases/download/v${runc_version}/runc.amd64\u0026#34; docker_url=\u0026#34;https://download.docker.com/linux/static/stable/x86_64/docker-${docker_version}.tgz\u0026#34; cni_plugins_url=\u0026#34;${base_url}/containernetworking/plugins/releases/download/${cni_plugins_version}/cni-plugins-linux-amd64-${cni_plugins_version}.tgz\u0026#34; cri_containerd_cni_url=\u0026#34;${base_url}/containerd/containerd/releases/download/v${cri_containerd_cni_version}/cri-containerd-cni-${cri_containerd_cni_version}-linux-amd64.tar.gz\u0026#34; crictl_url=\u0026#34;${base_url}/kubernetes-sigs/cri-tools/releases/download/${crictl_version}/crictl-${crictl_version}-linux-amd64.tar.gz\u0026#34; cri_dockerd_url=\u0026#34;${base_url}/Mirantis/cri-dockerd/releases/download/v${cri_dockerd_version}/cri-dockerd-${cri_dockerd_version}.amd64.tgz\u0026#34; etcd_url=\u0026#34;${base_url}/etcd-io/etcd/releases/download/${etcd_version}/etcd-${etcd_version}-linux-amd64.tar.gz\u0026#34; cfssl_url=\u0026#34;${base_url}/cloudflare/cfssl/releases/download/v${cfssl_version}/cfssl_${cfssl_version}_linux_amd64\u0026#34; cfssljson_url=\u0026#34;${base_url}/cloudflare/cfssl/releases/download/v${cfssl_version}/cfssljson_${cfssl_version}_linux_amd64\u0026#34; helm_url=\u0026#34;https://files.m.daocloud.io/get.helm.sh/helm-v${helm_version}-linux-amd64.tar.gz\u0026#34; kubernetes_server_url=\u0026#34;https://dl.k8s.io/v${kubernetes_server_version}/kubernetes-server-linux-amd64.tar.gz\u0026#34; nginx_url=\u0026#34;http://nginx.org/download/nginx-${nginx_version}.tar.gz\u0026#34; # Download packages packages=( #$kernel_url $runc_url $docker_url $cni_plugins_url $cri_containerd_cni_url $crictl_url $cri_dockerd_url $etcd_url $cfssl_url $cfssljson_url $helm_url $kubernetes_server_url $nginx_url ) for package_url in \u0026#34;${packages[@]}\u0026#34;; do filename=$(basename \u0026#34;$package_url\u0026#34;) if wget -cq --progress=bar:force:noscroll -nc \u0026#34;$package_url\u0026#34;; then echo \u0026#34;Downloaded $filename\u0026#34; else echo \u0026#34;Failed to download $filename\u0026#34; exit 1 fi done å…³é—­é˜²ç«å¢™ systemctl disable --now firewalld å…³é—­SELinux setenforce 0 sed -i \u0026#39;s#SELINUX=enforcing#SELINUX=disabled#g\u0026#39; /etc/selinux/config å…³é—­äº¤æ¢åˆ†åŒº sed -ri \u0026#39;s/.*swap.*/#\u0026amp;/\u0026#39; /etc/fstab swapoff -a \u0026amp;\u0026amp; sysctl -w vm.swappiness=0 cat /etc/fstab # /dev/mapper/centos-swap swap swap defaults 0 0 ç½‘ç»œé…ç½® # NetworkManager cat \u0026gt; /etc/NetworkManager/conf.d/calico.conf \u0026lt;\u0026lt; EOF [keyfile] unmanaged-devices=interface-name:cali*;interface-name:tunl* EOF systemctl restart NetworkManager æ—¶é—´åŒæ­¥ yum install chrony -y systemctl enable --now chronyd chronyc sources -v é…ç½®ulimit ulimit -SHn 65535 cat \u0026gt;\u0026gt; /etc/security/limits.conf \u0026lt;\u0026lt;EOF * soft nofile 655360 * hard nofile 655360 * soft nproc 655360 * hard nproc 655360 * soft memlock unlimited * hard memlock unlimitedd EOF é…ç½®å…å¯†ç™»å½• yum install -y sshpass ssh-keygen -f /root/.ssh/id_rsa -P \u0026#39;\u0026#39; export IP=\u0026#34;192.168.100.101 192.168.100.102 192.168.100.103 192.168.100.104 192.168.100.105\u0026#34; export SSHPASS=12345678 for HOST in $IP;do sshpass -e ssh-copy-id -o StrictHostKeyChecking=no $HOST done cat \u0026gt; /root/.ssh/config \u0026lt;\u0026lt;EOF Host * StrictHostKeyChecking no EOF æ·»åŠ elrepoæº yum install -y elrepo-release sed -i \u0026#34;s@mirrorlist@#mirrorlist@g\u0026#34; /etc/yum.repos.d/elrepo.repo sed -i \u0026#34;s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g\u0026#34; /etc/yum.repos.d/elrepo.repo # æŸ¥çœ‹å¯ç”¨å®‰è£…åŒ… yum --disablerepo=\u0026#34;*\u0026#34; --enablerepo=\u0026#34;elrepo-kernel\u0026#34; list available å‡çº§å†…æ ¸è‡³4.18ç‰ˆæœ¬ä»¥ä¸Š # ç¨³å®šç‰ˆkernel-ml é•¿æœŸç»´æŠ¤ç‰ˆkernel-lt yum -y --enablerepo=elrepo-kernel install kernel-lt # æŸ¥çœ‹å·²å®‰è£…é‚£äº›å†…æ ¸ rpm -qa | grep kernel # æŸ¥çœ‹é»˜è®¤å†…æ ¸ grubby --default-kernel # æŸ¥çœ‹æ‰€æœ‰å†…æ ¸ç‰ˆæœ¬ grubby --info=ALL # è‹¥ä¸æ˜¯æœ€æ–°çš„ä½¿ç”¨å‘½ä»¤è®¾ç½® grubby --set-default /boot/vmlinuz-5.4.256-1.el8.elrepo.x86_64 # é‡å¯ç”Ÿæ•ˆ init 6 # æˆ– systemctl --force reboot å®‰è£…ipvsadm yum install -y ipvsadm ipset sysstat conntrack libseccomp cat \u0026gt;\u0026gt; /etc/modules-load.d/ipvs.conf \u0026lt;\u0026lt;EOF ip_vs ip_vs_rr ip_vs_wrr ip_vs_sh nf_conntrack ip_tables ip_set xt_set ipt_set ipt_rpfilter ipt_REJECT ipip EOF systemctl restart systemd-modules-load.service lsmod | grep -e ip_vs -e nf_conntrack ip_vs_sh 16384 0 ip_vs_wrr 16384 0 ip_vs_rr 16384 16 ip_vs 176128 22 ip_vs_rr,ip_vs_sh,ip_vs_wrr nf_conntrack 159744 4 xt_conntrack,nf_nat,xt_MASQUERADE,ip_vs nf_defrag_ipv6 24576 2 nf_conntrack,ip_vs nf_defrag_ipv4 16384 1 nf_conntrack libcrc32c 16384 4 nf_conntrack,nf_nat,xfs,ip_vs ä¿®æ”¹å†…æ ¸å‚æ•° cat \u0026lt;\u0026lt;EOF \u0026gt; /etc/sysctl.d/k8s.conf net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-iptables = 1 fs.may_detach_mounts = 1 vm.overcommit_memory=1 vm.panic_on_oom=0 fs.inotify.max_user_watches=89100 fs.file-max=52706963 fs.nr_open=52706963 net.netfilter.nf_conntrack_max=2310720 net.ipv4.tcp_keepalive_time = 600 net.ipv4.tcp_keepalive_probes = 3 net.ipv4.tcp_keepalive_intvl =15 net.ipv4.tcp_max_tw_buckets = 36000 net.ipv4.tcp_tw_reuse = 1 net.ipv4.tcp_max_orphans = 327680 net.ipv4.tcp_orphan_retries = 3 net.ipv4.tcp_syncookies = 1 net.ipv4.tcp_max_syn_backlog = 16384 net.ipv4.ip_conntrack_max = 65536 net.ipv4.tcp_max_syn_backlog = 16384 net.ipv4.tcp_timestamps = 0 net.core.somaxconn = 16384 net.ipv6.conf.all.disable_ipv6 = 0 net.ipv6.conf.default.disable_ipv6 = 0 net.ipv6.conf.lo.disable_ipv6 = 0 net.ipv6.conf.all.forwarding = 1 EOF sysctl --system æ‰€æœ‰èŠ‚ç‚¹é…ç½®hostsæœ¬åœ°è§£æ cat /etc/hosts 192.168.100.100 k8s-vip 192.168.100.101 k8s-master01 192.168.100.102 k8s-master02 192.168.100.103 k8s-master03 192.168.100.104 k8s-node01 192.168.100.105 k8s-node02 k8såŸºç¡€ç»„ä»¶å®‰è£… æ³¨æ„: docker å’Œ containerd äºŒé€‰å…¶ä¸€å³å¯\nå®‰è£…Containerdä½œä¸ºRuntime(æ–¹å¼ä¸€ï¼Œæ¨è) # å‚è€ƒé“¾æ¥ # https://github.com/containernetworking/plugins/releases/ # https://github.com/containernetworking/plugins/releases/download/v1.3.0/cni-plugins-linux-amd64-v1.3.0.tgz #åˆ›å»ºcniæ’ä»¶æ‰€éœ€ç›®å½• mkdir -p /etc/cni/net.d /opt/cni/bin #è§£å‹cniäºŒè¿›åˆ¶åŒ… tar xf cni-plugins-linux-amd64-v*.tgz -C /opt/cni/bin/ # å‚è€ƒé“¾æ¥ # https://github.com/containerd/containerd/releases/ # https://github.com/containerd/containerd/releases/download/v1.7.6/cri-containerd-cni-1.7.6-linux-amd64.tar.gz #è§£å‹containerdåˆ°æ ¹ç›®å½• tar -xzf cri-containerd-cni-*-linux-amd64.tar.gz -C / #åˆ›å»ºæœåŠ¡å¯åŠ¨æ–‡ä»¶ cat \u0026gt; /etc/systemd/system/containerd.service \u0026lt;\u0026lt;EOF [Unit] Description=containerd container runtime Documentation=https://containerd.io After=network.target local-fs.target [Service] ExecStartPre=-/sbin/modprobe overlay ExecStart=/usr/local/bin/containerd Type=notify Delegate=yes KillMode=process Restart=always RestartSec=5 LimitNPROC=infinity LimitCORE=infinity LimitNOFILE=infinity TasksMax=infinity OOMScoreAdjust=-999 [Install] WantedBy=multi-user.target EOF é…ç½®Containerdæ‰€éœ€çš„æ¨¡å— cat \u0026lt;\u0026lt;EOF | sudo tee /etc/modules-load.d/containerd.conf overlay br_netfilter EOF # åŠ è½½æ¨¡å— systemctl restart systemd-modules-load.service é…ç½®Containerdæ‰€éœ€çš„å†…æ ¸ cat \u0026lt;\u0026lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf net.bridge.bridge-nf-call-iptables = 1 net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-ip6tables = 1 EOF # åŠ è½½å†…æ ¸ sysctl --system åˆ›å»ºContainerdçš„é…ç½®æ–‡ä»¶ # åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶ mkdir -p /etc/containerd containerd config default \u0026gt; /etc/containerd/config.toml # å¯ç”¨systemd cgroup sed -i \u0026#34;s#SystemdCgroup\\ \\=\\ false#SystemdCgroup\\ \\=\\ true#g\u0026#34; /etc/containerd/config.toml cat /etc/containerd/config.toml | grep SystemdCgroup sed -i \u0026#34;s#registry.k8s.io#m.daocloud.io/registry.k8s.io#g\u0026#34; /etc/containerd/config.toml cat /etc/containerd/config.toml | grep sandbox_image sed -i \u0026#34;s#config_path\\ \\=\\ \\\u0026#34;\\\u0026#34;#config_path\\ \\=\\ \\\u0026#34;/etc/containerd/certs.d\\\u0026#34;#g\u0026#34; /etc/containerd/config.toml cat /etc/containerd/config.toml | grep certs.d mkdir -pv /etc/containerd/certs.d/docker.io # é…ç½®å›½å†…åŠ é€Ÿ cat \u0026gt; /etc/containerd/certs.d/docker.io/hosts.toml \u0026lt;\u0026lt; EOF server = \u0026#34;https://docker.io\u0026#34; [host.\u0026#34;https://hub-mirror.c.163.com\u0026#34;] capabilities = [\u0026#34;pull\u0026#34;, \u0026#34;resolve\u0026#34;] EOF å¯åŠ¨å¹¶è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ systemctl daemon-reload systemctl enable --now containerd systemctl restart containerd é…ç½®crictlå®¢æˆ·ç«¯è¿æ¥çš„è¿è¡Œæ—¶ä½ç½® # https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.28.0/crictl-v1.28.0-linux-amd64.tar.gz #è§£å‹ tar xf crictl-v*-linux-amd64.tar.gz -C /usr/bin/ #ç”Ÿæˆé…ç½®æ–‡ä»¶ cat \u0026gt; /etc/crictl.yaml \u0026lt;\u0026lt;EOF runtime-endpoint: unix:///run/containerd/containerd.sock image-endpoint: unix:///run/containerd/containerd.sock timeout: 10 debug: false EOF #æµ‹è¯• systemctl restart containerd crictl info å®‰è£…dockerä½œä¸ºRuntime(æ–¹å¼äºŒ) å®‰è£…docker # äºŒè¿›åˆ¶åŒ…ä¸‹è½½åœ°å€ï¼šhttps://download.docker.com/linux/static/stable/x86_64/ # wget https://download.docker.com/linux/static/stable/x86_64/docker-24.0.6.tgz #è§£å‹ tar xf docker-*.tgz #æ‹·è´äºŒè¿›åˆ¶æ–‡ä»¶ cp docker/* /usr/bin/ #åˆ›å»ºcontainerdçš„serviceæ–‡ä»¶ cat \u0026gt;/etc/systemd/system/containerd.service \u0026lt;\u0026lt;EOF [Unit] Description=containerd container runtime Documentation=https://containerd.io After=network.target local-fs.target [Service] ExecStartPre=-/sbin/modprobe overlay ExecStart=/usr/bin/containerd Type=notify Delegate=yes KillMode=process Restart=always RestartSec=5 LimitNPROC=infinity LimitCORE=infinity LimitNOFILE=1048576 TasksMax=infinity OOMScoreAdjust=-999 [Install] WantedBy=multi-user.target EOF # è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable --now containerd.service #å‡†å¤‡dockerçš„serviceæ–‡ä»¶ cat \u0026gt; /etc/systemd/system/docker.service \u0026lt;\u0026lt;EOF [Unit] Description=Docker Application Container Engine Documentation=https://docs.docker.com After=network-online.target firewalld.service containerd.service Wants=network-online.target Requires=docker.socket containerd.service [Service] Type=notify ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock ExecReload=/bin/kill -s HUP $MAINPID TimeoutSec=0 RestartSec=2 Restart=always StartLimitBurst=3 StartLimitInterval=60s LimitNOFILE=infinity LimitNPROC=infinity LimitCORE=infinity TasksMax=infinity Delegate=yes KillMode=process OOMScoreAdjust=-500 [Install] WantedBy=multi-user.target EOF #å‡†å¤‡dockerçš„socketæ–‡ä»¶ cat \u0026gt; /etc/systemd/system/docker.socket \u0026lt;\u0026lt;EOF [Unit] Description=Docker Socket for the API [Socket] ListenStream=/var/run/docker.sock SocketMode=0660 SocketUser=root SocketGroup=docker [Install] WantedBy=sockets.target EOF #åˆ›å»ºdockerç»„ groupadd docker #å¯åŠ¨docker systemctl enable --now docker.socket systemctl enable --now docker.service #éªŒè¯ docker info # é…ç½®å›½å†…åŠ é€Ÿå™¨ mkdir -pv /etc/docker/ cat \u0026gt;/etc/docker/daemon.json \u0026lt;\u0026lt;EOF { \u0026#34;exec-opts\u0026#34;: [\u0026#34;native.cgroupdriver=systemd\u0026#34;], \u0026#34;registry-mirrors\u0026#34;: [ \u0026#34;https://docker.m.daocloud.io\u0026#34;, \u0026#34;https://docker.mirrors.ustc.edu.cn\u0026#34;, \u0026#34;http://hub-mirror.c.163.com\u0026#34; ], \u0026#34;max-concurrent-downloads\u0026#34;: 10, \u0026#34;log-driver\u0026#34;: \u0026#34;json-file\u0026#34;, \u0026#34;log-level\u0026#34;: \u0026#34;warn\u0026#34;, \u0026#34;log-opts\u0026#34;: { \u0026#34;max-size\u0026#34;: \u0026#34;10m\u0026#34;, \u0026#34;max-file\u0026#34;: \u0026#34;3\u0026#34; }, \u0026#34;data-root\u0026#34;: \u0026#34;/var/lib/docker\u0026#34; } EOF systemctl daemon-reload systemctl stop docker systemctl restart docker å®‰è£…cri-docker # ç”±äº1.24ä»¥åŠæ›´é«˜ç‰ˆæœ¬ä¸æ”¯æŒdockeræ‰€ä»¥å®‰è£…cri-docker # ä¸‹è½½cri-docker # wget https://ghproxy.com/https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.4/cri-dockerd-0.3.4.amd64.tgz # è§£å‹cri-docker tar xvf cri-dockerd-*.amd64.tgz cp -r cri-dockerd/ /usr/bin/ chmod +x /usr/bin/cri-dockerd/cri-dockerd # å†™å…¥å¯åŠ¨é…ç½®æ–‡ä»¶ cat \u0026gt; /usr/lib/systemd/system/cri-docker.service \u0026lt;\u0026lt;EOF [Unit] Description=CRI Interface for Docker Application Container Engine Documentation=https://docs.mirantis.com After=network-online.target firewalld.service docker.service Wants=network-online.target Requires=cri-docker.socket [Service] Type=notify ExecStart=/usr/bin/cri-dockerd/cri-dockerd --network-plugin=cni --pod-infra-container-image=m.daocloud.io/registry.k8s.io/pause:3.8 ExecReload=/bin/kill -s HUP $MAINPID TimeoutSec=0 RestartSec=2 Restart=always StartLimitBurst=3 StartLimitInterval=60s LimitNOFILE=infinity LimitNPROC=infinity LimitCORE=infinity TasksMax=infinity Delegate=yes KillMode=process [Install] WantedBy=multi-user.target EOF # å†™å…¥socketé…ç½®æ–‡ä»¶ cat \u0026gt; /usr/lib/systemd/system/cri-docker.socket \u0026lt;\u0026lt;EOF [Unit] Description=CRI Docker Socket for the API PartOf=cri-docker.service [Socket] ListenStream=%t/cri-dockerd.sock SocketMode=0660 SocketUser=root SocketGroup=docker [Install] WantedBy=sockets.target EOF # è¿›è¡Œå¯åŠ¨cri-docker systemctl daemon-reload systemctl enable --now cri-docker systemctl restart cri-docker systemctl status cri-docker k8sä¸etcdå®‰è£…(ä»…åœ¨master01æ“ä½œ) è§£å‹k8så®‰è£…åŒ… # ä¸‹è½½å®‰è£…åŒ… # wget https://dl.k8s.io/v1.27.6/kubernetes-server-linux-amd64.tar.gz # wget https://github.com/etcd-io/etcd/releases/download/v3.5.9/etcd-v3.5.9-linux-amd64.tar.gz # è§£å‹k8så®‰è£…æ–‡ä»¶ tar -xf kubernetes-server-linux-amd64.tar.gz --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy} # è§£å‹etcdå®‰è£…æ–‡ä»¶ tar -xf etcd*.tar.gz \u0026amp;\u0026amp; mv etcd-*/etcd /usr/local/bin/ \u0026amp;\u0026amp; mv etcd-*/etcdctl /usr/local/bin/ # æŸ¥çœ‹/usr/local/binä¸‹å†…å®¹ ls /usr/local/bin/ containerd crictl etcdctl kube-proxy containerd-shim critest kube-apiserver kube-scheduler containerd-shim-runc-v1 ctd-decoder kube-controller-manager containerd-shim-runc-v2 ctr kubectl containerd-stress etcd kubelet æŸ¥çœ‹ç‰ˆæœ¬ # kubelet --version Kubernetes v1.27.6 # etcdctl version etcdctl version: 3.5.9 API version: 3.5 å°†ç»„ä»¶å¤åˆ¶åˆ°å…¶ä»–k8sèŠ‚ç‚¹ Master=\u0026#39;k8s-master02 k8s-master03\u0026#39; Work=\u0026#39;k8s-node01 k8s-node02\u0026#39; # æ‹·è´masterç»„ä»¶ for NODE in $Master; do echo $NODE; scp /usr/local/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy} $NODE:/usr/local/bin/; scp /usr/local/bin/etcd* $NODE:/usr/local/bin/; done # æ‹·è´workç»„ä»¶ for NODE in $Work; do scp /usr/local/bin/kube{let,-proxy} $NODE:/usr/local/bin/ ; done # æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ mkdir -pv /opt/cni/bin ç›¸å…³è¯ä¹¦ç”Ÿæˆ # master01èŠ‚ç‚¹ä¸‹è½½è¯ä¹¦ç”Ÿæˆå·¥å…· # wget \u0026#34;https://ghproxy.com/https://github.com/cloudflare/cfssl/releases/download/v1.6.4/cfssl_1.6.4_linux_amd64\u0026#34; -O /usr/local/bin/cfssl # wget \u0026#34;https://ghproxy.com/https://github.com/cloudflare/cfssl/releases/download/v1.6.4/cfssljson_1.6.4_linux_amd64\u0026#34; -O /usr/local/bin/cfssljson # è½¯ä»¶åŒ…å†…æœ‰ cp cfssl_*_linux_amd64 /usr/local/bin/cfssl cp cfssljson_*_linux_amd64 /usr/local/bin/cfssljson # æ·»åŠ æ‰§è¡Œæƒé™ chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson ç”Ÿæˆetcdè¯ä¹¦ æ‰€æœ‰masterèŠ‚ç‚¹åˆ›å»ºè¯ä¹¦å­˜æ”¾ç›®å½• mkdir -pv /etc/etcd/ssl åœ¨master01èŠ‚ç‚¹ç”Ÿæˆetcdè¯ä¹¦ mkdir pki \u0026amp;\u0026amp; cd pki cat \u0026gt; etcd-ca-csr.json \u0026lt;\u0026lt;EOF { \u0026#34;CN\u0026#34;: \u0026#34;etcd\u0026#34;, \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;CN\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;Beijing\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;Beijing\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;etcd\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;Etcd Security\u0026#34; } ], \u0026#34;ca\u0026#34;: { \u0026#34;expiry\u0026#34;: \u0026#34;876000h\u0026#34; } } EOF cat \u0026gt; etcd-csr.json \u0026lt;\u0026lt;EOF { \u0026#34;CN\u0026#34;: \u0026#34;etcd\u0026#34;, \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;CN\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;Beijing\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;Beijing\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;etcd\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;Etcd Security\u0026#34; } ] } EOF cat \u0026gt; ca-config.json \u0026lt;\u0026lt;EOF { \u0026#34;signing\u0026#34;: { \u0026#34;default\u0026#34;: { \u0026#34;expiry\u0026#34;: \u0026#34;876000h\u0026#34; }, \u0026#34;profiles\u0026#34;: { \u0026#34;kubernetes\u0026#34;: { \u0026#34;usages\u0026#34;: [ \u0026#34;signing\u0026#34;, \u0026#34;key encipherment\u0026#34;, \u0026#34;server auth\u0026#34;, \u0026#34;client auth\u0026#34; ], \u0026#34;expiry\u0026#34;: \u0026#34;876000h\u0026#34; } } } } EOF # ç”Ÿæˆetcdè¯ä¹¦å’Œetcdè¯ä¹¦çš„keyï¼ˆå¦‚æœä½ è§‰å¾—ä»¥åå¯èƒ½ä¼šæ‰©å®¹ï¼Œå¯ä»¥åœ¨ipé‚£å¤šå†™å‡ ä¸ªé¢„ç•™å‡ºæ¥ï¼‰ # å¦‚æœæ²¡æœ‰IPv6 å¯åˆ é™¤å¯ä¿ç•™ cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare /etc/etcd/ssl/etcd-ca cfssl gencert \\ -ca=/etc/etcd/ssl/etcd-ca.pem \\ -ca-key=/etc/etcd/ssl/etcd-ca-key.pem \\ -config=ca-config.json \\ -hostname=127.0.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.100.101,192.168.100.102,192.168.100.103,fc00:43f4:1eea:1::10,fc00:43f4:1eea:1::20,fc00:43f4:1eea:1::30,::1 \\ -profile=kubernetes \\ etcd-csr.json | cfssljson -bare /etc/etcd/ssl/etcd å°†è¯ä¹¦å¤åˆ¶åˆ°å…¶ä»–èŠ‚ç‚¹ Master=\u0026#39;k8s-master02 k8s-master03\u0026#39; for NODE in $Master; do ssh $NODE \u0026#34;mkdir -p /etc/etcd/ssl\u0026#34;; for FILE in etcd-ca-key.pem etcd-ca.pem etcd-key.pem etcd.pem; do scp /etc/etcd/ssl/${FILE} $NODE:/etc/etcd/ssl/${FILE}; done; done ç”Ÿæˆk8sç›¸å…³è¯ä¹¦ æ‰€æœ‰k8sèŠ‚ç‚¹åˆ›å»ºè¯ä¹¦å­˜æ”¾ç›®å½• mkdir -pv /etc/kubernetes/pki master01èŠ‚ç‚¹ç”Ÿæˆk8sè¯ä¹¦ cat \u0026gt; ca-csr.json \u0026lt;\u0026lt;EOF { \u0026#34;CN\u0026#34;: \u0026#34;kubernetes\u0026#34;, \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;CN\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;Beijing\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;Beijing\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;Kubernetes\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;Kubernetes-manual\u0026#34; } ], \u0026#34;ca\u0026#34;: { \u0026#34;expiry\u0026#34;: \u0026#34;876000h\u0026#34; } } EOF cat \u0026gt; ca-config.json \u0026lt;\u0026lt;EOF { \u0026#34;signing\u0026#34;: { \u0026#34;default\u0026#34;: { \u0026#34;expiry\u0026#34;: \u0026#34;876000h\u0026#34; }, \u0026#34;profiles\u0026#34;: { \u0026#34;kubernetes\u0026#34;: { \u0026#34;usages\u0026#34;: [ \u0026#34;signing\u0026#34;, \u0026#34;key encipherment\u0026#34;, \u0026#34;server auth\u0026#34;, \u0026#34;client auth\u0026#34; ], \u0026#34;expiry\u0026#34;: \u0026#34;876000h\u0026#34; } } } } EOF cat \u0026gt; apiserver-csr.json \u0026lt;\u0026lt;EOF { \u0026#34;CN\u0026#34;: \u0026#34;kube-apiserver\u0026#34;, \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;CN\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;Beijing\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;Beijing\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;Kubernetes\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;Kubernetes-manual\u0026#34; } ] } EOF cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca # ç”Ÿæˆä¸€ä¸ªk8sæ ¹è¯ä¹¦ ï¼Œå¯ä»¥å¤šå†™ä¸€äº›IPä½œä¸ºé¢„ç•™IPï¼Œä¸ºå°†æ¥æ·»åŠ nodeåšå‡†å¤‡ # 10.96.0.1æ˜¯serviceç½‘æ®µçš„ç¬¬ä¸€ä¸ªåœ°å€ï¼Œéœ€è¦è®¡ç®—ï¼Œ192.168.100.100ä¸ºé«˜å¯ç”¨vipåœ°å€ # å¦‚æœæ²¡æœ‰IPv6 å¯åˆ é™¤å¯ä¿ç•™ cfssl gencert \\ -ca=/etc/kubernetes/pki/ca.pem \\ -ca-key=/etc/kubernetes/pki/ca-key.pem \\ -config=ca-config.json \\ -hostname=10.96.0.1,192.168.100.100,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,192.168.100.101,192.168.100.102,192.168.100.103,192.168.100.104,192.168.100.105,192.168.100.106,192.168.100.107,192.168.100.108,192.168.100.109,192.168.100.110,fc00:43f4:1eea:1::10,fc00:43f4:1eea:1::20,fc00:43f4:1eea:1::30,fc00:43f4:1eea:1::40,fc00:43f4:1eea:1::50,fc00:43f4:1eea:1::60,fc00:43f4:1eea:1::70,fc00:43f4:1eea:1::80,fc00:43f4:1eea:1::90,fc00:43f4:1eea:1::100,::1 \\ -profile=kubernetes apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver ç”Ÿæˆapiserverèšåˆè¯ä¹¦ cat \u0026gt; front-proxy-ca-csr.json \u0026lt;\u0026lt;EOF { \u0026#34;CN\u0026#34;: \u0026#34;kubernetes\u0026#34;, \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;ca\u0026#34;: { \u0026#34;expiry\u0026#34;: \u0026#34;876000h\u0026#34; } } EOF cat \u0026gt; front-proxy-client-csr.json \u0026lt;\u0026lt;EOF { \u0026#34;CN\u0026#34;: \u0026#34;front-proxy-client\u0026#34;, \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 } } EOF cfssl gencert -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca # æœ‰ä¸€ä¸ªè­¦å‘Šï¼Œå¯ä»¥å¿½ç•¥ cfssl gencert \\ -ca=/etc/kubernetes/pki/front-proxy-ca.pem \\ -ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client ç”Ÿæˆcontroller-manageçš„è¯ä¹¦ åœ¨é«˜å¯ç”¨é…ç½®éƒ¨åˆ†é€‰æ‹©ä½¿ç”¨å“ªç§é«˜å¯ç”¨æ–¹æ¡ˆ è‹¥ä½¿ç”¨ haproxyã€keepalived é‚£ä¹ˆä¸º --server=https://192.168.100.100:9443 è‹¥ä½¿ç”¨ nginxæ–¹æ¡ˆï¼Œé‚£ä¹ˆä¸º --server=https://127.0.0.1:8443 cat \u0026gt; manager-csr.json \u0026lt;\u0026lt;EOF { \u0026#34;CN\u0026#34;: \u0026#34;system:kube-controller-manager\u0026#34;, \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;CN\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;Beijing\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;Beijing\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;system:kube-controller-manager\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;Kubernetes-manual\u0026#34; } ] } EOF cfssl gencert \\ -ca=/etc/kubernetes/pki/ca.pem \\ -ca-key=/etc/kubernetes/pki/ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes \\ manager-csr.json | cfssljson -bare /etc/kubernetes/pki/controller-manager # è®¾ç½®ä¸€ä¸ªé›†ç¾¤é¡¹ kubectl config set-cluster kubernetes \\ --certificate-authority=/etc/kubernetes/pki/ca.pem \\ --embed-certs=true \\ --server=https://192.168.100.100:9443 \\ --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig # è®¾ç½®ä¸€ä¸ªç¯å¢ƒé¡¹ï¼Œä¸€ä¸ªä¸Šä¸‹æ–‡ kubectl config set-context system:kube-controller-manager@kubernetes \\ --cluster=kubernetes \\ --user=system:kube-controller-manager \\ --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig # è®¾ç½®ä¸€ä¸ªç”¨æˆ·é¡¹ kubectl config set-credentials system:kube-controller-manager \\ --client-certificate=/etc/kubernetes/pki/controller-manager.pem \\ --client-key=/etc/kubernetes/pki/controller-manager-key.pem \\ --embed-certs=true \\ --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig # è®¾ç½®é»˜è®¤ç¯å¢ƒ kubectl config use-context system:kube-controller-manager@kubernetes \\ --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig åœ¨é«˜å¯ç”¨é…ç½®éƒ¨åˆ†é€‰æ‹©ä½¿ç”¨å“ªç§é«˜å¯ç”¨æ–¹æ¡ˆ è‹¥ä½¿ç”¨ haproxyã€keepalived é‚£ä¹ˆä¸º --server=https://192.168.100.100:9443 è‹¥ä½¿ç”¨ nginxæ–¹æ¡ˆï¼Œé‚£ä¹ˆä¸º --server=https://127.0.0.1:8443 cat \u0026gt; scheduler-csr.json \u0026lt;\u0026lt;EOF { \u0026#34;CN\u0026#34;: \u0026#34;system:kube-scheduler\u0026#34;, \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;CN\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;Beijing\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;Beijing\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;system:kube-scheduler\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;Kubernetes-manual\u0026#34; } ] } EOF cfssl gencert \\ -ca=/etc/kubernetes/pki/ca.pem \\ -ca-key=/etc/kubernetes/pki/ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes \\ scheduler-csr.json | cfssljson -bare /etc/kubernetes/pki/scheduler kubectl config set-cluster kubernetes \\ --certificate-authority=/etc/kubernetes/pki/ca.pem \\ --embed-certs=true \\ --server=https://192.168.100.100:9443 \\ --kubeconfig=/etc/kubernetes/scheduler.kubeconfig kubectl config set-credentials system:kube-scheduler \\ --client-certificate=/etc/kubernetes/pki/scheduler.pem \\ --client-key=/etc/kubernetes/pki/scheduler-key.pem \\ --embed-certs=true \\ --kubeconfig=/etc/kubernetes/scheduler.kubeconfig kubectl config set-context system:kube-scheduler@kubernetes \\ --cluster=kubernetes \\ --user=system:kube-scheduler \\ --kubeconfig=/etc/kubernetes/scheduler.kubeconfig kubectl config use-context system:kube-scheduler@kubernetes \\ --kubeconfig=/etc/kubernetes/scheduler.kubeconfig åœ¨é«˜å¯ç”¨é…ç½®éƒ¨åˆ†é€‰æ‹©ä½¿ç”¨å“ªç§é«˜å¯ç”¨æ–¹æ¡ˆ è‹¥ä½¿ç”¨ haproxyã€keepalived é‚£ä¹ˆä¸º --server=https://192.168.100.100:9443 è‹¥ä½¿ç”¨ nginxæ–¹æ¡ˆï¼Œé‚£ä¹ˆä¸º --server=https://127.0.0.1:8443 cat \u0026gt; admin-csr.json \u0026lt;\u0026lt;EOF { \u0026#34;CN\u0026#34;: \u0026#34;admin\u0026#34;, \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;CN\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;Beijing\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;Beijing\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;system:masters\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;Kubernetes-manual\u0026#34; } ] } EOF cfssl gencert \\ -ca=/etc/kubernetes/pki/ca.pem \\ -ca-key=/etc/kubernetes/pki/ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes \\ admin-csr.json | cfssljson -bare /etc/kubernetes/pki/admin kubectl config set-cluster kubernetes \\ --certificate-authority=/etc/kubernetes/pki/ca.pem \\ --embed-certs=true \\ --server=https://192.168.100.100:9443 \\ --kubeconfig=/etc/kubernetes/admin.kubeconfig kubectl config set-credentials kubernetes-admin \\ --client-certificate=/etc/kubernetes/pki/admin.pem \\ --client-key=/etc/kubernetes/pki/admin-key.pem \\ --embed-certs=true \\ --kubeconfig=/etc/kubernetes/admin.kubeconfig kubectl config set-context kubernetes-admin@kubernetes \\ --cluster=kubernetes \\ --user=kubernetes-admin \\ --kubeconfig=/etc/kubernetes/admin.kubeconfig kubectl config use-context kubernetes-admin@kubernetes --kubeconfig=/etc/kubernetes/admin.kubeconfig ç”Ÿæˆkube-proxyè¯ä¹¦ åœ¨é«˜å¯ç”¨é…ç½®éƒ¨åˆ†é€‰æ‹©ä½¿ç”¨å“ªç§é«˜å¯ç”¨æ–¹æ¡ˆ è‹¥ä½¿ç”¨ haproxyã€keepalived é‚£ä¹ˆä¸º --server=https://192.168.100.100:9443 è‹¥ä½¿ç”¨ nginxæ–¹æ¡ˆï¼Œé‚£ä¹ˆä¸º --server=https://127.0.0.1:8443 cat \u0026gt; kube-proxy-csr.json \u0026lt;\u0026lt;EOF { \u0026#34;CN\u0026#34;: \u0026#34;system:kube-proxy\u0026#34;, \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;CN\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;Beijing\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;Beijing\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;system:kube-proxy\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;Kubernetes-manual\u0026#34; } ] } EOF cfssl gencert \\ -ca=/etc/kubernetes/pki/ca.pem \\ -ca-key=/etc/kubernetes/pki/ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes \\ kube-proxy-csr.json | cfssljson -bare /etc/kubernetes/pki/kube-proxy kubectl config set-cluster kubernetes \\ --certificate-authority=/etc/kubernetes/pki/ca.pem \\ --embed-certs=true \\ --server=https://192.168.100.100:9443 \\ --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig kubectl config set-credentials kube-proxy \\ --client-certificate=/etc/kubernetes/pki/kube-proxy.pem \\ --client-key=/etc/kubernetes/pki/kube-proxy-key.pem \\ --embed-certs=true \\ --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig kubectl config set-context kube-proxy@kubernetes \\ --cluster=kubernetes \\ --user=kube-proxy \\ --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig kubectl config use-context kube-proxy@kubernetes --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig ç”ŸæˆServiceAccount Key â€”â€”secret openssl genrsa -out /etc/kubernetes/pki/sa.key 2048 openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub å°†è¯ä¹¦å‘é€åˆ°å…¶ä»–masterèŠ‚ç‚¹ # å…¶ä»–èŠ‚ç‚¹åˆ›å»ºç›®å½• # mkdir -pv /etc/kubernetes/pki/ for NODE in k8s-master02 k8s-master03; do for FILE in $(ls /etc/kubernetes/pki | grep -v etcd); do scp /etc/kubernetes/pki/${FILE} $NODE:/etc/kubernetes/pki/${FILE}; done; for FILE in admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig; do scp /etc/kubernetes/${FILE} $NODE:/etc/kubernetes/${FILE}; done; done æŸ¥çœ‹è¯ä¹¦ # ls /etc/kubernetes/pki/ admin.csr apiserver.pem controller-manager-key.pem front-proxy-ca.pem kube-proxy-key.pem scheduler-key.pem admin-key.pem ca.csr controller-manager.pem front-proxy-client.csr kube-proxy.pem scheduler.pem admin.pem ca-key.pem front-proxy-client-key.pem sa.key apiserver.csr ca.pem front-proxy-ca.csr front-proxy-client.pem sa.pub apiserver-key.pem controller-manager.csr front-proxy-ca-key.pem kube-proxy.csr scheduler.csr # å…±26ä¸ª # ls /etc/kubernetes/pki/ |wc -l 26 k8sç³»ç»Ÿç»„ä»¶etcdé…ç½® etcdé…ç½® master01é…ç½® # å¦‚æœè¦ç”¨IPv6é‚£ä¹ˆæŠŠIPv4åœ°å€ä¿®æ”¹ä¸ºIPv6å³å¯ cat \u0026gt; /etc/etcd/etcd.config.yml \u0026lt;\u0026lt; EOF name: \u0026#39;k8s-master01\u0026#39; data-dir: /var/lib/etcd wal-dir: /var/lib/etcd/wal snapshot-count: 5000 heartbeat-interval: 100 election-timeout: 1000 quota-backend-bytes: 0 listen-peer-urls: \u0026#39;https://192.168.100.101:2380\u0026#39; listen-client-urls: \u0026#39;https://192.168.100.101:2379,http://127.0.0.1:2379\u0026#39; max-snapshots: 3 max-wals: 5 cors: initial-advertise-peer-urls: \u0026#39;https://192.168.100.101:2380\u0026#39; advertise-client-urls: \u0026#39;https://192.168.100.101:2379\u0026#39; discovery: discovery-fallback: \u0026#39;proxy\u0026#39; discovery-proxy: discovery-srv: initial-cluster: \u0026#39;k8s-master01=https://192.168.100.101:2380,k8s-master02=https://192.168.100.102:2380,k8s-master03=https://192.168.100.103:2380\u0026#39; initial-cluster-token: \u0026#39;etcd-k8s-cluster\u0026#39; initial-cluster-state: \u0026#39;new\u0026#39; strict-reconfig-check: false enable-v2: true enable-pprof: true proxy: \u0026#39;off\u0026#39; proxy-failure-wait: 5000 proxy-refresh-interval: 30000 proxy-dial-timeout: 1000 proxy-write-timeout: 5000 proxy-read-timeout: 0 client-transport-security: cert-file: \u0026#39;/etc/kubernetes/pki/etcd/etcd.pem\u0026#39; key-file: \u0026#39;/etc/kubernetes/pki/etcd/etcd-key.pem\u0026#39; client-cert-auth: true trusted-ca-file: \u0026#39;/etc/kubernetes/pki/etcd/etcd-ca.pem\u0026#39; auto-tls: true peer-transport-security: cert-file: \u0026#39;/etc/kubernetes/pki/etcd/etcd.pem\u0026#39; key-file: \u0026#39;/etc/kubernetes/pki/etcd/etcd-key.pem\u0026#39; peer-client-cert-auth: true trusted-ca-file: \u0026#39;/etc/kubernetes/pki/etcd/etcd-ca.pem\u0026#39; auto-tls: true debug: false log-package-levels: log-outputs: [default] force-new-cluster: false EOF master02é…ç½® # å¦‚æœè¦ç”¨IPv6é‚£ä¹ˆæŠŠIPv4åœ°å€ä¿®æ”¹ä¸ºIPv6å³å¯ cat \u0026gt; /etc/etcd/etcd.config.yml \u0026lt;\u0026lt; EOF name: \u0026#39;k8s-master02\u0026#39; data-dir: /var/lib/etcd wal-dir: /var/lib/etcd/wal snapshot-count: 5000 heartbeat-interval: 100 election-timeout: 1000 quota-backend-bytes: 0 listen-peer-urls: \u0026#39;https://192.168.100.102:2380\u0026#39; listen-client-urls: \u0026#39;https://192.168.100.102:2379,http://127.0.0.1:2379\u0026#39; max-snapshots: 3 max-wals: 5 cors: initial-advertise-peer-urls: \u0026#39;https://192.168.100.102:2380\u0026#39; advertise-client-urls: \u0026#39;https://192.168.100.102:2379\u0026#39; discovery: discovery-fallback: \u0026#39;proxy\u0026#39; discovery-proxy: discovery-srv: initial-cluster: \u0026#39;k8s-master01=https://192.168.100.101:2380,k8s-master02=https://192.168.100.102:2380,k8s-master03=https://192.168.100.103:2380\u0026#39; initial-cluster-token: \u0026#39;etcd-k8s-cluster\u0026#39; initial-cluster-state: \u0026#39;new\u0026#39; strict-reconfig-check: false enable-v2: true enable-pprof: true proxy: \u0026#39;off\u0026#39; proxy-failure-wait: 5000 proxy-refresh-interval: 30000 proxy-dial-timeout: 1000 proxy-write-timeout: 5000 proxy-read-timeout: 0 client-transport-security: cert-file: \u0026#39;/etc/kubernetes/pki/etcd/etcd.pem\u0026#39; key-file: \u0026#39;/etc/kubernetes/pki/etcd/etcd-key.pem\u0026#39; client-cert-auth: true trusted-ca-file: \u0026#39;/etc/kubernetes/pki/etcd/etcd-ca.pem\u0026#39; auto-tls: true peer-transport-security: cert-file: \u0026#39;/etc/kubernetes/pki/etcd/etcd.pem\u0026#39; key-file: \u0026#39;/etc/kubernetes/pki/etcd/etcd-key.pem\u0026#39; peer-client-cert-auth: true trusted-ca-file: \u0026#39;/etc/kubernetes/pki/etcd/etcd-ca.pem\u0026#39; auto-tls: true debug: false log-package-levels: log-outputs: [default] force-new-cluster: false master03é…ç½® # å¦‚æœè¦ç”¨IPv6é‚£ä¹ˆæŠŠIPv4åœ°å€ä¿®æ”¹ä¸ºIPv6å³å¯ cat \u0026gt; /etc/etcd/etcd.config.yml \u0026lt;\u0026lt; EOF name: \u0026#39;k8s-master03\u0026#39; data-dir: /var/lib/etcd wal-dir: /var/lib/etcd/wal snapshot-count: 5000 heartbeat-interval: 100 election-timeout: 1000 quota-backend-bytes: 0 listen-peer-urls: \u0026#39;https://192.168.100.103:2380\u0026#39; listen-client-urls: \u0026#39;https://192.168.100.103:2379,http://127.0.0.1:2379\u0026#39; max-snapshots: 3 max-wals: 5 cors: initial-advertise-peer-urls: \u0026#39;https://192.168.100.103:2380\u0026#39; advertise-client-urls: \u0026#39;https://192.168.100.103:2379\u0026#39; discovery: discovery-fallback: \u0026#39;proxy\u0026#39; discovery-proxy: discovery-srv: initial-cluster: \u0026#39;k8s-master01=https://192.168.100.101:2380,k8s-master02=https://192.168.100.102:2380,k8s-master03=https://192.168.100.103:2380\u0026#39; initial-cluster-token: \u0026#39;etcd-k8s-cluster\u0026#39; initial-cluster-state: \u0026#39;new\u0026#39; strict-reconfig-check: false enable-v2: true enable-pprof: true proxy: \u0026#39;off\u0026#39; proxy-failure-wait: 5000 proxy-refresh-interval: 30000 proxy-dial-timeout: 1000 proxy-write-timeout: 5000 proxy-read-timeout: 0 client-transport-security: cert-file: \u0026#39;/etc/kubernetes/pki/etcd/etcd.pem\u0026#39; key-file: \u0026#39;/etc/kubernetes/pki/etcd/etcd-key.pem\u0026#39; client-cert-auth: true trusted-ca-file: \u0026#39;/etc/kubernetes/pki/etcd/etcd-ca.pem\u0026#39; auto-tls: true peer-transport-security: cert-file: \u0026#39;/etc/kubernetes/pki/etcd/etcd.pem\u0026#39; key-file: \u0026#39;/etc/kubernetes/pki/etcd/etcd-key.pem\u0026#39; peer-client-cert-auth: true trusted-ca-file: \u0026#39;/etc/kubernetes/pki/etcd/etcd-ca.pem\u0026#39; auto-tls: true debug: false log-package-levels: log-outputs: [default] force-new-cluster: false åˆ›å»ºservice(æ‰€æœ‰masterèŠ‚ç‚¹æ“ä½œ) åˆ›å»ºetcd.serviceå¹¶å¯åŠ¨ cat \u0026gt; /usr/lib/systemd/system/etcd.service \u0026lt;\u0026lt; EOF [Unit] Description=Etcd Service Documentation=https://coreos.com/etcd/docs/latest/ After=network.target [Service] Type=notify ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml Restart=on-failure RestartSec=10 LimitNOFILE=65535 [Install] WantedBy=multi-user.target Alias=etcd3.service EOF åˆ›å»ºetcdè¯ä¹¦ç›®å½• mkdir /etc/kubernetes/pki/etcd ln -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/ systemctl daemon-reload systemctl enable --now etcd æŸ¥çœ‹etcdçŠ¶æ€ # å¦‚æœè¦ç”¨IPv6é‚£ä¹ˆæŠŠIPv4åœ°å€ä¿®æ”¹ä¸ºIPv6å³å¯ export ETCDCTL_API=3 etcdctl --endpoints=\u0026#34;192.168.100.101:2379,192.168.100.102:2379,192.168.100.103:2379\u0026#34; --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem endpoint stat --write-out=table +----------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | ENDPOINT | ID | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS | +----------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | 192.168.100.101:2379 | c88a7ad9caa0caa0 | 3.5.9 | 10 MB | false | false | 6 | 1607415 | 1607415 | | | 192.168.100.102:2379 | 66a0add9c0721410 | 3.5.9 | 10 MB | true | false | 6 | 1607415 | 1607415 | | | 192.168.100.103:2379 | 5d94bf57d46a5d6f | 3.5.9 | 10 MB | false | false | 6 | 1607415 | 1607415 | | +----------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ é«˜å¯ç”¨é…ç½®(åœ¨MasteræœåŠ¡å™¨ä¸Šæ“ä½œ) æ³¨æ„ nginx å’Œ haproxy+keepalived æ–¹æ¡ˆäºŒé€‰ä¸€å³å¯\né€‰æ‹©ä½¿ç”¨é‚£ç§é«˜å¯ç”¨æ–¹æ¡ˆï¼ŒåŒæ—¶å¯ä»¥ä¿©ç§éƒ½é€‰ç”¨ï¼Œæ¯”å¦‚ï¼š nginxæ–¹æ¡ˆå®ç°é›†ç¾¤å†…çš„é«˜å¯ç”¨\nhaproxyã€keepalived æ–¹æ¡ˆå®ç°é›†ç¾¤å¤–è®¿é—®\nåœ¨æ­¤ä¹‹å‰å·²ç»ç”Ÿæˆk8sç›¸å…³è¯ä¹¦ è‹¥ä½¿ç”¨ nginxæ–¹æ¡ˆï¼Œé‚£ä¹ˆä¸º --server=https://127.0.0.1:8443\nè‹¥ä½¿ç”¨ haproxyã€keepalived é‚£ä¹ˆä¸º --server=https://192.168.100.100:9443\nnginxé«˜å¯ç”¨æ–¹æ¡ˆ ç¼–è¯‘nginx # å®‰è£…ç¼–è¯‘ç¯å¢ƒ yum install gcc -y # ä¸‹è½½è§£å‹nginxäºŒè¿›åˆ¶æ–‡ä»¶ # wget http://nginx.org/download/nginx-1.25.1.tar.gz tar xvf nginx-*.tar.gz cd nginx-* # è¿›è¡Œç¼–è¯‘ ./configure --with-stream --without-http --without-http_uwsgi_module --without-http_scgi_module --without-http_fastcgi_module make \u0026amp;\u0026amp; make install # æ‹·è´ç¼–è¯‘å¥½çš„nginx node=\u0026#39;k8s-master02 k8s-master03 k8s-node01 k8s-node02\u0026#39; for NODE in $node; do scp -r /usr/local/nginx/ $NODE:/usr/local/nginx/; done å†™å…¥å¯åŠ¨é…ç½® åœ¨æ‰€æœ‰masterä¸»æœºä¸Šæ‰§è¡Œ # å†™å…¥nginxé…ç½®æ–‡ä»¶ cat \u0026gt; /usr/local/nginx/conf/kube-nginx.conf \u0026lt;\u0026lt;EOF worker_processes 1; events { worker_connections 1024; } stream { upstream backend { least_conn; hash $remote_addr consistent; server 192.168.100.101:6443 max_fails=3 fail_timeout=30s; server 192.168.100.102:6443 max_fails=3 fail_timeout=30s; server 192.168.100.103:6443 max_fails=3 fail_timeout=30s; } server { listen 127.0.0.1:8443; proxy_connect_timeout 1s; proxy_pass backend; } } EOF # å†™å…¥å¯åŠ¨é…ç½®æ–‡ä»¶ cat \u0026gt; /etc/systemd/system/kube-nginx.service \u0026lt;\u0026lt;EOF [Unit] Description=kube-apiserver nginx proxy After=network.target After=network-online.target Wants=network-online.target [Service] Type=forking ExecStartPre=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx -t ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx ExecReload=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx -s reload PrivateTmp=true Restart=always RestartSec=5 StartLimitInterval=0 LimitNOFILE=65535 [Install] WantedBy=multi-user.target EOF # è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable --now kube-nginx systemctl restart kube-nginx systemctl status kube-nginx keepalivedå’Œhaproxyé«˜å¯ç”¨æ–¹æ¡ˆ å®‰è£…keepalivedå’ŒhaproxyæœåŠ¡ systemctl disable --now firewalld setenforce 0 sed -i \u0026#39;s#SELINUX=enforcing#SELINUX=disabled#g\u0026#39; /etc/selinux/config yum -y install keepalived haproxy ä¿®æ”¹haproxyé…ç½®æ–‡ä»¶(æ‰€æœ‰masterèŠ‚ç‚¹é…ç½®æ–‡ä»¶ä¸€æ ·) # cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak cat \u0026gt;/etc/haproxy/haproxy.cfg\u0026lt;\u0026lt;\u0026#34;EOF\u0026#34; global maxconn 2000 ulimit-n 16384 log 127.0.0.1 local0 err stats timeout 30s defaults log global mode http option httplog timeout connect 5000 timeout client 50000 timeout server 50000 timeout http-request 15s timeout http-keep-alive 15s frontend monitor-in bind *:33305 mode http option httplog monitor-uri /monitor frontend k8s-master bind 0.0.0.0:9443 bind 127.0.0.1:9443 mode tcp option tcplog tcp-request inspect-delay 5s default_backend k8s-master backend k8s-master mode tcp option tcplog option tcp-check balance roundrobin default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100 server k8s-master01 192.168.100.101:6443 check server k8s-master02 192.168.100.102:6443 check server k8s-master03 192.168.100.103:6443 check EOF master01é…ç½®keepalived masterèŠ‚ç‚¹ #cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak cat \u0026gt; /etc/keepalived/keepalived.conf \u0026lt;\u0026lt; EOF ! Configuration File for keepalived global_defs { router_id LVS_DEVEL } vrrp_script chk_apiserver { script \u0026#34;/etc/keepalived/check_apiserver.sh\u0026#34; interval 5 weight -5 fall 2 rise 1 } vrrp_instance VI_1 { state MASTER # æ³¨æ„ç½‘å¡å interface ens1 mcast_src_ip 192.168.100.101 virtual_router_id 51 priority 100 nopreempt advert_int 2 authentication { auth_type PASS auth_pass K8SHA_KA_AUTH } virtual_ipaddress { 192.168.100.100 } track_script { chk_apiserver } } EOF master02é…ç½®keepalived backupèŠ‚ç‚¹ # cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak cat \u0026gt; /etc/keepalived/keepalived.conf \u0026lt;\u0026lt; EOF ! Configuration File for keepalived global_defs { router_id LVS_DEVEL } vrrp_script chk_apiserver { script \u0026#34;/etc/keepalived/check_apiserver.sh\u0026#34; interval 5 weight -5 fall 2 rise 1 } vrrp_instance VI_1 { state BACKUP # æ³¨æ„ç½‘å¡å interface ens1 mcast_src_ip 192.168.100.102 virtual_router_id 51 priority 80 nopreempt advert_int 2 authentication { auth_type PASS auth_pass K8SHA_KA_AUTH } virtual_ipaddress { 192.168.100.100 } track_script { chk_apiserver } } EOF master03é…ç½®keepalived backupèŠ‚ç‚¹ # cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak cat \u0026gt; /etc/keepalived/keepalived.conf \u0026lt;\u0026lt; EOF ! Configuration File for keepalived global_defs { router_id LVS_DEVEL } vrrp_script chk_apiserver { script \u0026#34;/etc/keepalived/check_apiserver.sh\u0026#34; interval 5 weight -5 fall 2 rise 1 } vrrp_instance VI_1 { state BACKUP # æ³¨æ„ç½‘å¡å interface ens1 mcast_src_ip 192.168.100.103 virtual_router_id 51 priority 50 nopreempt advert_int 2 authentication { auth_type PASS auth_pass K8SHA_KA_AUTH } virtual_ipaddress { 192.168.100.100 } track_script { chk_apiserver } } EOF é…ç½®å¥åº·æ£€æŸ¥è„šæœ¬(keepalivedä¸»æœºä¸Šé…ç½®) cat \u0026gt; /etc/keepalived/check_apiserver.sh \u0026lt;\u0026lt; EOF #!/bin/bash err=0 for k in \\$(seq 1 3) do check_code=\\$(pgrep haproxy) if [[ \\$check_code == \u0026#34;\u0026#34; ]]; then err=\\$(expr \\$err + 1) sleep 1 continue else err=0 break fi done if [[ \\$err != \u0026#34;0\u0026#34; ]]; then echo \u0026#34;systemctl stop keepalived\u0026#34; /usr/bin/systemctl stop keepalived exit 1 else exit 0 fi EOF # ç»™è„šæœ¬æ‰§è¡Œæƒé™ chmod +x /etc/keepalived/check_apiserver.sh å¯åŠ¨æœåŠ¡ systemctl daemon-reload systemctl enable --now haproxy systemctl enable --now keepalived æµ‹è¯•é«˜å¯ç”¨ # èƒ½pingé€š # ping 192.168.100.100 # èƒ½telnetè®¿é—® # telnet 192.168.100.100 9443 # å…³é—­ä¸»èŠ‚ç‚¹ï¼Œçœ‹vipæ˜¯å¦æ¼‚ç§»åˆ°å¤‡èŠ‚ç‚¹ k8sç»„ä»¶é…ç½® æ‰€æœ‰k8sèŠ‚ç‚¹åˆ›å»ºä»¥ä¸‹ç›®å½• mkdir -p /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/log/kubernetes åˆ›å»ºapiserver(æ‰€æœ‰masterèŠ‚ç‚¹) master01èŠ‚ç‚¹é…ç½® cat \u0026gt; /usr/lib/systemd/system/kube-apiserver.service \u0026lt;\u0026lt;EOF [Unit] Description=Kubernetes API Server Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=/usr/local/bin/kube-apiserver \\\\ --v=2 \\\\ --allow-privileged=true \\\\ --bind-address=0.0.0.0 \\\\ --secure-port=6443 \\\\ --advertise-address=192.168.100.101 \\\\ --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112 \\\\ --service-node-port-range=30000-32767 \\\\ --etcd-servers=https://192.168.100.101:2379,https://192.168.100.102:2379,https://192.168.100.103:2379 \\\\ --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \\\\ --etcd-certfile=/etc/etcd/ssl/etcd.pem \\\\ --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \\\\ --client-ca-file=/etc/kubernetes/pki/ca.pem \\\\ --tls-cert-file=/etc/kubernetes/pki/apiserver.pem \\\\ --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem \\\\ --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem \\\\ --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem \\\\ --service-account-key-file=/etc/kubernetes/pki/sa.pub \\\\ --service-account-signing-key-file=/etc/kubernetes/pki/sa.key \\\\ --service-account-issuer=https://kubernetes.default.svc.cluster.local \\\\ --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \\\\ --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota \\ --authorization-mode=Node,RBAC \\\\ --enable-bootstrap-token-auth=true \\\\ --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \\\\ --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem \\\\ --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem \\\\ --requestheader-allowed-names=aggregator \\\\ --requestheader-group-headers=X-Remote-Group \\\\ --requestheader-extra-headers-prefix=X-Remote-Extra- \\\\ --requestheader-username-headers=X-Remote-User \\\\ --enable-aggregator-routing=true Restart=on-failure RestartSec=10s LimitNOFILE=65535 [Install] WantedBy=multi-user.target EOF master02èŠ‚ç‚¹é…ç½® cat \u0026gt; /usr/lib/systemd/system/kube-apiserver.service \u0026lt;\u0026lt;EOF [Unit] Description=Kubernetes API Server Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=/usr/local/bin/kube-apiserver \\\\ --v=2 \\\\ --allow-privileged=true \\\\ --bind-address=0.0.0.0 \\\\ --secure-port=6443 \\\\ --advertise-address=192.168.100.102 \\\\ --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112 \\\\ --service-node-port-range=30000-32767 \\\\ --etcd-servers=https://192.168.100.101:2379,https://192.168.100.102:2379,https://192.168.100.103:2379 \\\\ --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \\\\ --etcd-certfile=/etc/etcd/ssl/etcd.pem \\\\ --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \\\\ --client-ca-file=/etc/kubernetes/pki/ca.pem \\\\ --tls-cert-file=/etc/kubernetes/pki/apiserver.pem \\\\ --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem \\\\ --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem \\\\ --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem \\\\ --service-account-key-file=/etc/kubernetes/pki/sa.pub \\\\ --service-account-signing-key-file=/etc/kubernetes/pki/sa.key \\\\ --service-account-issuer=https://kubernetes.default.svc.cluster.local \\\\ --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \\\\ --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota \\ --authorization-mode=Node,RBAC \\\\ --enable-bootstrap-token-auth=true \\\\ --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \\\\ --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem \\\\ --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem \\\\ --requestheader-allowed-names=aggregator \\\\ --requestheader-group-headers=X-Remote-Group \\\\ --requestheader-extra-headers-prefix=X-Remote-Extra- \\\\ --requestheader-username-headers=X-Remote-User \\\\ --enable-aggregator-routing=true Restart=on-failure RestartSec=10s LimitNOFILE=65535 [Install] WantedBy=multi-user.target EOF master03èŠ‚ç‚¹é…ç½® cat \u0026gt; /usr/lib/systemd/system/kube-apiserver.service \u0026lt;\u0026lt;EOF [Unit] Description=Kubernetes API Server Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=/usr/local/bin/kube-apiserver \\\\ --v=2 \\\\ --allow-privileged=true \\\\ --bind-address=0.0.0.0 \\\\ --secure-port=6443 \\\\ --advertise-address=192.168.100.103 \\\\ --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112 \\\\ --service-node-port-range=30000-32767 \\\\ --etcd-servers=https://192.168.100.101:2379,https://192.168.100.102:2379,https://192.168.100.103:2379 \\\\ --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \\\\ --etcd-certfile=/etc/etcd/ssl/etcd.pem \\\\ --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \\\\ --client-ca-file=/etc/kubernetes/pki/ca.pem \\\\ --tls-cert-file=/etc/kubernetes/pki/apiserver.pem \\\\ --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem \\\\ --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem \\\\ --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem \\\\ --service-account-key-file=/etc/kubernetes/pki/sa.pub \\\\ --service-account-signing-key-file=/etc/kubernetes/pki/sa.key \\\\ --service-account-issuer=https://kubernetes.default.svc.cluster.local \\\\ --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \\\\ --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota \\ --authorization-mode=Node,RBAC \\\\ --enable-bootstrap-token-auth=true \\\\ --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \\\\ --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem \\\\ --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem \\\\ --requestheader-allowed-names=aggregator \\\\ --requestheader-group-headers=X-Remote-Group \\\\ --requestheader-extra-headers-prefix=X-Remote-Extra- \\\\ --requestheader-username-headers=X-Remote-User \\\\ --enable-aggregator-routing=true Restart=on-failure RestartSec=10s LimitNOFILE=65535 [Install] WantedBy=multi-user.target EOF å¯åŠ¨apiserver(æ‰€æœ‰masterèŠ‚ç‚¹) systemctl daemon-reload systemctl enable --now kube-apiserver systemctl restart kube-apiserver systemctl status kube-apiserver é…ç½®kube-controller-manager service # æ‰€æœ‰masterèŠ‚ç‚¹é…ç½®ï¼Œä¸”é…ç½®ç›¸åŒ # 172.16.0.0/12ä¸ºpodç½‘æ®µï¼ŒæŒ‰éœ€æ±‚è®¾ç½®ä½ è‡ªå·±çš„ç½‘æ®µ cat \u0026gt; /usr/lib/systemd/system/kube-controller-manager.service \u0026lt;\u0026lt; EOF [Unit] Description=Kubernetes Controller Manager Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=/usr/local/bin/kube-controller-manager \\\\ --v=2 \\\\ --bind-address=0.0.0.0 \\\\ --root-ca-file=/etc/kubernetes/pki/ca.pem \\\\ --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \\\\ --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \\\\ --service-account-private-key-file=/etc/kubernetes/pki/sa.key \\\\ --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \\\\ --leader-elect=true \\\\ --use-service-account-credentials=true \\\\ --node-monitor-grace-period=40s \\\\ --node-monitor-period=5s \\\\ --controllers=*,bootstrapsigner,tokencleaner \\\\ --allocate-node-cidrs=true \\\\ --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112 \\\\ --cluster-cidr=172.16.0.0/12,fc00:2222::/112 \\\\ --node-cidr-mask-size-ipv4=24 \\\\ --node-cidr-mask-size-ipv6=120 \\\\ --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem Restart=always RestartSec=10s [Install] WantedBy=multi-user.target EOF å¯åŠ¨kube-controller-manager systemctl daemon-reload systemctl enable --now kube-controller-manager systemctl restart kube-controller-manager systemctl status kube-controller-manager é…ç½®kube-scheduler service æ‰€æœ‰masterèŠ‚ç‚¹é…ç½®ï¼Œä¸”é…ç½®ç›¸åŒ cat \u0026gt; /usr/lib/systemd/system/kube-scheduler.service \u0026lt;\u0026lt; EOF [Unit] Description=Kubernetes Scheduler Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=/usr/local/bin/kube-scheduler \\\\ --v=2 \\\\ --bind-address=0.0.0.0 \\\\ --leader-elect=true \\\\ --kubeconfig=/etc/kubernetes/scheduler.kubeconfig Restart=always RestartSec=10s [Install] WantedBy=multi-user.target EOF å¯åŠ¨å¹¶æŸ¥çœ‹æœåŠ¡çŠ¶æ€ systemctl daemon-reload systemctl enable --now kube-scheduler systemctl restart kube-scheduler systemctl status kube-scheduler TLS Bootstrappingé…ç½® åœ¨master01ä¸Šé…ç½® åœ¨é«˜å¯ç”¨é…ç½®éƒ¨åˆ†é€‰æ‹©ä½¿ç”¨å“ªç§é«˜å¯ç”¨æ–¹æ¡ˆ è‹¥ä½¿ç”¨ haproxyã€keepalived é‚£ä¹ˆä¸º --server=https://192.168.100.100:9443 è‹¥ä½¿ç”¨ nginxæ–¹æ¡ˆï¼Œé‚£ä¹ˆä¸º --server=https://127.0.0.1:8443 cd bootstrap cat \u0026gt; bootstrap.secret.yaml \u0026lt;\u0026lt;EOF apiVersion: v1 kind: Secret metadata: name: bootstrap-token-c8ad9c namespace: kube-system type: bootstrap.kubernetes.io/token stringData: description: \u0026#34;The default bootstrap token generated by \u0026#39;kubelet \u0026#39;.\u0026#34; token-id: c8ad9c token-secret: 2e4d610cf3e7426e usage-bootstrap-authentication: \u0026#34;true\u0026#34; usage-bootstrap-signing: \u0026#34;true\u0026#34; auth-extra-groups: system:bootstrappers:default-node-token,system:bootstrappers:worker,system:bootstrappers:ingress --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: kubelet-bootstrap roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:node-bootstrapper subjects: - apiGroup: rbac.authorization.k8s.io kind: Group name: system:bootstrappers:default-node-token --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: node-autoapprove-bootstrap roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:certificates.k8s.io:certificatesigningrequests:nodeclient subjects: - apiGroup: rbac.authorization.k8s.io kind: Group name: system:bootstrappers:default-node-token --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: node-autoapprove-certificate-rotation roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient subjects: - apiGroup: rbac.authorization.k8s.io kind: Group name: system:nodes --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: annotations: rbac.authorization.kubernetes.io/autoupdate: \u0026#34;true\u0026#34; labels: kubernetes.io/bootstrapping: rbac-defaults name: system:kube-apiserver-to-kubelet rules: - apiGroups: - \u0026#34;\u0026#34; resources: - nodes/proxy - nodes/stats - nodes/log - nodes/spec - nodes/metrics verbs: - \u0026#34;*\u0026#34; --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: system:kube-apiserver namespace: \u0026#34;\u0026#34; roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:kube-apiserver-to-kubelet subjects: - apiGroup: rbac.authorization.k8s.io kind: User name: kube-apiserver EOF kubectl config set-cluster kubernetes \\ --certificate-authority=/etc/kubernetes/pki/ca.pem \\ --embed-certs=true --server=https://127.0.0.1:8443 \\ --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig kubectl config set-credentials tls-bootstrap-token-user \\ --token=c8ad9c.2e4d610cf3e7426e \\ --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig kubectl config set-context tls-bootstrap-token-user@kubernetes \\ --cluster=kubernetes \\ --user=tls-bootstrap-token-user \\ --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig kubectl config use-context tls-bootstrap-token-user@kubernetes \\ --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig # tokençš„ä½ç½®åœ¨bootstrap.secret.yamlï¼Œå¦‚æœä¿®æ”¹çš„è¯åˆ°è¿™ä¸ªæ–‡ä»¶ä¿®æ”¹ mkdir -pv /root/.kube ; cp /etc/kubernetes/admin.kubeconfig /root/.kube/config # æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼Œæ²¡é—®é¢˜çš„è¯ç»§ç»­åç»­æ“ä½œ # kubectl get cs Warning: v1 ComponentStatus is deprecated in v1.19+ NAME STATUS MESSAGE ERROR controller-manager Healthy ok scheduler Healthy ok etcd-1 Healthy etcd-0 Healthy etcd-2 Healthy # é›†ç¾¤æ­£å¸¸åæ‰§è¡Œä»¥ä¸‹æ“ä½œ kubectl create -f bootstrap.secret.yaml nodeèŠ‚ç‚¹é…ç½® åœ¨master01ä¸Šå°†è¯ä¹¦å¤åˆ¶åˆ°nodeèŠ‚ç‚¹ cd /etc/kubernetes/ for NODE in k8s-master02 k8s-master03 k8s-node01 k8s-node02; do ssh $NODE mkdir -p /etc/kubernetes/pki; for FILE in pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig kube-proxy.kubeconfig; do scp /etc/kubernetes/$FILE $NODE:/etc/kubernetes/${FILE}; done; done kubeleté…ç½® å½“ä½¿ç”¨dockerä½œä¸ºRuntime cat \u0026gt; /usr/lib/systemd/system/kubelet.service \u0026lt;\u0026lt;EOF [Unit] Description=Kubernetes Kubelet Documentation=https://github.com/kubernetes/kubernetes [Service] ExecStart=/usr/local/bin/kubelet \\\\ --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig \\\\ --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\\\ --config=/etc/kubernetes/kubelet-conf.yml \\\\ --container-runtime-endpoint=unix:///run/cri-dockerd.sock \\\\ --node-labels=node.kubernetes.io/node= [Install] WantedBy=multi-user.target EOF å½“ä½¿ç”¨Containerdä½œä¸ºRuntime (æ¨è) mkdir -p /var/lib/kubelet /var/log/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/ # æ‰€æœ‰k8sèŠ‚ç‚¹é…ç½®kubelet service cat \u0026gt; /usr/lib/systemd/system/kubelet.service \u0026lt;\u0026lt; EOF [Unit] Description=Kubernetes Kubelet Documentation=https://github.com/kubernetes/kubernetes After=containerd.service Requires=containerd.service [Service] ExecStart=/usr/local/bin/kubelet \\\\ --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig \\\\ --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\\\ --config=/etc/kubernetes/kubelet-conf.yml \\\\ --container-runtime-endpoint=unix:///run/containerd/containerd.sock \\\\ --node-labels=node.kubernetes.io/node= [Install] WantedBy=multi-user.target EOF æ‰€æœ‰k8sèŠ‚ç‚¹åˆ›å»ºkubeletçš„é…ç½®æ–‡ä»¶ cat \u0026gt; /etc/kubernetes/kubelet-conf.yml \u0026lt;\u0026lt;EOF apiVersion: kubelet.config.k8s.io/v1beta1 kind: KubeletConfiguration address: 0.0.0.0 port: 10250 readOnlyPort: 10255 authentication: anonymous: enabled: false webhook: cacheTTL: 2m0s enabled: true x509: clientCAFile: /etc/kubernetes/pki/ca.pem authorization: mode: Webhook webhook: cacheAuthorizedTTL: 5m0s cacheUnauthorizedTTL: 30s cgroupDriver: systemd cgroupsPerQOS: true clusterDNS: - 10.96.0.10 clusterDomain: cluster.local containerLogMaxFiles: 5 containerLogMaxSize: 10Mi contentType: application/vnd.kubernetes.protobuf cpuCFSQuota: true cpuManagerPolicy: none cpuManagerReconcilePeriod: 10s enableControllerAttachDetach: true enableDebuggingHandlers: true enforceNodeAllocatable: - pods eventBurst: 10 eventRecordQPS: 5 evictionHard: imagefs.available: 15% memory.available: 100Mi nodefs.available: 10% nodefs.inodesFree: 5% evictionPressureTransitionPeriod: 5m0s failSwapOn: true fileCheckFrequency: 20s hairpinMode: promiscuous-bridge healthzBindAddress: 127.0.0.1 healthzPort: 10248 httpCheckFrequency: 20s imageGCHighThresholdPercent: 85 imageGCLowThresholdPercent: 80 imageMinimumGCAge: 2m0s iptablesDropBit: 15 iptablesMasqueradeBit: 14 kubeAPIBurst: 10 kubeAPIQPS: 5 makeIPTablesUtilChains: true maxOpenFiles: 1000000 maxPods: 110 nodeStatusUpdateFrequency: 10s oomScoreAdj: -999 podPidsLimit: -1 registryBurst: 10 registryPullQPS: 5 resolvConf: /etc/resolv.conf rotateCertificates: true runtimeRequestTimeout: 2m0s serializeImagePulls: true staticPodPath: /etc/kubernetes/manifests streamingConnectionIdleTimeout: 4h0m0s syncFrequency: 1m0s volumeStatsAggPeriod: 1m0s EOF å¯åŠ¨kubelet systemctl daemon-reload systemctl enable --now kubelet systemctl restart kubelet systemctl status kubelet æŸ¥çœ‹é›†ç¾¤ # kubectl get node NAME STATUS ROLES AGE VERSION k8s-master01 Ready \u0026lt;none\u0026gt; 13d v1.27.6 k8s-master02 Ready \u0026lt;none\u0026gt; 13d v1.27.6 k8s-master03 Ready \u0026lt;none\u0026gt; 13d v1.27.6 k8s-node01 Ready \u0026lt;none\u0026gt; 13d v1.27.6 k8s-node02 Ready \u0026lt;none\u0026gt; 13d v1.27.6 æŸ¥çœ‹å®¹å™¨è¿è¡Œæ—¶ # containerd # kubectl describe node | grep Runtime Container Runtime Version: containerd://1.7.6 Container Runtime Version: containerd://1.7.6 Container Runtime Version: containerd://1.7.6 Container Runtime Version: containerd://1.7.6 Container Runtime Version: containerd://1.7.6 # docker # kubectl describe node | grep Runtime Container Runtime Version: docker://24.0.2 Container Runtime Version: docker://24.0.2 Container Runtime Version: docker://24.0.2 Container Runtime Version: docker://24.0.2 Container Runtime Version: docker://24.0.2 kube-proxyé…ç½® å°†kubeconfigå‘é€è‡³å…¶ä»–èŠ‚ç‚¹ for NODE in k8s-master02 k8s-master03 k8s-node01 k8s-node02; do scp /etc/kubernetes/kube-proxy.kubeconfig $NODE:/etc/kubernetes/kube-proxy.kubeconfig; done æ‰€æœ‰k8sèŠ‚ç‚¹æ·»åŠ kube-proxyçš„serviceæ–‡ä»¶ cat \u0026gt; /usr/lib/systemd/system/kube-proxy.service \u0026lt;\u0026lt; EOF [Unit] Description=Kubernetes Kube Proxy Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=/usr/local/bin/kube-proxy \\\\ --config=/etc/kubernetes/kube-proxy.yaml \\\\ --v=2 Restart=always RestartSec=10s [Install] WantedBy=multi-user.target EOF æ‰€æœ‰k8sèŠ‚ç‚¹æ·»åŠ kube-proxyçš„é…ç½® cat \u0026gt; /etc/kubernetes/kube-proxy.yaml \u0026lt;\u0026lt; EOF apiVersion: kubeproxy.config.k8s.io/v1alpha1 bindAddress: 0.0.0.0 clientConnection: acceptContentTypes: \u0026#34;\u0026#34; burst: 10 contentType: application/vnd.kubernetes.protobuf kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig qps: 5 clusterCIDR: 172.16.0.0/12,fc00:2222::/112 configSyncPeriod: 15m0s conntrack: max: null maxPerCore: 32768 min: 131072 tcpCloseWaitTimeout: 1h0m0s tcpEstablishedTimeout: 24h0m0s enableProfiling: false healthzBindAddress: 0.0.0.0:10256 hostnameOverride: \u0026#34;\u0026#34; iptables: masqueradeAll: false masqueradeBit: 14 minSyncPeriod: 0s syncPeriod: 30s ipvs: masqueradeAll: true minSyncPeriod: 5s scheduler: \u0026#34;rr\u0026#34; syncPeriod: 30s kind: KubeProxyConfiguration metricsBindAddress: 127.0.0.1:10249 mode: \u0026#34;ipvs\u0026#34; nodePortAddresses: null oomScoreAdj: -999 portRange: \u0026#34;\u0026#34; udpIdleTimeout: 250ms EOF å¯åŠ¨kube-proxy systemctl daemon-reload systemctl restart kube-proxy systemctl enable --now kube-proxy systemctl status kube-proxy å®‰è£…ç½‘ç»œæ’ä»¶ æ³¨æ„: ç½‘ç»œæ’ä»¶calicoå’ŒciliumäºŒé€‰ä¸€å³å¯ å‡çº§runc(å¯é€‰) # https://github.com/opencontainers/runc/releases # å‡çº§runc # wget https://ghproxy.com/https://github.com/opencontainers/runc/releases/download/v1.1.4/runc.amd64 install -m 755 runc.amd64 /usr/local/sbin/runc cp -p /usr/local/sbin/runc /usr/local/bin/runc cp -p /usr/local/sbin/runc /usr/bin/runc å®‰è£…Calico æ›´æ”¹calicoç½‘æ®µ wget https://ghproxy.com/https://github.com/projectcalico/calico/blob/master/manifests/calico-typha.yaml cp calico-typha.yaml calico.yaml cp calico-typha.yaml calico-ipv6.yaml # vi calico.yaml # éœ€è¦æ›´æ–°ä»¥ä¸‹é…ç½®ï¼š \u0026#34;ipam\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;calico-ipam\u0026#34;, }, - name: IP value: \u0026#34;autodetect\u0026#34; - name: CALICO_IPV4POOL_CIDR value: \u0026#34;172.16.0.0/12\u0026#34; # vi calico-ipv6.yaml # éœ€è¦æ›´æ–°ä»¥ä¸‹é…ç½®ï¼š \u0026#34;ipam\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;calico-ipam\u0026#34;, \u0026#34;assign_ipv4\u0026#34;: \u0026#34;true\u0026#34;, \u0026#34;assign_ipv6\u0026#34;: \u0026#34;true\u0026#34; }, - name: IP value: \u0026#34;autodetect\u0026#34; - name: IP6 value: \u0026#34;autodetect\u0026#34; - name: CALICO_IPV4POOL_CIDR value: \u0026#34;172.16.0.0/12\u0026#34; - name: CALICO_IPV6POOL_CIDR value: \u0026#34;fc00::/48\u0026#34; - name: FELIX_IPV6SUPPORT value: \u0026#34;true\u0026#34; # è‹¥dockeré•œåƒæ‹‰ä¸ä¸‹æ¥ï¼Œå¯ä»¥ä½¿ç”¨å›½å†…çš„ä»“åº“ sed -i \u0026#34;s#docker.io/calico/#m.daocloud.io/docker.io/calico/#g\u0026#34; calico.yaml sed -i \u0026#34;s#docker.io/calico/#m.daocloud.io/docker.io/calico/#g\u0026#34; calico-ipv6.yaml # æœ¬åœ°æ²¡æœ‰å…¬ç½‘ IPv6 ä½¿ç”¨ calico.yaml kubectl apply -f calico.yaml # æœ¬åœ°æœ‰å…¬ç½‘ IPv6 ä½¿ç”¨ calico-ipv6.yaml kubectl apply -f calico-ipv6.yaml æŸ¥çœ‹å®¹å™¨çŠ¶æ€ # calico åˆå§‹åŒ–ä¼šå¾ˆæ…¢ éœ€è¦è€å¿ƒç­‰å¾…ä¸€ä¸‹ # kubectl get pod -A NAMESPACE NAME READY STATUS RESTARTS AGE kube-system calico-kube-controllers-76754ff848-gmx8n 1/1 Running 3 (29h ago) 13d kube-system calico-node-845jj 1/1 Running 2 (47h ago) 13d kube-system calico-node-m7p9n 1/1 Running 2 (47h ago) 13d kube-system calico-node-qqj7g 1/1 Running 2 (47h ago) 13d kube-system calico-node-rfq9m 1/1 Running 4 (11m ago) 13d kube-system calico-node-tdnmt 1/1 Running 3 (29h ago) 13d kube-system calico-typha-59d75c5dd4-8fg4d 1/1 Running 2 (47h ago) 13d å®‰è£…cilium(ç¤ºä¾‹) å®‰è£…helm(ç¤ºä¾‹) # curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 # chmod 700 get_helm.sh # ./get_helm.sh wget https://files.m.daocloud.io/get.helm.sh/helm-v3.12.1-linux-amd64.tar.gz tar xvf helm-*-linux-amd64.tar.gz cp linux-amd64/helm /usr/local/bin/ å®‰è£…(ç¤ºä¾‹) # æ·»åŠ æº helm repo add cilium https://helm.cilium.io # ä¿®æ”¹ä¸ºå›½å†…æº helm pull cilium/cilium tar xvf cilium-*.tgz cd cilium/ sed -i \u0026#34;s#quay.io/#m.daocloud.io/quay.io/#g\u0026#34; values.yaml # é»˜è®¤å‚æ•°å®‰è£… helm install cilium ./cilium/ -n kube-system # å¯ç”¨ipv6 # helm install cilium cilium/cilium --namespace kube-system --set ipv6.enabled=true # å¯ç”¨è·¯ç”±ä¿¡æ¯å’Œç›‘æ§æ’ä»¶ # helm install cilium cilium/cilium --namespace kube-system --set hubble.relay.enabled=true --set hubble.ui.enabled=true --set prometheus.enabled=true --set operator.prometheus.enabled=true --set hubble.enabled=true --set hubble.metrics.enabled=\u0026#34;{dns,drop,tcp,flow,port-distribution,icmp,http}\u0026#34; æŸ¥çœ‹(ç¤ºä¾‹) # kubectl get pod -A | grep cilium kube-system cilium-gmr6c 1/1 Running 0 5m3s kube-system cilium-kzgdj 1/1 Running 0 5m3s kube-system cilium-operator-69b677f97c-6pw4k 1/1 Running 0 5m3s kube-system cilium-operator-69b677f97c-xzzdk 1/1 Running 0 5m3s kube-system cilium-q2rnr 1/1 Running 0 5m3s kube-system cilium-smx5v 1/1 Running 0 5m3s kube-system cilium-tdjq4 1/1 Running 0 5m3s ä¸‹è½½ä¸“å±ç›‘æ§é¢æ¿(ç¤ºä¾‹) # wget https://ghproxy.com/https://raw.githubusercontent.com/cilium/cilium/1.12.1/examples/kubernetes/addons/prometheus/monitoring-example.yaml # sed -i \u0026#34;s#docker.io/#m.daocloud.io/docker.io/#g\u0026#34; monitoring-example.yaml # kubectl apply -f monitoring-example.yaml namespace/cilium-monitoring created serviceaccount/prometheus-k8s created configmap/grafana-config created configmap/grafana-cilium-dashboard created configmap/grafana-cilium-operator-dashboard created configmap/grafana-hubble-dashboard created configmap/prometheus created clusterrole.rbac.authorization.k8s.io/prometheus created clusterrolebinding.rbac.authorization.k8s.io/prometheus created service/grafana created service/prometheus created deployment.apps/grafana created deployment.apps/prometheus created ä¸‹è½½éƒ¨ç½²æµ‹è¯•ç”¨ä¾‹(ç¤ºä¾‹) è¯´æ˜ æµ‹è¯•ç”¨ä¾‹ éœ€è¦åœ¨ å®‰è£…CoreDNS ä¹‹åå®Œæˆ # wget https://ghproxy.com/https://raw.githubusercontent.com/cilium/cilium/master/examples/kubernetes/connectivity-check/connectivity-check.yaml # sed -i \u0026#34;s#google.com#baidu.cn#g\u0026#34; connectivity-check.yaml sed -i \u0026#34;s#quay.io/#m.daocloud.io/quay.io/#g\u0026#34; connectivity-check.yaml # kubectl apply -f connectivity-check.yaml deployment.apps/echo-a created deployment.apps/echo-b created deployment.apps/echo-b-host created deployment.apps/pod-to-a created deployment.apps/pod-to-external-1111 created deployment.apps/pod-to-a-denied-cnp created deployment.apps/pod-to-a-allowed-cnp created deployment.apps/pod-to-external-fqdn-allow-google-cnp created deployment.apps/pod-to-b-multi-node-clusterip created deployment.apps/pod-to-b-multi-node-headless created deployment.apps/host-to-b-multi-node-clusterip created deployment.apps/host-to-b-multi-node-headless created deployment.apps/pod-to-b-multi-node-nodeport created deployment.apps/pod-to-b-intra-node-nodeport created service/echo-a created service/echo-b created service/echo-b-headless created service/echo-b-host-headless created ciliumnetworkpolicy.cilium.io/pod-to-a-denied-cnp created ciliumnetworkpolicy.cilium.io/pod-to-a-allowed-cnp created ciliumnetworkpolicy.cilium.io/pod-to-external-fqdn-allow-google-cnp created æŸ¥çœ‹pod(ç¤ºä¾‹) # kubectl get pod -A NAMESPACE NAME READY STATUS RESTARTS AGE cilium-monitoring grafana-59957b9549-6zzqh 1/1 Running 0 10m cilium-monitoring prometheus-7c8c9684bb-4v9cl 1/1 Running 0 10m default test-75b5d7fbfb-7zjsr 1/1 Running 0 27h default test-75b5d7fbfb-hbvr8 1/1 Running 0 27h default test-75b5d7fbfb-ppbzg 1/1 Running 0 27h default echo-a-6799dff547-pnx6w 1/1 Running 0 10m default echo-b-fc47b659c-4bdg9 1/1 Running 0 10m default echo-b-host-67fcfd59b7-28r9s 1/1 Running 0 10m default host-to-b-multi-node-clusterip-69c57975d6-z4j2z 1/1 Running 0 10m default host-to-b-multi-node-headless-865899f7bb-frrmc 1/1 Running 0 10m default pod-to-a-allowed-cnp-5f9d7d4b9d-hcd8x 1/1 Running 0 10m default pod-to-a-denied-cnp-65cc5ff97b-2rzb8 1/1 Running 0 10m default pod-to-a-dfc64f564-p7xcn 1/1 Running 0 10m default pod-to-b-intra-node-nodeport-677868746b-trk2l 1/1 Running 0 10m default pod-to-b-multi-node-clusterip-76bbbc677b-knfq2 1/1 Running 0 10m default pod-to-b-multi-node-headless-698c6579fd-mmvd7 1/1 Running 0 10m default pod-to-b-multi-node-nodeport-5dc4b8cfd6-8dxmz 1/1 Running 0 10m default pod-to-external-1111-8459965778-pjt9b 1/1 Running 0 10m default pod-to-external-fqdn-allow-google-cnp-64df9fb89b-l9l4q 1/1 Running 0 10m kube-system cilium-7rfj6 1/1 Running 0 56s kube-system cilium-d4cch 1/1 Running 0 56s kube-system cilium-h5x8r 1/1 Running 0 56s kube-system cilium-operator-5dbddb6dbf-flpl5 1/1 Running 0 56s kube-system cilium-operator-5dbddb6dbf-gcznc 1/1 Running 0 56s kube-system cilium-t2xlz 1/1 Running 0 56s kube-system cilium-z65z7 1/1 Running 0 56s kube-system coredns-665475b9f8-jkqn8 1/1 Running 1 (36h ago) 36h kube-system hubble-relay-59d8575-9pl9z 1/1 Running 0 56s kube-system hubble-ui-64d4995d57-nsv9j 2/2 Running 0 56s kube-system metrics-server-776f58c94b-c6zgs 1/1 Running 1 (36h ago) 37h ä¿®æ”¹ä¸ºNodePort(ç¤ºä¾‹) # kubectl edit svc -n kube-system hubble-ui service/hubble-ui edited # kubectl edit svc -n cilium-monitoring grafana service/grafana edited # kubectl edit svc -n cilium-monitoring prometheus service/prometheus edited type: NodePort æŸ¥çœ‹ç«¯å£(ç¤ºä¾‹) # kubectl get svc -A | grep monit cilium-monitoring grafana NodePort 10.100.250.17 \u0026lt;none\u0026gt; 3000:30707/TCP 15m cilium-monitoring prometheus NodePort 10.100.131.243 \u0026lt;none\u0026gt; 9090:31155/TCP 15m # kubectl get svc -A | grep hubble kube-system hubble-metrics ClusterIP None \u0026lt;none\u0026gt; 9965/TCP 5m12s kube-system hubble-peer ClusterIP 10.100.150.29 \u0026lt;none\u0026gt; 443/TCP 5m12s kube-system hubble-relay ClusterIP 10.109.251.34 \u0026lt;none\u0026gt; 80/TCP 5m12s kube-system hubble-ui NodePort 10.102.253.59 \u0026lt;none\u0026gt; 80:31219/TCP 5m12s è®¿é—®(ç¤ºä¾‹) http://192.168.100.101:30707 http://192.168.100.101:31155 http://192.168.100.101:31219 å®‰è£…CoreDNS ä»¥ä¸‹æ­¥éª¤åªåœ¨master01æ“ä½œ ä¿®æ”¹æ–‡ä»¶ # ä¸‹è½½tgzåŒ… helm repo add coredns https://coredns.github.io/helm helm pull coredns/coredns tar xvf coredns-*.tgz cd coredns/ # ä¿®æ”¹IPåœ°å€ vi values.yaml cat values.yaml | grep clusterIP: clusterIP: \u0026#34;10.96.0.10\u0026#34; # ç¤ºä¾‹ --- service: # clusterIP: \u0026#34;\u0026#34; # clusterIPs: [] # loadBalancerIP: \u0026#34;\u0026#34; # externalIPs: [] # externalTrafficPolicy: \u0026#34;\u0026#34; # ipFamilyPolicy: \u0026#34;\u0026#34; # The name of the Service # If not set, a name is generated using the fullname template clusterIP: \u0026#34;10.96.0.10\u0026#34; name: \u0026#34;\u0026#34; annotations: {} --- # ä¿®æ”¹ä¸ºå›½å†…æº dockeræºå¯é€‰ sed -i \u0026#34;s#coredns/#m.daocloud.io/docker.io/coredns/#g\u0026#34; values.yaml sed -i \u0026#34;s#registry.k8s.io/#m.daocloud.io/registry.k8s.io/#g\u0026#34; values.yaml # é»˜è®¤å‚æ•°å®‰è£… helm install coredns ./coredns/ -n kube-system å®‰è£…Metrics Server ä»¥ä¸‹æ­¥éª¤åªåœ¨master01æ“ä½œ å®‰è£… åœ¨æ–°ç‰ˆçš„Kubernetesä¸­ç³»ç»Ÿèµ„æºçš„é‡‡é›†å‡ä½¿ç”¨Metrics-serverï¼Œå¯ä»¥é€šè¿‡Metricsé‡‡é›†èŠ‚ç‚¹å’ŒPodçš„å†…å­˜ã€ç£ç›˜ã€CPUå’Œç½‘ç»œçš„ä½¿ç”¨ç‡\n# å•æœºç‰ˆ wget https://ghproxy.com/https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml # é«˜å¯ç”¨ç‰ˆæœ¬ wget https://ghproxy.com/https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/high-availability.yaml # ä¿®æ”¹é…ç½® vim components.yaml vim high-availability.yaml --- # 1 defaultArgs: - --cert-dir=/tmp - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname - --kubelet-use-node-status-port - --metric-resolution=15s - --kubelet-insecure-tls - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem - --requestheader-username-headers=X-Remote-User - --requestheader-group-headers=X-Remote-Group - --requestheader-extra-headers-prefix=X-Remote-Extra- # 2 volumeMounts: - mountPath: /tmp name: tmp-dir - name: ca-ssl mountPath: /etc/kubernetes/pki # 3 volumes: - emptyDir: {} name: tmp-dir - name: ca-ssl hostPath: path: /etc/kubernetes/pki --- # ä¿®æ”¹ä¸ºå›½å†…æº dockeræºå¯é€‰ sed -i \u0026#34;s#registry.k8s.io/#m.daocloud.io/registry.k8s.io/#g\u0026#34; *.yaml # äºŒé€‰ä¸€ kubectl apply -f components.yaml # kubectl apply -f high-availability.yaml æŸ¥çœ‹çŠ¶æ€ # kubectl top node NAME CPU(cores) CPU% MEMORY(bytes) MEMORY% k8s-master01 94m 2% 1344Mi 35% k8s-master02 98m 2% 1412Mi 36% k8s-master03 87m 2% 1351Mi 35% k8s-node01 51m 1% 756Mi 19% k8s-node02 57m 1% 475Mi 12% é›†ç¾¤éªŒè¯ éƒ¨ç½²podèµ„æº cat\u0026lt;\u0026lt;EOF | kubectl apply -f - apiVersion: v1 kind: Pod metadata: name: busybox namespace: default spec: containers: - name: busybox image: docker.io/library/busybox:1.28 command: - sleep - \u0026#34;3600\u0026#34; imagePullPolicy: IfNotPresent restartPolicy: Always EOF # æŸ¥çœ‹ # kubectl get pod NAME READY STATUS RESTARTS AGE busybox 1/1 Running 0 17s ç”¨podè§£æé»˜è®¤å‘½åç©ºé—´ä¸­çš„kubernetes # æŸ¥çœ‹name # kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.96.0.1 \u0026lt;none\u0026gt; 443/TCP 14d # è¿›è¡Œè§£æ # kubectl exec busybox -n default -- nslookup kubernetes Server: 10.96.0.10 Address 1: 10.96.0.10 coredns-coredns.kube-system.svc.cluster.local Name: kubernetes Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local æµ‹è¯•è·¨å‘½åç©ºé—´æ˜¯å¦å¯ä»¥è§£æ # æŸ¥çœ‹æœ‰é‚£äº›name # kubectl get svc -A NAMESPACE NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE default kubernetes ClusterIP 10.96.0.1 \u0026lt;none\u0026gt; 443/TCP 14d ingress-nginx ingress-nginx-controller LoadBalancer 10.107.76.220 \u0026lt;pending\u0026gt; 80:30451/TCP,443:32101/TCP 13d ingress-nginx ingress-nginx-controller-admission ClusterIP 10.110.40.24 \u0026lt;none\u0026gt; 443/TCP 13d kube-system calico-typha ClusterIP 10.104.191.196 \u0026lt;none\u0026gt; 5473/TCP 13d kube-system coredns-coredns ClusterIP 10.96.0.10 \u0026lt;none\u0026gt; 53/UDP,53/TCP 13d kube-system default-http-backend ClusterIP 10.100.145.35 \u0026lt;none\u0026gt; 80/TCP 13d kube-system metrics-server ClusterIP 10.107.79.100 \u0026lt;none\u0026gt; 443/TCP 13d # è¿›è¡Œè§£æ # kubectl exec busybox -n default -- nslookup coredns-coredns.kube-system Server: 10.96.0.10 Address 1: 10.96.0.10 coredns-coredns.kube-system.svc.cluster.local Name: coredns-coredns.kube-system Address 1: 10.96.0.10 coredns-coredns.kube-system.svc.cluster.local æ¯ä¸ªèŠ‚ç‚¹éƒ½å¿…é¡»è¦èƒ½è®¿é—®Kubernetesçš„kubernetes svc 443å’Œkube-dnsçš„service 53 telnet 10.96.0.1 443 Trying 10.96.0.1... Connected to 10.96.0.1. Escape character is \u0026#39;^]\u0026#39;. telnet 10.96.0.10 53 Trying 10.96.0.10... Connected to 10.96.0.10. Escape character is \u0026#39;^]\u0026#39;. curl 10.96.0.10:53 curl: (52) Empty reply from server Podå’ŒPodä¹‹é—´è¦èƒ½é€š # kubectl get po -owide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES busybox 1/1 Running 0 18m 172.27.14.202 k8s-node02 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; # kubectl get po -n kube-system -owide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES calico-kube-controllers-76754ff848-gmx8n 1/1 Running 3 (30h ago) 13d 172.25.244.199 k8s-master01 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; calico-node-845jj 1/1 Running 2 (2d ago) 13d 192.168.100.102 k8s-master02 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; calico-node-m7p9n 1/1 Running 2 (2d ago) 13d 192.168.100.103 k8s-master03 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; calico-node-qqj7g 1/1 Running 2 (2d ago) 13d 192.168.100.104 k8s-node01 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; calico-node-rfq9m 1/1 Running 4 (53m ago) 13d 192.168.100.105 k8s-node02 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; calico-node-tdnmt 1/1 Running 3 (30h ago) 13d 192.168.100.101 k8s-master01 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; calico-typha-59d75c5dd4-8fg4d 1/1 Running 2 (2d ago) 13d 192.168.100.103 k8s-master03 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; coredns-coredns-5f4fc468-t5l96 1/1 Running 2 (2d ago) 13d 172.25.92.73 k8s-master02 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; default-http-backend-cf5544789-7qw27 1/1 Running 2 (2d ago) 13d 172.17.125.11 k8s-node01 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kubernetes-dashboard-5948b5f5d7-t2nkl 1/1 Running 3 (2d ago) 13d 172.25.92.74 k8s-master02 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; metrics-server-65875bc4f9-wcxlv 1/1 Running 4 (2d ago) 13d 172.17.125.10 k8s-node01 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; # è¿›å…¥busybox pingå…¶ä»–èŠ‚ç‚¹ä¸Šçš„pod #kubectl exec -ti busybox -- sh # ping 192.168.100.102 PING 192.168.100.102 (192.168.100.102): 56 data bytes 64 bytes from 192.168.100.102: seq=0 ttl=63 time=0.487 ms 64 bytes from 192.168.100.102: seq=1 ttl=63 time=0.432 ms 64 bytes from 192.168.100.102: seq=2 ttl=63 time=0.334 ms # å¯ä»¥è¿é€šè¯æ˜è¿™ä¸ªpodæ˜¯å¯ä»¥è·¨å‘½åç©ºé—´å’Œè·¨ä¸»æœºé€šä¿¡çš„ åˆ›å»ºä¸‰ä¸ªå‰¯æœ¬ï¼Œå¯ä»¥çœ‹åˆ°3ä¸ªå‰¯æœ¬åˆ†å¸ƒåœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Š cat \u0026gt; deployments.yaml \u0026lt;\u0026lt; EOF apiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx ports: - containerPort: 80 EOF # kubectl apply -f deployments.yaml deployment.apps/nginx-deployment created # kubectl get pod NAME READY STATUS RESTARTS AGE busybox 1/1 Running 0 21m nginx-deployment-55f598f8d-4rnwj 1/1 Running 0 8s nginx-deployment-55f598f8d-tvfgk 1/1 Running 0 8s nginx-deployment-55f598f8d-xsc9p 1/1 Running 0 8s # åˆ é™¤nginx # kubectl delete -f deployments.yaml å®‰è£…dashboard helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/ helm install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard --namespace kube-system æ›´æ”¹dashboardçš„svcä¸ºNodePort # kubectl edit svc kubernetes-dashboard -n kube-system type: NodePort æŸ¥çœ‹ç«¯å£å· # kubectl get svc kubernetes-dashboard -n kube-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes-dashboard NodePort 10.100.112.99 \u0026lt;none\u0026gt; 443:31048/TCP 13d åˆ›å»ºtoken cat \u0026gt; dashboard-user.yaml \u0026lt;\u0026lt; EOF apiVersion: v1 kind: ServiceAccount metadata: name: admin-user namespace: kube-system --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: admin-user roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: cluster-admin subjects: - kind: ServiceAccount name: admin-user namespace: kube-system EOF # kubectl apply -f dashboard-user.yaml # åˆ›å»ºtoken # kubectl -n kube-system create token admin-user eyJhbGciOiJSUzI1NiIsImtpZCI6IlA1MVFqS1lwOTU2S1pMSWxC...... ç™»å½•dashboard https://192.168.100.100:31048 ingresså®‰è£… éƒ¨ç½² wget https://ghproxy.com/https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml # ä¿®æ”¹ä¸ºå›½å†…æº dockeræºå¯é€‰ sed -i \u0026#34;s#registry.k8s.io/#m.daocloud.io/registry.k8s.io/#g\u0026#34; *.yaml cat \u0026gt; backend.yaml \u0026lt;\u0026lt; EOF apiVersion: apps/v1 kind: Deployment metadata: name: default-http-backend labels: app.kubernetes.io/name: default-http-backend namespace: kube-system spec: replicas: 1 selector: matchLabels: app.kubernetes.io/name: default-http-backend template: metadata: labels: app.kubernetes.io/name: default-http-backend spec: terminationGracePeriodSeconds: 60 containers: - name: default-http-backend image: registry.cn-hangzhou.aliyuncs.com/test/defaultbackend-amd64:1.5 livenessProbe: httpGet: path: /healthz port: 8080 scheme: HTTP initialDelaySeconds: 30 timeoutSeconds: 5 ports: - containerPort: 8080 resources: limits: cpu: 10m memory: 20Mi requests: cpu: 10m memory: 20Mi --- apiVersion: v1 kind: Service metadata: name: default-http-backend namespace: kube-system labels: app.kubernetes.io/name: default-http-backend spec: ports: - port: 80 targetPort: 8080 selector: app.kubernetes.io/name: default-http-backend EOF kubectl apply -f deploy.yaml kubectl apply -f backend.yaml cat \u0026gt; ingress-demo-app.yaml \u0026lt;\u0026lt; EOF apiVersion: apps/v1 kind: Deployment metadata: name: hello-server spec: replicas: 2 selector: matchLabels: app: hello-server template: metadata: labels: app: hello-server spec: containers: - name: hello-server image: registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/hello-server ports: - containerPort: 9000 --- apiVersion: apps/v1 kind: Deployment metadata: labels: app: nginx-demo name: nginx-demo spec: replicas: 2 selector: matchLabels: app: nginx-demo template: metadata: labels: app: nginx-demo spec: containers: - image: nginx name: nginx --- apiVersion: v1 kind: Service metadata: labels: app: nginx-demo name: nginx-demo spec: selector: app: nginx-demo ports: - port: 8000 protocol: TCP targetPort: 80 --- apiVersion: v1 kind: Service metadata: labels: app: hello-server name: hello-server spec: selector: app: hello-server ports: - port: 8000 protocol: TCP targetPort: 9000 --- apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: ingress-host-bar spec: ingressClassName: nginx rules: - host: \u0026#34;hello.test.cn\u0026#34; http: paths: - pathType: Prefix path: \u0026#34;/\u0026#34; backend: service: name: hello-server port: number: 8000 - host: \u0026#34;demo.test.cn\u0026#34; http: paths: - pathType: Prefix path: \u0026#34;/nginx\u0026#34; backend: service: name: nginx-demo port: number: 8000 EOF # ç­‰åˆ›å»ºå®Œæˆååœ¨æ‰§è¡Œï¼š kubectl apply -f ingress-demo-app.yaml kubectl get ingress NAME CLASS HOSTS ADDRESS PORTS AGE ingress-host-bar nginx hello.test.cn,demo.test.cn 192.168.100.102 80 7s è¿‡æ»¤æŸ¥çœ‹ingressç«¯å£ # ä¿®æ”¹ä¸ºnodeport kubectl edit svc -n ingress-nginx ingress-nginx-controller type: NodePort # kubectl get svc -A | grep ingress ingress-nginx ingress-nginx-controller LoadBalancer 10.107.76.220 \u0026lt;pending\u0026gt; 80:30451/TCP,443:32101/TCP 13d ingress-nginx ingress-nginx-controller-admission ClusterIP 10.110.40.24 \u0026lt;none\u0026gt; 443/TCP 13d IPv6æµ‹è¯•(ç¤ºä¾‹) #éƒ¨ç½²åº”ç”¨ cat\u0026lt;\u0026lt;EOF | kubectl apply -f - apiVersion: apps/v1 kind: Deployment metadata: name: test spec: replicas: 3 selector: matchLabels: app: test template: metadata: labels: app: test spec: containers: - name: test image: docker.io/library/nginx resources: limits: memory: \u0026#34;128Mi\u0026#34; cpu: \u0026#34;500m\u0026#34; ports: - containerPort: 80 --- apiVersion: v1 kind: Service metadata: name: test spec: ipFamilyPolicy: PreferDualStack ipFamilies: - IPv6 - IPv4 type: NodePort selector: app: test ports: - port: 80 targetPort: 80 EOF #æŸ¥çœ‹ç«¯å£ # kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE test NodePort fd00::a29c \u0026lt;none\u0026gt; 80:30779/TCP 5s #ä½¿ç”¨å†…ç½‘è®¿é—® # curl -I http://[fd00::a29c] HTTP/1.1 200 OK Server: nginx/1.21.6 Date: Thu, 05 May 2022 10:20:35 GMT Content-Type: text/html Content-Length: 615 Last-Modified: Tue, 25 Jan 2022 15:03:52 GMT Connection: keep-alive ETag: \u0026#34;61f01158-267\u0026#34; Accept-Ranges: bytes # curl -I http://192.168.100.101:30779 HTTP/1.1 200 OK Server: nginx/1.21.6 Date: Thu, 05 May 2022 10:20:59 GMT Content-Type: text/html Content-Length: 615 Last-Modified: Tue, 25 Jan 2022 15:03:52 GMT Connection: keep-alive ETag: \u0026#34;61f01158-267\u0026#34; Accept-Ranges: bytes #ä½¿ç”¨å…¬ç½‘è®¿é—® # curl -I http://[2409:8a10:9e18:9020::10]:30779 HTTP/1.1 200 OK Server: nginx/1.21.6 Date: Thu, 05 May 2022 10:20:54 GMT Content-Type: text/html Content-Length: 615 Last-Modified: Tue, 25 Jan 2022 15:03:52 GMT Connection: keep-alive ETag: \u0026#34;61f01158-267\u0026#34; Accept-Ranges: bytes å®‰è£…å‘½ä»¤è¡Œè‡ªåŠ¨è¡¥å…¨åŠŸèƒ½(å¯é€‰) yum install bash-completion -y source /usr/share/bash-completion/bash_completion source \u0026lt;(kubectl completion bash) echo \u0026#34;source \u0026lt;(kubectl completion bash)\u0026#34; \u0026gt;\u0026gt; ~/.bashrc é™„å½•(è½¬è½½) # é•œåƒåŠ é€Ÿå™¨å¯ä»¥ä½¿ç”¨DaoCloudä»“åº“ï¼Œæ›¿æ¢è§„åˆ™å¦‚ä¸‹ cr.l5d.io/ ===\u0026gt; m.daocloud.io/cr.l5d.io/ docker.elastic.co/ ===\u0026gt; m.daocloud.io/docker.elastic.co/ docker.io/ ===\u0026gt; m.daocloud.io/docker.io/ gcr.io/ ===\u0026gt; m.daocloud.io/gcr.io/ ghcr.io/ ===\u0026gt; m.daocloud.io/ghcr.io/ k8s.gcr.io/ ===\u0026gt; m.daocloud.io/k8s.gcr.io/ mcr.microsoft.com/ ===\u0026gt; m.daocloud.io/mcr.microsoft.com/ nvcr.io/ ===\u0026gt; m.daocloud.io/nvcr.io/ quay.io/ ===\u0026gt; m.daocloud.io/quay.io/ registry.jujucharms.com/ ===\u0026gt; m.daocloud.io/registry.jujucharms.com/ registry.k8s.io/ ===\u0026gt; m.daocloud.io/registry.k8s.io/ registry.opensource.zalan.do/ ===\u0026gt; m.daocloud.io/registry.opensource.zalan.do/ rocks.canonical.com/ ===\u0026gt; m.daocloud.io/rocks.canonical.com/ # é•œåƒç‰ˆæœ¬è¦è‡ªè¡ŒæŸ¥çœ‹ï¼Œå› ä¸ºé•œåƒç‰ˆæœ¬æ˜¯éšæ—¶æ›´æ–°çš„ï¼Œæ–‡æ¡£æ— æ³•åšåˆ°å®æ—¶æ›´æ–° # docker pull é•œåƒ docker pull registry.cn-hangzhou.aliyuncs.com/test/cni:master docker pull registry.cn-hangzhou.aliyuncs.com/test/node:master docker pull registry.cn-hangzhou.aliyuncs.com/test/kube-controllers:master docker pull registry.cn-hangzhou.aliyuncs.com/test/typha:master docker pull registry.cn-hangzhou.aliyuncs.com/test/coredns:v1.10.0 docker pull registry.cn-hangzhou.aliyuncs.com/test/pause:3.6 docker pull registry.cn-hangzhou.aliyuncs.com/test/metrics-server:v0.5.2 docker pull kubernetesui/dashboard:v2.7.0 docker pull kubernetesui/metrics-scraper:v1.0.8 docker pull quay.io/cilium/cilium:v1.12.6 docker pull quay.io/cilium/certgen:v0.1.8 docker pull quay.io/cilium/hubble-relay:v1.12.6 docker pull quay.io/cilium/hubble-ui-backend:v0.9.2 docker pull quay.io/cilium/hubble-ui:v0.9.2 docker pull quay.io/cilium/cilium-etcd-operator:v2.0.7 docker pull quay.io/cilium/operator:v1.12.6 docker pull quay.io/cilium/clustermesh-apiserver:v1.12.6 docker pull quay.io/coreos/etcd:v3.5.4 docker pull quay.io/cilium/startup-script:d69851597ea019af980891a4628fb36b7880ec26 # docker ä¿å­˜é•œåƒ docker save registry.cn-hangzhou.aliyuncs.com/test/cni:master -o cni.tar docker save registry.cn-hangzhou.aliyuncs.com/test/node:master -o node.tar docker save registry.cn-hangzhou.aliyuncs.com/test/typha:master -o typha.tar docker save registry.cn-hangzhou.aliyuncs.com/test/kube-controllers:master -o kube-controllers.tar docker save registry.cn-hangzhou.aliyuncs.com/test/coredns:v1.10.0 -o coredns.tar docker save registry.cn-hangzhou.aliyuncs.com/test/pause:3.6 -o pause.tar docker save registry.cn-hangzhou.aliyuncs.com/test/metrics-server:v0.5.2 -o metrics-server.tar docker save kubernetesui/dashboard:v2.7.0 -o dashboard.tar docker save kubernetesui/metrics-scraper:v1.0.8 -o metrics-scraper.tar docker save quay.io/cilium/cilium:v1.12.6 -o cilium.tar docker save quay.io/cilium/certgen:v0.1.8 -o certgen.tar docker save quay.io/cilium/hubble-relay:v1.12.6 -o hubble-relay.tar docker save quay.io/cilium/hubble-ui-backend:v0.9.2 -o hubble-ui-backend.tar docker save quay.io/cilium/hubble-ui:v0.9.2 -o hubble-ui.tar docker save quay.io/cilium/cilium-etcd-operator:v2.0.7 -o cilium-etcd-operator.tar docker save quay.io/cilium/operator:v1.12.6 -o operator.tar docker save quay.io/cilium/clustermesh-apiserver:v1.12.6 -o clustermesh-apiserver.tar docker save quay.io/coreos/etcd:v3.5.4 -o etcd.tar docker save quay.io/cilium/startup-script:d69851597ea019af980891a4628fb36b7880ec26 -o startup-script.tar # ä¼ è¾“åˆ°å„ä¸ªèŠ‚ç‚¹ for NODE in k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02; do scp -r images/ $NODE:/root/ ; done # åˆ›å»ºå‘½åç©ºé—´ ctr ns create k8s.io # å¯¼å…¥é•œåƒ ctr --namespace k8s.io image import images/cni.tar ctr --namespace k8s.io image import images/node.tar ctr --namespace k8s.io image import images/typha.tar ctr --namespace k8s.io image import images/kube-controllers.tar ctr --namespace k8s.io image import images/coredns.tar ctr --namespace k8s.io image import images/pause.tar ctr --namespace k8s.io image import images/metrics-server.tar ctr --namespace k8s.io image import images/dashboard.tar ctr --namespace k8s.io image import images/metrics-scraper.tar ctr --namespace k8s.io image import images/dashboard.tar ctr --namespace k8s.io image import images/metrics-scraper.tar ctr --namespace k8s.io image import images/cilium.tar ctr --namespace k8s.io image import images/certgen.tar ctr --namespace k8s.io image import images/hubble-relay.tar ctr --namespace k8s.io image import images/hubble-ui-backend.tar ctr --namespace k8s.io image import images/hubble-ui.tar ctr --namespace k8s.io image import images/cilium-etcd-operator.tar ctr --namespace k8s.io image import images/operator.tar ctr --namespace k8s.io image import images/clustermesh-apiserver.tar ctr --namespace k8s.io image import images/etcd.tar ctr --namespace k8s.io image import images/startup-script.tar # pull taråŒ… è§£å‹å helm pull cilium/cilium # æŸ¥çœ‹é•œåƒç‰ˆæœ¬ # cat values.yaml| grep tag: -C1 repository: \u0026#34;quay.io/cilium/cilium\u0026#34; tag: \u0026#34;v1.12.6\u0026#34; pullPolicy: \u0026#34;IfNotPresent\u0026#34; -- repository: \u0026#34;quay.io/cilium/certgen\u0026#34; tag: \u0026#34;v0.1.8@sha256:4a456552a5f192992a6edcec2febb1c54870d665173a33dc7d876129b199ddbd\u0026#34; pullPolicy: \u0026#34;IfNotPresent\u0026#34; -- repository: \u0026#34;quay.io/cilium/hubble-relay\u0026#34; tag: \u0026#34;v1.12.6\u0026#34; # hubble-relay-digest -- repository: \u0026#34;quay.io/cilium/hubble-ui-backend\u0026#34; tag: \u0026#34;v0.9.2@sha256:a3ac4d5b87889c9f7cc6323e86d3126b0d382933bd64f44382a92778b0cde5d7\u0026#34; pullPolicy: \u0026#34;IfNotPresent\u0026#34; -- repository: \u0026#34;quay.io/cilium/hubble-ui\u0026#34; tag: \u0026#34;v0.9.2@sha256:d3596efc94a41c6b772b9afe6fe47c17417658956e04c3e2a28d293f2670663e\u0026#34; pullPolicy: \u0026#34;IfNotPresent\u0026#34; -- repository: \u0026#34;quay.io/cilium/cilium-etcd-operator\u0026#34; tag: \u0026#34;v2.0.7@sha256:04b8327f7f992693c2cb483b999041ed8f92efc8e14f2a5f3ab95574a65ea2dc\u0026#34; pullPolicy: \u0026#34;IfNotPresent\u0026#34; -- repository: \u0026#34;quay.io/cilium/operator\u0026#34; tag: \u0026#34;v1.12.6\u0026#34; # operator-generic-digest -- repository: \u0026#34;quay.io/cilium/startup-script\u0026#34; tag: \u0026#34;d69851597ea019af980891a4628fb36b7880ec26\u0026#34; pullPolicy: \u0026#34;IfNotPresent\u0026#34; -- repository: \u0026#34;quay.io/cilium/cilium\u0026#34; tag: \u0026#34;v1.12.6\u0026#34; # cilium-digest -- repository: \u0026#34;quay.io/cilium/clustermesh-apiserver\u0026#34; tag: \u0026#34;v1.12.6\u0026#34; # clustermesh-apiserver-digest -- repository: \u0026#34;quay.io/coreos/etcd\u0026#34; tag: \u0026#34;v3.5.4@sha256:795d8660c48c439a7c3764c2330ed9222ab5db5bb524d8d0607cac76f7ba82a3\u0026#34; pullPolicy: \u0026#34;IfNotPresent\u0026#34; å‚è€ƒèµ„æ–™: https://github.com/cby-chen/Kubernetes\n","permalink":"https://gnail89.github.io/posts/kubernetes-v1.27.6-centos8stream-binary-install/","summary":"ç¯å¢ƒ ä¸»æœºå IPåœ°å€ å¤‡æ³¨ VIP 192.168.100.100 æµ®åŠ¨IP k8s-master01 192.168.100.101 masterèŠ‚ç‚¹ k8s-master02 192.168.100.102 masterèŠ‚ç‚¹ k8s-master03 192.168.100.103 masterèŠ‚ç‚¹ k8s-node01 192.168.100.104 nodeèŠ‚ç‚¹ k8s-node02 192.168.100.105 nodeèŠ‚ç‚¹ ç½‘æ®µè¯´æ˜\nservice: 10.96.0.0/12 pod: 172.16.0.0/12 k8såŸºç¡€ç³»ç»Ÿç¯å¢ƒé…ç½® é…ç½®IP # ç½‘å¡UUIDä¸èƒ½é‡å¤ï¼ŒUUIDé‡å¤æ— æ³•è·å–åˆ°IPV6åœ°å€ # # æŸ¥çœ‹å½“å‰çš„ç½‘å¡åˆ—è¡¨å’Œ UUIDï¼š # nmcli con show # åˆ é™¤è¦æ›´æ”¹ UUID çš„ç½‘ç»œè¿æ¥ï¼š # nmcli con delete uuid \u0026lt;åŸ UUID\u0026gt; # é‡æ–°ç”Ÿæˆ UUIDï¼š # nmcli con add type ethernet ifname \u0026lt;æ¥å£åç§°\u0026gt; con-name \u0026lt;æ–°åç§°\u0026gt; # é‡æ–°å¯ç”¨ç½‘ç»œè¿æ¥ï¼š # nmcli con up \u0026lt;æ–°åç§°\u0026gt; # æ›´æ”¹ç½‘å¡çš„UUID nmcli con delete uuid a5078897-4aae-3fa8-8b7a-0773d924901d;nmcli con add type ethernet ifname ens1 con-name ens1;nmcli con up ens1 nmcli con delete uuid a5078897-4aae-3fa8-8b7a-0773d924901d;nmcli con add type ethernet ifname ens1 con-name ens1;nmcli con up ens1 nmcli con delete uuid a5078897-4aae-3fa8-8b7a-0773d924901d;nmcli con add type ethernet ifname ens1 con-name ens1;nmcli con up ens1 nmcli con delete uuid a5078897-4aae-3fa8-8b7a-0773d924901d;nmcli con add type ethernet ifname ens1 con-name ens1;nmcli con up ens1 nmcli con delete uuid a5078897-4aae-3fa8-8b7a-0773d924901d;nmcli con add type ethernet ifname ens1 con-name ens1;nmcli con up ens1 # ä¿®æ”¹é™æ€çš„IPv4åœ°å€ nmcli con mod ens1 ipv4.","title":"Kubernetes V1.27.6 Centos8stream Binary Install"},{"content":"1. è½¯ä»¶ç‰ˆæœ¬ï¼š OS: Anolis OS release 8.8 SSH: openssh-9.3p1.tar.gz SSL: openssl-1.1.1t.tar.gz 2. å®‰è£…åŸºç¡€ä¾èµ–åŒ… dnf install -y gcc gcc-c++ make zlib zlib-devel pam pam-devel tar 3. æ‰‹åŠ¨ç¼–è¯‘OpenSSL # è§£å‹ç¼© tar zxf openssl-1.1.1t.tar.gz cd openssl-1.1.1t # ç¼–è¯‘å®‰è£… ./config --prefix=/opt/openssl/ make \u0026amp;\u0026amp; make install å®‰è£…ç›®å½•ç»“æ„ /opt/openssl/ â”œâ”€â”€ bin â”‚Â â”œâ”€â”€ c_rehash â”‚Â â””â”€â”€ openssl â”œâ”€â”€ include â”‚Â â””â”€â”€ openssl â”œâ”€â”€ lib â”‚Â â”œâ”€â”€ engines-1.1 â”‚Â â”œâ”€â”€ libcrypto.a â”‚Â â”œâ”€â”€ libcrypto.so -\u0026gt; libcrypto.so.1.1 â”‚Â â”œâ”€â”€ libcrypto.so.1.1 â”‚Â â”œâ”€â”€ libssl.a â”‚Â â”œâ”€â”€ libssl.so -\u0026gt; libssl.so.1.1 â”‚Â â”œâ”€â”€ libssl.so.1.1 â”‚Â â””â”€â”€ pkgconfig â”œâ”€â”€ share â”‚Â â”œâ”€â”€ doc â”‚Â â””â”€â”€ man â””â”€â”€ ssl â”œâ”€â”€ certs â”œâ”€â”€ ct_log_list.cnf â”œâ”€â”€ ct_log_list.cnf.dist â”œâ”€â”€ misc â”œâ”€â”€ openssl.cnf â”œâ”€â”€ openssl.cnf.dist â””â”€â”€ private 4. æ‰‹åŠ¨ç¼–è¯‘OpenSSH # è§£å‹ç¼© tar zxf openssh-9.3p1.tar.gz cd openssh-9.3p1 # æŒ‡å®šLD_LIBRARY_PATH export LD_LIBRARY_PATH=/opt/openssl/include/openssl:/opt/openssl/lib mv /opt/openssl/lib/libcrypto.so{,.bak} # é…ç½® ./configure --prefix=/usr/local/openssh \\ --bindir=/usr/bin \\ --sbindir=/usr/sbin \\ --sysconfdir=/etc/ssh \\ --with-zlib \\ --with-pam \\ --with-ssl-dir=/opt/openssl \\ --with-ldflags=\u0026#34;-L/opt/openssl/lib -l:libcrypto.a -pthread\u0026#34; # ç¼–è¯‘å®‰è£… make \u0026amp;\u0026amp; make install # å‡çº§åçš„ç‰ˆæœ¬sshd -V OpenSSH_9.3, OpenSSL 1.1.1t 7 Feb 2023 sshd é“¾æ¥åº“ä¿¡æ¯ $ ldd /usr/sbin/sshd linux-vdso.so.1 (0x00007ffdcac9f000) libcrypt.so.1 =\u0026gt; /lib64/libcrypt.so.1 (0x00007fe856a00000) libpam.so.0 =\u0026gt; /lib64/libpam.so.0 (0x00007fe856600000) libdl.so.2 =\u0026gt; /lib64/libdl.so.2 (0x00007fe856200000) libutil.so.1 =\u0026gt; /lib64/libutil.so.1 (0x00007fe855e00000) libresolv.so.2 =\u0026gt; /lib64/libresolv.so.2 (0x00007fe855a00000) libz.so.1 =\u0026gt; /lib64/libz.so.1 (0x00007fe855600000) libpthread.so.0 =\u0026gt; /lib64/libpthread.so.0 (0x00007fe855200000) libc.so.6 =\u0026gt; /lib64/libc.so.6 (0x00007fe854e00000) libaudit.so.1 =\u0026gt; /lib64/libaudit.so.1 (0x00007fe854a00000) /lib64/ld-linux-x86-64.so.2 (0x00007fe8574c4000) libcap-ng.so.0 =\u0026gt; /lib64/libcap-ng.so.0 (0x00007fe854600000) systemdå¯åŠ¨é…ç½®ç¤ºä¾‹ $ cat /usr/lib/systemd/system/sshd.service [Unit] Description=OpenSSH server daemon Documentation=man:sshd(8) man:sshd_config(5) After=network.target sshd-keygen.target Wants=sshd-keygen.target [Service] Type=simple ExecStart=/usr/sbin/sshd -D ExecReload=/bin/kill -HUP $MAINPID KillMode=process Restart=on-failure RestartSec=42s [Install] WantedBy=multi-user.target sshdæœåŠ¡é‡å¯ systemctl daemon-reload systemctl restart sshd systemctl status sshd ","permalink":"https://gnail89.github.io/posts/openssh_upgrade/","summary":"1. è½¯ä»¶ç‰ˆæœ¬ï¼š OS: Anolis OS release 8.8 SSH: openssh-9.3p1.tar.gz SSL: openssl-1.1.1t.tar.gz 2. å®‰è£…åŸºç¡€ä¾èµ–åŒ… dnf install -y gcc gcc-c++ make zlib zlib-devel pam pam-devel tar 3. æ‰‹åŠ¨ç¼–è¯‘OpenSSL # è§£å‹ç¼© tar zxf openssl-1.1.1t.tar.gz cd openssl-1.1.1t # ç¼–è¯‘å®‰è£… ./config --prefix=/opt/openssl/ make \u0026amp;\u0026amp; make install å®‰è£…ç›®å½•ç»“æ„ /opt/openssl/ â”œâ”€â”€ bin â”‚Â â”œâ”€â”€ c_rehash â”‚Â â””â”€â”€ openssl â”œâ”€â”€ include â”‚Â â””â”€â”€ openssl â”œâ”€â”€ lib â”‚Â â”œâ”€â”€ engines-1.1 â”‚Â â”œâ”€â”€ libcrypto.a â”‚Â â”œâ”€â”€ libcrypto.so -\u0026gt; libcrypto.so.1.1 â”‚Â â”œâ”€â”€ libcrypto.","title":"OpenSSH 9.3p1ç¼–è¯‘å®‰è£…,é“¾æ¥OpenSSL 1.1.1té™æ€åº“"},{"content":"å·¥å…· éœ€è¦ä»¥ä¸‹æœ€æ–°ç‰ˆæœ¬å·¥å…·\nsmartctl\nMegaCli64\nlsscsi\nè·å–åŸºæœ¬ä¿¡æ¯ ä½¿ç”¨lsscsiè·å–SCSIè®¾å¤‡ä¿¡æ¯å’Œå±æ€§ å…¶ä¸­idçš„å«ä¹‰å¯ä»¥ä»/proc/scsi/scsiæ–‡ä»¶ä¸­ç®€å•è·å–ã€‚ [0:2:2:0]åˆ†åˆ«è¡¨ç¤ºHost, Channel, Id, Lun\n# lsscsi -g [0:0:2:0] enclosu SAS/SATA Expander RevA - /dev/sg0 [0:2:0:0] disk LSI LSI 3.40 /dev/sda /dev/sg1 [0:2:1:0] disk LSI LSI 3.40 /dev/sdb /dev/sg2 [0:2:2:0] disk LSI LSI 3.40 /dev/sdc /dev/sg3 [0:2:3:0] disk LSI LSI 3.40 /dev/sdd /dev/sg4 [0:2:4:0] disk LSI LSI 3.40 /dev/sde /dev/sg5 [0:2:5:0] disk LSI LSI 3.40 /dev/sdf /dev/sg6 [0:2:6:0] disk LSI LSI 3.40 /dev/sdg /dev/sg7 [0:2:7:0] disk LSI LSI 3.40 /dev/sdh /dev/sg8 [0:2:8:0] disk LSI LSI 3.40 /dev/sdi /dev/sg9 [0:2:9:0] disk LSI LSI 3.40 /dev/sdj /dev/sg10 [0:2:10:0] disk LSI LSI 3.40 /dev/sdk /dev/sg11 [0:2:11:0] disk LSI LSI 3.40 /dev/sdl /dev/sg12 [0:2:12:0] disk LSI LSI 3.40 /dev/sdm /dev/sg13 # cat /proc/scsi/scsi Attached devices: Host: scsi0 Channel: 00 Id: 02 Lun: 00 Vendor: SAS/SATA Model: Expander Rev: RevA Type: Enclosure ANSI SCSI revision: 05 Host: scsi0 Channel: 02 Id: 00 Lun: 00 Vendor: LSI Model: LSI Rev: 3.40 Type: Direct-Access ANSI SCSI revision: 05 Host: scsi0 Channel: 02 Id: 01 Lun: 00 Vendor: LSI Model: LSI Rev: 3.40 Type: Direct-Access ANSI SCSI revision: 05 ... ä½¿ç”¨MegaCli64è·å–ç¡¬ç›˜ä¿¡æ¯ # è·å–MegaRAIDçš„bus idä¸ºï¼š02:00.0 # lspci |grep MegaRAID 02:00.0 RAID bus controller: LSI Logic / Symbios Logic MegaRAID SAS 2208 # MegaCli64 -LdPdInfo -aALL |egrep \u0026#34;Target Id:|Enclosure Device ID:|^Slot Number:|^Device Id:|^Inquiry Data:\u0026#34; Virtual Drive: 0 (Target Id: 0) Enclosure Device ID: 2 Slot Number: 12 Device Id: 18 Inquiry Data: HGST xxxxxxxx xxxxxxxx Enclosure Device ID: 2 Slot Number: 13 Device Id: 19 Inquiry Data: HGST xxxxxxxx xxxxxxxx Virtual Drive: 1 (Target Id: 1) Enclosure Device ID: 2 Slot Number: 0 Device Id: 6 Inquiry Data: HGST xxxxxxxx xxxxxxxx Virtual Drive: 2 (Target Id: 2) Enclosure Device ID: 2 Slot Number: 1 Device Id: 14 Inquiry Data: YHH7HWLAA xxxxxxxx xxxxxxxx ... # MegaCli64 -pdInfo -PhysDrv[2:1] -aALL Enclosure Device ID: 2 Slot Number: 1 Drive\u0026#39;s position: DiskGroup: 10, Span: 0, Arm: 0 Enclosure position: 1 Device Id: 14 WWN: 5000cca225d181c1 Sequence Number: 2 Media Error Count: 0 Other Error Count: 0 Predictive Failure Count: 0 Last Predictive Failure Event Seq Number: 0 PD Type: SATA ... ä½¿ç”¨smartctlæ‰«æè®¾å¤‡ # smartctl --scan-open /dev/sda -d scsi # /dev/sda, SCSI device /dev/sdb -d scsi # /dev/sdb, SCSI device /dev/sdc -d scsi # /dev/sdc, SCSI device /dev/sdd -d scsi # /dev/sdd, SCSI device ... /dev/bus/0 -d sat+megaraid,3 # /dev/bus/0 [megaraid_disk_03] [SAT]ï¼ŒATA device /dev/bus/0 -d sat+megaraid,11 # /dev/bus/0 [megaraid_disk_11] [SAT]ï¼ŒATA device /dev/bus/0 -d sat+megaraid,14 # /dev/bus/0 [megaraid_disk_14] [SAT]ï¼ŒATA device /dev/bus/0 -d sat+megaraid,17 # /dev/bus/0 [megaraid_disk_17] [SAT]ï¼ŒATA device ... æ–¹æ³• ä»lsscsiä¸­å¯ä»¥å¾—åˆ°è®¾å¤‡ID ä¾‹å­ï¼š[0:2:2:0] disk LSI \u0026hellip; /dev/sdc ==\u0026gt; Host id: 0 Channel id: 2 Target id: 2 # å¯¹åº”MegaRAIDä¸­çš„Target id Lun id: 0\nä»MegaCli64ä¸­å¯ä»¥å¾—åˆ°è®¾å¤‡çš„Target idï¼ŒEnclosure Device IDï¼ŒSlot Numberï¼ŒInquiry Dataç­‰ä¿¡æ¯ ä¾‹å­ï¼šPhysDrv[2:1] Virtual Drive: 2 (Target Id: 2) # å¯¹åº”scsiä¸­çš„Target id Device Id: 14 # å¯¹åº”smartctlä¸­çš„megaraid id Enclosure Device ID: 2 Slot Number: 1 # å¯¹åº”æœºç®±æ§½ä½å· Inquiry Data: YHH7HWLAA xxxxxxxx xxxxxxxx # ç¡¬ç›˜åºåˆ—å·ä¿¡æ¯\nä»smartctlä¸­å¯ä»¥å¾—åˆ°megaraidä¿¡æ¯ /dev/bus/0 -d sat+megaraid,14 # å¯¹åº”MegaRAIDä¸­Device id\nä»¥/dev/sdcä¸ºä¾‹ã€‚\n/dev/sdcçš„scsi idä¸º[0:2:2:0] =\u0026gt; MegaRAIDç¡¬ç›˜PhysDrv[2:1] =\u0026gt; smartctlä¸­megaraid,14\né€šè¿‡åºåˆ—å·éªŒè¯MegaRAIDä¸smartctlçš„å…³ç³»ï¼š\n# smartctl -a /dev/bus/0 -d sat+megaraid,14 |grep \u0026#34;Serial Number\u0026#34; Serial Number: YHH7HWLAA # MegaC1164 -pdInfo -PhysDrv[2:1] -aALL ... Enclosure Device ID: 2 Slot Number: 1 Device Id: 14 Inquiry Data: YHH7HWLAA xxxxxxxx xxxxxxxx ... ","permalink":"https://gnail89.github.io/posts/find-disk-slot/","summary":"å·¥å…· éœ€è¦ä»¥ä¸‹æœ€æ–°ç‰ˆæœ¬å·¥å…·\nsmartctl\nMegaCli64\nlsscsi\nè·å–åŸºæœ¬ä¿¡æ¯ ä½¿ç”¨lsscsiè·å–SCSIè®¾å¤‡ä¿¡æ¯å’Œå±æ€§ å…¶ä¸­idçš„å«ä¹‰å¯ä»¥ä»/proc/scsi/scsiæ–‡ä»¶ä¸­ç®€å•è·å–ã€‚ [0:2:2:0]åˆ†åˆ«è¡¨ç¤ºHost, Channel, Id, Lun\n# lsscsi -g [0:0:2:0] enclosu SAS/SATA Expander RevA - /dev/sg0 [0:2:0:0] disk LSI LSI 3.40 /dev/sda /dev/sg1 [0:2:1:0] disk LSI LSI 3.40 /dev/sdb /dev/sg2 [0:2:2:0] disk LSI LSI 3.40 /dev/sdc /dev/sg3 [0:2:3:0] disk LSI LSI 3.40 /dev/sdd /dev/sg4 [0:2:4:0] disk LSI LSI 3.40 /dev/sde /dev/sg5 [0:2:5:0] disk LSI LSI 3.40 /dev/sdf /dev/sg6 [0:2:6:0] disk LSI LSI 3.40 /dev/sdg /dev/sg7 [0:2:7:0] disk LSI LSI 3.","title":"ç¡¬ç›˜é©±åŠ¨å™¨ä¸ç‰©ç†ç¡¬ç›˜å¯¹åº”å…³ç³»"},{"content":" åˆ†äº«sshå®‰å…¨é…ç½®å®è·µ\n1. opensshåŸºæœ¬é…ç½® å…³æ³¨å®‰å…¨æ¼æ´ä¿¡æ¯ï¼Œå®šæœŸå‡çº§ssh1ç‰ˆæœ¬ï¼Œå…³é”®å‚æ•°é…ç½®å‚è€ƒï¼š\ncat /etc/ssh/sshd_config Port 22 # å»ºè®®æ›´æ”¹é»˜è®¤ç«¯å£ Protocol 2 PermitRootLogin no MaxAuthTries 3 PubkeyAuthentication yes PermitEmptyPasswords no PasswordAuthentication no UsePAM yes X11Forwarding no PrintMotd no ClientAliveInterval 180 ClientAliveCountMax 0 UseDNS no Banner /etc/ssh_banner AllowUsers username 2. ä½¿ç”¨PAMæ¨¡å—é”å®šè´¦æˆ· PAM2æ¨¡å—ï¼Œpam_tally2å’Œpam_faillockæ¨¡å—åŠŸèƒ½ç›¸ä¼¼ï¼Œä»¥pam_faillockæ¨¡å—ä¸ºä¾‹ï¼š\ncat /etc/pam.d/password-auth #%PAM-1.0 # This file is auto-generated. # User changes will be destroyed the next time authselect is run. auth required pam_env.so auth required pam_faillock.so deny=3 unlock_time=900 even_deny_root root_unlock_time=900 auth sufficient pam_unix.so try_first_pass nullok auth required pam_deny.so account required pam_unix.so ... cat /etc/pam.d/system-auth #%PAM-1.0 # This file is auto-generated. # User changes will be destroyed the next time authselect is run. auth required pam_env.so auth required pam_faillock.so deny=3 unlock_time=900 even_deny_root root_unlock_time=900 auth sufficient pam_unix.so try_first_pass nullok auth required pam_deny.so account required pam_unix.so ... 3. åˆ©ç”¨iptables + ipset å¯ç”¨iptables3ï¼Œå¹¶é…ç½®sshç«¯å£é˜»æ­¢ç­–ç•¥ï¼Œç¤ºä¾‹ï¼š\niptablesç­–ç•¥ systemctl enable iptables \u0026amp;\u0026amp; systemctl start iptables cat /etc/sysconfig/iptables # sample configuration for iptables service # you can edit this manually or use system-config-firewall # please do not ask us to add additional ports/services to this default configuration *filter :INPUT ACCEPT [0:0] :FORWARD ACCEPT [0:0] :OUTPUT ACCEPT [0:0] -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT -A INPUT -p icmp -j ACCEPT -A INPUT -i lo -j ACCEPT -A INPUT -m set --match-set banlist src -p tcp -m tcp --dport 22 -j DROP -m comment --comment \u0026#34;block ipset banlist\u0026#34; -A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT -A INPUT -j REJECT --reject-with icmp-host-prohibited -A FORWARD -j REJECT --reject-with icmp-host-prohibited COMMIT ipsetç­–ç•¥ å¯ç”¨ipset4æœåŠ¡ï¼Œå¹¶æ–°å»ºç­–ç•¥banlistã€‚\n# å®‰è£…ipsetæœåŠ¡ yum install -y ipset-service systemctl enable ipset # åˆ›å»ºipsetç­–ç•¥ ipset create banlist hash:ip hashsize 4096 maxelem 1000000 timeout 86400 # ä¿å­˜ipseté…ç½® ipset save \u0026gt; /etc/sysconfig/ipset # å¯åŠ¨ipsetæœåŠ¡ systemctl restart ipset #æŸ¥çœ‹ipsetç­–ç•¥ ipset list åˆ¶å®šipsetæ§åˆ¶è„šæœ¬ ä»¥CentOS 7ä¸ºä¾‹ï¼Œshellè„šæœ¬ç¤ºä¾‹å¦‚ä¸‹ï¼š\n#!/bin/bash ipset_name=\u0026#34;banlist\u0026#34; num=3 date_time=\u0026#34;$(date -d \u0026#34;1 hours ago\u0026#34; \u0026#34;+%Y-%m-%d %H:%M:%S\u0026#34;)\u0026#34; [[ $(ipset list ${ipset_name}) ]] || ipset create ${ipset_name} hash:ip hashsize 4096 maxelem 1000000 timeout 86400 ipset_info=\u0026#34;$(ipset save ${ipset_name})\u0026#34; lastb -a -s \u0026#34;${date_time}\u0026#34; |awk \u0026#39;/ssh/{print $NF}\u0026#39; |sort -n |uniq -c |while read line; do count=\u0026#34;$(echo $line |awk \u0026#39;{print $1}\u0026#39;)\u0026#34; ipaddr=\u0026#34;$(echo $line |awk \u0026#39;{print $2}\u0026#39;)\u0026#34; if [ $count -ge $num ] \u0026amp;\u0026amp; [ $(echo ${ipset_info} |grep -wc \u0026#34;${ipaddr}\u0026#34;) -eq 0 ]; then /usr/sbin/ipset add ${ipset_name} ${ipaddr} fi done é…ç½®rootç”¨æˆ·crontabå®šæ—¶ä»»åŠ¡ï¼š crontab -l * * * * * /bin/bash /opt/ban_ssh_ip.sh \u0026amp;\u0026gt;/dev/null openssh\u0026#160;\u0026#x21a9;\u0026#xfe0e;\nLinux PAM\u0026#160;\u0026#x21a9;\u0026#xfe0e;\niptables\u0026#160;\u0026#x21a9;\u0026#xfe0e;\nipset\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","permalink":"https://gnail89.github.io/posts/ssh-security/","summary":"åˆ†äº«sshå®‰å…¨é…ç½®å®è·µ\n1. opensshåŸºæœ¬é…ç½® å…³æ³¨å®‰å…¨æ¼æ´ä¿¡æ¯ï¼Œå®šæœŸå‡çº§ssh1ç‰ˆæœ¬ï¼Œå…³é”®å‚æ•°é…ç½®å‚è€ƒï¼š\ncat /etc/ssh/sshd_config Port 22 # å»ºè®®æ›´æ”¹é»˜è®¤ç«¯å£ Protocol 2 PermitRootLogin no MaxAuthTries 3 PubkeyAuthentication yes PermitEmptyPasswords no PasswordAuthentication no UsePAM yes X11Forwarding no PrintMotd no ClientAliveInterval 180 ClientAliveCountMax 0 UseDNS no Banner /etc/ssh_banner AllowUsers username 2. ä½¿ç”¨PAMæ¨¡å—é”å®šè´¦æˆ· PAM2æ¨¡å—ï¼Œpam_tally2å’Œpam_faillockæ¨¡å—åŠŸèƒ½ç›¸ä¼¼ï¼Œä»¥pam_faillockæ¨¡å—ä¸ºä¾‹ï¼š\ncat /etc/pam.d/password-auth #%PAM-1.0 # This file is auto-generated. # User changes will be destroyed the next time authselect is run. auth required pam_env.so auth required pam_faillock.so deny=3 unlock_time=900 even_deny_root root_unlock_time=900 auth sufficient pam_unix.","title":"SSH Security"},{"content":"1. ç¯å¢ƒä¿¡æ¯ CentOS 7 ç¦ç”¨firewalld ç¦ç”¨selinux æ—¶é’ŸåŒæ­¥ è®¾ç½®ä¸»æœºå ip addr hostname 192.168.61.129 ceph-node01 192.168.61.130 ceph-node02 192.168.61.131 ceph-node03 2. å®‰è£…ä¾èµ–åŒ… æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦å®‰è£…\nå®‰è£…epelå’Œelrepoè½¯ä»¶æº yum install -y epel-release elrepo-release å®‰è£…python3 yum install -y python3 å‡çº§kernelè‡³æœ€æ–° yum --enablerepo=elrepo-kernel install -y kernel-ml # è®¾ç½®é»˜è®¤ä½¿ç”¨çš„å†…æ ¸ grubby --default-index grubby --info=ALL grubby --set-default-index=0 å®‰è£…docker-ceè½¯ä»¶æº cd /etc/yum.repos.d/ curl --remote-name https://download.docker.com/linux/centos/docker-ce.repo å®‰è£…æœ€æ–°ç‰ˆæœ¬docker yum install -y docker-ce systemctl start docker systemctl enable docker é‡å¯ç”Ÿæ•ˆ 3. å®‰è£…cephadm curl --remote-name --location https://mirrors.tuna.tsinghua.edu.cn/ceph/rpm-octopus/elnoarch/cephadm chmod +x ./cephadm ./cephadm add-repo --release octopus #æ·»åŠ repoè½¯ä»¶æº ./cephadm install #å‡çº§æœ€æ–°cephadmåŒ… 4. åˆå§‹åŒ–cephé›†ç¾¤ åˆå§‹åŒ–ç¬¬ä¸€ä¸ªmonèŠ‚ç‚¹ cephadm install ceph-common #å®‰è£…ceph cliå·¥å…· #æŸ¥çœ‹ç¼–æ’åç«¯æ˜¯cephadmï¼Œå¦‚æœæ˜¯æ˜¾ç¤ºrookè¿™é‡Œåç«¯å°±ä¼šæ˜¾ç¤ºrookã€‚ ceph orch status mkdir -p /etc/ceph cephadm bootstrap --mon-ip 192.168.61.129 #åˆå§‹åŒ–ä¸€ä¸ªmonèŠ‚ç‚¹ï¼Œè·å–æœ€æ–°çš„å®¹å™¨é•œåƒåˆ°æœ¬åœ° # è·å–monå®¹å™¨shell cephadm shell --fsid ec45b570-5432-11ed-9ea9-000c29cb9f51 -c /etc/ceph/ceph.conf -k /etc/ceph/ceph.client.admin.keyring å¼•å¯¼å®Œæˆä¸€ä¸ªå•èŠ‚ç‚¹ç¾¤é›†ï¼Œç¨‹åºä¼šåšå¦‚ä¸‹äº‹æƒ…ï¼š\nåœ¨æœ¬åœ°ä¸»æœºä¸Šä¸ºæ–°é›†ç¾¤åˆ›å»ºmonitor å’Œ manager daemonå®ˆæŠ¤ç¨‹åºã€‚ ä¸ºCephé›†ç¾¤ç”Ÿæˆä¸€ä¸ªæ–°çš„SSHå¯†é’¥ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°rootç”¨æˆ·çš„/root/.ssh/authorized_keysæ–‡ä»¶ä¸­ã€‚ å°†ä¸æ–°ç¾¤é›†è¿›è¡Œé€šä¿¡æ‰€éœ€çš„æœ€å°é…ç½®æ–‡ä»¶ä¿å­˜åˆ°/etc/ceph/ceph.confã€‚ å‘/etc/ceph/ceph.client.admin.keyringå†™å…¥client.adminç®¡ç†secret keyçš„å‰¯æœ¬ã€‚ å°†public keyçš„å‰¯æœ¬å†™å…¥/etc/ceph/ceph.pubã€‚ åˆå§‹çš„mgrä¿¡æ¯ï¼š\nURL: https://ceph-node01:8443 User: admin Password: å®‰è£…æç¤ºè·å–å¯†ç  (å¯é€‰)å¦‚æœå¿˜è®°mgrå¯†ç å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•é‡ç½®å¯†ç (å°†å¯†ç å†™å…¥passwordæ–‡ä»¶ä¸­ï¼Œé€šè¿‡å‘½ä»¤å¯¼å…¥å¯†ç )\nceph dashboard ac-user-set-password admin -i password å½“å‰èŠ‚ç‚¹å®‰è£…åå®¹å™¨åˆ—è¡¨ä¸­çš„è§’è‰²ï¼š mon.ceph-node01 # monitorèŠ‚ç‚¹ mgr.ceph-node01.hnlomt # mgrç®¡ç†èŠ‚ç‚¹ prometheus.ceph-node01 # prometheusç›‘æ§ alertmanager.ceph-node01 # prometheuså‘Šè­¦ç›¸å…³ grafana.ceph-node01 # ç›‘æ§å‘Šè­¦å±•ç¤º node-exporter.ceph-node01 # æ•°æ®é‡‡é›†nodeèŠ‚ç‚¹ crash.ceph-node01 # crashç›¸å…³ åˆ†å‘cephadmèŠ‚ç‚¹å…¬é’¥åˆ°å…¶ä½™èŠ‚ç‚¹ï¼š ssh-copy-id -f -i /etc/ceph/ceph.pub root@ceph-node02 ssh-copy-id -f -i /etc/ceph/ceph.pub root@ceph-node03 æ–°å¢cephä¸»æœºåˆ°é›†ç¾¤æ–°å¢cephä¸»æœºåˆ°é›†ç¾¤ ceph orch host add ceph-node02 192.168.61.130 ceph orch host add ceph-node03 192.168.61.131 è°ƒæ•´monèŠ‚ç‚¹åˆ†å¸ƒ é»˜è®¤monèŠ‚ç‚¹æ˜¯5ä¸ªï¼Œéšæœºåˆ†å¸ƒåœ¨é›†ç¾¤ä¸»æœºä¸Šï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µï¼ŒæŒ‡å®šéƒ¨ç½²ceph monèŠ‚ç‚¹ï¼ˆorchæ¨¡å—è‡ªåŠ¨ç®¡ç†ï¼‰\nceph orch apply mon \u0026#34;ceph-node01,ceph-node02,ceph-node03\u0026#34; æŒ‡å®šéƒ¨ç½²monæ•°é‡ï¼Œorchæ¨¡å—è‡ªåŠ¨éƒ¨ç½²ï¼Œé»˜è®¤å€¼ä¸º5 ceph orch apply mon 3 æŒ‡å®šéƒ¨ç½²monåˆ°æŒ‡å®šæ ‡ç­¾èŠ‚ç‚¹ï¼ˆorchæ¨¡å—è‡ªåŠ¨ç®¡ç†ï¼‰ ceph orch apply mon label:mon ç¦ç”¨monè‡ªåŠ¨éƒ¨ç½²ï¼ˆå¯é€‰ï¼‰ è¿™ç§æƒ…å†µä¸‹éœ€è¦æ‰‹åŠ¨éƒ¨ç½²monèŠ‚ç‚¹ï¼ŒmonèŠ‚ç‚¹ä¸å—orchæ¨¡å—è‡ªåŠ¨ç®¡ç†\nceph orch apply mon --unmanaged æ‰‹åŠ¨æŒ‡å®šèŠ‚ç‚¹éƒ¨ç½²monï¼ˆå¯é€‰ï¼‰ ceph orch daemon add mon ceph-node02:192.168.61.130 ceph orch daemon add mon ceph-node03:192.168.61.131 å¯¹èŠ‚ç‚¹æ‰“æ ‡ç­¾(å¯é€‰) ceph orch host label add ceph-node01 mon ceph orch host label add ceph-node02 mon ceph orch host label add ceph-node03 mon ceph orch host label add ceph-node01 _admin ceph orch host label add ceph-node01 mgr ceph orch host label add ceph-node02 mgr æŸ¥è¯¢é›†ç¾¤çŠ¶æ€ æŸ¥çœ‹ServiceçŠ¶æ€ ceph orch ls NAME RUNNING REFRESHED AGE PLACEMENT IMAGNAME IMAGE ID alertmanager 1/1 7m ago 23h count:1 quay.iprometheus/alertmanager:v0.20.0 0881eb8f169f crash 3/3 7m ago 23h * quay.io/cepceph:v15 93146564743f grafana 1/1 7m ago 23h count:1 quay.io/cepceph-grafana:6.7.4 557c83e11646 mgr 2/2 7m ago 23h count:2 quay.io/cepceph:v15 93146564743f mon 3/3 7m ago 118m ceph-node01;ceph-node02;ceph-node03 quay.io/cepceph:v15 93146564743f node-exporter 3/3 7m ago 23h * quay.iprometheus/node-exporter:v0.18.1 e5a616e4b9cf prometheus 1/1 7m ago 23h count:1 quay.iprometheus/prometheus:v2.18.1 de242295e225 æŸ¥è¯¢DeamonçŠ¶æ€ ceph orch ps NAME HOST STATUS REFRESHED AGE VERSION IMAGE NAME IMAGE ID CONTAINER ID alertmanager.ceph-node01 ceph-node01 running (2h) 3m ago 4w 0.20.0 quay.io/prometheus/alertmanager:v0.20.0 0881eb8f169f 689490756acc crash.ceph-node01 ceph-node01 running (2h) 3m ago 4w 15.2.17 quay.io/ceph/ceph:v15 93146564743f 5c05118fec32 crash.ceph-node02 ceph-node02 running (2h) 3m ago 4w 15.2.17 quay.io/ceph/ceph:v15 93146564743f bbc408935136 crash.ceph-node03 ceph-node03 running (2h) 3m ago 4w 15.2.17 quay.io/ceph/ceph:v15 93146564743f 87c1e705053e grafana.ceph-node01 ceph-node01 running (2h) 3m ago 4w 6.7.4 quay.io/ceph/ceph-grafana:6.7.4 557c83e11646 e211ea6be042 mgr.ceph-node01.wmeddo ceph-node01 running (2h) 3m ago 5d 15.2.17 quay.io/ceph/ceph:v15 93146564743f e465de9c3e9d mgr.ceph-node02.hyipxw ceph-node02 running (2h) 3m ago 4w 15.2.17 quay.io/ceph/ceph:v15 93146564743f 5026b159b240 mon.ceph-node01 ceph-node01 running (2h) 3m ago 4w 15.2.17 quay.io/ceph/ceph:v15 93146564743f 3f48f4045628 mon.ceph-node02 ceph-node02 running (2h) 3m ago 4w 15.2.17 quay.io/ceph/ceph:v15 93146564743f 3cf45764cafb mon.ceph-node03 ceph-node03 running (2h) 3m ago 4w 15.2.17 quay.io/ceph/ceph:v15 93146564743f f689c97923f6 node-exporter.ceph-node01 ceph-node01 running (2h) 3m ago 4w 0.18.1 quay.io/prometheus/node-exporter:v0.18.1 e5a616e4b9cf 12aec21e4c45 node-exporter.ceph-node02 ceph-node02 running (2h) 3m ago 4w 0.18.1 quay.io/prometheus/node-exporter:v0.18.1 e5a616e4b9cf 4fcfb820aa3b node-exporter.ceph-node03 ceph-node03 running (2h) 3m ago 4w 0.18.1 quay.io/prometheus/node-exporter:v0.18.1 e5a616e4b9cf 8aee37a4868b prometheus.ceph-node01 ceph-node01 running (2h) 3m ago 4w 2.18.1 quay.io/prometheus/prometheus:v2.18.1 de242295e225 aa30615a1ce0 æŸ¥çœ‹orchç®¡ç†çš„ä¸»æœºåˆ—è¡¨ ceph orch host ls HOST ADDR LABELS STATUS ceph-node01 ceph-node01 _admin mgr mon ceph-node02 ceph-node02 mgr mon ceph-node03 ceph-node03 mon 5. éƒ¨ç½²osd æ·»åŠ OSDéœ€æ±‚æ»¡è¶³ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶ï¼š\nè®¾å¤‡å¿…é¡»æ²¡æœ‰åˆ†åŒºã€‚\nè®¾å¤‡ä¸å¾—å…·æœ‰ä»»ä½•LVMçŠ¶æ€ã€‚\nä¸å¾—å®‰è£…è®¾å¤‡ã€‚\nè¯¥è®¾å¤‡ä¸å¾—åŒ…å«æ–‡ä»¶ç³»ç»Ÿã€‚\nè¯¥è®¾å¤‡ä¸å¾—åŒ…å«Ceph BlueStore OSDã€‚\nè®¾å¤‡å¿…é¡»å¤§äº5 GBã€‚\norchæ¨¡å—è‡ªåŠ¨éƒ¨ç½²osd ceph orch apply osd --all-available-devices æš‚åœorchæ¨¡å—è‡ªåŠ¨ç®¡ç†osdï¼ˆå¯é€‰ï¼‰ ceph orch apply osd --all-available-devices --unmanaged=true æ‰‹åŠ¨æ–°å¢osdï¼ˆå¯é€‰ï¼‰ ceph orch device ls ceph orch device zap ceph-node01 /dev/sdb --force ceph orch daemon add osd ceph-node01:/dev/sdb ç§»é™¤osd ceph orch daemon stop osd.2 ceph orch osd rm 2 #ç­‰å¾…æ•°æ®å¹³è¡¡ ceph orch osd rm status ceph osd tree ceph osd out osd.2 #ç­‰å¾…æ•°æ®å¹³è¡¡ ceph osd purge osd.2 --force ceph osd crush ls ceph-node01 ceph orch daemon rm osd.2 --force é—®é¢˜ï¼šwipefs: error: /dev/sdb: probing initialization failed: Device or resource busy è§£å†³åŠæ³•ï¼š\nç§»é™¤é€»è¾‘å·ï¼š dmsetup remove --force ceph--cd03e720--2f3e--497e--8f7a--97432c2b675d-osd--block--c4b4700e--1001--473a--ab05--470b7e9c711e æ“¦é™¤æ–‡ä»¶ç³»ç»Ÿçš„ç­¾å wipefs -a /dev/sdb é‡æ–°åˆå§‹åŒ– ceph orch device zap ceph-node01 /dev/sdb --force é—®é¢˜ï¼šé›†ç¾¤æ‰€æœ‰mgrå…¨éƒ¨downï¼Œé›†ç¾¤æŠ¥warningï¼Œæ— æ³•ä½¿ç”¨orchç®¡ç†ã€‚ æ‰¾åˆ°mgrä¸€ä¸ªèŠ‚ç‚¹ï¼Œmgrä¸€èˆ¬ä¿å­˜ä½ç½®ä¸ºï¼š/var/lib/ceph/{fsid}/mgr.node.name\né€šè¿‡cephadmä¸´æ—¶æ‹‰èµ·mgræœåŠ¡ï¼š\ncephadm run --name {mgr.node.name} --fsid {fsid} ç„¶åç”¨orchæ¨¡å—æ‹‰èµ·å‰©ä½™mgræœåŠ¡ï¼š ceph orch ps ceph orch daemon start mgr.ceph-node01.name åœæ‰cephadmä¸´æ—¶æ‹‰èµ·çš„mgrï¼Œç„¶åç”¨orchæ¨¡å—é‡å¯æ‰€æœ‰mgrï¼š ceph orch restart mgr 6. éƒ¨ç½²CEPHFSæœåŠ¡ ä½¿ç”¨ceph fsåˆ›å»º åˆ›å»ºcephfsæ–‡ä»¶ç³»ç»Ÿï¼Œæ–°ç‰ˆæœ¬cephä¼šè‡ªåŠ¨åˆ›å»ºmdsæœåŠ¡ï¼Œä½¿ç”¨cephfsæ–‡ä»¶ç³»ç»Ÿéœ€è¦ä¸€ä¸ªæˆ–å¤šä¸ªMDSæœåŠ¡ã€‚\nceph fs volume create cephfs --placement=3 ceph fs status # æˆ–è€…æ‰‹åŠ¨éƒ¨ç½²mdså®ˆæŠ¤è¿›ç¨‹ï¼š ceph orch apply mds cephfs --placement 3 ceph orch ls æŸ¥çœ‹ceph fsçŠ¶æ€ï¼Œå¯ä»¥æ˜¾ç¤ºä¸»å¤‡mdsèŠ‚ç‚¹ä¿¡æ¯ï¼Œæ–‡ä»¶ç³»ç»Ÿæƒ…å†µ\nceph fs status ceph fs ls ceph mds stat æ‰‹åŠ¨åˆ›å»º # åˆ›å»ºfs dataæ± ï¼Œå¯ç”¨erasureçº åˆ åŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨replicatedåŠŸèƒ½ã€‚ ceph osd pool create cephfs.cephfs.data 32 erasure # åˆ›å»ºfs metadataæ± ï¼Œåªèƒ½é»˜è®¤replicatedå¤åˆ¶åŠŸèƒ½ ceph osd pool create cephfs.cephfs.meta 32 # åˆ›å»ºceph fsï¼Œé™„ä¸Šmetadataå’Œdataæ±  ceph fs new cephfs cephfs.cephfs.meta cephfs.cephfs.data # æ‰‹åŠ¨éƒ¨ç½²cephfs mdsæœåŠ¡ ceph orch apply mds cephfs --placement=3 ï¼ˆå¯é€‰ï¼‰å¯å°†cephfsçš„æ•°æ®æ± è®¾ç½®å¯ç”¨çº åˆ ç (poolåˆ›å»ºæ—¶éœ€è¦æŒ‡å®šä¸ºerasureå‚æ•°)ï¼Œç„¶åå¯ç”¨ec overwritesã€‚ä½†cephfs metadataå…ƒæ•°æ®æ± ä¸èƒ½ä½¿ç”¨çº åˆ ç ï¼Œå› ä¸ºå…ƒæ•°æ®ä½¿ç”¨OMAPæ•°æ®ç»“æ„æ‰€ä»¥ä¸æ”¯æŒã€‚\nceph osd pool set cephfs.cephfs.data allow_ec_overwrites true LinuxæŒ‚è½½cephfsæ–‡ä»¶ç³»ç»Ÿæ–¹æ³• ç”Ÿæˆcephé…ç½®æ–‡ä»¶è‡³å®¢æˆ·ç«¯ä¸»æœº mkdir -p -m 755 /etc/ceph ssh {user}@{mon-host} \u0026#34;sudo ceph config generate-minimal-conf\u0026#34; | sudo tee /etc/ceph/ceph.conf chmod 644 /etc/ceph/ceph.conf ç”Ÿæˆcephxè®¤è¯ä¿¡æ¯ ssh {user}@{mon-host} \u0026#34;sudo ceph fs authorize cephfs client.mountfs / rw\u0026#34; | sudo tee /etceph/ceph.client.mountfs.keyring chmod 600 /etc/ceph/ceph.client.mountfs.keyring å½“ä½¿ç”¨å†…æ ¸é©±åŠ¨æŒ‚è½½cephfsæ—¶ä½¿ç”¨ï¼ˆæ³„éœ²å¯†é’¥é£é™©ï¼‰ # mount -t ceph {device-string}:{path-to-mounted} {mount-point} -o {key-value-args{other-args} mount -t ceph 192.168.61.129:6789,192.168.61.130:6789,192.168.61.131:6789:/ /mnt -name=mountfs,secret=AQBtO3dj8bjLNxAAGFHw02lPnlbapyAVwwIBuA== ä½¿ç”¨mount.cephæŒ‚è½½ï¼ˆéœ€è¦å®‰è£…ceph-commonåŒ…ï¼‰ mount -t ceph :/ /mnt -o name=mountfs,fs=cephfs å†™å…¥/etc/fstabæ–‡ä»¶ :/ /mnt ceph name=mountfs,[fs=cephfs,secret=str,]noatime,[nodiratime,]_netdev 0 2 7. éƒ¨ç½²CEPH NFSæœåŠ¡ ä»…æ”¯æŒ NFSv4 åè®®ã€‚\nåˆ›å»ºæ–°æ±  ceph osd pool create ganesha_data 32 ceph osd pool application enable ganesha_data nfs åˆ›å»ºNFSç½‘å…³ ceph orch apply nfs nfs ganesha_data --placement=2 æŸ¥çœ‹ServiceçŠ¶æ€ ceph orch ls NAME RUNNING REFRESHED AGE PLACEMENT IMAGE NAME IMAGE ID alertmanager 1/1 46s ago 4w count:1 quay.io/prometheus/alertmanager:v0.20.0 0881eb8f169f crash 3/3 48s ago 4w * quay.io/ceph/ceph:v15 93146564743f grafana 1/1 46s ago 4w count:1 quay.io/ceph/ceph-grafana:6.7.4 557c83e11646 mds.cephfs 2/2 48s ago 5d count:2 quay.io/ceph/ceph:v15 93146564743f mgr 2/2 48s ago 9d ceph-node01;ceph-node02 quay.io/ceph/ceph:v15 93146564743f mon 3/3 48s ago 4w ceph-node01;ceph-node02;ceph-node03 quay.io/ceph/ceph:v15 93146564743f nfs.nfs 2/2 46s ago 11m count:2 quay.io/ceph/ceph:v15 93146564743f node-exporter 3/3 48s ago 4w * quay.io/prometheus/node-exporter:v0.18.1 e5a616e4b9cf osd.all-available-devices 3/3 48s ago 9d * quay.io/ceph/ceph:v15 93146564743f prometheus 1/1 46s ago 4w count:1 quay.io/prometheus/prometheus:v2.18.1 de242295e225 æŸ¥çœ‹daemonçŠ¶æ€ ceph orch ps NAME HOST STATUS REFRESHED AGE VERSION IMAGE NAME IMAGE ID CONTAINER ID alertmanager.ceph-node01 ceph-node01 running (5h) 81s ago 4w 0.20.0 quay.io/prometheus/alertmanager:v0.20.0 0881eb8f169f 689490756acc crash.ceph-node01 ceph-node01 running (5h) 81s ago 4w 15.2.17 quay.io/ceph/ceph:v15 93146564743f 5c05118fec32 crash.ceph-node02 ceph-node02 running (5h) 84s ago 4w 15.2.17 quay.io/ceph/ceph:v15 93146564743f bbc408935136 crash.ceph-node03 ceph-node03 running (5h) 58s ago 4w 15.2.17 quay.io/ceph/ceph:v15 93146564743f 87c1e705053e grafana.ceph-node01 ceph-node01 running (5h) 81s ago 4w 6.7.4 quay.io/ceph/ceph-grafana:6.7.4 557c83e11646 e211ea6be042 mds.cephfs.ceph-node02.mxqelr ceph-node02 running (5h) 84s ago 5d 15.2.17 quay.io/ceph/ceph:v15 93146564743f 549606028df4 mds.cephfs.ceph-node03.xhcgto ceph-node03 running (5h) 58s ago 5d 15.2.17 quay.io/ceph/ceph:v15 93146564743f ee51fb9c1a8b mgr.ceph-node01.wmeddo ceph-node01 running (5h) 81s ago 6d 15.2.17 quay.io/ceph/ceph:v15 93146564743f e465de9c3e9d mgr.ceph-node02.hyipxw ceph-node02 running (5h) 84s ago 4w 15.2.17 quay.io/ceph/ceph:v15 93146564743f 5026b159b240 mon.ceph-node01 ceph-node01 running (5h) 81s ago 4w 15.2.17 quay.io/ceph/ceph:v15 93146564743f 3f48f4045628 mon.ceph-node02 ceph-node02 running (5h) 84s ago 4w 15.2.17 quay.io/ceph/ceph:v15 93146564743f 3cf45764cafb mon.ceph-node03 ceph-node03 running (5h) 58s ago 4w 15.2.17 quay.io/ceph/ceph:v15 93146564743f f689c97923f6 nfs.nfs.ceph-node01 ceph-node01 running (11m) 81s ago 11m 3.3 quay.io/ceph/ceph:v15 93146564743f 117e58e5990c nfs.nfs.ceph-node03 ceph-node03 running (60s) 58s ago 11m 3.3 quay.io/ceph/ceph:v15 93146564743f 3662ecedd542 node-exporter.ceph-node01 ceph-node01 running (5h) 81s ago 4w 0.18.1 quay.io/prometheus/node-exporter:v0.18.1 e5a616e4b9cf 12aec21e4c45 node-exporter.ceph-node02 ceph-node02 running (5h) 84s ago 4w 0.18.1 quay.io/prometheus/node-exporter:v0.18.1 e5a616e4b9cf 4fcfb820aa3b node-exporter.ceph-node03 ceph-node03 running (5h) 58s ago 4w 0.18.1 quay.io/prometheus/node-exporter:v0.18.1 e5a616e4b9cf 8aee37a4868b osd.0 ceph-node03 running (5h) 58s ago 4w 15.2.17 quay.io/ceph/ceph:v15 93146564743f 4d8635a833cc osd.1 ceph-node02 running (5h) 84s ago 3w 15.2.17 quay.io/ceph/ceph:v15 93146564743f 6fa84fe728c7 osd.2 ceph-node01 running (5h) 81s ago 9d 15.2.17 quay.io/ceph/ceph:v15 93146564743f 16d42b3583ea prometheus.ceph-node01 ceph-node01 running (5h) 81s ago 4w 2.18.1 quay.io/prometheus/prometheus:v2.18.1 de242295e225 aa30615a1ce0 NFS é«˜å¯ç”¨(é«˜ç‰ˆæœ¬æ”¯æŒ) ingress nfs éƒ¨ç½²æ–‡ä»¶ï¼šingress-nfs.yml service_type: ingress service_id: nfs.nfs placement: count: 2 spec: backend_service: nfs.nfs frontend_port: 2050 # å¯¹å¤–æœåŠ¡ç«¯å£ monitor_port: 9000 # haproxyæŸ¥çœ‹çŠ¶æ€é¡µé¢ virtual_ip: 192.168.61.140/24 éƒ¨ç½² ceph orch apply -i ingress-nfs.yaml 8. éƒ¨ç½²RGWæœåŠ¡ ceph orch apply rgw object-service us-east-1 --placement=3 é»˜è®¤æƒ…å†µä¸‹ï¼Œcephadmä¼šè‡ªåŠ¨åˆ›å»ºrealmå’Œzoneï¼Œæˆ–è€…ä¹Ÿå¯ä»¥æ‰‹åŠ¨åˆ›å»ºrealmï¼Œzonegroupï¼Œzoneã€‚\nradosgw-admin realm create --rgw-realm=\u0026lt;realm-name\u0026gt; --default radosgw-admin zonegroup create --rgw-zonegroup=\u0026lt;zonegroup-name\u0026gt; --master --default radosgw-admin zone create --rgw-zonegroup=\u0026lt;zonegroup-name\u0026gt; --rgw-zone=\u0026lt;zone-name\u0026gt; --master --default radosgw-admin period update --rgw-realm=\u0026lt;realm-name\u0026gt; --commit ","permalink":"https://gnail89.github.io/posts/install-ceph-octopus-with-cephadm/","summary":"1. ç¯å¢ƒä¿¡æ¯ CentOS 7 ç¦ç”¨firewalld ç¦ç”¨selinux æ—¶é’ŸåŒæ­¥ è®¾ç½®ä¸»æœºå ip addr hostname 192.168.61.129 ceph-node01 192.168.61.130 ceph-node02 192.168.61.131 ceph-node03 2. å®‰è£…ä¾èµ–åŒ… æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦å®‰è£…\nå®‰è£…epelå’Œelrepoè½¯ä»¶æº yum install -y epel-release elrepo-release å®‰è£…python3 yum install -y python3 å‡çº§kernelè‡³æœ€æ–° yum --enablerepo=elrepo-kernel install -y kernel-ml # è®¾ç½®é»˜è®¤ä½¿ç”¨çš„å†…æ ¸ grubby --default-index grubby --info=ALL grubby --set-default-index=0 å®‰è£…docker-ceè½¯ä»¶æº cd /etc/yum.repos.d/ curl --remote-name https://download.docker.com/linux/centos/docker-ce.repo å®‰è£…æœ€æ–°ç‰ˆæœ¬docker yum install -y docker-ce systemctl start docker systemctl enable docker é‡å¯ç”Ÿæ•ˆ 3. å®‰è£…cephadm curl --remote-name --location https://mirrors.tuna.tsinghua.edu.cn/ceph/rpm-octopus/elnoarch/cephadm chmod +x .","title":"Install Ceph Octopus With Cephadm"},{"content":"1. åŸºæœ¬è¯­æ³• Markdownè¯­æ³•ä¸»è¦åˆ†ç±»: æ ‡é¢˜, æ®µè½, åŒºå—å¼•ç”¨, ä»£ç åŒºå—, å¼ºè°ƒ, åˆ—è¡¨, åˆ†å‰²çº¿, é“¾æ¥, å›¾ç‰‡, åæ–œæ \\, ç¬¦å·\u0026rsquo;`' æ ‡é¢˜ ä½¿ç”¨=å’Œ-ç¬¦å·æ ‡è®°ä¸€çº§å’ŒäºŒçº§æ ‡é¢˜ è¿™æ˜¯ä¸€çº§æ ‡é¢˜ ========== è¿™æ˜¯äºŒçº§æ ‡é¢˜ ---------- ä½¿ç”¨#ç¬¦å·ï¼Œå¯ä»¥è¡¨ç¤º1-6çº§æ ‡é¢˜ # ä¸€çº§æ ‡é¢˜ ## äºŒçº§æ ‡é¢˜ ### ä¸‰çº§æ ‡é¢˜ #### å››çº§æ ‡é¢˜ ##### äº”çº§æ ‡é¢˜ ###### å…­çº§æ ‡é¢˜ æ®µè½ æ®µè½å†…å¼ºåˆ¶æ¢è¡Œä½¿ç”¨ä¸¤ä¸ªä»¥ä¸Šç©ºæ ¼åŠ ä¸Šå›è½¦, å¼•ç”¨ä¸­æ¢è¡Œå¯çœç•¥å›è½¦ åŒºå—å¼•ç”¨ åœ¨æ®µè½çš„æ¯è¡Œæˆ–åªåœ¨ç¬¬ä¸€è¡Œä½¿ç”¨ç¬¦å·\u0026gt;,è¿˜å¯ä½¿ç”¨å¤šä¸ªåµŒå¥—å¼•ç”¨ \u0026gt; åŒºå—å¼•ç”¨ \u0026gt;\u0026gt; åµŒå¥—å¼•ç”¨ ä»£ç åŒºå— ä»£ç åŒºå—çš„å»ºç«‹æ˜¯åœ¨æ¯è¡ŒåŠ ä¸Š4ä¸ªç©ºæ ¼æˆ–è€…ä¸€ä¸ªåˆ¶è¡¨ç¬¦ æ³¨æ„:éœ€è¦å’Œæ™®é€šæ®µè½ä¹‹é—´å­˜åœ¨ç©ºè¡Œã€‚\nvoid main() { printf(\u0026quot;Hello, Markdown.\u0026quot;); } å¼ºè°ƒ åœ¨å¼ºè°ƒå†…å®¹ä¸¤ä¾§åˆ†åˆ«åŠ ä¸Š*æˆ–è€…_ *æ–œä½“* _æ–œä½“_ **ç²—ä½“** __ç²—ä½“__ ***æ–œä½“åŠ ç²—*** ~~åˆ é™¤çº¿~~ åˆ—è¡¨ ä½¿ç”¨æ˜Ÿå·*,åŠ å·+,å‡å·-æ ‡è®°æ— åºåˆ—è¡¨ * æ— åºåˆ—è¡¨æ–‡å­— * æ— åºåˆ—è¡¨æ–‡å­— * æ— åºåˆ—è¡¨æ–‡å­— + æ— åºåˆ—è¡¨æ–‡å­— + æ— åºåˆ—è¡¨æ–‡å­— + æ— åºåˆ—è¡¨æ–‡å­— - æ— åºåˆ—è¡¨æ–‡å­— - æ— åºåˆ—è¡¨æ–‡å­— - æ— åºåˆ—è¡¨æ–‡å­— æœ‰åºåˆ—è¡¨çš„æ ‡è®°æ–¹å¼æ˜¯å°†ä¸Šè¿°çš„ç¬¦å·æ¢æˆæ•°å­—,å¹¶åŠ ä¸Šè‹±æ–‡å¥å·.,åé¢è¿˜æœ‰ä¸€ä¸ªç©ºæ ¼ 1. æœ‰åºåˆ—è¡¨ 2. æœ‰åºåˆ—è¡¨ 3. æœ‰åºåˆ—è¡¨ åˆ†å‰²çº¿ åˆ†å‰²çº¿æœ€å¸¸ä½¿ç”¨å°±æ˜¯ä¸‰ä¸ªæˆ–ä»¥ä¸Š*æˆ–-æˆ–_ é“¾æ¥ é“¾æ¥å¯ä»¥ç”±ä¸¤ç§å½¢å¼ç”Ÿæˆï¼šè¡Œå†…å¼å’Œå‚è€ƒå¼\nè¡Œå†…å¼:\n[æ˜¾ç¤ºåç§°](https://www.google.com \u0026#34;é“¾æ¥åˆ«å\u0026#34;) æ•ˆæœ:\næ˜¾ç¤ºåç§°\nå‚è€ƒå¼: [æ˜¾ç¤ºåç§°1][1] [æ˜¾ç¤ºåç§°2][2] [1]:https://www.google.com \u0026#34;é“¾æ¥åˆ«å1\u0026#34; [2]:https://www.google.com \u0026#34;é“¾æ¥åˆ«å2\u0026#34; æ•ˆæœ: æ˜¾ç¤ºåç§°1 æ˜¾ç¤ºåç§°2\nå›¾ç‰‡ æ·»åŠ å›¾ç‰‡çš„å½¢å¼å’Œé“¾æ¥ç›¸ä¼¼ï¼Œåªéœ€åœ¨é“¾æ¥çš„åŸºç¡€ä¸Šå‰æ–¹åŠ ä¸€ä¸ªè‹±æ–‡æ„Ÿå¹å·! ![æ˜¾ç¤ºåç§°](https://www.google.com/logo.png \u0026#34;é“¾æ¥åˆ«å\u0026#34;) åæ–œæ \\ ç›¸å½“äºåè½¬ä¹‰ä½œç”¨ã€‚ä½¿ç¬¦å·æˆä¸ºæ™®é€šç¬¦å· ä»¥ä¸‹åˆ—å‡ºçš„å­—ç¬¦éƒ½å¯ä»¥é€šè¿‡ä½¿ç”¨åæ–œæ å­—ç¬¦ä»è€Œè¾¾åˆ°è½¬ä¹‰ç›®çš„ã€‚ Character Name \\ backslash ` backtick (see also escaping backticks in code) * asterisk _ underscore { } curly braces [ ] brackets ( ) parentheses # pound sign + plus sign - minus sign (hyphen) . dot ! exclamation mark | pipe (see also escaping pipe in tables) ç¬¦å·\u0026rsquo;`' èµ·åˆ°æ ‡è®°çš„ä½œç”¨, ä¾‹å¦‚: `point` æ•ˆæœ:\npoint\n2. æ‰©å±•è¯­æ³• è¡¨æ ¼ è¦æ·»åŠ è¡¨ï¼Œè¯·ä½¿ç”¨ä¸‰ä¸ªæˆ–å¤šä¸ªè¿å­—ç¬¦ï¼ˆ---ï¼‰åˆ›å»ºæ¯åˆ—çš„æ ‡é¢˜ï¼Œå¹¶ä½¿ç”¨ç®¡é“ï¼ˆ|ï¼‰åˆ†éš”æ¯åˆ—ã€‚æ‚¨å¯ä»¥é€‰æ‹©åœ¨è¡¨çš„ä»»ä¸€ç«¯æ·»åŠ ç®¡é“ã€‚\n| Syntax | Description | | ----------- | ----------- | | Header | Title | | Paragraph | Text | æ•ˆæœï¼š Syntax Description Header Title Paragraph Text å¯¹é½ é€šè¿‡åœ¨æ ‡é¢˜è¡Œä¸­çš„è¿å­—ç¬¦çš„å·¦ä¾§ï¼Œå³ä¾§æˆ–ä¸¤ä¾§æ·»åŠ å†’å·ï¼ˆ:ï¼‰ï¼Œå°†åˆ—ä¸­çš„æ–‡æœ¬å¯¹é½åˆ°å·¦ä¾§ï¼Œå³ä¾§æˆ–ä¸­å¿ƒã€‚\n| Syntax | Description | Test Text | | :--- | :----: | ---: | | Header | Title | Here\u0026#39;s this | | Paragraph | Text | And more | æ•ˆæœï¼š Syntax Description Test Text Header Title Here\u0026rsquo;s this Paragraph Text And more å›´æ ä»£ç å— MarkdownåŸºæœ¬è¯­æ³•å…è®¸æ‚¨é€šè¿‡å°†è¡Œç¼©è¿›å››ä¸ªç©ºæ ¼æˆ–ä¸€ä¸ªåˆ¶è¡¨ç¬¦æ¥åˆ›å»ºä»£ç å—ã€‚å¦‚æœå‘ç°ä¸æ–¹ä¾¿ï¼Œè¯·å°è¯•ä½¿ç”¨å—ä¿æŠ¤çš„ä»£ç å—ã€‚æ ¹æ®Markdownå¤„ç†å™¨æˆ–ç¼–è¾‘å™¨çš„ä¸åŒï¼Œæ‚¨å°†åœ¨ä»£ç å—ä¹‹å‰å’Œä¹‹åçš„è¡Œä¸Šä½¿ç”¨ä¸‰ä¸ªåå¼•å·(```ï¼‰æˆ–ä¸‰ä¸ªæ³¢æµªå·ï¼ˆ~~~ï¼‰ã€‚\n``` { \u0026quot;firstName\u0026quot;: \u0026quot;John\u0026quot;, \u0026quot;lastName\u0026quot;: \u0026quot;Smith\u0026quot;, \u0026quot;age\u0026quot;: 25 } ``` æ•ˆæœï¼š { \u0026#34;firstName\u0026#34;: \u0026#34;John\u0026#34;, \u0026#34;lastName\u0026#34;: \u0026#34;Smith\u0026#34;, \u0026#34;age\u0026#34;: 25 } è¯­æ³•é«˜äº® è®¸å¤šMarkdownå¤„ç†å™¨éƒ½æ”¯æŒå—å›´æ ä»£ç å—çš„è¯­æ³•çªå‡ºæ˜¾ç¤ºã€‚ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œæ‚¨å¯ä»¥ä¸ºç¼–å†™ä»£ç çš„ä»»ä½•è¯­è¨€æ·»åŠ é¢œè‰²çªå‡ºæ˜¾ç¤ºã€‚è¦æ·»åŠ è¯­æ³•çªå‡ºæ˜¾ç¤ºï¼Œè¯·åœ¨å—é˜²æŠ¤çš„ä»£ç å—ä¹‹å‰çš„åå¼•å·æ—è¾¹æŒ‡å®šä¸€ç§è¯­è¨€ã€‚\n```json { \u0026quot;firstName\u0026quot;: \u0026quot;John\u0026quot;, \u0026quot;lastName\u0026quot;: \u0026quot;Smith\u0026quot;, \u0026quot;age\u0026quot;: 25 } ``` æ•ˆæœï¼š { \u0026#34;firstName\u0026#34;: \u0026#34;John\u0026#34;, \u0026#34;lastName\u0026#34;: \u0026#34;Smith\u0026#34;, \u0026#34;age\u0026#34;: 25 } å®šä¹‰åˆ—è¡¨ ä¸€äº›Markdownå¤„ç†å™¨å…è®¸æ‚¨åˆ›å»ºæœ¯è¯­åŠå…¶å¯¹åº”å®šä¹‰çš„å®šä¹‰åˆ—è¡¨ã€‚è¦åˆ›å»ºå®šä¹‰åˆ—è¡¨ï¼Œè¯·åœ¨ç¬¬ä¸€è¡Œä¸Šé”®å…¥æœ¯è¯­ã€‚åœ¨ä¸‹ä¸€è¡Œï¼Œé”®å…¥ä¸€ä¸ªå†’å·ï¼Œåè·Ÿä¸€ä¸ªç©ºæ ¼å’Œå®šä¹‰ã€‚\nFirst Term : This is the definition of the first term. Second Term : This is one definition of the second term. : This is another definition of the second term. æ•ˆæœï¼š First Term This is the definition of the first term. Second Term This is one definition of the second term. This is another definition of the second term. ä»»åŠ¡åˆ—è¡¨è¯­æ³• ä»»åŠ¡åˆ—è¡¨ä½¿æ‚¨å¯ä»¥åˆ›å»ºå¸¦æœ‰å¤é€‰æ¡†çš„é¡¹ç›®åˆ—è¡¨ã€‚åœ¨æ”¯æŒä»»åŠ¡åˆ—è¡¨çš„Markdownåº”ç”¨ç¨‹åºä¸­ï¼Œå¤é€‰æ¡†å°†æ˜¾ç¤ºåœ¨å†…å®¹æ—è¾¹ã€‚è¦åˆ›å»ºä»»åŠ¡åˆ—è¡¨ï¼Œè¯·åœ¨ä»»åŠ¡åˆ—è¡¨é¡¹ä¹‹å‰æ·»åŠ ç ´æŠ˜å·-å’Œæ–¹æ‹¬å·[ ]ï¼Œå¹¶åœ¨[ ]å‰é¢åŠ ä¸Šç©ºæ ¼ã€‚è¦é€‰æ‹©ä¸€ä¸ªå¤é€‰æ¡†ï¼Œè¯·åœ¨æ–¹æ‹¬å·[x]ä¹‹é—´æ·»åŠ  x ã€‚\n- [x] Write the press release - [ ] Update the website - [ ] Contact the media æ•ˆæœï¼š Write the press release Update the website Contact the media ä½¿ç”¨ Emoji è¡¨æƒ… æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥å°†è¡¨æƒ…ç¬¦å·æ·»åŠ åˆ°Markdownæ–‡ä»¶ä¸­ï¼šå°†è¡¨æƒ…ç¬¦å·å¤åˆ¶å¹¶ç²˜è´´åˆ°Markdownæ ¼å¼çš„æ–‡æœ¬ä¸­ï¼Œæˆ–è€…é”®å…¥emoji shortcodesã€‚\nå¤åˆ¶å’Œç²˜è´´è¡¨æƒ…ç¬¦å· åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ç®€å•åœ°ä»Emojipediaç­‰æ¥æºå¤åˆ¶è¡¨æƒ…ç¬¦å·å¹¶å°†å…¶ç²˜è´´åˆ°æ–‡æ¡£ä¸­ã€‚è®¸å¤šMarkdownåº”ç”¨ç¨‹åºä¼šè‡ªåŠ¨ä»¥Markdownæ ¼å¼çš„æ–‡æœ¬æ˜¾ç¤ºè¡¨æƒ…ç¬¦å·ã€‚ä»Markdownåº”ç”¨ç¨‹åºå¯¼å‡ºçš„HTMLå’ŒPDFæ–‡ä»¶åº”æ˜¾ç¤ºè¡¨æƒ…ç¬¦å·ã€‚\nTip: å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯é™æ€ç½‘ç«™ç”Ÿæˆå™¨ï¼Œè¯·ç¡®ä¿å°†HTMLé¡µé¢ç¼–ç ä¸ºUTF-8ã€‚\nä½¿ç”¨è¡¨æƒ…ç¬¦å·ç®€ç  ä¸€äº›Markdownåº”ç”¨ç¨‹åºå…è®¸æ‚¨é€šè¿‡é”®å…¥è¡¨æƒ…ç¬¦å·çŸ­ä»£ç æ¥æ’å…¥è¡¨æƒ…ç¬¦å·ã€‚è¿™äº›ä»¥å†’å·å¼€å¤´å’Œç»“å°¾ï¼Œå¹¶åŒ…å«è¡¨æƒ…ç¬¦å·çš„åç§°ã€‚\nå›¾é’‰ :pushpin: æ•ˆæœï¼š å›¾é’‰ \u0026#x1f4cc;\nè‡ªåŠ¨ç½‘å€é“¾æ¥ è®¸å¤šMarkdownå¤„ç†å™¨ä¼šè‡ªåŠ¨å°†URLè½¬æ¢ä¸ºé“¾æ¥ã€‚è¿™æ„å‘³ç€å¦‚æœæ‚¨è¾“å…¥http://www.example.comï¼Œå³ä½¿æ‚¨æœªä½¿ç”¨æ–¹æ‹¬å·ï¼Œæ‚¨çš„Markdownå¤„ç†å™¨ä¹Ÿä¼šè‡ªåŠ¨å°†å…¶è½¬æ¢ä¸ºé“¾æ¥ã€‚\nhttp://www.example.com æ•ˆæœï¼š http://www.example.com\nç¦ç”¨è‡ªåŠ¨URLé“¾æ¥ å¦‚æœæ‚¨ä¸å¸Œæœ›è‡ªåŠ¨é“¾æ¥URLï¼Œåˆ™å¯ä»¥é€šè¿‡å°†URLè¡¨ç¤ºä¸ºå¸¦åå¼•å·(`)çš„ä»£ç æ¥åˆ é™¤è¯¥é“¾æ¥ã€‚\n`http://www.example.com` æ•ˆæœï¼š http://www.example.com\nè„šæ³¨ Here\u0026#39;s a simple footnote,[^1] and here\u0026#39;s a longer one.[^bignote] [^1]: This is the first footnote. [^bignote]: Here\u0026#39;s one with multiple paragraphs and code. Indent paragraphs to include them in the footnote. `{ my code }` Add as many paragraphs as you like. æ•ˆæœï¼š Here\u0026rsquo;s a simple footnote,1 and here\u0026rsquo;s a longer one.2\nå‚è€ƒèµ„æ–™3\nThis is the first footnote.\u0026#160;\u0026#x21a9;\u0026#xfe0e;\nHere\u0026rsquo;s one with multiple paragraphs and code.\nIndent paragraphs to include them in the footnote.\n{ my code }\nAdd as many paragraphs as you like.\u0026#160;\u0026#x21a9;\u0026#xfe0e;\nhttps://markdown.com.cn\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","permalink":"https://gnail89.github.io/posts/markdown/","summary":"1. åŸºæœ¬è¯­æ³• Markdownè¯­æ³•ä¸»è¦åˆ†ç±»: æ ‡é¢˜, æ®µè½, åŒºå—å¼•ç”¨, ä»£ç åŒºå—, å¼ºè°ƒ, åˆ—è¡¨, åˆ†å‰²çº¿, é“¾æ¥, å›¾ç‰‡, åæ–œæ \\, ç¬¦å·\u0026rsquo;`' æ ‡é¢˜ ä½¿ç”¨=å’Œ-ç¬¦å·æ ‡è®°ä¸€çº§å’ŒäºŒçº§æ ‡é¢˜ è¿™æ˜¯ä¸€çº§æ ‡é¢˜ ========== è¿™æ˜¯äºŒçº§æ ‡é¢˜ ---------- ä½¿ç”¨#ç¬¦å·ï¼Œå¯ä»¥è¡¨ç¤º1-6çº§æ ‡é¢˜ # ä¸€çº§æ ‡é¢˜ ## äºŒçº§æ ‡é¢˜ ### ä¸‰çº§æ ‡é¢˜ #### å››çº§æ ‡é¢˜ ##### äº”çº§æ ‡é¢˜ ###### å…­çº§æ ‡é¢˜ æ®µè½ æ®µè½å†…å¼ºåˆ¶æ¢è¡Œä½¿ç”¨ä¸¤ä¸ªä»¥ä¸Šç©ºæ ¼åŠ ä¸Šå›è½¦, å¼•ç”¨ä¸­æ¢è¡Œå¯çœç•¥å›è½¦ åŒºå—å¼•ç”¨ åœ¨æ®µè½çš„æ¯è¡Œæˆ–åªåœ¨ç¬¬ä¸€è¡Œä½¿ç”¨ç¬¦å·\u0026gt;,è¿˜å¯ä½¿ç”¨å¤šä¸ªåµŒå¥—å¼•ç”¨ \u0026gt; åŒºå—å¼•ç”¨ \u0026gt;\u0026gt; åµŒå¥—å¼•ç”¨ ä»£ç åŒºå— ä»£ç åŒºå—çš„å»ºç«‹æ˜¯åœ¨æ¯è¡ŒåŠ ä¸Š4ä¸ªç©ºæ ¼æˆ–è€…ä¸€ä¸ªåˆ¶è¡¨ç¬¦ æ³¨æ„:éœ€è¦å’Œæ™®é€šæ®µè½ä¹‹é—´å­˜åœ¨ç©ºè¡Œã€‚\nvoid main() { printf(\u0026quot;Hello, Markdown.\u0026quot;); } å¼ºè°ƒ åœ¨å¼ºè°ƒå†…å®¹ä¸¤ä¾§åˆ†åˆ«åŠ ä¸Š*æˆ–è€…_ *æ–œä½“* _æ–œä½“_ **ç²—ä½“** __ç²—ä½“__ ***æ–œä½“åŠ ç²—*** ~~åˆ é™¤çº¿~~ åˆ—è¡¨ ä½¿ç”¨æ˜Ÿå·*,åŠ å·+,å‡å·-æ ‡è®°æ— åºåˆ—è¡¨ * æ— åºåˆ—è¡¨æ–‡å­— * æ— åºåˆ—è¡¨æ–‡å­— * æ— åºåˆ—è¡¨æ–‡å­— + æ— åºåˆ—è¡¨æ–‡å­— + æ— åºåˆ—è¡¨æ–‡å­— + æ— åºåˆ—è¡¨æ–‡å­— - æ— åºåˆ—è¡¨æ–‡å­— - æ— åºåˆ—è¡¨æ–‡å­— - æ— åºåˆ—è¡¨æ–‡å­— æœ‰åºåˆ—è¡¨çš„æ ‡è®°æ–¹å¼æ˜¯å°†ä¸Šè¿°çš„ç¬¦å·æ¢æˆæ•°å­—,å¹¶åŠ ä¸Šè‹±æ–‡å¥å·.","title":"MarkdownåŸºæœ¬è¯­æ³•"},{"content":"æ•™ç¨‹ Markdown æ•™ç¨‹ Pro Git 2 ç®€ä½“ä¸­æ–‡\ngitåœ¨çº¿å­¦ä¹ å·¥å…·\nèœé¸Ÿæ•™ç¨‹\nLinuxå‘½ä»¤å¤§å…¨\né¸Ÿå“¥æ•™ç¨‹\nå·¥å…· å¼€æºä¸­å›½åœ¨çº¿å·¥å…·\nèœé¸Ÿæ•™ç¨‹åœ¨çº¿å·¥å…·\nç¨‹åºå‘˜åœ¨çº¿å·¥å…·\nè„šæœ¬ä¹‹å®¶åœ¨çº¿å·¥å…·\nw3cschoolåœ¨çº¿å·¥å…·\nåœ¨çº¿å‹ç¼©è½¬æ¢å·¥å…·\nç äº‘å¼€æºé¡¹ç›®æ¨èåˆ—è¡¨\nåšå®¢ Javaå…¨æ ˆçŸ¥è¯†ä½“ç³» ","permalink":"https://gnail89.github.io/posts/website-favorites/","summary":"æ•™ç¨‹ Markdown æ•™ç¨‹ Pro Git 2 ç®€ä½“ä¸­æ–‡\ngitåœ¨çº¿å­¦ä¹ å·¥å…·\nèœé¸Ÿæ•™ç¨‹\nLinuxå‘½ä»¤å¤§å…¨\né¸Ÿå“¥æ•™ç¨‹\nå·¥å…· å¼€æºä¸­å›½åœ¨çº¿å·¥å…·\nèœé¸Ÿæ•™ç¨‹åœ¨çº¿å·¥å…·\nç¨‹åºå‘˜åœ¨çº¿å·¥å…·\nè„šæœ¬ä¹‹å®¶åœ¨çº¿å·¥å…·\nw3cschoolåœ¨çº¿å·¥å…·\nåœ¨çº¿å‹ç¼©è½¬æ¢å·¥å…·\nç äº‘å¼€æºé¡¹ç›®æ¨èåˆ—è¡¨\nåšå®¢ Javaå…¨æ ˆçŸ¥è¯†ä½“ç³» ","title":"ç½‘ç«™æ”¶è—å¤¹"}]